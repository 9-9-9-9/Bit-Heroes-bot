/*
 2008 PersonalGrid Corporation <http://personalgrid.com/>
 @package LivePipe UI
 @url http://livepipe.net/control/tabs
 @require prototype.js, livepipe.js
*/
(function(){var a;Kongregate.MessageConnection=function(a){this.initialize(a)};Kongregate.MessageConnection.MESSAGE_EVENT="kongregate:api:message";Kongregate.MessageConnection.prototype={initialize:function(b){a=b.channel_id;this._window=b.window||window;this._targetOrigin=b.target_origin;this._targetWindows=b.target_window?[b.target_window]:[];this._sendListener=b.send_listener;this._retryConnection=b.retry_connection||!1;this._messageListeners=[];this._supportsObjects=Kongregate.PostMessage.supportsObjects();
this._client="string"===typeof this._targetOrigin;this._connected=this._handleMessages=!1},addMessageListener:function(a){this._messageListeners.push(a)},isSupported:function(){return this.supportsObjects()||"undefined"!==typeof this._window.JSON?"undefined"!==typeof(this._targetWindows[0]||window).postMessage:!1},connected:function(){return this._connected},isClient:function(){return this._client},supportsObjects:function(){return this._supportsObjects},logPrefix:function(){return this._client?"[Game:JS]":
"[Konduit]"},listen:function(){if(this.isSupported()&&!this._listening){this._listening=!0;var a=this;Kongregate.PostMessage.addMessageListener(this._window,function(b){a.onMessageReceived.call(a,b)})}},parseMessage:function(a){try{var b=Kongregate.PostMessage.parseMessage(a);if(b&&b.kongregate_type===Kongregate.MessageConnection.MESSAGE_EVENT)return{opcode:b.opcode,params:b.params}}catch(d){Kongregate.Log.warn(this.logPrefix(),"Error parsing message",a,d)}return null},onMessageReceived:function(a){var b=
a.origin||a.originalEvent.origin;this._targetOrigin&&b!==this._targetOrigin?Kongregate.Log.debug(this.logPrefix(),"Ignoring message from "+b):(b=this.parseMessage(a.data))&&this.processMessage(b,a)},processMessage:function(a,c){Kongregate.Log.debug(this.logPrefix(),"Message received:",a);switch(a.opcode){case KonduitEvent.CONNECT:this.onClientConnected(a.params,c.source);break;case KonduitEvent.CONNECTED:this.onConnectedToServer()}for(c=0;c<this._messageListeners.length;c++)this._messageListeners[c](a.opcode,
a.params)},sendMessage:function(a,c){this.removeMissingWindows();if(this.connected()||a===KonduitEvent.CONNECT||a===KonduitEvent.CONNECTED){var b={kongregate_type:Kongregate.MessageConnection.MESSAGE_EVENT,opcode:a,params:"string"===typeof c?JSON.parse(c):c};this.supportsObjects()||(b=JSON.stringify(b));for(var e=this._targetOrigin||"*",g=0;g<this._targetWindows.length;g++)this._targetWindows[g].postMessage(b,e);this._sendListener&&this._sendListener(a,c)}else Kongregate.Log.debug(this.logPrefix(),
"Not sending "+a+", not connected")},connect:function(){this.connected()||(this.listen(),Kongregate.Log.debug("Attempting to connect to Kongregate API"),this.sendMessage(KonduitEvent.CONNECT,{chnl:a}),this._retryConnection&&this.retryConnection())},retryConnection:function(){var a=this;setTimeout(function(){a.connect()},5E3)},onClientConnected:function(b,c){b.chnl!==a?Kongregate.Log.warn(this.logPrefix(),"Channel ID mismatch, ignoring connect"):(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),
this.acceptClientConnection(c))},onConnectedToServer:function(){this.connected()||(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),this._connected=!0)},acceptClientConnection:function(a){for(var b=!1,d=this._targetWindows,e=0;e<this._targetWindows.length;e++)if(this._targetWindows[e]===a){Kongregate.Log.warn("Re-initializing duplicate connection");b=!0;break}this._targetWindows=[a];this.sendMessage(KonduitEvent.CONNECTED,{});this._targetWindows=d;b||this._targetWindows.push(a);
this.removeMissingWindows()},removeMissingWindows:function(a){if(!this._client){for(i=this._targetWindows.length-1;0<=i;i--)this._targetWindows[i].top||this._targetWindows.splice(i,1);this._connected=0<this._targetWindows.length}}}})();
Kongregate.PostMessage={addMessageListener:function(a,b){if(a.document.addEventListener)try{a.document.addEventListener.call(a,"message",b,!1)}catch(c){Kongregate.Log.debug("addEventListener failed, using iframe addEventListener: "+c),Kongregate.PostMessage.createIframeEventListener(a,b)}else a.attachEvent?a.attachEvent("onmessage",b):Kongregate.Log.error("Could not add event listener, neither addEventListener or attachEvent found!");return b},removeMessageListener:function(a,b){a.removeEventListener?
a.removeEventListener("message",b):a.detachEvent&&a.detachEvent("onmessage",b)},supportsObjects:function(){var a=document.createElement("iframe"),b=!0;a.src="about:blank";document.body.appendChild(a);try{a.contentWindow.postMessage({toString:function(){b=!1;return""}},"*")}catch(c){}document.body.removeChild(a);return b},parseMessage:function(a){return"string"===typeof a&&"{"===a.charAt(0)?JSON.parse(a):"object"===typeof a?a:null},createIframeEventListener:function(a,b){var c=document.createElement("iframe");
c.src="about:blank";document.head.appendChild(c);c.contentWindow.addEventListener.call(a,"message",b,!1);document.head.removeChild(c)}};if("undefined"==typeof Prototype)throw"Control.Tabs requires Prototype to be loaded.";if("undefined"==typeof Object.Event)throw"Control.Tabs requires Object.Event to be loaded.";
Control.Tabs=Class.create({initialize:function(a,b){if(!$(a))throw"Control.Tabs could not find the element: "+a;this.activeLink=this.activeContainer=!1;this.containers=$H({});this.links=[];Control.Tabs.instances.push(this);this.options={beforeChange:Prototype.emptyFunction,afterChange:Prototype.emptyFunction,hover:!1,linkSelector:"li a",setClassOnContainer:!1,activeClassName:"active",defaultTab:"first",autoLinkExternal:!0,targetRegExp:/#(.+)$/,showFunction:Element.show,hideFunction:Element.hide};
Object.extend(this.options,b||{});(typeof("string"==this.options.linkSelector)?$(a).select(this.options.linkSelector):this.options.linkSelector($(a))).findAll(function(a){return/^#/.exec((Prototype.Browser.WebKit?decodeURIComponent(a.href):a.href).replace((Prototype.Browser.WebKit?decodeURIComponent(window.location.href):window.location.href).split("#")[0],""))}).each(function(a){this.addTab(a)}.bind(this));this.containers.values().each(Element.hide);"first"==this.options.defaultTab?this.setActiveTab(this.links.first()):
"last"==this.options.defaultTab?this.setActiveTab(this.links.last()):this.setActiveTab(this.options.defaultTab);(a=this.options.targetRegExp.exec(window.location))&&a[1]&&a[1].split(",").each(function(a){this.setActiveTab(this.links.find(function(b){return b.key==a}))}.bind(this));this.options.autoLinkExternal&&$A(document.getElementsByTagName("a")).each(function(a){if(!this.links.include(a)){var b=a.href.replace(window.location.href.split("#")[0],"");"#"==b.substring(0,1)&&this.containers.keys().include(b.substring(1))&&
$(a).observe("click",function(a,b){this.setActiveTab(b.substring(1))}.bindAsEventListener(this,b))}}.bind(this))},addTab:function(a){this.links.push(a);a.key=a.getAttribute("href").replace(window.location.href.split("#")[0],"").split("/").last().replace(/#/,"");var b=$(a.key);if(!b)throw"Control.Tabs: #"+a.key+" was not found on the page.";this.containers.set(a.key,b);Event.observe(a,this.options.hover?"mouseover":"click",function(b){Event.stop(b);this.setActiveTab(a);return!1}.bind(this))},setActiveTab:function(a){if(a||
"undefined"!=typeof a)"string"==typeof a?this.setActiveTab(this.links.find(function(b){return b.key==a})):"number"==typeof a?this.setActiveTab(this.links[a]):!1!==this.notify("beforeChange",this.activeContainer,this.containers.get(a.key))&&(this.activeContainer&&this.options.hideFunction(this.activeContainer),this.links.each(function(a){(this.options.setClassOnContainer?$(a.parentNode):a).removeClassName(this.options.activeClassName)}.bind(this)),(this.options.setClassOnContainer?$(a.parentNode):
a).addClassName(this.options.activeClassName),this.activeContainer=this.containers.get(a.key),this.activeLink=a,this.options.showFunction(this.containers.get(a.key)),this.notify("afterChange",this.containers.get(a.key)))},next:function(){this.links.each(function(a,b){if(this.activeLink==a&&this.links[b+1])throw this.setActiveTab(this.links[b+1]),$break;}.bind(this))},previous:function(){this.links.each(function(a,b){if(this.activeLink==a&&this.links[b-1])throw this.setActiveTab(this.links[b-1]),$break;
}.bind(this))},first:function(){this.setActiveTab(this.links.first())},last:function(){this.setActiveTab(this.links.last())}});Object.extend(Control.Tabs,{instances:[],findByTabId:function(a){return Control.Tabs.instances.find(function(b){return b.links.find(function(b){return b.key==a})})}});Object.Event.extend(Control.Tabs);
(function(a){(function(a,c){"function"===typeof define&&define.amd?define("strophe-base64",function(){return c()}):a.Base64=c()})(this,function(){return{encode:function(a){var b="",d=0;do{var e=a.charCodeAt(d++);var g=a.charCodeAt(d++);var h=a.charCodeAt(d++);var l=e>>2;var f=(e&3)<<4|g>>4;var m=(g&15)<<2|h>>6;var r=h&63;isNaN(g)?(f=(e&3)<<4,m=r=64):isNaN(h)&&(r=64);b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(m)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)}while(d<a.length);return b},decode:function(a){var b="",d=0;a=a.replace(/[^A-Za-z0-9\+\/=]/g,"");do{var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(d++));var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(d++));var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(d++));
var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(d++));e=e<<2|g>>4;g=(g&15)<<4|h>>2;var f=(h&3)<<6|l;b+=String.fromCharCode(e);64!=h&&(b+=String.fromCharCode(g));64!=l&&(b+=String.fromCharCode(f))}while(d<a.length);return b}}});(function(a,c){"function"===typeof define&&define.amd?define("strophe-sha1",function(){return c()}):a.SHA1=c()})(this,function(){function a(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;b=Array(80);var c=1732584193,e=-271733879,g=
-1732584194,f=271733878,h=-1009589776,l,w;for(l=0;l<a.length;l+=16){var B=c;var G=e;var n=g;var N=f;var U=h;for(w=0;80>w;w++){if(16>w)b[w]=a[l+w];else{var J=b[w-3]^b[w-8]^b[w-14]^b[w-16];b[w]=J<<1|J>>>31}J=c<<5|c>>>27;var ca=20>w?e&g|~e&f:40>w?e^g^f:60>w?e&g|e&f|g&f:e^g^f;J=d(d(J,ca),d(d(h,b[w]),20>w?1518500249:40>w?1859775393:60>w?-1894007588:-899497514));h=f;f=g;g=e<<30|e>>>2;e=c;c=J}c=d(c,B);e=d(e,G);g=d(g,n);f=d(f,N);h=d(h,U)}return[c,e,g,f,h]}function c(b,c){var d=e(b);16<d.length&&(d=a(d,8*
b.length));var g=Array(16);b=Array(16);for(var f=0;16>f;f++)g[f]=d[f]^909522486,b[f]=d[f]^1549556828;c=a(g.concat(e(c)),512+8*c.length);return a(b.concat(c),672)}function d(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function e(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;return b}function g(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}function h(a){for(var b="",c,d,e=0;e<4*a.length;e+=
3)for(c=(a[e>>2]>>8*(3-e%4)&255)<<16|(a[e+1>>2]>>8*(3-(e+1)%4)&255)<<8|a[e+2>>2]>>8*(3-(e+2)%4)&255,d=0;4>d;d++)b=8*e+6*d>32*a.length?b+"=":b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c>>6*(3-d)&63);return b}return{b64_hmac_sha1:function(a,b){return h(c(a,b))},b64_sha1:function(b){return h(a(e(b),8*b.length))},binb2str:g,core_hmac_sha1:c,str_hmac_sha1:function(a,b){return g(c(a,b))},str_sha1:function(b){return g(a(e(b),8*b.length))}}});(function(a,c){"function"===typeof define&&
define.amd?define("strophe-md5",function(){return c()}):a.MD5=c()})(this,function(a){var b=function(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535},d=function(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<c%32;return b},e=function(a,c,d,e,g,f){a=b(b(c,a),b(e,f));return b(a<<g|a>>>32-g,d)},g=function(a,b,c,d,g,f,h){return e(b&c|~b&d,a,b,g,f,h)},h=function(a,b,c,d,g,f,h){return e(b&d|c&~d,a,b,g,f,h)},l=function(a,b,c,d,g,f,h){return e(c^(b|~d),a,b,
g,f,h)},f=function(a,c){a[c>>5]|=128<<c%32;a[(c+64>>>9<<4)+14]=c;c=1732584193;for(var d=-271733879,m=-1732584194,f=271733878,r,w,B,G,n=0;n<a.length;n+=16)r=c,w=d,B=m,G=f,c=g(c,d,m,f,a[n+0],7,-680876936),f=g(f,c,d,m,a[n+1],12,-389564586),m=g(m,f,c,d,a[n+2],17,606105819),d=g(d,m,f,c,a[n+3],22,-1044525330),c=g(c,d,m,f,a[n+4],7,-176418897),f=g(f,c,d,m,a[n+5],12,1200080426),m=g(m,f,c,d,a[n+6],17,-1473231341),d=g(d,m,f,c,a[n+7],22,-45705983),c=g(c,d,m,f,a[n+8],7,1770035416),f=g(f,c,d,m,a[n+9],12,-1958414417),
m=g(m,f,c,d,a[n+10],17,-42063),d=g(d,m,f,c,a[n+11],22,-1990404162),c=g(c,d,m,f,a[n+12],7,1804603682),f=g(f,c,d,m,a[n+13],12,-40341101),m=g(m,f,c,d,a[n+14],17,-1502002290),d=g(d,m,f,c,a[n+15],22,1236535329),c=h(c,d,m,f,a[n+1],5,-165796510),f=h(f,c,d,m,a[n+6],9,-1069501632),m=h(m,f,c,d,a[n+11],14,643717713),d=h(d,m,f,c,a[n+0],20,-373897302),c=h(c,d,m,f,a[n+5],5,-701558691),f=h(f,c,d,m,a[n+10],9,38016083),m=h(m,f,c,d,a[n+15],14,-660478335),d=h(d,m,f,c,a[n+4],20,-405537848),c=h(c,d,m,f,a[n+9],5,568446438),
f=h(f,c,d,m,a[n+14],9,-1019803690),m=h(m,f,c,d,a[n+3],14,-187363961),d=h(d,m,f,c,a[n+8],20,1163531501),c=h(c,d,m,f,a[n+13],5,-1444681467),f=h(f,c,d,m,a[n+2],9,-51403784),m=h(m,f,c,d,a[n+7],14,1735328473),d=h(d,m,f,c,a[n+12],20,-1926607734),c=e(d^m^f,c,d,a[n+5],4,-378558),f=e(c^d^m,f,c,a[n+8],11,-2022574463),m=e(f^c^d,m,f,a[n+11],16,1839030562),d=e(m^f^c,d,m,a[n+14],23,-35309556),c=e(d^m^f,c,d,a[n+1],4,-1530992060),f=e(c^d^m,f,c,a[n+4],11,1272893353),m=e(f^c^d,m,f,a[n+7],16,-155497632),d=e(m^f^c,d,
m,a[n+10],23,-1094730640),c=e(d^m^f,c,d,a[n+13],4,681279174),f=e(c^d^m,f,c,a[n+0],11,-358537222),m=e(f^c^d,m,f,a[n+3],16,-722521979),d=e(m^f^c,d,m,a[n+6],23,76029189),c=e(d^m^f,c,d,a[n+9],4,-640364487),f=e(c^d^m,f,c,a[n+12],11,-421815835),m=e(f^c^d,m,f,a[n+15],16,530742520),d=e(m^f^c,d,m,a[n+2],23,-995338651),c=l(c,d,m,f,a[n+0],6,-198630844),f=l(f,c,d,m,a[n+7],10,1126891415),m=l(m,f,c,d,a[n+14],15,-1416354905),d=l(d,m,f,c,a[n+5],21,-57434055),c=l(c,d,m,f,a[n+12],6,1700485571),f=l(f,c,d,m,a[n+3],10,
-1894986606),m=l(m,f,c,d,a[n+10],15,-1051523),d=l(d,m,f,c,a[n+1],21,-2054922799),c=l(c,d,m,f,a[n+8],6,1873313359),f=l(f,c,d,m,a[n+15],10,-30611744),m=l(m,f,c,d,a[n+6],15,-1560198380),d=l(d,m,f,c,a[n+13],21,1309151649),c=l(c,d,m,f,a[n+4],6,-145523070),f=l(f,c,d,m,a[n+11],10,-1120210379),m=l(m,f,c,d,a[n+2],15,718787259),d=l(d,m,f,c,a[n+9],21,-343485551),c=b(c,r),d=b(d,w),m=b(m,B),f=b(f,G);return[c,d,m,f]};return{hexdigest:function(a){a=f(d(a),8*a.length);for(var b="",c=0;c<4*a.length;c++)b+="0123456789abcdef".charAt(a[c>>
2]>>c%4*8+4&15)+"0123456789abcdef".charAt(a[c>>2]>>c%4*8&15);return b},hash:function(a){a=f(d(a),8*a.length);for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}}});(function(a,c){"function"===typeof define&&define.amd?define("strophe-utils",function(){return c()}):a.stropheUtils=c()})(this,function(){return{utf16to8:function(a){var b,d="",e=a.length;for(b=0;b<e;b++){var g=a.charCodeAt(b);0<=g&&127>=g?d+=a.charAt(b):(2047<g?(d+=String.fromCharCode(224|g>>12&15),
d+=String.fromCharCode(128|g>>6&63)):d+=String.fromCharCode(192|g>>6&31),d+=String.fromCharCode(128|g>>0&63))}return d},addCookies:function(a){var b,d,e;for(b in a||{}){var g=e=d="";var h=a[b];var l="object"==typeof h;var f=escape(unescape(l?h.value:h));l&&(d=h.expires?";expires="+h.expires:"",e=h.domain?";domain="+h.domain:"",g=h.path?";path="+h.path:"");document.cookie=b+"="+f+d+e+g}}}});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-polyfill",[],function(){return c()});
else return c()})(this,function(){Function.prototype.bind||(Function.prototype.bind=function(a){var b=this,d=Array.prototype.slice,e=Array.prototype.concat,g=d.call(arguments,1);return function(){return b.apply(a?a:this,e.call(g,d.call(arguments,0)))}});Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var b=this.length;c=Number(c)||0;c=0>c?Math.ceil(c):Math.floor(c);for(0>c&&(c+=b);c<
b;c++)if(c in this&&this[c]===a)return c;return-1})});Array.prototype.forEach||(Array.prototype.forEach=function(a,c){var b,e;if(null===this)throw new TypeError(" this is null or not defined");var g=Object(this),h=g.length>>>0;if("function"!==typeof a)throw new TypeError(a+" is not a function");1<arguments.length&&(b=c);for(e=0;e<h;){if(e in g){var l=g[e];a.call(b,l,e,g)}e++}});(function(a,c){"function"===typeof define&&define.amd?define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5",
"strophe-utils","strophe-polyfill"],function(){return c.apply(this,arguments)}):(a=c(a.SHA1,a.Base64,a.MD5,a.stropheUtils),window.Strophe=a.Strophe,window.$build=a.$build,window.$iq=a.$iq,window.$msg=a.$msg,window.$pres=a.$pres,window.SHA1=a.SHA1,window.Base64=a.Base64,window.MD5=a.MD5,window.b64_hmac_sha1=a.SHA1.b64_hmac_sha1,window.b64_sha1=a.SHA1.b64_sha1,window.str_hmac_sha1=a.SHA1.str_hmac_sha1,window.str_sha1=a.SHA1.str_sha1)})(this,function(a,c,d,e){function b(a,b){return new f.Builder(a,b)}
function h(a){return new f.Builder("iq",a)}function l(a){return new f.Builder("presence",a)}var f={VERSION:"1.2.12",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",
FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],
p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(a){for(var b=0;b<f.XHTML.tags.length;b++)if(a==f.XHTML.tags[b])return!0;return!1},validAttribute:function(a,b){if("undefined"!==typeof f.XHTML.attributes[a]&&0<f.XHTML.attributes[a].length)for(var c=0;c<f.XHTML.attributes[a].length;c++)if(b==f.XHTML.attributes[a][c])return!0;return!1},validCSS:function(a){for(var b=
0;b<f.XHTML.css.length;b++)if(a==f.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(a,b){f.NS[a]=b},forEachChild:function(a,b,c){var d;for(d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];e.nodeType!=f.ElementType.NORMAL||
b&&!this.isTagEqual(e,b)||c(e)}},isTagEqual:function(a,b){return a.tagName==b},_xmlGenerator:null,_makeGenerator:function(){if(void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode){var a=this._getIEXmlDom();a.appendChild(a.createElement("strophe"))}else a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){f._xmlGenerator||(f._xmlGenerator=f._makeGenerator());return f._xmlGenerator},
_getIEXmlDom:function(){for(var a=null,b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),c=0;c<b.length;c++)if(null===a)try{a=new ActiveXObject(b[c])}catch(x){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=f.xmlGenerator().createElement(a),c,d,e;for(c=1;c<arguments.length;c++){var m=arguments[c];if(m)if("string"==typeof m||"number"==typeof m)b.appendChild(f.xmlTextNode(m));
else if("object"==typeof m&&"function"==typeof m.sort)for(d=0;d<m.length;d++){var g=m[d];"object"==typeof g&&"function"==typeof g.sort&&void 0!==g[1]&&null!==g[1]&&b.setAttribute(g[0],g[1])}else if("object"==typeof m)for(e in m)m.hasOwnProperty(e)&&void 0!==m[e]&&null!==m[e]&&b.setAttribute(e,m[e])}return b},xmlescape:function(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlunescape:function(a){a=a.replace(/&amp;/g,
"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&apos;/g,"'");return a=a.replace(/&quot;/g,'"')},xmlTextNode:function(a){return f.xmlGenerator().createTextNode(a)},xmlHtmlNode:function(a){if(window.DOMParser)var b=(new DOMParser).parseFromString(a,"text/xml");else b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a);return b},getText:function(a){if(!a)return null;var b="";0===a.childNodes.length&&a.nodeType==f.ElementType.TEXT&&(b+=a.nodeValue);for(var c=0;c<a.childNodes.length;c++)a.childNodes[c].nodeType==
f.ElementType.TEXT&&(b+=a.childNodes[c].nodeValue);return f.xmlescape(b)},copyElement:function(a){var b;if(a.nodeType==f.ElementType.NORMAL){var c=f.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)c.setAttribute(a.attributes[b].nodeName,a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)c.appendChild(f.copyElement(a.childNodes[b]))}else a.nodeType==f.ElementType.TEXT&&(c=f.xmlGenerator().createTextNode(a.nodeValue));return c},createHtml:function(a){var b,c;if(a.nodeType==f.ElementType.NORMAL){var d=
a.nodeName.toLowerCase();if(f.XHTML.validTag(d))try{var e=f.xmlElement(d);for(b=0;b<f.XHTML.attributes[d].length;b++){var g=f.XHTML.attributes[d][b];var m=a.getAttribute(g);if("undefined"!=typeof m&&null!==m&&""!==m&&!1!==m&&0!==m)if("style"==g&&"object"==typeof m&&"undefined"!=typeof m.cssText&&(m=m.cssText),"style"==g){var h=[];var l=m.split(";");for(c=0;c<l.length;c++){var n=l[c].split(":");var N=n[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(f.XHTML.validCSS(N)){var U=n[1].replace(/^\s*/,
"").replace(/\s*$/,"");h.push(N+": "+U)}}0<h.length&&(m=h.join("; "),e.setAttribute(g,m))}else e.setAttribute(g,m)}for(b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]))}catch(J){e=f.xmlTextNode("")}else for(e=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]))}else if(a.nodeType==f.ElementType.FRAGMENT)for(e=f.xmlGenerator().createDocumentFragment(),b=0;b<a.childNodes.length;b++)e.appendChild(f.createHtml(a.childNodes[b]));
else a.nodeType==f.ElementType.TEXT&&(e=f.xmlTextNode(a.nodeValue));return e},escapeNode:function(a){return"string"!==typeof a?a:a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return"string"!==typeof a?a:a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,
"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=f.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},
_handleError:function(a){"undefined"!==typeof a.stack&&f.fatal(a.stack);a.sourceURL?f.fatal("error: "+this.handler+" "+a.sourceURL+":"+a.line+" - "+a.name+": "+a.message):a.fileName?f.fatal("error: "+this.handler+" "+a.fileName+":"+a.lineNumber+" - "+a.name+": "+a.message):f.fatal("error: "+a.message)},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,
a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var b=a.nodeName,c;a.getAttribute("_realname")&&(b=a.getAttribute("_realname"));var d="<"+b;for(c=0;c<a.attributes.length;c++)"_realname"!=a.attributes[c].nodeName&&(d+=" "+a.attributes[c].nodeName+"='"+f.xmlescape(a.attributes[c].value)+"'");if(0<a.childNodes.length){d+=">";for(c=0;c<a.childNodes.length;c++){var e=a.childNodes[c];switch(e.nodeType){case f.ElementType.NORMAL:d+=
f.serialize(e);break;case f.ElementType.TEXT:d+=f.xmlescape(e.nodeValue);break;case f.ElementType.CDATA:d+="<![CDATA["+e.nodeValue+"]]\x3e"}}d+="</"+b+">"}else d+="/>";return d},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){f._connectionPlugins[a]=b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=f.NS.CLIENT:b||(b={xmlns:f.NS.CLIENT});this.node=this.nodeTree=f.xmlElement(a,b)}};f.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return f.serialize(this.nodeTree)},
up:function(){this.node=this.node.parentNode;return this},root:function(){this.node=this.nodeTree;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&(void 0===a[b]?this.node.removeAttribute(b):this.node.setAttribute(b,a[b]));return this},c:function(a,b,c){a=f.xmlElement(a,b,c);this.node.appendChild(a);"string"!==typeof c&&"number"!==typeof c&&(this.node=a);return this},cnode:function(a){var b=f.xmlGenerator();try{var c=void 0!==b.importNode}catch(x){c=!1}a=c?b.importNode(a,!0):f.copyElement(a);
this.node.appendChild(a);this.node=a;return this},t:function(a){a=f.xmlTextNode(a);this.node.appendChild(a);return this},h:function(a){var b=document.createElement("body");b.innerHTML=a;for(a=f.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}};f.Handler=function(a,b,c,d,e,g,h){this.handler=a;this.ns=b;this.name=c;this.type=d;this.id=e;this.options=h||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(f.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),
this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.from=this.options.matchBareFromJid?g?f.getBareJidFromJid(g):null:g;this.user=!0};f.Handler.prototype={getNamespace:function(a){(a=a.getAttribute("xmlns"))&&this.options.ignoreNamespaceFragment&&(a=a.split("#")[0]);return a},namespaceMatch:function(a){var b=!1;if(this.ns){var c=this;f.forEachChild(a,null,function(a){c.getNamespace(a)===c.ns&&(b=!0)});b=b||this.getNamespace(a)===this.ns}else return!0;return b},
isMatch:function(a){var b=a.getAttribute("from");this.options.matchBareFromJid&&(b=f.getBareJidFromJid(b));var c=a.getAttribute("type");return!this.namespaceMatch(a)||this.name&&!f.isTagEqual(a,this.name)||this.type&&(Array.isArray(this.type)?-1==this.type.indexOf(c):c!=this.type)||this.id&&a.getAttribute("id")!=this.id||this.from&&b!=this.from?!1:!0},run:function(a){var b=null;try{b=this.handler(a)}catch(q){throw f._handleError(q),q;}return b},toString:function(){return"{Handler: "+this.handler+
"("+this.name+","+this.id+","+this.ns+")}"}};f.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0};f.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};f.Connection=function(a,b){this.service=a;this.options=b||{};b=this.options.protocol||"";0===a.indexOf("ws:")||
0===a.indexOf("wss:")||0===b.indexOf("ws")?this._proto=new f.Websocket(this):this._proto=new f.Bosh(this);this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._disconnectTimeout=this._idleTimeout=null;this.disconnecting=this.connected=this.authenticated=!1;this.do_authentication=!0;this.restored=
this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100);e.addCookies(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);for(var c in f._connectionPlugins)f._connectionPlugins.hasOwnProperty(c)&&(a=function(){},a.prototype=f._connectionPlugins[c],this[c]=new a,this[c].init(this))};f.Connection.prototype={reset:function(){this._proto._reset();
this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.restored=this.disconnecting=this.connected=this.authenticated=!1;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)});return"string"==
typeof a||"number"==typeof a?b+":"+a:b+""},addProtocolErrorHandler:function(a,b,c){this.protocolErrorHandlers[a][b]=c},connect:function(a,b,c,d,e,g,h){this.jid=a;this.authzid=f.getBareJidFromJid(this.jid);this.authcid=h||f.getNodeFromJid(this.jid);this.pass=b;this.servtype="xmpp";this.connect_callback=c;this.restored=this.authenticated=this.connected=this.disconnecting=!1;this.domain=f.getDomainFromJid(this.jid);this._changeConnectStatus(f.Status.CONNECTING,null);this._proto._connect(d,e,g)},attach:function(a,
b,c,d,e,g,h){if(this._proto instanceof f.Bosh)this._proto._attach(a,b,c,d,e,g,h);else throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};},restore:function(a,b,c,d,e){if(this._sessionCachingSupported())this._proto._restore(a,b,c,d,e);else throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};},_sessionCachingSupported:function(){if(this._proto instanceof f.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_",
"_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(m){return!1}return!0}return!1},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},nextValidRid:function(a){},send:function(a){if(null!==a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendPresence:function(a,
b,c,d){var e=null,g=this;"function"===typeof a.tree&&(a=a.tree());var f=a.getAttribute("id");f||(f=this.getUniqueId("sendPresence"),a.setAttribute("id",f));if("function"===typeof b||"function"===typeof c){var m=this.addHandler(function(a){e&&g.deleteTimedHandler(e);"error"==a.getAttribute("type")?c&&c(a):b&&b(a)},null,"presence",null,f);d&&(e=this.addTimedHandler(d,function(){g.deleteHandler(m);c&&c(null);return!1}))}this.send(a);return f},sendIQ:function(a,b,c,d){var e=null,g=this;"function"===typeof a.tree&&
(a=a.tree());var f=a.getAttribute("id");f||(f=this.getUniqueId("sendIQ"),a.setAttribute("id",f));if("function"===typeof b||"function"===typeof c){var m=this.addHandler(function(a){e&&g.deleteTimedHandler(e);var d=a.getAttribute("type");if("result"==d)b&&b(a);else if("error"==d)c&&c(a);else throw{name:"StropheError",message:"Got bad IQ type of "+d};},null,"iq",["error","result"],f);d&&(e=this.addTimedHandler(d,function(){g.deleteHandler(m);c&&c(null);return!1}))}this.send(a);return f},_queueData:function(a){if(null===
a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(a,b){a=new f.TimedHandler(a,b);this.addTimeds.push(a);return a},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,b,c,d,e,g,h){a=new f.Handler(a,b,c,d,e,g,h);this.addHandlers.push(a);
return a},deleteHandler:function(a){this.removeHandlers.push(a);a=this.addHandlers.indexOf(a);0<=a&&this.addHandlers.splice(a,1)},registerSASLMechanisms:function(a){this.mechanisms={};a=a||[f.SASLAnonymous,f.SASLExternal,f.SASLMD5,f.SASLOAuthBearer,f.SASLPlain,f.SASLSHA1];a.forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(a){this.mechanisms[a.prototype.name]=a},disconnect:function(a){this._changeConnectStatus(f.Status.DISCONNECTING,a);f.info("Disconnect was called because: "+
a);this.connected?(a=!1,this.disconnecting=!0,this.authenticated&&(a=l({xmlns:f.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a)):(f.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect())},_changeConnectStatus:function(a,b){this._status=a;for(var c in f._connectionPlugins)if(f._connectionPlugins.hasOwnProperty(c)){var d=this[c];if(d.statusChanged)try{d.statusChanged(a,
b)}catch(v){f.error(""+c+" plugin caused an exception changing status: "+v)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(v){f._handleError(v),f.error("User connection callback caused an exception: "+v)}},_doDisconnect:function(a){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout);null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);f.info("_doDisconnect was called");this._proto._doDisconnect();this.restored=
this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(f.Status.DISCONNECTED,a);this.connected=!1},_dataRecv:function(a,b){f.info("_dataRecv called");a=this._proto._reqToData(a);if(null!==a){this.xmlInput!==f.Connection.prototype.xmlInput&&(a.nodeName===this._proto.strip&&a.childNodes.length?this.xmlInput(a.childNodes[0]):this.xmlInput(a));for(this.rawInput!==f.Connection.prototype.rawInput&&
(b?this.rawInput(b):this.rawInput(f.serialize(a)));0<this.removeHandlers.length;)b=this.removeHandlers.pop(),b=this.handlers.indexOf(b),0<=b&&this.handlers.splice(b,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else if(b=a.getAttribute("type"),null!==b&&"terminate"==b)this.disconnecting||(b=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),null!==b?("remote-stream-error"==b&&0<a.length&&
(b="conflict"),this._changeConnectStatus(f.Status.CONNFAIL,b)):this._changeConnectStatus(f.Status.CONNFAIL,"unknown"),this._doDisconnect(b));else{var c=this;f.forEachChild(a,null,function(a){var b;var d=c.handlers;c.handlers=[];for(b=0;b<d.length;b++){var e=d[b];try{!e.isMatch(a)||!c.authenticated&&e.user?c.handlers.push(e):e.run(a)&&c.handlers.push(e)}catch(B){f.warn("Removing Strophe handlers due to uncaught exception: "+B.message)}}})}}},mechanisms:{},_connect_cb:function(a,b,c){f.info("_connect_cb was called");
this.connected=!0;try{var d=this._proto._reqToData(a)}catch(w){if("badformat"!=w)throw w;this._changeConnectStatus(f.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(d&&(this.xmlInput!==f.Connection.prototype.xmlInput&&(d.nodeName===this._proto.strip&&d.childNodes.length?this.xmlInput(d.childNodes[0]):this.xmlInput(d)),this.rawInput!==f.Connection.prototype.rawInput&&(c?this.rawInput(c):this.rawInput(f.serialize(d))),this._proto._connect_cb(d)!==f.Status.CONNFAIL))if(d.getElementsByTagNameNS?
0<d.getElementsByTagNameNS(f.NS.STREAM,"features").length:0<d.getElementsByTagName("stream:features").length||0<d.getElementsByTagName("features").length){a=[];var e=d.getElementsByTagName("mechanism");if(0<e.length)for(c=0;c<e.length;c++){var g=f.getText(e[c]);this.mechanisms[g]&&a.push(this.mechanisms[g])}0===a.length&&0===d.getElementsByTagName("auth").length?this._proto._no_auth_received(b):!1!==this.do_authentication&&this.authenticate(a)}else this._proto._no_auth_received(b)},sortMechanismsByPriority:function(a){var b,
c;for(b=0;b<a.length-1;++b){var d=b;for(c=b+1;c<a.length;++c)a[c].prototype.priority>a[d].prototype.priority&&(d=c);d!=b&&(c=a[b],a[b]=a[d],a[d]=c)}return a},_attemptSASLAuth:function(a){a=this.sortMechanismsByPriority(a||[]);var d,e=!1;for(d=0;d<a.length;++d)if(a[d].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);
this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new a[d];this._sasl_mechanism.onStart(this);a=b("auth",{xmlns:f.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(d=this._sasl_mechanism.onChallenge(this,null),a.t(c.encode(d)));this.send(a.tree());e=!0;break}return e},_attemptLegacyAuth:function(){null===f.getNodeFromJid(this.jid)?(this._changeConnectStatus(f.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),
this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(h({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).tree()))},authenticate:function(a){this._attemptSASLAuth(a)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(a){a=c.decode(f.getText(a));a=this._sasl_mechanism.onChallenge(this,a);var d=b("response",
{xmlns:f.NS.SASL});""!==a&&d.t(c.encode(a));this.send(d.tree());return!0},_auth1_cb:function(a){a=h({type:"set",id:"_auth_2"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).up().c("password").t(this.pass);f.getResourceFromJid(this.jid)||(this.jid=f.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(f.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){if(this._sasl_data["server-signature"]){var b;
a=c.decode(f.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"==a[1]&&(b=a[2]);if(b!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}f.info("SASL authentication succeeded.");if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);
this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var d=[],e=function(a,b){for(;a.length;)this.deleteHandler(a.pop());this._sasl_auth1_cb.bind(this)(b);return!1};d.push(this._addSysHandler(function(a){e.bind(this)(d,a)}.bind(this),null,"stream:features",null,null));d.push(this._addSysHandler(function(a){e.bind(this)(d,a)}.bind(this),f.NS.STREAM,"features",null,null));this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=
a;var b;for(b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"bind"==c.nodeName&&(this.do_bind=!0);"session"==c.nodeName&&(this.do_session=!0)}this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=f.getResourceFromJid(this.jid))?this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).c("resource",{}).t(a).tree()):this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).tree())):this._changeConnectStatus(f.Status.AUTHFAIL,
null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type")){f.info("SASL binding failed.");var b;0<a.getElementsByTagName("conflict").length&&(b="conflict");this._changeConnectStatus(f.Status.AUTHFAIL,b);return!1}a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=f.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(h({type:"set",id:"_session_auth_2"}).c("session",
{xmlns:f.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)));else return f.info("SASL binding failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(f.info("Session creation failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&
(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(f.Status.AUTHFAIL,
null),this.disconnect("authentication failed"));return!1},_addSysTimedHandler:function(a,b){a=new f.TimedHandler(a,b);a.user=!1;this.addTimeds.push(a);return a},_addSysHandler:function(a,b,c,d,e){a=new f.Handler(a,b,c,d,e);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){f.info("_onDisconnectTimeout was called");this._changeConnectStatus(f.Status.CONNTIMEOUT,null);this._proto._onDisconnectTimeout();this._doDisconnect();return!1},_onIdle:function(){for(var a,b,c,d;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());
for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var e=(new Date).getTime();d=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)c=b.lastCalled+b.period,0>=c-e?b.run()&&d.push(b):d.push(b);this.timedHandlers=d;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100))}};f.SASLMechanism=function(a,
b,c){this.name=a;this.isClientFirst=b;this.priority=c};f.SASLMechanism.prototype={test:function(a){return!0},onStart:function(a){this._connection=a},onChallenge:function(a,b){throw Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};f.SASLAnonymous=function(){};f.SASLAnonymous.prototype=new f.SASLMechanism("ANONYMOUS",!1,20);f.SASLAnonymous.prototype.test=function(a){return null===a.authcid};f.SASLPlain=function(){};
f.SASLPlain.prototype=new f.SASLMechanism("PLAIN",!0,30);f.SASLPlain.prototype.test=function(a){return null!==a.authcid};f.SASLPlain.prototype.onChallenge=function(a){var b=a.authzid;b=b+"\x00"+a.authcid;b=b+"\x00"+a.pass;return e.utf16to8(b)};f.SASLSHA1=function(){};f.SASLSHA1.prototype=new f.SASLMechanism("SCRAM-SHA-1",!0,50);f.SASLSHA1.prototype.test=function(a){return null!==a.authcid};f.SASLSHA1.prototype.onChallenge=function(b,g,f){g=f||d.hexdigest(1234567890*Math.random());f="n="+e.utf16to8(b.authcid);
f=f+",r="+g;b._sasl_data.cnonce=g;b._sasl_data["client-first-message-bare"]=f;f="n,,"+f;this.onChallenge=function(b,d){var g,f="c=biws,",h=b._sasl_data["client-first-message-bare"]+","+d+",";var m=b._sasl_data.cnonce;for(g=/([a-z]+)=([^,]+)(,|$)/;d.match(g);){var l=d.match(g);d=d.replace(l[0],"");switch(l[1]){case "r":var r=l[2];break;case "s":var x=l[2];break;case "i":var v=l[2]}}if(r.substr(0,m.length)!==m)return b._sasl_data={},b._sasl_failure_cb();f+="r="+r;h+=f;x=c.decode(x);x+="\x00\x00\x00\u0001";
r=e.utf16to8(b.pass);x=d=a.core_hmac_sha1(r,x);for(m=1;m<v;m++){g=a.core_hmac_sha1(r,a.binb2str(d));for(d=0;5>d;d++)x[d]^=g[d];d=g}x=a.binb2str(x);v=a.core_hmac_sha1(x,"Client Key");d=a.str_hmac_sha1(x,"Server Key");x=a.core_hmac_sha1(a.str_sha1(a.binb2str(v)),h);b._sasl_data["server-signature"]=a.b64_hmac_sha1(d,h);for(d=0;5>d;d++)v[d]^=x[d];return f+=",p="+c.encode(a.binb2str(v))}.bind(this);return f};f.SASLMD5=function(){};f.SASLMD5.prototype=new f.SASLMechanism("DIGEST-MD5",!1,40);f.SASLMD5.prototype.test=
function(a){return null!==a.authcid};f.SASLMD5.prototype._quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};f.SASLMD5.prototype.onChallenge=function(a,b,c){var g=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;c=c||d.hexdigest(""+1234567890*Math.random());for(var f="",h=null,l="",m;b.match(g);)switch(m=b.match(g),b=b.replace(m[0],""),m[2]=m[2].replace(/^"(.+)"$/,"$1"),m[1]){case "realm":f=m[2];break;case "nonce":l=m[2];break;case "host":h=m[2]}b=a.servtype+"/"+a.domain;null!==h&&(b=
b+"/"+h);g=e.utf16to8(a.authcid+":"+f+":"+this._connection.pass);g=d.hash(g)+":"+l+":"+c;h="AUTHENTICATE:"+b;a="charset=utf-8,"+("username="+this._quote(e.utf16to8(a.authcid))+",");a+="realm="+this._quote(f)+",";a+="nonce="+this._quote(l)+",";a=a+"nc=00000001,"+("cnonce="+this._quote(c)+",");a+="digest-uri="+this._quote(b)+",";a+="response="+d.hexdigest(d.hexdigest(g)+":"+l+":00000001:"+c+":auth:"+d.hexdigest(h))+",";this.onChallenge=function(){return""};return a+"qop=auth"};f.SASLOAuthBearer=function(){};
f.SASLOAuthBearer.prototype=new f.SASLMechanism("OAUTHBEARER",!0,60);f.SASLOAuthBearer.prototype.test=function(a){return null!==a.authcid};f.SASLOAuthBearer.prototype.onChallenge=function(a){var b="n,a="+a.authzid;b=b+",\u0001auth=Bearer "+a.pass;return e.utf16to8(b+"\u0001\u0001")};f.SASLExternal=function(){};f.SASLExternal.prototype=new f.SASLMechanism("EXTERNAL",!0,10);f.SASLExternal.prototype.onChallenge=function(a){return a.authcid===a.authzid?"":a.authzid};return{Strophe:f,$build:b,$msg:function(a){return new f.Builder("message",
a)},$iq:h,$pres:l,SHA1:a,Base64:c,MD5:d}});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-bosh",["strophe-core"],function(a){return c(a.Strophe,a.$build)});else return c(Strophe,$build)})(this,function(a,c){a.Request=function(b,c,g,h){this.id=++a._requestId;this.xmlData=b;this.data=a.serialize(b);this.func=this.origFunc=c;this.rid=g;this.date=NaN;this.sends=h||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?
(new Date-this.dead)/1E3:0};this.xhr=this._newXHR()};a.Request.prototype={getResponse:function(){var b=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(b=this.xhr.responseXML.documentElement,"parsererror"==b.tagName)throw a.error("invalid response received"),a.error("responseText: "+this.xhr.responseText),a.error("responseXML: "+a.serialize(this.xhr.responseXML)),"parsererror";}else if(this.xhr.responseText)throw a.error("invalid response received"),a.error("responseText: "+
this.xhr.responseText),"badformat";return b},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};a.Bosh=function(a){this._conn=a;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this.inactivity=null;this._requests=[]};a.Bosh.prototype=
{strip:null,_buildBody:function(){var b=c("body",{rid:this.rid++,xmlns:a.NS.HTTPBIND});null!==this.sid&&b.attrs({sid:this.sid});this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession();return b},_reset:function(){this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_connect:function(b,c,g){this.wait=b||this.wait;this.hold=
c||this.hold;this.errors=0;b=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":a.NS.BOSH});g&&b.attrs({route:g});g=this._conn._connect_cb;this._requests.push(new a.Request(b.tree(),this._onRequestStateChange.bind(this,g.bind(this._conn)),b.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(b,c,g,h,l,f,m){this._conn.jid=b;this.sid=c;this.rid=g;this._conn.connect_callback=
h;this._conn.domain=a.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=l||this.wait;this.hold=f||this.hold;this.window=m||this.window;this._conn._changeConnectStatus(a.Status.ATTACHED,null)},_restore:function(b,c,g,h,l){var d=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if("undefined"!==typeof d&&null!==d&&d.rid&&d.sid&&d.jid&&("undefined"===typeof b||null===b||a.getBareJidFromJid(d.jid)==a.getBareJidFromJid(b)||null===a.getNodeFromJid(b)&&
a.getDomainFromJid(d.jid)==b))this._conn.restored=!0,this._attach(d.jid,d.sid,d.rid,c,g,h,l);else throw{name:"StropheSessionError",message:"_restore: no restoreable session."};},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(b){var c=b.getAttribute("type");if(null!==
c&&"terminate"==c)return c=b.getAttribute("condition"),a.error("BOSH-Connection failed: "+c),b=b.getElementsByTagName("conflict"),null!==c?("remote-stream-error"==c&&0<b.length&&(c="conflict"),this._conn._changeConnectStatus(a.Status.CONNFAIL,c)):this._conn._changeConnectStatus(a.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(c),a.Status.CONNFAIL;this.sid||(this.sid=b.getAttribute("sid"));if(c=b.getAttribute("requests"))this.window=parseInt(c,10);if(c=b.getAttribute("hold"))this.hold=parseInt(c,
10);if(c=b.getAttribute("wait"))this.wait=parseInt(c,10);if(b=b.getAttribute("inactivity"))this.inactivity=parseInt(b,10)},_disconnect:function(a){this._sendTerminate(a)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(4294967295*Math.random());this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(a){a=this._getRequestStatus(a);
var b;(b=this._conn.protocolErrorHandlers.HTTP[a])&&b.call(this,a)},_hitError:function(b){this.errors++;a.warn("request errored, status: "+b+", number of errors: "+this.errors);4<this.errors&&this._conn._onDisconnectTimeout()},_no_auth_received:function(b){b=b?b.bind(this._conn):this._conn._connect_cb.bind(this._conn);var c=this._buildBody();this._requests.push(new a.Request(c.tree(),this._onRequestStateChange.bind(this,b.bind(this._conn)),c.tree().getAttribute("rid")));this._throttledRequestHandler()},
_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){}},_onIdle:function(){var b=this._conn._data;this._conn.authenticated&&0===this._requests.length&&0===b.length&&!this._conn.disconnecting&&(a.info("no requests during idle cycle, sending blank request"),b.push(null));if(!this._conn.paused){if(2>this._requests.length&&0<b.length){for(var c=this._buildBody(),
g=0;g<b.length;g++)null!==b[g]&&("restart"===b[g]?c.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":a.NS.BOSH}):c.cnode(b[g]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new a.Request(c.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),c.tree().getAttribute("rid")));this._throttledRequestHandler()}0<this._requests.length&&(b=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>
Math.floor(a.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),b>Math.floor(a.TIMEOUT*this.wait)&&(a.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(a.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},_getRequestStatus:function(b,c){if(4==b.xhr.readyState)try{var d=b.xhr.status}catch(h){a.error("Caught an error while retrieving a request's status, reqStatus: "+d)}"undefined"==typeof d&&(d="number"===typeof c?c:0);return d},_onRequestStateChange:function(b,
c){a.debug("request id "+c.id+"."+c.sends+" state changed to "+c.xhr.readyState);if(c.abort)c.abort=!1;else if(4===c.xhr.readyState){var d=this._getRequestStatus(c);if(this.disconnecting&&400<=d)this._hitError(d),this._callProtocolErrorHandlers(c);else{if(0<d&&500>d||5<c.sends)this._removeRequest(c),a.debug("request id "+c.id+" should now be removed");if(200==d){var e=this._requests[0]==c;(this._requests[1]==c||e&&0<this._requests.length&&this._requests[0].age()>Math.floor(a.SECONDARY_TIMEOUT*this.wait))&&
this._restartRequest(0);this._conn.nextValidRid(Number(c.rid)+1);a.debug("request id "+c.id+"."+c.sends+" got 200");b(c);this.errors=0}else 0===d||400<=d&&600>d||12E3<=d?(a.error("request id "+c.id+"."+c.sends+" error "+d+" happened"),this._hitError(d),this._callProtocolErrorHandlers(c),400<=d&&500>d&&(this._conn._changeConnectStatus(a.Status.DISCONNECTING,null),this._conn._doDisconnect())):a.error("request id "+c.id+"."+c.sends+" error "+d+" happened");0<d&&500>d&&!(5<c.sends)||this._throttledRequestHandler()}}},
_processRequest:function(b){var c=this,d=this._requests[b],h=this._getRequestStatus(d,-1);if(d.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var l=d.age();l=!isNaN(l)&&l>Math.floor(a.TIMEOUT*this.wait);var f=null!==d.dead&&d.timeDead()>Math.floor(a.SECONDARY_TIMEOUT*this.wait);h=4==d.xhr.readyState&&(1>h||500<=h);if(l||f||h)f&&a.error("Request "+this._requests[b].id+" timed out (secondary), restarting"),d.abort=!0,d.xhr.abort(),d.xhr.onreadystatechange=function(){},this._requests[b]=
new a.Request(d.xmlData,d.origFunc,d.rid,d.sends),d=this._requests[b];if(0===d.xhr.readyState){a.debug("request id "+d.id+"."+d.sends+" posting");try{var m=this._conn.options.contentType||"text/xml; charset=utf-8";d.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0);"undefined"!==typeof d.xhr.setRequestHeader&&d.xhr.setRequestHeader("Content-Type",m);this._conn.options.withCredentials&&(d.xhr.withCredentials=!0)}catch(q){a.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(a.Status.CONNFAIL,
"bad-service");this._conn.disconnect();return}var r=function(){d.date=new Date;if(c._conn.options.customHeaders){var a=c._conn.options.customHeaders,b;for(b in a)a.hasOwnProperty(b)&&d.xhr.setRequestHeader(b,a[b])}d.xhr.send(d.data)};1<d.sends?setTimeout(function(){r()},1E3*Math.min(Math.floor(a.TIMEOUT*this.wait),Math.pow(d.sends,3))):r();d.sends++;this._conn.xmlOutput!==a.Connection.prototype.xmlOutput&&(d.xmlData.nodeName===this.strip&&d.xmlData.childNodes.length?this._conn.xmlOutput(d.xmlData.childNodes[0]):
this._conn.xmlOutput(d.xmlData));this._conn.rawOutput!==a.Connection.prototype.rawOutput&&this._conn.rawOutput(d.data)}else a.debug("_processRequest: "+(0===b?"first":"second")+" request has readyState of "+d.xhr.readyState)}},_removeRequest:function(b){a.debug("removing request");var c;for(c=this._requests.length-1;0<=c;c--)b==this._requests[c]&&this._requests.splice(c,1);b.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];null===
b.dead&&(b.dead=new Date);this._processRequest(a)},_reqToData:function(a){try{return a.getResponse()}catch(e){if("parsererror"!=e)throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(b){a.info("_sendTerminate was called");var c=this._buildBody().attrs({type:"terminate"});b&&c.cnode(b.tree());b=new a.Request(c.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),c.tree().getAttribute("rid"));this._requests.push(b);this._throttledRequestHandler()},
_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?a.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):a.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&
(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};return a});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-websocket",["strophe-core"],function(a){return c(a.Strophe,a.$build)});else return c(Strophe,$build)})(this,function(a,c){a.Websocket=function(a){this._conn=a;this.strip="wrapper";var b=a.service;if(0!==b.indexOf("ws:")&&0!==b.indexOf("wss:")){var c=
"";c="ws"===a.options.protocol&&"https:"!==window.location.protocol?c+"ws":c+"wss";c+="://"+window.location.host;c=0!==b.indexOf("/")?c+(window.location.pathname+b):c+b;a.service=c}};a.Websocket.prototype={_buildStream:function(){return c("open",{xmlns:a.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(b,c){b=b.getElementsByTagNameNS?b.getElementsByTagNameNS(a.NS.STREAM,"error"):b.getElementsByTagName("stream:error");if(0===b.length)return!1;for(var d=b[0],e=b="",l=0;l<
d.childNodes.length;l++){var f=d.childNodes[l];if("urn:ietf:params:xml:ns:xmpp-streams"!==f.getAttribute("xmlns"))break;"text"===f.nodeName?e=f.textContent||f.text:b=f.nodeName}d="WebSocket stream error: ";d=b?d+b:d+"unknown";e&&(d+=" - "+e);a.error(d);this._conn._changeConnectStatus(c,b);this._conn._doDisconnect();return!0},_reset:function(){},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=
this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(b){if(this._check_streamerror(b,a.Status.CONNFAIL))return a.Status.CONNFAIL},_handleStreamStart:function(b){var c=!1,d=b.getAttribute("xmlns");"string"!==typeof d?c="Missing xmlns in <open />":d!==a.NS.FRAMING&&(c="Wrong xmlns in <open />: "+d);b=b.getAttribute("version");"string"!==typeof b?c="Missing version in <open />":"1.0"!==b&&(c="Wrong version in <open />: "+
b);return c?(this._conn._changeConnectStatus(a.Status.CONNFAIL,c),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(b){if(0===b.data.indexOf("<open ")||0===b.data.indexOf("<?xml")){var c=b.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==c&&(c=(new DOMParser).parseFromString(c,"text/xml").documentElement,this._conn.xmlInput(c),this._conn.rawInput(b.data),this._handleStreamStart(c)&&this._connect_cb(c))}else 0===b.data.indexOf("<close ")?(this._conn.rawInput(b.data),this._conn.xmlInput(b),(b=
b.getAttribute("see-other-uri"))?(this._conn._changeConnectStatus(a.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=b,this._connect()):(this._conn._changeConnectStatus(a.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(c=this._streamWrap(b.data),c=(new DOMParser).parseFromString(c,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(c,null,b.data))},_disconnect:function(b){if(this.socket&&
this.socket.readyState!==WebSocket.CLOSED){b&&this._conn.send(b);b=c("close",{xmlns:a.NS.FRAMING});this._conn.xmlOutput(b);b=a.serialize(b);this._conn.rawOutput(b);try{this.socket.send(b)}catch(e){a.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){a.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(a){return"<wrapper>"+a+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(d){}this.socket=null},
_emptyQueue:function(){return!0},_onClose:function(){this._conn._status!==a.Status.CONNECTING&&!this._conn.connected||this._conn.disconnecting?a.info("Websocket closed"):(a.error("Websocket closed unexpectedly"),this._conn._doDisconnect())},_no_auth_received:function(b){a.error("Server did not send any auth methods");this._conn._changeConnectStatus(a.Status.CONNFAIL,"Server did not send any auth methods");b&&(b=b.bind(this._conn),b());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},
_abortAllRequests:function(){},_onError:function(b){a.error("Websocket error "+b);this._conn._changeConnectStatus(a.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var b=this._conn._data;if(0<b.length&&!this._conn.paused){for(var c=0;c<b.length;c++)if(null!==b[c]){var g="restart"===b[c]?this._buildStream().tree():b[c];var h=a.serialize(g);this._conn.xmlOutput(g);this._conn.rawOutput(h);this.socket.send(h)}this._conn._data=
[]}},_onMessage:function(b){if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===b.data)this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),this._conn.xmlInput(b),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===b.data.search("<open ")){var c=(new DOMParser).parseFromString(b.data,"text/xml").documentElement;if(!this._handleStreamStart(c))return}else c=this._streamWrap(b.data),c=(new DOMParser).parseFromString(c,"text/xml").documentElement;this._check_streamerror(c,
a.Status.ERROR)||(this._conn.disconnecting&&"presence"===c.firstChild.nodeName&&"unavailable"===c.firstChild.getAttribute("type")?(this._conn.xmlInput(c),this._conn.rawInput(a.serialize(c))):this._conn._dataRecv(c,b.data))}},_onOpen:function(){a.info("Websocket open");var b=this._buildStream();this._conn.xmlOutput(b.tree());b=a.serialize(b);this._conn.rawOutput(b);this.socket.send(b)},_reqToData:function(a){return a},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);
this._conn._onIdle.bind(this._conn)()}};return a});(function(a){"function"===typeof define&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(a){return a})})(this);if(a)if("function"===typeof define&&define.amd)"function"===typeof requirejs?requirejs(["strophe"],function(b){a(b.Strophe,b.$build,b.$msg,b.$iq,b.$pres)}):require(["strophe"],function(b){a(b.Strophe,b.$build,b.$msg,b.$iq,b.$pres)});else return a(Strophe,$build,$msg,$iq,$pres)})(function(a,b,c,d,
e){window.Strophe=a;window.$build=b;window.$msg=c;window.$iq=d;window.$pres=e});var Occupant,RoomConfig,XmppRoom,hasProp={}.hasOwnProperty,bind=function(a,b){return function(){return a.apply(b,arguments)}};
Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(a){this._connection=a;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig");return Strophe.addNamespace("MUC_REGISTER","jabber:iq:register")},join:function(a,b,c,d,e,g,h,l){var f=this.test_append_nick(a,b);
f=$pres({from:this._connection.jid,to:f}).c("x",{xmlns:Strophe.NS.MUC});null!=h&&(f=f.c("history",h).up());null!=g&&f.cnode(Strophe.xmlElement("password",[],g));null!=l&&f.up().cnode(l);null==this._muc_handler&&(this._muc_handler=this._connection.addHandler(function(b){return function(c){var d,e;var f=c.getAttribute("from");if(!f)return!0;f=f.split("/")[0];if(!b.rooms[f])return!0;a=b.rooms[f];f={};if("message"===c.nodeName)f=a._message_handlers;else if("presence"===c.nodeName){var g=c.getElementsByTagName("x");
if(0<g.length){var h=0;for(e=g.length;h<e;h++){var l=g[h];if((l=l.getAttribute("xmlns"))&&l.match(Strophe.NS.MUC)){f=a._presence_handlers;break}}}}for(d in f)h=f[d],h(c,a)||delete f[d];return!0}}(this)));this.rooms.hasOwnProperty(a)||(this.rooms[a]=new XmppRoom(this,a,b,g),d&&this.rooms[a].addHandler("presence",d),c&&this.rooms[a].addHandler("message",c),e&&this.rooms[a].addHandler("roster",e),this.roomNames.push(a));return this._connection.send(f)},leave:function(a,b,c,d){var e=this.roomNames.indexOf(a);
delete this.rooms[a];0<=e&&(this.roomNames.splice(e,1),0===this.roomNames.length&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null));b=this.test_append_nick(a,b);a=this._connection.getUniqueId();b=$pres({type:"unavailable",id:a,from:this._connection.jid,to:b});null!=d&&b.c("status",d);null!=c&&this._connection.addHandler(c,null,"presence",null,a);this._connection.send(b);return a},message:function(a,b,c,d,e,g){a=this.test_append_nick(a,b);e=e||(null!=b?"chat":"groupchat");
g=g||this._connection.getUniqueId();b=$msg({to:a,from:this._connection.jid,type:e,id:g}).c("body").t(c);b.up();null!=d&&(b.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(d),0===b.node.childNodes.length?(d=b.node.parentNode,b.up().up(),b.node.removeChild(d)):b.up().up());b.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(b);return g},groupchat:function(a,b,c,d){return this.message(a,null,b,c,void 0,d)},invite:function(a,b,c){var d=this._connection.getUniqueId();
a=$msg({from:this._connection.jid,to:a,id:d}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:b});null!=c&&a.c("reason",c);this._connection.send(a);return d},multipleInvites:function(a,b,c){var d;var e=this._connection.getUniqueId();var g=$msg({from:this._connection.jid,to:a,id:e}).c("x",{xmlns:Strophe.NS.MUC_USER});a=0;for(d=b.length;a<d;a++){var h=b[a];g.c("invite",{to:h});null!=c&&(g.c("reason",c),g.up());g.up()}this._connection.send(g);return e},directInvite:function(a,b,c,d){var e=this._connection.getUniqueId();
a={xmlns:"jabber:x:conference",jid:a};null!=c&&(a.reason=c);null!=d&&(a.password=d);b=$msg({from:this._connection.jid,to:b,id:e}).c("x",a);this._connection.send(b);return e},queryOccupants:function(a,b,c){var d={xmlns:Strophe.NS.DISCO_ITEMS};a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",d);return this._connection.sendIQ(a,b,c)},configure:function(a,b,c){a=$iq({to:a,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).tree();return this._connection.sendIQ(a,b,c)},cancelConfigure:function(a){a=
$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}).tree();return this._connection.sendIQ(a)},saveConfiguration:function(a,b,c,d){var e;var g=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});if("undefined"!==typeof Strophe.x&&"undefined"!==typeof Strophe.x.Form&&b instanceof Strophe.x.Form)b.type="submit",g.cnode(b.toXML());else{g.c("x",{xmlns:"jabber:x:data",type:"submit"});var h=0;for(e=b.length;h<e;h++)a=b[h],g.cnode(a).up()}b=
g.tree();return this._connection.sendIQ(b,c,d)},createInstantRoom:function(a,b,c){a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(a.tree(),b,c)},createConfiguredRoom:function(a,b,c,d){var e;a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});a.c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up();for(e in b)if(hasProp.call(b,
e)){var g=b[e];a.c("field",{"var":e}).c("value").t(g).up().up()}return this._connection.sendIQ(a.tree(),c,d)},setTopic:function(a,b){a=$msg({to:a,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(b);return this._connection.send(a.tree())},_modifyPrivilege:function(a,b,c,d,e){a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(b.node);null!=c&&a.c("reason",c);return this._connection.sendIQ(a.tree(),d,e)},modifyRole:function(a,b,c,d,e,g){b=$build("item",
{nick:b,role:c});return this._modifyPrivilege(a,b,d,e,g)},kick:function(a,b,c,d,e){return this.modifyRole(a,b,"none",c,d,e)},voice:function(a,b,c,d,e){return this.modifyRole(a,b,"participant",c,d,e)},mute:function(a,b,c,d,e){return this.modifyRole(a,b,"visitor",c,d,e)},op:function(a,b,c,d,e){return this.modifyRole(a,b,"moderator",c,d,e)},deop:function(a,b,c,d,e){return this.modifyRole(a,b,"participant",c,d,e)},modifyAffiliation:function(a,b,c,d,e,g){b=$build("item",{jid:b,affiliation:c});return this._modifyPrivilege(a,
b,d,e,g)},ban:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"outcast",c,d,e)},member:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"member",c,d,e)},revoke:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"none",c,d,e)},owner:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"owner",c,d,e)},admin:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"admin",c,d,e)},changeNick:function(a,b){a=this.test_append_nick(a,b);a=$pres({from:this._connection.jid,to:a,id:this._connection.getUniqueId()});
return this._connection.send(a.tree())},setStatus:function(a,b,c,d){a=this.test_append_nick(a,b);a=$pres({from:this._connection.jid,to:a});null!=c&&a.c("show",c).up();null!=d&&a.c("status",d);return this._connection.send(a.tree())},registrationRequest:function(a,b,c){a=$iq({to:a,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER});return this._connection.sendIQ(a,function(a){var c;var d=a.getElementsByTagName("field");var h={required:[],optional:[]};var l=0;for(c=d.length;l<
c;l++){a=d[l];var f={"var":a.getAttribute("var"),label:a.getAttribute("label"),type:a.getAttribute("type")};0<a.getElementsByTagName("required").length?h.required.push(f):h.optional.push(f)}return b(h)},c)},submitRegistrationForm:function(a,b,c,d){var e;a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER});a.c("x",{xmlns:"jabber:x:data",type:"submit"});a.c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#register").up().up();for(e in b){var g=b[e];a.c("field",
{"var":e}).c("value").t(g).up().up()}return this._connection.sendIQ(a,c,d)},listRooms:function(a,b,c){a=$iq({to:a,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(a,b,c)},test_append_nick:function(a,b){var c=Strophe.escapeNode(Strophe.getNodeFromJid(a));a=Strophe.getDomainFromJid(a);return c+"@"+a+(null!=b?"/"+b:"")}});
XmppRoom=function(){function a(a,c,d,e){this.client=a;this.name=c;this.nick=d;this.password=e;this._roomRosterHandler=bind(this._roomRosterHandler,this);this._addOccupant=bind(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;this.client.muc&&(this.client=this.client.muc);this.name=Strophe.getBareJidFromJid(this.name);this.addHandler("presence",this._roomRosterHandler)}a.prototype.join=function(a,c,d){return this.client.join(this.name,
this.nick,a,c,d,this.password)};a.prototype.leave=function(a,c){this.client.leave(this.name,this.nick,a,c);return delete this.client.rooms[this.name]};a.prototype.message=function(a,c,d,e){return this.client.message(this.name,a,c,d,e)};a.prototype.groupchat=function(a,c){return this.client.groupchat(this.name,a,c)};a.prototype.invite=function(a,c){return this.client.invite(this.name,a,c)};a.prototype.multipleInvites=function(a,c){return this.client.invite(this.name,a,c)};a.prototype.directInvite=
function(a,c){return this.client.directInvite(this.name,a,c,this.password)};a.prototype.configure=function(a){return this.client.configure(this.name,a)};a.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};a.prototype.saveConfiguration=function(a){return this.client.saveConfiguration(this.name,a)};a.prototype.queryOccupants=function(a,c){return this.client.queryOccupants(this.name,a,c)};a.prototype.setTopic=function(a){return this.client.setTopic(this.name,a)};a.prototype.modifyRole=
function(a,c,d,e,g){return this.client.modifyRole(this.name,a,c,d,e,g)};a.prototype.kick=function(a,c,d,e){return this.client.kick(this.name,a,c,d,e)};a.prototype.voice=function(a,c,d,e){return this.client.voice(this.name,a,c,d,e)};a.prototype.mute=function(a,c,d,e){return this.client.mute(this.name,a,c,d,e)};a.prototype.op=function(a,c,d,e){return this.client.op(this.name,a,c,d,e)};a.prototype.deop=function(a,c,d,e){return this.client.deop(this.name,a,c,d,e)};a.prototype.modifyAffiliation=function(a,
c,d,e,g){return this.client.modifyAffiliation(this.name,a,c,d,e,g)};a.prototype.ban=function(a,c,d,e){return this.client.ban(this.name,a,c,d,e)};a.prototype.member=function(a,c,d,e){return this.client.member(this.name,a,c,d,e)};a.prototype.revoke=function(a,c,d,e){return this.client.revoke(this.name,a,c,d,e)};a.prototype.owner=function(a,c,d,e){return this.client.owner(this.name,a,c,d,e)};a.prototype.admin=function(a,c,d,e){return this.client.admin(this.name,a,c,d,e)};a.prototype.changeNick=function(a){this.nick=
a;return this.client.changeNick(this.name,nick)};a.prototype.setStatus=function(a,c){return this.client.setStatus(this.name,this.nick,a,c)};a.prototype.addHandler=function(a,c){var b=this._handler_ids++;switch(a){case "presence":this._presence_handlers[b]=c;break;case "message":this._message_handlers[b]=c;break;case "roster":this._roster_handlers[b]=c;break;default:return this._handler_ids--,null}return b};a.prototype.removeHandler=function(a){delete this._presence_handlers[a];delete this._message_handlers[a];
return delete this._roster_handlers[a]};a.prototype._addOccupant=function(a){a=new Occupant(a,this);return this.roster[a.nick]=a};a.prototype._roomRosterHandler=function(b){var c;b=a._parsePresence(b);var d=b.nick;var e=b.newnick||null;switch(b.type){case "error":return!0;case "unavailable":e&&(b.nick=e,this.roster[d]&&this.roster[e]&&(this.roster[d].update(this.roster[e]),this.roster[e]=this.roster[d]),this.roster[d]&&!this.roster[e]&&(this.roster[e]=this.roster[d].update(b)));delete this.roster[d];
break;default:this.roster[d]?this.roster[d].update(b):this._addOccupant(b)}e=this._roster_handlers;for(c in e)b=e[c],b(this.roster,this)||delete this._roster_handlers[c];return!0};a._parsePresence=function(a){var b,d,e;var g={};g.nick=Strophe.getResourceFromJid(a.getAttribute("from"));g.type=a.getAttribute("type");g.states=[];var h=a.childNodes;a=0;for(b=h.length;a<b;a++){var l=h[a];switch(l.nodeName){case "error":g.errorcode=l.getAttribute("code");g.error=null!=(e=l.childNodes[0])?e.nodeName:void 0;
break;case "status":g.status=l.textContent||l.text||null;break;case "show":g.show=l.textContent||l.text||null;break;case "x":if(l.getAttribute("xmlns")===Strophe.NS.MUC_USER){e=l.childNodes;var f=0;for(d=e.length;f<d;f++)switch(l=e[f],l.nodeName){case "item":g.affiliation=l.getAttribute("affiliation");g.role=l.getAttribute("role");g.jid=l.getAttribute("jid");g.newnick=l.getAttribute("nick");break;case "status":l.getAttribute("code")&&g.states.push(l.getAttribute("code"))}}}}return g};return a}();
RoomConfig=function(){function a(a){this.parse=bind(this.parse,this);null!=a&&this.parse(a)}a.prototype.parse=function(a){var b,d;var e=a.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];a=0;for(b=e.length;a<b;a++){var g=e[a];var h=g.attributes;switch(g.nodeName){case "identity":var l={};var f=0;for(d=h.length;f<d;f++)g=h[f],l[g.name]=g.textContent||g.text;this.identities.push(l);break;case "feature":this.features.push(g.getAttribute("var"));break;case "x":if("FORM_TYPE"!==
!g.childNodes[0].getAttribute("var")&&"hidden"!==!g.childNodes[0].getAttribute("type"))for(f=g.childNodes,g=0,l=f.length;g<l;g++)h=f[g],h.attributes.type||this.x.push({"var":h.getAttribute("var"),label:h.getAttribute("label")||"",value:h.firstChild.textContent||h.firstChild.text||""})}}return{identities:this.identities,features:this.features,x:this.x}};return a}();
Occupant=function(){function a(a,c){this.room=c;this.update=bind(this.update,this);this.admin=bind(this.admin,this);this.owner=bind(this.owner,this);this.revoke=bind(this.revoke,this);this.member=bind(this.member,this);this.ban=bind(this.ban,this);this.modifyAffiliation=bind(this.modifyAffiliation,this);this.deop=bind(this.deop,this);this.op=bind(this.op,this);this.mute=bind(this.mute,this);this.voice=bind(this.voice,this);this.kick=bind(this.kick,this);this.modifyRole=bind(this.modifyRole,this);
this.update(a)}a.prototype.modifyRole=function(a,c,d,e){return this.room.modifyRole(this.nick,a,c,d,e)};a.prototype.kick=function(a,c,d){return this.room.kick(this.nick,a,c,d)};a.prototype.voice=function(a,c,d){return this.room.voice(this.nick,a,c,d)};a.prototype.mute=function(a,c,d){return this.room.mute(this.nick,a,c,d)};a.prototype.op=function(a,c,d){return this.room.op(this.nick,a,c,d)};a.prototype.deop=function(a,c,d){return this.room.deop(this.nick,a,c,d)};a.prototype.modifyAffiliation=function(a,
c,d,e){return this.room.modifyAffiliation(this.jid,a,c,d,e)};a.prototype.ban=function(a,c,d){return this.room.ban(this.jid,a,c,d)};a.prototype.member=function(a,c,d){return this.room.member(this.jid,a,c,d)};a.prototype.revoke=function(a,c,d){return this.room.revoke(this.jid,a,c,d)};a.prototype.owner=function(a,c,d){return this.room.owner(this.jid,a,c,d)};a.prototype.admin=function(a,c,d){return this.room.admin(this.jid,a,c,d)};a.prototype.update=function(a){this.nick=a.nick||null;this.affiliation=
a.affiliation||null;this.role=a.role||null;this.jid=a.jid||null;this.status=a.status||null;this.show=a.show||null;return this};return a}();
Strophe.addConnectionPlugin("ping",{_c:null,init:function(a){this._c=a;Strophe.addNamespace("PING","urn:xmpp:ping")},ping:function(a,b,c,d){var e=this._c.getUniqueId("ping");a=$iq({type:"get",to:a,id:e}).c("ping",{xmlns:Strophe.NS.PING});this._c.sendIQ(a,b,c,d)},pong:function(a){var b=a.getAttribute("from");a=a.getAttribute("id");b=$iq({type:"result",to:b,id:a});this._c.sendIQ(b)},addPingHandler:function(a){return this._c.addHandler(a,Strophe.NS.PING,"iq","get")}});
(function(){var a={VERSION:"1.1.3",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:"long-polling cross-origin-long-polling callback-polling websocket eventsource in-process".split(" "),MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"!==typeof window?window:global,extend:function(a,c,d){if(!c)return a;for(var b in c)c.hasOwnProperty(b)&&(a.hasOwnProperty(b)&&!1===d||a[b]!==c[b]&&(a[b]=c[b]));return a},random:function(a){a=
a||this.ID_LENGTH;var b=Math.ceil(a*Math.log(2)/Math.log(36));for(a=csprng(a,36);a.length<b;)a="0"+a;return a},validateOptions:function(a,c){for(var b in a)if(0>this.indexOf(c,b))throw Error("Unrecognized option: "+b);},clientIdFromMessages:function(a){a=this.filter([].concat(a),function(a){return"/meta/connect"===a.channel});return a[0]&&a[0].clientId},copyObject:function(b){var c;if(b instanceof Array){var d=[];for(c=b.length;c--;)d[c]=a.copyObject(b[c]);return d}if("object"===typeof b){d=null===
b?null:{};for(c in b)d[c]=a.copyObject(b[c]);return d}return b},commonElement:function(a,c){for(var b=0,e=a.length;b<e;b++)if(-1!==this.indexOf(c,a[b]))return a[b];return null},indexOf:function(a,c){if(a.indexOf)return a.indexOf(c);for(var b=0,e=a.length;b<e;b++)if(a[b]===c)return b;return-1},map:function(a,c,d){if(a.map)return a.map(c,d);var b=[];if(a instanceof Array)for(var g=0,h=a.length;g<h;g++)b.push(c.call(d||null,a[g],g));else for(g in a)a.hasOwnProperty(g)&&b.push(c.call(d||null,g,a[g]));
return b},filter:function(a,c,d){if(a.filter)return a.filter(c,d);for(var b=[],g=0,h=a.length;g<h;g++)c.call(d||null,a[g],g)&&b.push(a[g]);return b},asyncEach:function(a,c,d,e){var b=a.length,h=-1,l=0,f=!1,m=function(){l+=1;if(!f){for(f=!0;0<l;)--l,h+=1,h===b?d&&d.call(e):c(a[h],m);f=!1}};m()},toJSON:function(a){return this.stringify?this.stringify(a,function(a,b){return this[a]instanceof Array?this[a]:b}):JSON.stringify(a)}};"undefined"!==typeof module?module.exports=a:"undefined"!==typeof window&&
(window.Faye=a);a.Class=function(b,c){"function"!==typeof b&&(c=b,b=Object);var d=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},e=function(){};e.prototype=b.prototype;d.prototype=new e;a.extend(d.prototype,c);return d};(function(){var b=a.EventEmitter=function(){},c="function"===typeof Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.prototype.emit=function(a){if("error"===a&&(!this._events||!this._events.error||
c(this._events.error)&&!this._events.error.length)){if(arguments[1]instanceof Error)throw arguments[1];throw Error("Uncaught, unspecified 'error' event.");}if(!this._events)return!1;var b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:var d=Array.prototype.slice.call(arguments,1);b.apply(this,d)}return!0}if(c(b)){d=Array.prototype.slice.call(arguments,
1);b=b.slice();for(var h=0,l=b.length;h<l;h++)b[h].apply(this,d);return!0}return!1};b.prototype.addListener=function(a,b){if("function"!==typeof b)throw Error("addListener only takes instances of Function");this._events||(this._events={});this.emit("newListener",a,b);this._events[a]?c(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b;return this};b.prototype.on=b.prototype.addListener;b.prototype.once=function(a,b){var c=this;c.on(a,function l(){c.removeListener(a,
l);b.apply(this,arguments)});return this};b.prototype.removeListener=function(a,b){if("function"!==typeof b)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[a])return this;var d=this._events[a];if(c(d)){a:if(d.indexOf)b=d.indexOf(b);else{for(var e=0;e<d.length;e++)if(b===d[e]){b=e;break a}b=-1}if(0>b)return this;d.splice(b,1);0==d.length&&delete this._events[a]}else this._events[a]===b&&delete this._events[a];return this};b.prototype.removeAllListeners=
function(a){if(0===arguments.length)return this._events={},this;a&&this._events&&this._events[a]&&(this._events[a]=null);return this};b.prototype.listeners=function(a){this._events||(this._events={});this._events[a]||(this._events[a]=[]);c(this._events[a])||(this._events[a]=[this._events[a]]);return this._events[a]}})();a.Namespace=a.Class({initialize:function(){this._used={}},exists:function(a){return this._used.hasOwnProperty(a)},generate:function(){for(var b=a.random();this._used.hasOwnProperty(b);)b=
a.random();return this._used[b]=b},release:function(a){delete this._used[a]}});(function(){var b=setTimeout;var c="function"===typeof setImmediate?function(a){setImmediate(a)}:"object"===typeof process&&process.nextTick?function(a){process.nextTick(a)}:function(a){b(a,0)};var d=function(a){return a},e=function(a){throw a;},g=function(a){this._state=0;this._onFulfilled=[];this._onRejected=[];if("function"===typeof a){var b=this;a(function(a){m(b,a)},function(a){q(b,a)})}};g.prototype.then=function(a,
b){var c=new g;h(this,a,c);l(this,b,c);return c};var h=function(a,b,c){"function"!==typeof b&&(b=d);var e=function(a){f(b,a,c)};0===a._state?a._onFulfilled.push(e):1===a._state&&e(a._value)},l=function(a,b,c){"function"!==typeof b&&(b=e);var d=function(a){f(b,a,c)};0===a._state?a._onRejected.push(d):2===a._state&&d(a._reason)},f=function(a,b,d){c(function(){a:{try{var c=a(b)}catch(B){q(d,B);break a}c===d?q(d,new TypeError("Recursive promise chain detected")):m(d,c)}})},m=g.fulfill=g.resolve=function(a,
b){var c=!1;try{var d=typeof b;var e=null!==b&&("function"===d||"object"===d)&&b.then;if("function"!==typeof e)return r(a,b);e.call(b,function(b){c^(c=!0)&&m(a,b)},function(b){c^(c=!0)&&q(a,b)})}catch(G){c^(c=!0)&&q(a,G)}},r=function(a,b){if(0===a._state){a._state=1;a._value=b;a._onRejected=[];a=a._onFulfilled;for(var c;c=a.shift();)c(b)}},q=g.reject=function(a,b){if(0===a._state){a._state=2;a._reason=b;a._onFulfilled=[];a=a._onRejected;for(var c;c=a.shift();)c(b)}};g.all=function(a){return new g(function(b,
c){var d=[],e=a.length,f;if(0===e)return b(d);for(f=0;f<e;f++)(function(a,f){g.fulfilled(a).then(function(a){d[f]=a;0===--e&&b(d)},c)})(a[f],f)})};g.defer=c;g.deferred=g.pending=function(){var a={};a.promise=new g(function(b,c){a.fulfill=a.resolve=b;a.reject=c});return a};g.fulfilled=g.resolved=function(a){return new g(function(b,c){b(a)})};g.rejected=function(a){return new g(function(b,c){c(a)})};"undefined"===typeof a?module.exports=g:a.Promise=g})();a.Set=a.Class({initialize:function(){this._index=
{}},add:function(a){var b=void 0!==a.id?a.id:a;if(this._index.hasOwnProperty(b))return!1;this._index[b]=a;return!0},forEach:function(a,c){for(var b in this._index)this._index.hasOwnProperty(b)&&a.call(c,this._index[b])},isEmpty:function(){for(var a in this._index)if(this._index.hasOwnProperty(a))return!1;return!0},member:function(a){for(var b in this._index)if(this._index[b]===a)return!0;return!1},remove:function(a){a=void 0!==a.id?a.id:a;var b=this._index[a];delete this._index[a];return b},toArray:function(){var a=
[];this.forEach(function(b){a.push(b)});return a}});a.URI={isURI:function(a){return a&&a.protocol&&a.host&&a.path},isSameOrigin:function(b){var c=a.ENV.location;return b.protocol===c.protocol&&b.hostname===c.hostname&&b.port===c.port},parse:function(b){if("string"!==typeof b)return b;var c={},d;var e=function(a,d){b=b.replace(d,function(b){c[a]=b;return""});c[a]=c[a]||""};e("protocol",/^[a-z]+:/i);e("host",/^\/\/[^\/\?#]+/);/^\//.test(b)||c.host||(b=a.ENV.location.pathname.replace(/[^\/]*$/,"")+b);
e("pathname",/^[^\?#]*/);e("search",/^\?[^#]*/);e("hash",/^#.*/);c.protocol=c.protocol||a.ENV.location.protocol;c.host?(c.host=c.host.substr(2),e=c.host.split(":"),c.hostname=e[0],c.port=e[1]||""):(c.host=a.ENV.location.host,c.hostname=a.ENV.location.hostname,c.port=a.ENV.location.port);c.pathname=c.pathname||"/";c.path=c.pathname+c.search;var g=(e=c.search.replace(/^\?/,""))?e.split("&"):[];var h={};var l=0;for(d=g.length;l<d;l++)e=g[l].split("="),h[decodeURIComponent(e[0]||"")]=decodeURIComponent(e[1]||
"");c.query=h;c.href=this.stringify(c);return c},stringify:function(a){var b=a.protocol+"//"+a.hostname;a.port&&(b+=":"+a.port);return b+=a.pathname+this.queryString(a.query)+(a.hash||"")},queryString:function(a){var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));return 0===b.length?"":"?"+b.join("&")}};a.Error=a.Class({initialize:function(a,c,d){this.code=a;this.params=Array.prototype.slice.call(c);this.message=d},toString:function(){return this.code+
":"+this.params.join(",")+":"+this.message}});a.Error.parse=function(b){b=b||"";if(!a.Grammar.ERROR.test(b))return new this(null,[],b);b=b.split(":");var c=parseInt(b[0]),d=b[1].split(",");b=b[2];return new this(c,d,b)};a.Error.versionMismatch=function(){return(new this(300,arguments,"Version mismatch")).toString()};a.Error.conntypeMismatch=function(){return(new this(301,arguments,"Connection types not supported")).toString()};a.Error.extMismatch=function(){return(new this(302,arguments,"Extension mismatch")).toString()};
a.Error.badRequest=function(){return(new this(400,arguments,"Bad request")).toString()};a.Error.clientUnknown=function(){return(new this(401,arguments,"Unknown client")).toString()};a.Error.parameterMissing=function(){return(new this(402,arguments,"Missing required parameter")).toString()};a.Error.channelForbidden=function(){return(new this(403,arguments,"Forbidden channel")).toString()};a.Error.channelUnknown=function(){return(new this(404,arguments,"Unknown channel")).toString()};a.Error.channelInvalid=
function(){return(new this(405,arguments,"Invalid channel")).toString()};a.Error.extUnknown=function(){return(new this(406,arguments,"Unknown extension")).toString()};a.Error.publishFailed=function(){return(new this(407,arguments,"Failed to publish")).toString()};a.Error.serverError=function(){return(new this(500,arguments,"Internal server error")).toString()};a.Deferrable={then:function(b,c){var d=this;this._promise||(this._promise=new a.Promise(function(a,b){d._fulfill=a;d._reject=b}));return 0===
arguments.length?this._promise:this._promise.then(b,c)},callback:function(a,c){return this.then(function(b){a.call(c,b)})},errback:function(a,c){return this.then(null,function(b){a.call(c,b)})},timeout:function(b,c){this.then();var d=this;this._timer=a.ENV.setTimeout(function(){d._reject(c)},1E3*b)},setDeferredStatus:function(b,c){this._timer&&a.ENV.clearTimeout(this._timer);this.then();"succeeded"===b?this._fulfill(c):"failed"===b?this._reject(c):delete this._promise}};a.Publisher={countListeners:function(a){return this.listeners(a).length},
bind:function(a,c,d){var b=Array.prototype.slice,g=function(){c.apply(d,b.call(arguments))};this._listeners=this._listeners||[];this._listeners.push([a,c,d,g]);return this.on(a,g)},unbind:function(a,c,d){this._listeners=this._listeners||[];for(var b=this._listeners.length,g;b--;)g=this._listeners[b],g[0]!==a||c&&(g[1]!==c||g[2]!==d)||(this._listeners.splice(b,1),this.removeListener(a,g[3]))}};a.extend(a.Publisher,a.EventEmitter.prototype);a.Publisher.trigger=a.Publisher.emit;a.Timeouts={addTimeout:function(b,
c,d,e){this._timeouts=this._timeouts||{};if(!this._timeouts.hasOwnProperty(b)){var g=this;this._timeouts[b]=a.ENV.setTimeout(function(){delete g._timeouts[b];d.call(e)},1E3*c)}},removeTimeout:function(b){this._timeouts=this._timeouts||{};var c=this._timeouts[b];c&&(a.ENV.clearTimeout(c),delete this._timeouts[b])},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var a in this._timeouts)this.removeTimeout(a)}};a.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(b,
c){if(a.logger){var d=Array.prototype.slice.apply(b);b="[Faye";var e=this.className,g=d.shift().replace(/\?/g,function(){try{return a.toJSON(d.shift())}catch(l){return"[Object]"}}),h;for(h in a)e||"function"===typeof a[h]&&this instanceof a[h]&&(e=h);e&&(b+="."+e);b+="] ";if("function"===typeof a.logger[c])a.logger[c](b+g);else"function"===typeof a.logger&&a.logger(b+g)}}};(function(){for(var b in a.Logging.LOG_LEVELS)(function(b){a.Logging[b]=function(){this.writeLog(arguments,b)}})(b)})();a.Grammar=
{CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|_|!|~|\(|\)|\$|@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|_))*)*$/};
a.Extensible={addExtension:function(a){this._extensions=this._extensions||[];this._extensions.push(a);a.added&&a.added(this)},removeExtension:function(a){if(this._extensions)for(var b=this._extensions.length;b--;)this._extensions[b]===a&&(this._extensions.splice(b,1),a.removed&&a.removed(this))},pipeThroughExtensions:function(a,c,d,e,g){this.debug("Passing through ? extensions: ?",a,c);if(!this._extensions)return e.call(g,c);var b=this._extensions.slice(),l=function(c){if(!c)return e.call(g,c);var f=
b.shift();if(!f)return e.call(g,c);var h=f[a];if(!h)return l(c);if(3<=h.length)f[a](c,d,l);else f[a](c,l)};l(c)}};a.extend(a.Extensible,a.Logging);a.Channel=a.Class({initialize:function(a){this.id=this.name=a},push:function(a){this.trigger("message",a)},isUnused:function(){return 0===this.countListeners("message")}});a.extend(a.Channel.prototype,a.Publisher);a.extend(a.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",
META:"meta",SERVICE:"service",expand:function(a){var b=this.parse(a);a=["/**",a];var d=b.slice();d[d.length-1]="*";a.push(this.unparse(d));for(var e=1,g=b.length;e<g;e++)d=b.slice(0,e),d.push("**"),a.push(this.unparse(d));return a},isValid:function(b){return a.Grammar.CHANNEL_NAME.test(b)||a.Grammar.CHANNEL_PATTERN.test(b)},parse:function(a){return this.isValid(a)?a.split("/").slice(1):null},unparse:function(a){return"/"+a.join("/")},isMeta:function(a){return(a=this.parse(a))?a[0]===this.META:null},
isService:function(a){return(a=this.parse(a))?a[0]===this.SERVICE:null},isSubscribable:function(a){return this.isValid(a)?!this.isMeta(a)&&!this.isService(a):null},Set:a.Class({initialize:function(){this._channels={}},getKeys:function(){var a=[],c;for(c in this._channels)a.push(c);return a},remove:function(a){delete this._channels[a]},hasSubscription:function(a){return this._channels.hasOwnProperty(a)},subscribe:function(b,c,d){for(var e,g=0,h=b.length;g<h;g++)e=b[g],e=this._channels[e]=this._channels[e]||
new a.Channel(e),c&&e.bind("message",c,d)},unsubscribe:function(a,c,d){var b=this._channels[a];if(!b)return!1;b.unbind("message",c,d);return b.isUnused()?(this.remove(a),!0):!1},distributeMessage:function(b){for(var c=a.Channel.expand(b.channel),d=0,e=c.length;d<e;d++){var g=this._channels[c[d]];g&&g.trigger("message",b.data)}}})});a.Publication=a.Class(a.Deferrable);a.Subscription=a.Class({initialize:function(a,c,d,e){this._client=a;this._channels=c;this._callback=d;this._context=e;this._cancelled=
!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}});a.extend(a.Subscription.prototype,a.Deferrable);a.Client=a.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(b,c){this.info("New client created for ?",b);c=c||{};a.validateOptions(c,"interval timeout endpoints proxy retry scheduler websocketExtensions tls ca".split(" "));
this._endpoint=b||this.DEFAULT_ENDPOINT;this._channels=new a.Channel.Set;this._dispatcher=new a.Dispatcher(this,this._endpoint,c);this._messageId=0;this._state=this.UNCONNECTED;this._responseCallbacks={};this._advice={reconnect:this.RETRY,interval:1E3*(c.interval||this.INTERVAL),timeout:1E3*(c.timeout||this.CONNECTION_TIMEOUT)};this._dispatcher.timeout=this._advice.timeout/1E3;this._dispatcher.bind("message",this._receiveMessage,this);if(a.Event&&void 0!==a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",
function(){0>a.indexOf(this._dispatcher._disabled,"autodisconnect")&&this.disconnect()},this)},addWebsocketExtension:function(a){return this._dispatcher.addWebsocketExtension(a)},disable:function(a){return this._dispatcher.disable(a)},setHeader:function(a,c){return this._dispatcher.setHeader(a,c)},handshake:function(b,c){if(this._advice.reconnect!==this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var d=this;this.info("Initiating handshake with ?",a.URI.stringify(this._endpoint));
this._dispatcher.selectTransport(a.MANDATORY_CONNECTION_TYPES);this._sendMessage({channel:a.Channel.HANDSHAKE,version:a.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(e){e.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=e.clientId,this._dispatcher.selectTransport(e.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),b&&a.Promise.defer(function(){b.call(c)})):
(this.info("Handshake unsuccessful"),a.ENV.setTimeout(function(){d.handshake(b,c)},1E3*this._dispatcher.retry),this._state=this.UNCONNECTED)},this)}},connect:function(b,c){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(b,c)},this);this.callback(b,c);this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown"),
this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:a.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)))}},disconnect:function(){if(this._state===this.CONNECTED){this._state=this.DISCONNECTED;this.info("Disconnecting ?",this._dispatcher.clientId);var b=new a.Publication;this._sendMessage({channel:a.Channel.DISCONNECT,clientId:this._dispatcher.clientId},
{},function(c){c.successful?(this._dispatcher.close(),b.setDeferredStatus("succeeded")):b.setDeferredStatus("failed",a.Error.parse(c.error))},this);this.info("Clearing channel listeners for ?",this._dispatcher.clientId);this._channels=new a.Channel.Set;return b}},subscribe:function(b,c,d){if(b instanceof Array)return a.map(b,function(a){return this.subscribe(a,c,d)},this);var e=new a.Subscription(this,b,c,d),g=!0===c;if(this._channels.hasSubscription(b)&&!g)return this._channels.subscribe([b],c,d),
e.setDeferredStatus("succeeded"),e;this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,b);g||this._channels.subscribe([b],c,d);this._sendMessage({channel:a.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:b},{},function(g){if(!g.successful)return e.setDeferredStatus("failed",a.Error.parse(g.error)),this._channels.unsubscribe(b,c,d);g=[].concat(g.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,
g);e.setDeferredStatus("succeeded")},this)},this);return e},unsubscribe:function(b,c,d){if(b instanceof Array)return a.map(b,function(a){return this.unsubscribe(a,c,d)},this);this._channels.unsubscribe(b,c,d)&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,b);this._sendMessage({channel:a.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:b},{},function(a){a.successful&&(a=[].concat(a.subscription),this.info("Unsubscription acknowledged for ? from ?",
this._dispatcher.clientId,a))},this)},this)},publish:function(b,c,d){a.validateOptions(d||{},["attempts","deadline"]);var e=new a.Publication;this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,b,c);this._sendMessage({channel:b,data:c,clientId:this._dispatcher.clientId},d,function(b){b.successful?e.setDeferredStatus("succeeded"):e.setDeferredStatus("failed",a.Error.parse(b.error))},this)},this);return e},_sendMessage:function(a,c,d,e){a.id=this._generateMessageId();
var b=this._advice.timeout?1.2*this._advice.timeout/1E3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",a,null,function(a){a&&(d&&(this._responseCallbacks[a.id]=[d,e]),this._dispatcher.sendMessage(a,b,c||{}))},this)},_generateMessageId:function(){this._messageId+=1;this._messageId>=Math.pow(2,32)&&(this._messageId=0);return this._messageId.toString(36)},_receiveMessage:function(a){var b=a.id;if(void 0!==a.successful){var d=this._responseCallbacks[b];delete this._responseCallbacks[b]}this.pipeThroughExtensions("incoming",
a,null,function(a){a&&(a.advice&&this._handleAdvice(a.advice),this._deliverMessage(a),d&&d[0].call(d[1],a))},this)},_handleAdvice:function(b){a.extend(this._advice,b);this._dispatcher.timeout=this._advice.timeout/1E3;this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(a){a.channel&&void 0!==a.data&&(this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,
a.channel,a.data),this._channels.distributeMessage(a))},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var b=this;a.ENV.setTimeout(function(){b.connect()},this._advice.interval)}});a.extend(a.Client.prototype,a.Deferrable);a.extend(a.Client.prototype,a.Publisher);a.extend(a.Client.prototype,a.Logging);a.extend(a.Client.prototype,a.Extensible);a.Dispatcher=a.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,
DOWN:2,initialize:function(b,c,d){this._client=b;this.endpoint=a.URI.parse(c);this._alternates=d.endpoints||{};this.cookies=a.Cookies&&new a.Cookies.CookieJar;this._disabled=[];this._envelopes={};this.headers={};this.retry=d.retry||this.DEFAULT_RETRY;this._scheduler=d.scheduler||a.Scheduler;this._state=0;this.transports={};this.wsExtensions=[];this.proxy=d.proxy||{};"string"===typeof this._proxy&&(this._proxy={origin:this._proxy});if(b=d.websocketExtensions){b=[].concat(b);c=0;for(var e=b.length;c<
e;c++)this.addWebsocketExtension(b[c])}this.tls=d.tls||{};this.tls.ca=this.tls.ca||d.ca;for(var g in this._alternates)this._alternates[g]=a.URI.parse(this._alternates[g]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(a){return this._alternates[a]||this.endpoint},addWebsocketExtension:function(a){this.wsExtensions.push(a)},disable:function(a){this._disabled.push(a)},setHeader:function(a,c){this.headers[a]=c},close:function(){var a=this._transport;delete this._transport;a&&a.close()},
getConnectionTypes:function(){return a.Transport.getConnectionTypes()},selectTransport:function(b){a.Transport.get(this,b,this._disabled,function(b){this.debug("Selected ? transport for ?",b.connectionType,a.URI.stringify(b.endpoint));b!==this._transport&&(this._transport&&this._transport.close(),this._transport=b,this.connectionType=b.connectionType)},this)},sendMessage:function(a,c,d){d=d||{};var b=a.id,g=d.attempts;d=d.deadline&&(new Date).getTime()+1E3*d.deadline;var h=this._envelopes[b];h||(c=
new this._scheduler(a,{timeout:c,interval:this.retry,attempts:g,deadline:d}),h=this._envelopes[b]={message:a,scheduler:c});this._sendEnvelope(h)},_sendEnvelope:function(b){if(this._transport&&!b.request&&!b.timer){var c=b.message,d=b.scheduler,e=this;d.isDeliverable()?(b.timer=a.ENV.setTimeout(function(){e.handleError(c)},1E3*d.getTimeout()),d.send(),b.request=this._transport.sendMessage(c)):(d.abort(),delete this._envelopes[c.id])}},handleResponse:function(b){var c=this._envelopes[b.id];void 0!==
b.successful&&c&&(c.scheduler.succeed(),delete this._envelopes[b.id],a.ENV.clearTimeout(c.timer));this.trigger("message",b);this._state!==this.UP&&(this._state=this.UP,this._client.trigger("transport:up"))},handleError:function(b,c){var d=this._envelopes[b.id];b=d&&d.request;var e=this;b&&(b.then(function(a){a&&a.abort&&a.abort()}),b=d.scheduler,b.fail(),a.ENV.clearTimeout(d.timer),d.request=d.timer=null,c?this._sendEnvelope(d):d.timer=a.ENV.setTimeout(function(){d.timer=null;e._sendEnvelope(d)},
1E3*b.getInterval()),this._state!==this.DOWN&&(this._state=this.DOWN,this._client.trigger("transport:down")))}});a.extend(a.Dispatcher.prototype,a.Publisher);a.extend(a.Dispatcher.prototype,a.Logging);a.Scheduler=function(a,c){this.message=a;this.options=c;this.attempts=0};a.extend(a.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var a=this.options.attempts,c=this.attempts,d=this.options.deadline,
e=(new Date).getTime();return void 0!==a&&c>=a||void 0!==d&&e>d?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}});a.Transport=a.extend(a.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(b,c){this._dispatcher=b;this.endpoint=c;this._outbox=[];this._proxy=a.extend({},this._dispatcher.proxy);!this._proxy.origin&&a.NodeAdapter&&(this._proxy.origin=0<=a.indexOf(this.SECURE_PROTOCOLS,
this.endpoint.protocol)?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(a){return""},sendMessage:function(b){this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),b);if(!this.batching)return a.Promise.fulfilled(this.request([b]));this._outbox.push(b);this._flushLargeBatch();if(b.channel===a.Channel.HANDSHAKE)return this._publish(.01);b.channel===a.Channel.CONNECT&&
(this._connectMessage=b);return this._publish(this.MAX_DELAY)},_publish:function(b){this._promise=this._promise||new a.Promise;this.addTimeout("publish",b,function(){this._flush();delete this._promise},this);return this._promise},_flush:function(){this.removeTimeout("publish");1<this._outbox.length&&this._connectMessage&&(this._connectMessage.advice={timeout:0});a.Promise.fulfill(this._promise,this.request(this._outbox));this._connectMessage=null;this._outbox=[]},_flushLargeBatch:function(){if(!(this.encode(this._outbox).length<
this._dispatcher.maxRequestSize)){var b=this._outbox.pop();this._promise=this._promise||new a.Promise;this._flush();b&&this._outbox.push(b)}},_receive:function(b){if(b){b=[].concat(b);this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),this.connectionType,b);for(var c=0,d=b.length;c<d;c++)this._dispatcher.handleResponse(b[c])}},_handleError:function(b,c){b=[].concat(b);this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,
a.URI.stringify(this.endpoint),this.connectionType,b);c=0;for(var d=b.length;c<d;c++)this._dispatcher.handleError(b[c])},_getCookies:function(){var b=this._dispatcher.cookies,c=a.URI.stringify(this.endpoint);return b?a.map(b.getCookiesSync(c),function(a){return a.cookieString()}).join("; "):""},_storeCookies:function(b){var c=this._dispatcher.cookies,d=a.URI.stringify(this.endpoint);if(b&&c){b=[].concat(b);for(var e=0,g=b.length;e<g;e++){var h=a.Cookies.Cookie.parse(b[e]);c.setCookieSync(h,d)}}}}),
{get:function(b,c,d,e,g){var h=b.endpoint;a.asyncEach(this._transports,function(h,f){var l=h[0],r=h[1],q=b.endpointFor(l);if(0<=a.indexOf(d,l))return f();if(0>a.indexOf(c,l))return r.isUsable(b,q,function(){}),f();r.isUsable(b,q,function(a){if(!a)return f();a=r.hasOwnProperty("create")?r.create(b,q):new r(b,q);e.call(g,a)})},function(){throw Error("Could not find a usable connection type for "+a.URI.stringify(h));})},register:function(a,c){this._transports.push([a,c]);c.prototype.connectionType=a},
getConnectionTypes:function(){return a.map(this._transports,function(a){return a[0]})},_transports:[]});a.extend(a.Transport.prototype,a.Logging);a.extend(a.Transport.prototype,a.Timeouts);a.Event={_registry:[],on:function(a,c,d,e){var b=function(){d.call(e)};a.addEventListener?a.addEventListener(c,b,!1):a.attachEvent("on"+c,b);this._registry.push({_element:a,_type:c,_callback:d,_context:e,_handler:b})},detach:function(a,c,d,e){for(var b=this._registry.length,h;b--;)h=this._registry[b],a&&a!==h._element||
c&&c!==h._type||d&&d!==h._callback||e&&e!==h._context||(h._element.removeEventListener?h._element.removeEventListener(h._type,h._handler,!1):h._element.detachEvent("on"+h._type,h._handler),this._registry.splice(b,1))}};if(void 0!==a.ENV.onunload)a.Event.on(a.ENV,"unload",a.Event.detach,a.Event);"object"!==typeof JSON&&(JSON={});(function(){function b(a){return 10>a?"0"+a:a}function c(a){g.lastIndex=0;return g.test(a)?'"'+a.replace(g,function(a){var b=f[a];return"string"===typeof b?b:"\\u"+("0000"+
a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function d(a,b){var e=h,f=b[a];f&&"object"===typeof f&&"function"===typeof f.toJSON&&(f=f.toJSON(a));"function"===typeof m&&(f=m.call(b,a,f));switch(typeof f){case "string":return c(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";h+=l;var g=[];if("[object Array]"===Object.prototype.toString.apply(f)){var r=f.length;for(a=0;a<r;a+=1)g[a]=d(a,f)||"null";b=0===g.length?
"[]":h?"[\n"+h+g.join(",\n"+h)+"\n"+e+"]":"["+g.join(",")+"]";h=e;return b}if(m&&"object"===typeof m)for(r=m.length,a=0;a<r;a+=1){if("string"===typeof m[a]){var q=m[a];(b=d(q,f))&&g.push(c(q)+(h?": ":":")+b)}}else for(q in f)Object.prototype.hasOwnProperty.call(f,q)&&(b=d(q,f))&&g.push(c(q)+(h?": ":":")+b);b=0===g.length?"{}":h?"{\n"+h+g.join(",\n"+h)+"\n"+e+"}":"{"+g.join(",")+"}";h=e;return b}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?
this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g=/[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h,l,f={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;a.stringify=function(a,b,c){var e;l=h="";if("number"===typeof c)for(e=0;e<c;e+=1)l+=" ";else"string"===typeof c&&(l=c);if((m=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return d("",{"":a})};"function"!==typeof JSON.stringify&&(JSON.stringify=a.stringify);"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function c(a,d){var e,f=a[d];if(f&&"object"===
typeof f)for(e in f)if(Object.prototype.hasOwnProperty.call(f,e)){var g=c(f,e);void 0!==g?f[e]=g:delete f[e]}return b.call(a,d,f)}a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return a=eval("("+a+")"),"function"===typeof b?c({"":a},
""):a;throw new SyntaxError("JSON.parse");})})();a.Transport.WebSocket=a.extend(a.Class(a.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(a,c){this.callback(function(){a.call(c,!0)});this.errback(function(){a.call(c,!1)});this.connect()},request:function(b){this._pending=this._pending||new a.Set;for(var c=0,d=b.length;c<d;c++)this._pending.add(b[c]);var e=new a.Promise;this.callback(function(c){c&&1===c.readyState&&(c.send(a.toJSON(b)),a.Promise.fulfill(e,c))},this);
this.connect();return{abort:function(){e.then(function(a){a.close()})}}},connect:function(){if(!a.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var b=this._createSocket();if(!b)return this.setDeferredStatus("failed");var c=this;b.onopen=function(){b.headers&&c._storeCookies(b.headers["set-cookie"]);c._socket=b;c._state=c.CONNECTED;c._everConnected=!0;c._ping();c.setDeferredStatus("succeeded",b)};var d=!1;b.onclose=
b.onerror=function(){if(!d){d=!0;var a=c._state===c.CONNECTED;b.onopen=b.onclose=b.onerror=b.onmessage=null;delete c._socket;c._state=c.UNCONNECTED;c.removeTimeout("ping");var g=c._pending?c._pending.toArray():[];delete c._pending;a||c._everConnected?(c.setDeferredStatus("unknown"),c._handleError(g,a)):c.setDeferredStatus("failed")}};b.onmessage=function(a){if(a=JSON.parse(a.data)){a=[].concat(a);for(var b=0,d=a.length;b<d;b++)void 0!==a[b].successful&&c._pending.remove(a[b]);c._receive(a)}}}},close:function(){this._socket&&
this._socket.close()},_createSocket:function(){var b=a.Transport.WebSocket.getSocketUrl(this.endpoint),c=this._dispatcher.headers,d=this._dispatcher.wsExtensions,e=this._getCookies();c={extensions:d,headers:c,proxy:this._proxy,tls:this._dispatcher.tls};""!==e&&(c.headers.Cookie=e);if(a.WebSocket)return new a.WebSocket.Client(b,[],c);if(a.ENV.MozWebSocket)return new MozWebSocket(b);if(a.ENV.WebSocket)return new WebSocket(b)},_ping:function(){this._socket&&1===this._socket.readyState&&(this._socket.send("[]"),
this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this))}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(a,c){var b=a.transports.websocket=a.transports.websocket||{};b[c.href]=b[c.href]||new this(a,c);return b[c.href]},getSocketUrl:function(b){b=a.copyObject(b);b.protocol=this.PROTOCOLS[b.protocol];return a.URI.stringify(b)},isUsable:function(a,c,d,e){this.create(a,c).isUsable(d,e)}});a.extend(a.Transport.WebSocket.prototype,a.Deferrable);a.Transport.register("websocket",
a.Transport.WebSocket);if(a.Event&&void 0!==a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",function(){a.Transport.WebSocket._unloaded=!0});a.Transport.EventSource=a.extend(a.Class(a.Transport,{initialize:function(b,c){a.Transport.prototype.initialize.call(this,b,c);if(!a.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new a.Transport.XHR(b,c);c=a.copyObject(c);c.pathname+="/"+b.clientId;var d=new EventSource(a.URI.stringify(c)),e=this;d.onopen=function(){e._everConnected=!0;
e.setDeferredStatus("succeeded")};d.onerror=function(){e._everConnected?e._handleError([]):(e.setDeferredStatus("failed"),d.close())};d.onmessage=function(a){e._receive(JSON.parse(a.data))};this._socket=d},close:function(){this._socket&&(this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket)},isUsable:function(a,c){this.callback(function(){a.call(c,!0)});this.errback(function(){a.call(c,!1)})},encode:function(a){return this._xhr.encode(a)},request:function(a){return this._xhr.request(a)}}),
{isUsable:function(b,c,d,e){if(!b.clientId)return d.call(e,!1);a.Transport.XHR.isUsable(b,c,function(a){if(!a)return d.call(e,!1);this.create(b,c).isUsable(d,e)},this)},create:function(b,c){var d=b.transports.eventsource=b.transports.eventsource||{},e=b.clientId,g=a.copyObject(c);g.pathname+="/"+(e||"");g=a.URI.stringify(g);d[g]=d[g]||new this(b,c);return d[g]}});a.extend(a.Transport.EventSource.prototype,a.Deferrable);a.Transport.register("eventsource",a.Transport.EventSource);a.Transport.XHR=a.extend(a.Class(a.Transport,
{encode:function(b){return a.toJSON(b)},request:function(b){var c=this.endpoint.href,d=this;try{var e=new XMLHttpRequest}catch(l){e=a.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}e.open("POST",c,!0);e.setRequestHeader("Content-Type","application/json");e.setRequestHeader("Pragma","no-cache");e.setRequestHeader("X-Requested-With","XMLHttpRequest");c=this._dispatcher.headers;for(var g in c)c.hasOwnProperty(g)&&e.setRequestHeader(g,c[g]);var h=function(){e.abort()};if(void 0!==
a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",h);e.onreadystatechange=function(){if(e&&4===e.readyState){var c=null,f=e.status,g=e.responseText;f=200<=f&&300>f||304===f||1223===f;void 0!==a.ENV.onbeforeunload&&a.Event.detach(a.ENV,"beforeunload",h);e.onreadystatechange=function(){};e=null;if(!f)return d._handleError(b);try{c=JSON.parse(g)}catch(r){}c?d._receive(c):d._handleError(b)}};e.send(this.encode(b));return e}}),{isUsable:function(b,c,d,e){d.call(e,a.URI.isSameOrigin(c))}});a.Transport.register("long-polling",
a.Transport.XHR);a.Transport.CORS=a.extend(a.Class(a.Transport,{encode:function(b){return"message="+encodeURIComponent(a.toJSON(b))},request:function(b){var c=a.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,d=new c,e=++a.Transport.CORS._id,g=this._dispatcher.headers,h=this,l;d.open("POST",a.URI.stringify(this.endpoint),!0);if(d.setRequestHeader)for(l in d.setRequestHeader("Pragma","no-cache"),g)g.hasOwnProperty(l)&&d.setRequestHeader(l,g[l]);var f=function(){if(!d)return!1;a.Transport.CORS._pending.remove(e);
d=d.onload=d.onerror=d.ontimeout=d.onprogress=null};d.onload=function(){var a=null;try{a=JSON.parse(d.responseText)}catch(r){}f();a?h._receive(a):h._handleError(b)};d.onerror=d.ontimeout=function(){f();h._handleError(b)};d.onprogress=function(){};c===a.ENV.XDomainRequest&&a.Transport.CORS._pending.add({id:e,xhr:d});d.send(this.encode(b));return d}}),{_id:0,_pending:new a.Set,isUsable:function(b,c,d,e){return a.URI.isSameOrigin(c)?d.call(e,!1):a.ENV.XDomainRequest?d.call(e,c.protocol===a.ENV.location.protocol):
a.ENV.XMLHttpRequest?(b=new a.ENV.XMLHttpRequest,d.call(e,void 0!==b.withCredentials)):d.call(e,!1)}});a.Transport.register("cross-origin-long-polling",a.Transport.CORS);a.Transport.JSONP=a.extend(a.Class(a.Transport,{encode:function(b){var c=a.copyObject(this.endpoint);c.query.message=a.toJSON(b);c.query.jsonp="__jsonp"+a.Transport.JSONP._cbCount+"__";return a.URI.stringify(c)},request:function(b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script"),e=a.Transport.JSONP.getCallbackName(),
g=a.copyObject(this.endpoint),h=this;g.query.message=a.toJSON(b);g.query.jsonp=e;var l=function(){if(!a.ENV[e])return!1;a.ENV[e]=void 0;try{delete a.ENV[e]}catch(f){}d.parentNode.removeChild(d)};a.ENV[e]=function(a){l();h._receive(a)};d.type="text/javascript";d.src=a.URI.stringify(g);c.appendChild(d);d.onerror=function(){l();h._handleError(b)};return{abort:l}}}),{_cbCount:0,getCallbackName:function(){this._cbCount+=1;return"__jsonp"+this._cbCount+"__"},isUsable:function(a,c,d,e){d.call(e,!0)}});a.Transport.register("callback-polling",
a.Transport.JSONP)})();var slice=Array.prototype.slice;Evented={on:function(a,b,c){this.__callbacks||(this.__callbacks={});this.__callbacks[a]||(this.__callbacks[a]=[]);if(c){var d=slice.call(arguments,3);d.unshift(b);d=Function.prototype.bind.apply(b[c],d)}else d=b;this.__callbacks[a].push(d)},trigger:function(a){var b=slice.call(arguments,1);this.__callbacks&&this.__callbacks[a]&&$j.each(this.__callbacks[a],function(a,d){d.apply(null,b)})}};
(function(){if("undefined"!==typeof Faye){var a=Faye.Transport.prototype._receive;Faye.Transport.prototype._receive=function(){a.apply(this,arguments);var b=this._dispatcher;b._state!==b.UP&&(b._state=b.UP,b._client.trigger("transport:up"))}}})();FayeBackoffScheduler=function(){Faye.Scheduler.apply(this,arguments)};
(function(){function a(){}a.prototype=Faye.Scheduler.prototype;FayeBackoffScheduler.prototype=new a;FayeBackoffScheduler.prototype.getInterval=function(){delay=Math.pow(this.attempts,2)+Math.random(5);return Math.min(60,delay)}})();
FayeMessageTransformer=function(){return{transform:function(a){a={version:a[0],kuid:a[1],uuid:a[2],text:a[3],timestamp:a[4],user_id:a[5],username:a[6],character_name:a[7],level:a[8],admin:0<=a[10].indexOf("a"),developer:0<=a[10].indexOf("d"),mobile:0<=a[10].indexOf("m"),premium:0<=a[10].indexOf("p"),guid:a[9]};"0"===a.kuid?(a.data=JSON.parse(a.text),a.type=a.data.type):a.type="chat";return a}}}();FayeConnectionMonitor=function(a){this.initialize(a)};
(function(){FayeConnectionMonitor.prototype={initialize:function(a){this._client=a.client;this._transportDown=!1;this._disconnected=!0;this._disconnectTimeout=a.timeout||2E4;this._addListeners()},isConnected:function(){return!this._disconnected},destroy:function(){this._removeListeners();this._clearTimeout();this._client=void 0},_clearTimeout:function(){clearTimeout(this._timeout);this._timeout=void 0},_addListeners:function(){var a=this;this._upListener=function(){var b=a._disconnected;a._clearTimeout();
a._transportDown=!1;a._disconnected=!1;b&&a.trigger("connect")};this._downListener=function(){a._transportDown=!0;a._timeout=setTimeout(function(){a._transportDown&&a._client&&(a._disconnected=!0,a._ping(),a.trigger("disconnect"))},a._disconnectTimeout)};this._client.on("transport:up",this._upListener);this._client.on("transport:down",this._downListener)},_removeListeners:function(){this._client.removeListener("transport:up",this._upListener);this._client.removeListener("transport:down",this._downListener);
this._upListener=this._downListener=void 0},_isWebSocket:function(){return"websocket"===this._client._dispatcher.connectionType},_ping:function(){this._isWebSocket()||this._client.publish("/service/ping",{})}};$j.extend(FayeConnectionMonitor.prototype,Evented)})();
var CropDraggable=Class.create(Draggable,{initialize:function(a,b){this.options=Object.extend({drawMethod:function(){}},b||{});this.handle=this.element=$(a);this.delta=this.currentDelta();this.dragging=!1;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},draw:function(a){var b=Element.cumulativeOffset(this.element),c=this.currentDelta();b[0]-=c[0];b[1]-=c[1];c=[0,1].map(function(c){return a[c]-b[c]-this.offset[c]}.bind(this));
this.options.drawMethod(c)}}),Cropper={};
Cropper.Img=Class.create({initialize:function(a,b){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:!1,onEndCrop:Prototype.emptyFunction,captureKeys:!0,onloadCoords:null,maxWidth:0,maxHeight:0,autoIncludeCSS:!1},b||{});this.img=$(a);this.clickCoords={x:0,y:0};this.resizing=this.dragging=!1;this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent);this.isIE=/MSIE/.test(navigator.userAgent);this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent);this.ratioY=
this.ratioX=0;this.attached=!1;this.fixedWidth=0<this.options.maxWidth&&this.options.minWidth>=this.options.maxWidth;this.fixedHeight=0<this.options.maxHeight&&this.options.minHeight>=this.options.maxHeight;if("undefined"!=typeof this.img)if(this.options.autoIncludeCSS&&$$("script").each(function(a){if(a.src.match(/\/cropper([^\/]*)\.js/)){a=a.src.replace(/\/cropper([^\/]*)\.js.*/,"");var b=document.createElement("link");b.rel="stylesheet";b.type="text/css";b.href=a+"/cropper.css";b.media="screen";
document.getElementsByTagName("head")[0].appendChild(b)}}),0<this.options.ratioDim.x&&0<this.options.ratioDim.y&&(a=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y),this.ratioX=this.options.ratioDim.x/a,this.ratioY=this.options.ratioDim.y/a),this.subInitialize(),this.img.complete||this.isWebKit)this.onLoad();else Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this))},getGCD:function(a,b){return 0===b?a:this.getGCD(b,a%b)},onLoad:function(){var a=this.img.parentNode,b="";
this.isOpera8&&(b=" opera8");this.imgWrap=new Element("div",{"class":"imgCrop_wrap"+b});this.north=(new Element("div",{"class":"imgCrop_overlay imgCrop_north"})).insert(new Element("span"));this.east=(new Element("div",{"class":"imgCrop_overlay imgCrop_east"})).insert(new Element("span"));this.south=(new Element("div",{"class":"imgCrop_overlay imgCrop_south"})).insert(new Element("span"));this.west=(new Element("div",{"class":"imgCrop_overlay imgCrop_west"})).insert(new Element("span"));b=[this.north,
this.east,this.south,this.west];this.dragArea=new Element("div",{"class":"imgCrop_dragArea"});b.each(function(a){this.dragArea.insert(a)},this);this.handleN=new Element("div",{"class":"imgCrop_handle imgCrop_handleN"});this.handleNE=new Element("div",{"class":"imgCrop_handle imgCrop_handleNE"});this.handleE=new Element("div",{"class":"imgCrop_handle imgCrop_handleE"});this.handleSE=new Element("div",{"class":"imgCrop_handle imgCrop_handleSE"});this.handleS=new Element("div",{"class":"imgCrop_handle imgCrop_handleS"});
this.handleSW=new Element("div",{"class":"imgCrop_handle imgCrop_handleSW"});this.handleW=new Element("div",{"class":"imgCrop_handle imgCrop_handleW"});this.handleNW=new Element("div",{"class":"imgCrop_handle imgCrop_handleNW"});this.selArea=new Element("div",{"class":"imgCrop_selArea"});[(new Element("div",{"class":"imgCrop_marqueeHoriz imgCrop_marqueeNorth"})).insert(new Element("span")),(new Element("div",{"class":"imgCrop_marqueeVert imgCrop_marqueeEast"})).insert(new Element("span")),(new Element("div",
{"class":"imgCrop_marqueeHoriz imgCrop_marqueeSouth"})).insert(new Element("span")),(new Element("div",{"class":"imgCrop_marqueeVert imgCrop_marqueeWest"})).insert(new Element("span")),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,new Element("div",{"class":"imgCrop_clickArea"})].each(function(a){this.selArea.insert(a)},this);this.imgWrap.appendChild(this.img);this.imgWrap.appendChild(this.dragArea);this.dragArea.appendChild(this.selArea);
this.dragArea.appendChild(new Element("div",{"class":"imgCrop_clickArea"}));a.appendChild(this.imgWrap);this.startDragBind=this.startDrag.bindAsEventListener(this);Event.observe(this.dragArea,"mousedown",this.startDragBind);this.onDragBind=this.onDrag.bindAsEventListener(this);Event.observe(document,"mousemove",this.onDragBind);this.endCropBind=this.endCrop.bindAsEventListener(this);Event.observe(document,"mouseup",this.endCropBind);this.resizeBind=this.startResize.bindAsEventListener(this);this.handles=
[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];this.registerHandles(!0);this.options.captureKeys&&(this.keysBind=this.handleKeys.bindAsEventListener(this),Event.observe(document,"keypress",this.keysBind));new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)});this.setParams()},registerHandles:function(a){for(var b=0;b<this.handles.length;b++){var c=$(this.handles[b]);if(a){var d=!1;if(this.fixedWidth&&this.fixedHeight)d=
!0;else if(this.fixedWidth||this.fixedHeight){var e=c.className.match(/([S|N][E|W])$/),g=c.className.match(/(E|W)$/),h=c.className.match(/(N|S)$/);if(e||this.fixedWidth&&g||this.fixedHeight&&h)d=!0}d?c.hide():Event.observe(c,"mousedown",this.resizeBind)}else c.show(),Event.stopObserving(c,"mousedown",this.resizeBind)}},setParams:function(){this.imgW=this.img.width;this.imgH=this.img.height;$(this.north).setStyle({height:0});$(this.east).setStyle({width:0,height:0});$(this.south).setStyle({height:0});
$(this.west).setStyle({width:0,height:0});$(this.imgWrap).setStyle({width:this.imgW+"px",height:this.imgH+"px"});$(this.selArea).hide();var a={x1:0,y1:0,x2:0,y2:0},b=!1;null!==this.options.onloadCoords?(a=this.cloneCoords(this.options.onloadCoords),b=!0):0<this.options.ratioDim.x&&0<this.options.ratioDim.y&&(a.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2),a.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2),a.x2=a.x1+this.options.ratioDim.x,a.y2=a.y1+this.options.ratioDim.y,b=!0);this.setAreaCoords(a,
!1,!1,1);this.options.displayOnInit&&b&&(this.selArea.show(),this.drawArea(),this.endCrop());this.attached=!0},remove:function(){this.attached&&(this.attached=!1,this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap),this.imgWrap.parentNode.removeChild(this.imgWrap),Event.stopObserving(this.dragArea,"mousedown",this.startDragBind),Event.stopObserving(document,"mousemove",this.onDragBind),Event.stopObserving(document,"mouseup",this.endCropBind),this.registerHandles(!1),this.options.captureKeys&&
Event.stopObserving(document,"keypress",this.keysBind))},reset:function(){if(this.attached)this.setParams();else this.onLoad();this.endCrop()},handleKeys:function(a){var b=0,c=0;if(!this.dragging){switch(a.keyCode){case 37:b=-1;break;case 38:c=-1;break;case 39:b=1;break;case 40:c=1}if(0!==b||0!==c)a.shiftKey&&(b*=10,c*=10),this.moveArea([this.areaCoords.x1+b,this.areaCoords.y1+c]),this.endCrop(),Event.stop(a)}},calcW:function(){return this.areaCoords.x2-this.areaCoords.x1},calcH:function(){return this.areaCoords.y2-
this.areaCoords.y1},moveArea:function(a){this.setAreaCoords({x1:a[0],y1:a[1],x2:a[0]+this.calcW(),y2:a[1]+this.calcH()},!0,!1);this.drawArea()},cloneCoords:function(a){return{x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2}},setAreaCoords:function(a,b,c,d,e){if(b)c=a.x2-a.x1,d=a.y2-a.y1,0>a.x1&&(a.x1=0,a.x2=c),0>a.y1&&(a.y1=0,a.y2=d),a.x2>this.imgW&&(a.x2=this.imgW,a.x1=this.imgW-c),a.y2>this.imgH&&(a.y2=this.imgH,a.y1=this.imgH-d);else if(0>a.x1&&(a.x1=0),0>a.y1&&(a.y1=0),a.x2>this.imgW&&(a.x2=this.imgW),a.y2>this.imgH&&
(a.y2=this.imgH),null!==d&&(0<this.ratioX?this.applyRatio(a,{x:this.ratioX,y:this.ratioY},d,e):c&&this.applyRatio(a,{x:1,y:1},d,e),b=[this.options.minWidth,this.options.minHeight],e=[this.options.maxWidth,this.options.maxHeight],0<b[0]||0<b[1]||0<e[0]||0<e[1])){var g={a1:a.x1,a2:a.x2};a={a1:a.y1,a2:a.y2};var h={min:0,max:this.imgW},l={min:0,max:this.imgH};0===b[0]&&0===b[1]||!c||(0<b[0]?b[1]=b[0]:0<b[1]&&(b[0]=b[1]));0===e[0]&&0===e[0]||!c||(0<e[0]&&e[0]<=e[1]?e[1]=e[0]:0<e[1]&&e[1]<=e[0]&&(e[0]=
e[1]));0<b[0]&&this.applyDimRestriction(g,b[0],d.x,h,"min");1<b[1]&&this.applyDimRestriction(a,b[1],d.y,l,"min");0<e[0]&&this.applyDimRestriction(g,e[0],d.x,h,"max");1<e[1]&&this.applyDimRestriction(a,e[1],d.y,l,"max");a={x1:g.a1,y1:a.a1,x2:g.a2,y2:a.a2}}this.areaCoords=a},applyDimRestriction:function(a,b,c,d,e){if("min"==e?a.a2-a.a1<b:a.a2-a.a1>b)1==c?a.a2=a.a1+b:a.a1=a.a2-b,a.a1<d.min?(a.a1=d.min,a.a2=b):a.a2>d.max&&(a.a1=d.max-b,a.a2=d.max)},applyRatio:function(a,b,c,d){"N"==d||"S"==d?(b=this.applyRatioToAxis({a1:a.y1,
b1:a.x1,a2:a.y2,b2:a.x2},{a:b.y,b:b.x},{a:c.y,b:c.x},{min:0,max:this.imgW}),a.x1=b.b1,a.y1=b.a1,a.x2=b.b2,a.y2=b.a2):(b=this.applyRatioToAxis({a1:a.x1,b1:a.y1,a2:a.x2,b2:a.y2},{a:b.x,b:b.y},{a:c.x,b:c.y},{min:0,max:this.imgH}),a.x1=b.a1,a.y1=b.b1,a.x2=b.a2,a.y2=b.b2)},applyRatioToAxis:function(a,b,c,d){a=Object.extend(a,{});var e=Math.floor((a.a2-a.a1)*b.b/b.a),g=null;1==c.b?(e=a.b1+e,e>d.max&&(e=d.max,g=e-a.b1),a.b2=e):(e=a.b2-e,e<d.min&&(e=d.min,g=e+a.b2),a.b1=e);null!==g&&(b=Math.floor(g*b.a/b.b),
1==c.a?a.a2=a.a1+b:a.a1=a.a2-b);return a},drawArea:function(){var a=this.calcW(),b=this.calcH(),c=[this.areaCoords.x1+"px",this.areaCoords.y1+"px",a+"px",b+"px",this.areaCoords.x2+"px",this.areaCoords.y2+"px",this.img.width-this.areaCoords.x2+"px",this.img.height-this.areaCoords.y2+"px"],d=this.selArea.style;d.left=c[0];d.top=c[1];d.width=c[2];d.height=c[3];a=Math.ceil((a-6)/2)+"px";b=Math.ceil((b-6)/2)+"px";this.handleN.style.left=a;this.handleE.style.top=b;this.handleS.style.left=a;this.handleW.style.top=
b;this.north.style.height=c[1];b=this.east.style;b.top=c[1];b.height=c[3];b.left=c[4];b.width=c[6];b=this.south.style;b.top=c[5];b.height=c[7];b=this.west.style;b.top=c[1];b.height=c[3];b.width=c[0];this.subDrawArea();this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var a=document.createTextNode(" "),b;if(this.isIE)fixEl=this.selArea;else if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0];var c=new Element("div");c.style.visibility=
"hidden";var d=["SE","S","SW"];for(b=0;b<d.length;b++){var e=document.getElementsByClassName("imgCrop_handle"+d[b],this.selArea)[0];e.childNodes.length&&e.removeChild(e.childNodes[0]);e.appendChild(c)}}fixEl.appendChild(a);fixEl.removeChild(a)}},startResize:function(a){this.startCoords=this.cloneCoords(this.areaCoords);this.resizing=!0;this.resizeHandle=Event.element(a).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,"");Event.stop(a)},startDrag:function(a){this.selArea.show();this.clickCoords=
this.getCurPos(a);this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},!1,!1,null);this.dragging=!0;this.onDrag(a);Event.stop(a)},getCurPos:function(a){for(var b=this.imgWrap,c=Element.cumulativeOffset(b);"BODY"!=b.nodeName;)c[1]-=b.scrollTop||0,c[0]-=b.scrollLeft||0,b=b.parentNode;return{x:Event.pointerX(a)-c[0],y:Event.pointerY(a)-c[1]}},onDrag:function(a){if(this.dragging||this.resizing){var b=null,c=this.getCurPos(a),d=this.cloneCoords(this.areaCoords),
e={x:1,y:1};this.dragging?(c.x<this.clickCoords.x&&(e.x=-1),c.y<this.clickCoords.y&&(e.y=-1),this.transformCoords(c.x,this.clickCoords.x,d,"x"),this.transformCoords(c.y,this.clickCoords.y,d,"y")):this.resizing&&(b=this.resizeHandle,b.match(/E/)?(this.transformCoords(c.x,this.startCoords.x1,d,"x"),c.x<this.startCoords.x1&&(e.x=-1)):b.match(/W/)&&(this.transformCoords(c.x,this.startCoords.x2,d,"x"),c.x<this.startCoords.x2&&(e.x=-1)),b.match(/N/)?(this.transformCoords(c.y,this.startCoords.y2,d,"y"),
c.y<this.startCoords.y2&&(e.y=-1)):b.match(/S/)&&(this.transformCoords(c.y,this.startCoords.y1,d,"y"),c.y<this.startCoords.y1&&(e.y=-1)));this.setAreaCoords(d,!1,a.shiftKey,e,b);this.drawArea();Event.stop(a)}},transformCoords:function(a,b,c,d){var e=[a,b];a>b&&e.reverse();c[d+"1"]=e[0];c[d+"2"]=e[1]},endCrop:function(){this.resizing=this.dragging=!1;this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}});
Cropper.ImgWithPreview=Class.create(Cropper.Img,{subInitialize:function(){this.hasPreviewImg=!1;"undefined"!=typeof this.options.previewWrap&&0<this.options.minWidth&&0<this.options.minHeight&&(this.previewWrap=$(this.options.previewWrap),this.previewImg=this.img.cloneNode(!1),this.previewImg.id="imgCrop_"+this.previewImg.id,this.hasPreviewImg=this.options.displayOnInit=!0,this.previewWrap.addClassName("imgCrop_previewWrap"),this.previewWrap.setStyle({width:this.options.minWidth+"px",height:this.options.minHeight+
"px"}),this.previewWrap.appendChild(this.previewImg))},subDrawArea:function(){if(this.hasPreviewImg){var a=this.calcW(),b=this.calcH(),c=Math.ceil(this.imgH/b*this.options.minHeight)+"px",d="-"+Math.ceil(this.areaCoords.x1/(a/this.options.minWidth))+"px";b="-"+Math.ceil(this.areaCoords.y1/(b/this.options.minHeight))+"px";var e=this.previewImg.style;e.width=Math.ceil(this.imgW/a*this.options.minWidth)+"px";e.height=c;e.left=d;e.top=b}}});
if("undefined"==typeof unityObject)var unityObject=function(){function a(a,b,c){if("installed"==a){if(null==Y||"installed"==Y)return}else if(null!=Y)return;Y=a;sa.send(a,b,c)}function b(a,b,c,d){Y=a;sa.send(a,b,c,d)}function c(a){a=new RegExp(escape(a)+"=([^;]+)");return a.test(t.cookie+";")?(a.exec(t.cookie+";"),RegExp.$1):!1}function d(a){O?a():Z[Z.length]=a}function e(){if(!O){try{var a=t.getElementsByTagName("body")[0],b=a.appendChild(t.createElement("span"));a.removeChild(b)}catch(V){return}O=
!0;for(a=0;a<Z.length;++a)Z[a]()}}function g(a){if("undefined"!=typeof D.addEventListener)D.addEventListener("load",a,!1);else if("undefined"!=typeof t.addEventListener)t.addEventListener("load",a,!1);else if("undefined"!=typeof D.attachEvent)h(D,"onload",a);else if("function"==typeof window.onload){var b=window.onload;D.onload=function(){b();a()}}else D.onload=a}function h(a,b,c){a.attachEvent(b,c);da[da.length]={target:a,type:b,event:c}}function l(a){var b=0;if(a&&(a=a.toLowerCase().match(/^(\d+)(?:\.(\d+)(?:\.(\d+)([dabfr])?(\d+)?)?)?$/))&&
a[1]){var c=a[1],d=a[3]?a[3]:0,e=a[4]?a[4]:"r",f=a[5]?a[5]:0;b=b|c/10%10<<28|c%10<<24|(a[2]?a[2]:0)%10<<20;b=b|d%10<<16|{d:8192,a:16384,b:24576,f:32768,r:32768}[e];b|=f/100%10<<8;b|=f/10%10<<4;b|=f%10}return b}function f(a,b){var c=t.getElementsByTagName("body")[0],d=t.createElement("object");if(c&&d){d.setAttribute("type","application/vnd.unity");d.style.visibility="hidden";c.appendChild(d);var e=0;(function(){if("undefined"==typeof d.GetPluginVersion)10>e++?setTimeout(arguments.callee,10):(c.removeChild(d),
a(null));else{var f={};if(b)for(var g=0;g<b.length;++g)f[b[g]]=d.GetUnityVersion(b[g]);f.plugin=d.GetPluginVersion();c.removeChild(d);a(f)}})()}else a(null)}function m(b,c){var d="missing";E.plugins.refresh();if("undefined"!=typeof E.plugins&&E.plugins["Unity Player"]&&"undefined"!=typeof E.mimeTypes&&E.mimeTypes["application/vnd.unity"]&&E.mimeTypes["application/vnd.unity"].enabledPlugin){d="installed";if(u.sf&&/Mac OS X 10_6/.test(E.appVersion)){f(function(c){c&&c.plugin||(d="broken",y="OSX10.6-SFx64");
a(d,W,y);b(d,c)},c);return}if(u.mac&&u.ch){f(function(c){c&&(l(c.plugin)<=l("2.6.1f3")||l(c.plugin)<l(unityObject.minRequiredVersion))&&(d="broken",y="OSX-CH-U<=2.6.1f3");a(d,W,y);b(d,c)},c);return}if(c){f(function(c){l(c.plugin)<l(unityObject.minRequiredVersion)&&(d="broken");a(d,W,y);b(d,c)},c);return}}else if(u.ie)try{var e=new ActiveXObject("UnityWebPlayer.UnityWebPlayer.1"),g=e.GetPluginVersion();if(c){for(var h={},A=0;A<c.length;++A)h[c[A]]=e.GetUnityVersion(c[A]);h.plugin=g}d="installed";if("2.5.0f5"==
g){var m=/Windows NT \d+\.\d+/.exec(E.userAgent);if(m&&0<m.length&&6<=parseFloat(m[0].split(" ")[2])){d="broken";var y="WIN-U2.5.0f5"}}l(g)<l(unityObject.minRequiredVersion)&&(d="broken")}catch(wa){y=u.win&&u.ie&&u.x64?"WIN-IEx64":"ActiveXFailed"}a(d,W,y);b(d,h)}function r(a){/^[-+]?[0-9]+$/.test(a)&&(a+="px");return a}function q(a,b,c,d){var e=t.getElementById(a);if(e){if(u.win&&u.ie){var f="",g;for(g in b)b[g]!=Object.prototype[g]&&("styleclass"==g.toLowerCase()?f+=' class="'+b[g]+'"':"classid"!=
g.toLowerCase()&&(f+=" "+g+'="'+b[g]+'"'));var h="";for(g in c)c[g]!=Object.prototype[g]&&"classid"!=g.toLowerCase()&&(h+='<param name="'+g+'" value="'+c[g]+'" />');e.outerHTML='<div id="'+a+'" style="width: '+r(b.width)+"; height: "+r(b.height)+'; visibility: hidden;"><object classid="clsid:444785F1-DE89-4295-863A-D46C3A781394" style="display: block; width: 100%; height: 100%;"'+f+">"+h+"</object></div>";ea[ea.length]=a}else{f=t.createElement("div");f.setAttribute("id",a);f.style.width=r(b.width);
f.style.height=r(b.height);f.style.visibility="hidden";h=t.createElement("embed");h.setAttribute("type","application/vnd.unity");h.style.display="block";h.style.width="100%";h.style.height="100%";for(g in b)b[g]!=Object.prototype[g]&&("styleclass"==g.toLowerCase()?h.setAttribute("class",b[g]):"classid"!=g.toLowerCase()&&h.setAttribute(g,b[g]));for(g in c)c[g]!=Object.prototype[g]&&"classid"!=g.toLowerCase()&&h.setAttribute(g,c[g]);f.appendChild(h);e.parentNode.replaceChild(f,e)}ca(a,function(b){b?
(b.parentNode.style.visibility="visible",u.sf&&u.mac||setTimeout(function(){b.focus()},100)):J(a);if(d){var c;b||(c="UnityElementNotFound");d({success:!!b,id:a,ref:b,type:W,error:c})}})}else d&&d({success:!1,id:a,type:W,error:"UnityElementNotFound"})}function x(a,b){for(var c in a)if(c.toLowerCase()==b){a=a[c];if(/^((?:[\da-f]){2}){3,4}$/i.test(a))return a.substr(0,6);break}return null}function v(a,b,c,d,e){var f=t.getElementById(a);if(f){var g=r(b.width);b=r(b.height);var h=x(c,"backgroundcolor"),
A=x(c,"textcolor"),l=x(c,"bordercolor");u.win&&u.ie&&(c="font-family: Verdana; font-size: 12px; text-align: center;",h&&(c+=" background-color: #"+h+";"),A&&(c+=" color: #"+A+";"),l&&(c+=" border: 1px solid #"+l+";"),h="",R&&(c+=" width: "+g+"; height: "+b+";",h="width: "+g+"; line-height: "+b+";"),f.outerHTML='<div id="'+a+'" style="'+c+'"><span style="'+h+'">'+e+"</span></div>")}d&&d({success:!1,id:a,error:e})}function I(a,d,e,f,h,A,l){preInstallCallback=va[a];var m=t.getElementById(a);if(m){var y=
"standard";if(fa&&u.java&&!ha&&!c("_unity_triedjava")){ia[a]={attributes:d,params:e,callback:f,broken:h};var z="javascript:unityObject.doJavaInstall('"+a+"');";y="java"}else la&&u.co?(z=C+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(C+w()),y="clickonce"):u.win?z=C+w():"MacIntel"==E.platform?(z=C+(aa?"webplayer-i386.dmg":"webplayer-mini.dmg"),L&&(z+="?referrer="+L)):"MacPPC"==E.platform?(z=C+(aa?"webplayer-ppc.dmg":"webplayer-mini.dmg"),L&&(z+="?referrer="+L)):(z='javascript:window.open("http://unity3d.com/webplayer/");',
y="unsupported");b("ready",y);if(h){var M="Unity Web Player. Install now! Restart your browser after install.",ra=ma+"/installation/getunityrestart.png";h=190;var H=75}else M="Unity Web Player. Install now!",ra=ma+"installation/getunity.png",h=193,H=63;var q=d.width||h;d=d.height||H;var ua=r(-parseInt(H)),V="unityObject.notifyBeginInstall('"+a+"','"+y+"');unityObject.setInstallStatus('start','"+y+"',null";V="clickonce"!=y?V+(",'"+z.replace(/'/g,"\\'")+"');"):V+(");document.location='"+z+"';");V+=
"return false;";var p=x(e,"backgroundcolor"),na=x(e,"textcolor");e=x(e,"bordercolor");var ta=a+"_img";if(u.win&&u.ie){var v='<img id="'+ta+'" alt="'+M+'" src="'+ra+'" width="'+h+'" height="'+H+'" style="border-width: 0px;" />';z='<a href="'+z+'" title="'+M+'" onclick="'+V+'"';R&&(z+=' style="display: block; height: '+r(H)+"; position: relative; top: "+ua+';"');z+=">"+v+"</a>";H="";p&&(H+=" background-color: #"+p+";");na&&(H+=" color: #"+na+";");e&&(H+=" border: 1px solid #"+e+";");R?(h='<div style="width: '+
r(h)+'; margin: auto; position: relative;">'+z+"</div>",m.outerHTML='<div id="'+a+'" style="width: '+r(q)+"; height: "+r(d)+"; text-align: center;"+H+'">'+h+"</div>"):m.outerHTML='<div id="'+a+'" style="'+H+'">'+z+"</div>"}else{var Q=t.createElement("div");Q.setAttribute("id",a);p&&(Q.style.backgroundColor="#"+p);na&&(Q.style.color="#"+na);e&&(Q.style.border="1px solid #"+e);R&&(Q.style.width=r(q),Q.style.height=r(d),v=t.createElement("div"),v.style.width=r(h),v.style.margin="auto",v.style.position=
"relative");q=t.createElement("a");q.setAttribute("href",z);q.setAttribute("title",M);q.setAttribute("onclick",V);R&&(q.style.display="block",q.style.height=r(H),q.style.position="relative",q.style.top=ua);z=t.createElement("img");z.setAttribute("id",ta);z.setAttribute("alt",M);z.setAttribute("src",ra);z.setAttribute("width",h);z.setAttribute("height",H);z.style.borderWidth="0px";q.appendChild(z);R?(v.appendChild(q),Q.appendChild(v)):Q.appendChild(q);m.parentNode.replaceChild(Q,m)}ba(a,!0)}f&&f({success:!1,
id:a,type:A,error:l});preInstallCallback&&preInstallCallback({id:a,type:y});W=y;oa?"java"==y?(b("start",y),N(a)):"clickonce"!=y||K||(K=!0,g(function(){b("start",y);t.location=C+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(C+w())})):"java"==y&&ja&&(ka.push(ta),n(a+"_java"))}function w(){var a=aa?"UnityWebPlayerFull.exe":"UnityWebPlayer.exe";L&&(a+="?referrer="+L);return a}function B(a,b,c){if(u.win&&u.ie){var d="",e;for(e in a)d+=" "+e+'="'+a[e]+'"';a="";for(e in b)a+='<param name="'+
e+'" value="'+b[e]+'" />';c.outerHTML="<object"+d+">"+a+"</object>"}else{d=t.createElement("object");for(e in a)d.setAttribute(e,a[e]);for(e in b)a=t.createElement("param"),a.name=e,a.value=b[e],d.appendChild(a);c.parentNode.replaceChild(d,c)}}function G(a){return"undefined"==typeof a||!a.complete||"undefined"!=typeof a.naturalWidth&&0==a.naturalWidth?!1:!0}function n(a){var b=!1;for(i=0;i<ka.length;i++)ka[i]&&(G(t.images[ka[i]])?ka[i]=null:b=!0);b?setTimeout(arguments.callee,100):setTimeout(function(){var b=
t.getElementById(a);b||(b=t.createElement("div"),t.body.insertBefore(b,t.body.lastChild.nextSibling));B({id:a,type:"application/x-java-applet",code:"JVMPreloader",width:1,height:1,name:"JVM Preloader"},{context:a,codebase:C+"3.0/jws/",classloader_cache:!1,scriptable:!0,mayscript:!0},b);ba(a,!0)},100)}function N(a){var b=ha=!0;document.cookie=escape("_unity_triedjava")+"="+escape(b)+"; path=/";b=t.getElementById(a);var c=ia[a],d={id:a,type:"application/x-java-applet",archive:C+"3.0/jws/UnityWebPlayer.jar",
code:"UnityWebPlayer",width:c.attributes.width||600,height:c.attributes.height||450,name:"Unity Web Player"};u.win&&u.ff&&(d.style="visibility: hidden;");var e=C+"3.0/jws/UnityWebPlayer.jnlp",f=C;if(u.win)var g=w();else g="UnityPlayer.plugin.zip",L&&(g+="?referrer="+L);e={context:a,jnlp_href:e,classloader_cache:!1,installer:f+g,image:ma+"installation/unitylogo.png",centerimage:!0,boxborder:!1,scriptable:!0,mayscript:!0};for(var h in c.params)"src"!=h&&c.params[h]!=Object.prototype[h]&&(e[h]=c.params[h],
"logoimage"==h.toLowerCase()?e.image=c.params[h]:"backgroundcolor"==h.toLowerCase()?e.boxbgcolor="#"+c.params[h]:"bordercolor"==h.toLowerCase()?e.boxborder=!0:"textcolor"==h.toLowerCase()&&(e.boxfgcolor="#"+c.params[h]));B(d,e,b);ba(a,!0)}function U(a){setTimeout(function(){var b=t.getElementById(a);b&&b.parentNode.removeChild(b)},0)}function J(a){var b=t.getElementById(a);if(b){if(u.win&&u.ie){var c=b.firstChild;if(c&&"OBJECT"==c.nodeName){b.style.display="none";(function(){if(4==c.readyState){for(var a in c)"function"==
typeof c[a]&&(c[a]=null);b.parentNode.removeChild(b)}else setTimeout(arguments.callee,10)})();return}}b.parentNode.removeChild(b)}}function ca(a,b){a=t.getElementById(a);if(!a)return b&&b(null),null;var c;u.win&&u.ie?(a=a.getElementsByTagName("object")[0])&&"OBJECT"==a.nodeName&&(c=a):(a=a.getElementsByTagName("embed")[0])&&"EMBED"==a.nodeName&&(c=a);return function(){if(c&&"undefined"==typeof c.GetPluginVersion)return b&&setTimeout(arguments.callee,10),null;b&&b(c);return c}()}function ba(a,b){if(pa)if(b=
b?"visible":"hidden",O&&t.getElementById(a))t.getElementById(a).style.visibility=b;else if(a="#"+a,b="visibility: "+b+";",!u.mac||!u.ie){var c=t.getElementsByTagName("head")[0];if(c){if(!S||"screen"!=qa){var d=t.createElement("style");d.setAttribute("type","text/css");d.setAttribute("media","screen");S=c.appendChild(d);u.win&&u.ie&&"undefined"!=typeof t.styleSheets&&0<t.styleSheets.length&&(S=t.styleSheets[t.styleSheets.length-1]);qa="screen"}u.win&&u.ie&&"object"==typeof S.addRule?S.addRule(a,b):
S&&"undefined"!=typeof t.createTextNode&&S.appendChild(t.createTextNode(a+" { "+b+" }"))}}}function p(){for(var a in da)try{var b=da[a];b.target.detachEvent(b.type,b.event)}catch(V){}for(a in ea)J(ea[a]);for(a in u)u[a]=null;u=null;for(a in unityObject)unityObject[a]=null;unityObject=null}function T(a,b,c){var d={},e=-1;if(a&&"object"==typeof a)for(var f in a)d[f]=a[f],"tabindex"==f.toLowerCase()&&(e=d[f]);d.width=b;d.height=c;-1==e&&(d.tabIndex=0);return d}function F(a,b){var c="unityObject.firstFrameCallback();",
d={};if(a&&"object"==typeof a)for(var e in a)d[e]=a[e],"firstframecallback"==e.toLowerCase()&&(d[e]=c+d[e],c=null);c&&(d.firstFrameCallback=c);d.src=b;return d}var D=window,t=document,E=navigator,O=!1,Z=[],ea=[],da=[],S=null,qa=null,pa=!0,R=!0,X="https:"==document.location.protocol,P=X?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",ma=X?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",C=P+"download_webplayer-3.x/",aa=!1,oa=!1,fa=!0,ja=!1,ha=c("_unity_triedjava"),
ia=[],la=!0,K=!1,A=!X&&!1,y=!0,M=!1,W=null,H=[],va=[],ka=[],L=null,Y=null,u=function(){function a(a,b){for(var c=0;c<Math.max(a.length,b.length);++c){var d=c<a.length&&a[c]?new Number(a[c]):0,e=c<b.length&&b[c]?new Number(b[c]):0;if(d<e)return-1;if(d>e)return 1}return 0}var b=E.userAgent,c=E.platform,d=!1;/msie/i.test(b)?d=parseFloat(b.replace(/^.*msie ([0-9]+(\.[0-9]+)?).*$/i,"$1")):/Trident/i.test(b)&&(d=parseFloat(b.replace(/^.*rv:([0-9]+(\.[0-9]+)?).*$/i,"$1")));var e={w3:"undefined"!=typeof t.getElementById&&
"undefined"!=typeof t.getElementsByTagName&&"undefined"!=typeof t.createElement,win:c?/win/i.test(c):/win/i.test(b),mac:c?/mac/i.test(c):/mac/i.test(b),ie:d,ff:/firefox/i.test(b),ch:/chrome/i.test(b),sf:/safari/i.test(b),wk:/webkit/i.test(b)?parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/i,"$1")):!1,x64:/win64/i.test(b)&&/x64/i.test(b),moz:/mozilla/i.test(b)?parseFloat(b.replace(/^.*mozilla\/([0-9]+(\.[0-9]+)?).*$/i,"$1")):0};c=t.getElementsByTagName("script");for(d=0;d<c.length;++d){var f=c[d].src.match(/^(.*)3\.0\/uo\/UnityObject\.js$/i);
if(f){C=f[1];break}}e.java=function(){if(E.javaEnabled()){var b=e.win&&e.ff;if(b){if("undefined"!=typeof E.mimeTypes){var c=b?[1,6,0,12]:[1,4,2,0];for(b=0;b<E.mimeTypes.length;++b)if(E.mimeTypes[b].enabledPlugin){var d=E.mimeTypes[b].type.match(/^application\/x-java-applet;(?:jpi-)?version=(\d+)(?:\.(\d+)(?:\.(\d+)(?:_(\d+))?)?)?$/);if(null!=d&&0>=a(c,d.slice(1)))return!0}}}else if(e.win&&e.ie&&"undefined"!=typeof ActiveXObject){b=function(a){try{return null!=new ActiveXObject("JavaWebStart.isInstalled."+
a+".0")}catch(xa){return!1}};if(b("1.7.0"))return!0;if(8<=e.ie){if(b("1.6.0"))for(b=12;50>=b;++b){try{c=null!=new ActiveXObject("JavaPlugin.160_"+b)}catch(wa){c=!1}if(c&&!(9==e.ie&&5==e.moz&&24>b))return!0}}else return b("1.6.0")||b("1.5.0")||b("1.4.2")}}return!1}();e.co=function(){if(e.win&&e.ie){var c=b.match(/(\.NET CLR [0-9.]+)|(\.NET[0-9.]+)/g);if(null!=c)for(var d=[3,5,0],f=0;f<c.length;++f){var g=c[f].match(/[0-9.]{2,}/g)[0].split(".");if(0>=a(d,g))return!0}}return!1}();return e}(),sa=function(){function a(a,
b,e,f){if(A){a="http://unityanalyticscapture.appspot.com/event?u="+encodeURIComponent(c)+"&s="+encodeURIComponent(d)+"&e="+encodeURIComponent(a);L&&(a+="?r="+L);b&&(a+="&t="+encodeURIComponent(b));e&&(a+="&d="+encodeURIComponent(e));var g=new Image;if(f){var h=null;g.onload=g.onerror=function(){clearTimeout(h);g.onload=g.onerror=null;f()};h=setTimeout(g.onload,3E3)}g.src=a}else f&&f()}function b(a,b,c,d){if(y){var e=window._ugaq=window._ugaq||[];M||e.push(["unity._setAccount","UA-16068464-16"]);a=
"/webplayer/install/"+a;var f="?";b&&(a+=f+"t="+encodeURIComponent(b),f="&");c&&(a+=f+"d="+encodeURIComponent(c),f="&");if(d){b=function(){unityObject.googleAnalyticsCallback=null;clearTimeout(g);d()};unityObject.googleAnalyticsCallback=b;var g=setTimeout(b,3E3)}e.push(["unity._trackPageview",a]);if(!M){e=C+"3.0/uo/ga.js";b=t.getElementsByTagName("script");for(c=0;c<b.length;++c)if(b[c].src&&b[c].src.toLowerCase()==e.toLowerCase()){M=!0;break}M||(M=!0,b=t.createElement("script"),b.type="text/javascript",
b.async=!0,b.src=e,e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(b,e))}}else d&&d()}var c=function(){var a=new Date;return Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDay(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds()).toString(16)+Math.floor(2147483647*Math.random()).toString(16)}(),d=0;return{send:function(c,e,f,g){function h(){0==--A&&(location.href=g)}++d;var A=2;a(c,e,f,g?h:null);b(c,e,f,g?h:null)}}}();(function(){u.w3&&(("undefined"!=
typeof t.readyState&&"complete"==t.readyState||"undefined"==typeof t.readyState&&(t.getElementsByTagName("body")[0]||t.body))&&e(),O||("undefined"!=typeof t.addEventListener?t.addEventListener("DOMContentLoaded",e,!1):u.win&&u.ie&&(t.attachEvent("onreadystatechange",function(){"complete"==t.readyState&&(t.detachEvent("onreadystatechange",arguments.callee),e())}),D==top&&function(){if(!O){try{t.documentElement.doScroll("left")}catch(z){setTimeout(arguments.callee,10);return}e()}}()),u.wk&&function(){O||
(/loaded|complete/.test(t.readyState)?e():setTimeout(arguments.callee,10))}(),g(e)))})();(function(){if(u.win&&u.ie)if("undefined"!=typeof D.attachEvent)h(D,"onunload",p);else if("function"==typeof D.onunload){var a=D.onunload;D.onunload=function(){a();p()}}else D.onunload=p})();return{missingUnityId:null,minRequiredVersion:"3.0.0",embedUnity:function(a,b,c,e,f,g,h){u.w3&&!(u.wk&&312>u.wk)&&a&&b&&c&&e?d(function(){var d=T(g,c,e),A=F(f,b);m(function(b){"installed"==b?q(a,d,A,h):"unsupported"==b?v(a,
d,A,h,"Unsupported browser."):(I(unityObject.missingUnityId||a,d,A,h,"broken"==b,null,"NotInstalled"),function(){var b=arguments.callee;m(function(c){"installed"==c?(ba(a,!1),q(a,d,A,h)):setTimeout(b,500)})}())})}):h&&h({success:!1,id:a})},addPreInstallCallback:function(a,b){va[a]=b},addBeginInstallCallback:function(a,b){H[a]=b},getObjectById:function(a,b){if(u.w3&&a)return ca(a,b);b&&b(null);return null},setAutoHideShow:function(a){pa=a},setFullSizeMissing:function(a){R=a},enableFullInstall:function(a){aa=
a},enableAutoInstall:function(a){oa=a},enableJavaInstall:function(a){fa=a},enableJavaPreloading:function(a,b){ja=a;"undefined"!=typeof b&&(ka=b)},enableClickOnceInstall:function(a){la=a},enableAnalytics:function(a){A=!X&&a;y=a},enableUnityAnalytics:function(a){A=!X&&a},enableGoogleAnalytics:function(a){y=a},setBaseDomain:function(a){var b=P;P=a;"/"!=P[P.length-1]&&(P+="/");C=P+C.substr(b.length)},setBaseDownloadUrl:function(a){C=a;"/"!=C[C.length-1]&&(C+="/");P=a.match(/([^:]*):\/\/([^/]*)/)[0]+"/"},
setReferrer:function(a){L=a?encodeURIComponent(a):a},addLoadEvent:g,addDomLoadEvent:d,ua:u,detectUnity:function(a,b){!u.w3||u.wk&&312>u.wk||!a?a&&a("missing"):d(function(){m(a,b)})},createUnity:function(a,b,c,d){u.w3&&!(u.wk&&312>u.wk)&&a&&b&&c&&d?q(a,c,b,d):d&&d({success:!1,id:a})},removeUnity:function(a){u.w3&&J(a)},notifyBeginInstall:function(a,b){(callback=H[a])&&callback({id:a,type:b})},setInstallStatus:function(a,c,d,e){b(a,c,d,e)},doJavaInstall:function(a){N(a)},jvmPreloaded:function(a){U(a)},
appletStarted:function(a){},javaInstallDone:function(a,b,c){setTimeout('unityObject.javaInstallDoneDirect("'+a+'", '+b+', "'+c+'");',0)},javaInstallDoneDirect:function(a,c,d){c||(c=ia[a],b("error","java",d),I(unityObject.missingUnityId||a,c.attributes,c.params,c.callback,c.broken,"java",d))},firstFrameCallback:function(){var a=W;null!=Y&&(Y="first",sa.send("first",a,void 0))}}}();
function addDOMLoadEvent(a){if(!window.__load_events){var b=function(){if(!arguments.callee.done){arguments.callee.done=!0;window.__load_timer&&(clearInterval(window.__load_timer),window.__load_timer=null);for(var a=0;a<window.__load_events.length;a++)window.__load_events[a]();window.__load_events=null}};document.addEventListener&&document.addEventListener("DOMContentLoaded",b,!1);/WebKit/i.test(navigator.userAgent)&&(window.__load_timer=setInterval(function(){/loaded|complete/.test(document.readyState)&&
b()},10));window.onload=b;window.__load_events=[]}window.__load_events.push(a)}
function tabset(){if(!document.getElementById)return!1;var a=document.getElementsByTagName("dl"),b;for(k=0;k<a.length;k++){var c=a[k];if(-1!=c.className.indexOf("tabset")){var d=0,e=c.getElementsByTagName("dd");for(i=0;i<e.length;i++)e[i].parentNode==c&&(0===i?b=e.item(0):e[i].style.display="none",e[i].count=d++);d=[];e=c.getElementsByTagName("dt");for(i=0;i<e.length;i++)e[i].parentNode==c&&(d[d.length]=e[i]);c=[];for(i=0;i<d.length;i++)d[i].transformed_to_tab||(d[i].transformed_to_tab=!0,d[i].count=
i,d[i].onclick=toggleDt,d[i].innerHTML="<a href='#' title='"+d[i].innerHTML+"'>"+d[i].innerHTML+"</a>",d[i].parentNode.removeChild(d[i]),b.parentNode.insertBefore(d[i],b)),0<=d[i].className.indexOf("active")&&(c[c.length]=d[i]);for(i=0;i<c.length;i++)c[i].onclick()}}}
function toggleDt(){var a=this.parentNode.getElementsByTagName("dt");for(i=0;i<a.length;i++)this==a[i]&&0<=this.className.indexOf("dormant")&&-1==this.className.indexOf("active")&&a[i].parentNode==this.parentNode?(this.className+=" active",this.className=this.className.replace(/(?:^\s*|\s*$)/,"")):this!=a[i]&&a[i].parentNode==this.parentNode&&(a[i].className=a[i].className.replace("active","dormant"));a=this.parentNode.getElementsByTagName("dd");for(i=0;i<a.length;i++)a[i].parentNode==this.parentNode&&
(a[i].style.display=this.count==a[i].count?"block":"none");return!1}addDOMLoadEvent(tabset);
var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(e,g,h){var l=dateFormat;1!=arguments.length||"[object String]"!=Object.prototype.toString.call(e)||/\d/.test(e)||(g=e,e=void 0);e=e?new Date(e):new Date;if(isNaN(e))throw SyntaxError("invalid date");
g=String(l.masks[g]||g||l.masks["default"]);"UTC:"==g.slice(0,4)&&(g=g.slice(4),h=!0);var f=h?"getUTC":"get",m=e[f+"Date"](),r=e[f+"Day"](),q=e[f+"Month"](),x=e[f+"FullYear"](),v=e[f+"Hours"](),I=e[f+"Minutes"](),w=e[f+"Seconds"]();f=e[f+"Milliseconds"]();var B=h?0:e.getTimezoneOffset(),G={d:m,dd:d(m),ddd:l.i18n.dayNames[r],dddd:l.i18n.dayNames[r+7],m:q+1,mm:d(q+1),mmm:l.i18n.monthNames[q],mmmm:l.i18n.monthNames[q+12],yy:String(x).slice(2),yyyy:x,h:v%12||12,hh:d(v%12||12),H:v,HH:d(v),M:I,MM:d(I),
s:w,ss:d(w),l:d(f,3),L:d(99<f?Math.round(f/10):f),t:12>v?"a":"p",tt:12>v?"am":"pm",T:12>v?"A":"P",TT:12>v?"AM":"PM",Z:h?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(0<B?"-":"+")+d(100*Math.floor(Math.abs(B)/60)+Math.abs(B)%60,4),S:["th","st","nd","rd"][3<m%10?0:(10!=m%100-m%10)*m%10]};return g.replace(a,function(a){return a in G?G[a]:a.slice(1,a.length-1)})}}();
dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:"Sun Mon Tue Wed Thu Fri Sat Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),monthNames:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec January February March April May June July August September October November December".split(" ")};
Date.prototype.format=function(a,b){return dateFormat(this,a,b)};function AccomplishmentGroup(a){this.initialize(a)}
AccomplishmentGroup.prototype={initialize:function(a){this._id=a.id;this._scheduled_end=null;a.scheduled_end&&(this._scheduled_end=new Date(a.scheduled_end));this._progress_content=null;this._dueling_group=a.dueling_group;this._name=a.name},id:function(){return this._id},name:function(){return this._name},scheduledEnd:function(){return this._scheduled_end},setProgressContent:function(a){this._progress_content=a},progressContent:function(){return this.expired()?null:this._progress_content},expired:function(){return this._dueling_group&&
active_user.duelingGroup()&&this._dueling_group!=active_user.duelingGroup()||this._scheduled_end&&new Date>this._scheduled_end?!0:!1}};AccomplishmentTask=function(a){this.initialize(a)};AccomplishmentTask.AND_OPERATOR="AND";AccomplishmentTask.OR_OPERATOR="OR";
AccomplishmentTask.prototype={initialize:function(a){this._id=a.id;this._quota=a.quota;this._operator=a.operator;this._statistic=a.statistic;this._current_progress=a.current_progress;this._statistic.addAccomplishmentTask(this)},quota:function(){return this._quota},isAndTask:function(){return AccomplishmentTask.AND_OPERATOR===this._operator},isOrTask:function(){return AccomplishmentTask.OR_OPERATOR===this._operator},id:function(){return this._id},statistic:function(){return this._statistic},progress:function(){return this._current_progress},
isComplete:function(){return 0<=this._statistic.compare(this._quota,this._current_progress)},isUnprogressed:function(){var a=this.progress();return null===a||void 0===a},updateProgress:function(a,b){this.isComplete()||a!==this._statistic.id()||null===b||void 0===b||1>this._statistic.compare(this._current_progress,b)||(this._current_progress=b,this.trigger("progress",this),this.isComplete()&&this.trigger("complete",this))},displayValue:function(){this.statistic().type();return this.isUnprogressed()?
0:this.progress()},percentValue:function(){var a=this.statistic().type();Statistic.ADD_TYPE==a||Statistic.MAX_TYPE==a?this.isUnprogressed()?a=0:(a=this.quota()+0,a=(this.progress()+0)/a*100):a=this.isComplete()?100:0;100<a&&(a=100);return a},purgeProgress:function(){this._current_progress=void 0}};$j.extend(AccomplishmentTask.prototype,Evented);Accomplishment=function(a){this.initialize(a)};
Accomplishment.prototype={initialize:function(a){var b=this;this._tasks=(a.accomplishment_tasks||[]).map(function(c){c.statistic=a.statisticProvider(c.statistic_id);c=new AccomplishmentTask(c);c.on("complete",function(a){b.trigger("task-complete",a)});c.on("progress",function(a){b.trigger("task-progress",a)});return c});this._id=a.id;this._dom_id=a.dom_id;this._level=a.level;this._badge_id=a.badge_id;this._card_id=a.card_id;this._raffle_id=a.raffle_id;this._item_id=a.item_id;this._reward_points=a.reward_points;
this._badge_of_the_day=a.badge_of_the_day;this._hidden=a.hidden;this._has_completion_tab_been_shown=!1;a.accomplishment_group&&(this._accomplishment_group=new AccomplishmentGroup(a.accomplishment_group));a.scheduled_end&&(this._scheduled_end=new Date(1E3*a.scheduled_end))},id:function(){return this._id},domId:function(){return this._dom_id},tasks:function(){return this._tasks},andTasks:function(){return this.tasks().select(function(a){return a.isAndTask()})},orTasks:function(){return this.tasks().select(function(a){return a.isOrTask()})},
isComplete:function(){if(this._complete)return!0;var a=!0;0<this.andTasks().length&&this.andTasks().any(function(a){return!a.isComplete()})&&(a=!1);a&&0<this.orTasks().length&&this.orTasks().all(function(a){return!a.isComplete()})&&(a=!1);a&&(this._complete=!0);return a},isAchievement:function(){return this._level?!0:!1},isBadgeOfTheDay:function(){return this._badge_of_the_day},rank:function(){return[null,"badge_of_the_day","easy","medium","hard","impossible"].indexOf(this._level)},scheduledEnd:function(){return this._scheduled_end},
isActive:function(){return this.scheduledEnd()?this.scheduledEnd()>=new Date:!0},isHidden:function(){return this._hidden},updateProgress:function(a,b){this.isComplete()||(this._tasks.forEach(function(c){c.updateProgress(a,b)}),this.isComplete()&&this.trigger("complete",this))},purgeProgress:function(){this._complete=!1;this.tasks().invoke("purgeProgress")},prizeName:function(){return this._card_id?"card":this._badge_id?"badge":this._raffle_id?"ticket":this._reward_points?"points":"reward"},hasCompletionTabBeenShown:function(){return this._has_completion_tab_been_shown},
setHasCompletionTabBeenShown:function(){this._has_completion_tab_been_shown=!0},accomplishmentGroup:function(){return this._accomplishment_group},setAccomplishmentGroupProgressContent:function(a){this._accomplishment_group.setProgressContent(a)},accomplishmentGroupProgressContent:function(){var a=this.accomplishmentGroup();if(a)return a.progressContent()},hasCompleteAccomplishmentGroup:function(){return this.accomplishmentGroup()&&!this.accomplishmentGroup().expired()&&!this.accomplishmentGroup().progressContent()},
hasItem:function(){return!!this._item_id}};$j.extend(Accomplishment.prototype,Evented);Statistic=function(a){this.initialize(a)};Statistic.ADD_TYPE="Add";Statistic.MAX_TYPE="Max";Statistic.MIN_TYPE="Min";Statistic.REPLACE_TYPE="Replace";Statistic.LOW="low";Statistic.MEDIUM="medium";Statistic.HIGH="high";Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL=12E4;Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL=3E4;Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL=15E3;
Statistic.betterThanForType=function(a,b,c){return Statistic.ADD_TYPE===c?!1:null===a||void 0===a||isNaN(a)?!0:Statistic.MIN_TYPE===c?b<a:Statistic.MAX_TYPE===c?b>a:b!=a};Statistic.sortOnSentAt=function(a){return a.sort(function(a,c){return a.sentAt()===c.sentAt()?0:a.sentAt()<c.sentAt()?-1:1})};
Statistic.prototype={initialize:function(a){this._stat_type=a.stat_type;this._id=a.id;this._name=a.name;this._display_name=a.display_name;this._display_in_table=a.display_in_table;this._tasks=(a.tasks||[]).slice();this.reset()},reset:function(){this._sent_at=this.getTime();this._pending_value=this._saved_value=this.type()===Statistic.ADD_TYPE?0:null;this._current_value=null},name:function(){return this._name},displayName:function(){return this._display_name||this._name},id:function(){return this._id},
type:function(){return this._stat_type},displayInTable:function(){return this._display_in_table},valueToSend:function(){return this._current_value},value:function(){return Statistic.ADD_TYPE===this.type()?this._saved_value+this._pending_value+this._current_value:this._current_value},pendingValue:function(){return this._pending_value},setPendingValue:function(a){this._pending_value=a},savedValue:function(){return this._saved_value},setSavedValue:function(a){this._saved_value=a},addAccomplishmentTask:function(a){this._tasks.push(a)},
sentAt:function(){return this._sent_at},markAsSent:function(){this._sent_at=this.getTime();Statistic.ADD_TYPE===this.type()?(this._pending_value+=this._current_value,this._current_value=0):this._pending_value=this._current_value},resetPendingValue:function(){Statistic.ADD_TYPE===this.type()?(this._current_value+=this._pending_value,this._pending_value=0):this._pending_value=null},priority:function(){return this.hasIncompleteTasks()?Statistic.HIGH:this._display_in_table?Statistic.MEDIUM:Statistic.LOW},
hasIncompleteTasks:function(){return 0<this.incompleteTasks().length},incompleteTasks:function(){var a=this.value(),b=this.type(),c=this;return null===a||void 0===a?this._tasks.slice():this._tasks.filter(function(d){return d.isComplete()?!1:Statistic.MIN_TYPE===b?a>d.quota():Statistic.ADD_TYPE===b?a-c._saved_value+d.progress()<d.quota():a<d.quota()})},pending:function(){return this.type()===Statistic.ADD_TYPE?null!==this._pending_value&&0!==this._pending_value:null!==this._pending_value},attemptUpdate:function(a){var b=
!1,c=this.incompleteTasks();Statistic.ADD_TYPE===this.type()?(this._current_value+=a,b=0!==a):this.betterThanCurrentValue(a)&&(this._current_value=a,b=!0);b&&c.length!=this.incompleteTasks().length&&(Kongregate.Log.debug("Incomplete tasks list for "+this.name()+" changed"),this._sent_at=0);return b},betterThanCurrentValue:function(a){return Statistic.betterThanForType(this.value(),a,this.type())},betterThanSavedValue:function(a){return Statistic.betterThanForType(this._saved_value,a,this.type())},
betterThanPendingValue:function(a){return Statistic.betterThanForType(this._pending_value,a,this.type())},dirty:function(){var a=this.valueToSend();return isNaN(a)||null===a||void 0===a?!1:Statistic.ADD_TYPE===this.type()?0!==a:this.betterThanSavedValue(a)&&this.betterThanPendingValue(a)},minWaitInterval:function(){switch(this.priority()){case Statistic.LOW:return Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.MEDIUM:return Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.HIGH:return Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL;
default:return 3E5}},readyToSend:function(){if(!this.dirty())return!1;var a=this.sentAt();return 0===a||this.getTime()-a>=this.minWaitInterval()},sendImmediately:function(){return this.dirty()&&0===this.sentAt()},getTime:function(){return(new Date).getTime()},compare:function(a,b){return void 0===a?1:void 0===b?-1:a==b?0:this._stat_type==Statistic.MIN_TYPE?a>b?1:-1:a<b?1:-1}};AccomplishmentTracker=function(a){this.initialize(a)};
AccomplishmentTracker.prototype={initialize:function(a){this._accomplishments=[];this._statistics=[];this._buffered_events=[];this._accomplishments_ever_set=!1;this._earned_as_guest=Cookie.get("guest_accomplishments");this._guest_points=parseInt(Cookie.get("guest_points")||0,10);this._stat_values={};this._watch_stats=!1;this._earned_as_guest=this._earned_as_guest?this._earned_as_guest.split(","):[];a.statistics&&this.setStatistics(a.statistics);a.accomplishments&&this.setAccomplishments(a.accomplishments)},
purgeProgress:function(){this.accomplishments().invoke("purgeProgress")},setAccomplishmentsProgress:function(a){this.purgeProgress();var b=this;try{this._setting_progress=!0,a.pluck("accomplishment_tasks").flatten().each(function(a){b.updateProgress(a.statistic_id,a.current_progress)})}finally{this._setting_progress=!1}},setAccomplishments:function(a){var b=this;this._accomplishments_ever_set=!0;this._accomplishments=[];for(var c=a.length-1;0<=c;c--){var d=a[c];d.statisticProvider=this.getStatisticById.bind(this);
d=new Accomplishment(d);d.on("task-complete",function(a){b.trigger("task-complete",a)});d.on("task-progress",function(a){b.trigger("task-progress",a)});d.on("complete",function(a){return b._setting_progress||b.trigger("accomplishment-complete",a)});this._accomplishments.push(d)}var e=this;this._buffered_events.each(function(a){e.onStatisticUpdated(a)});this._buffered_events=[]},getAccomplishmentById:function(a){return this.accomplishments().detect(function(b){return a==b.id()})},accomplishmentHasInProgressGroup:function(a){(a=
this.getAccomplishmentById(a))&&a.setAccomplishmentGroupInProgress()},accomplishments:function(){return this._accomplishments.select(function(a){return a.isActive()&&!a.isHidden()})},achievements:function(){return this.accomplishments().filter(function(a){return a.isAchievement()})},completeAchievements:function(){return this.achievements().filter(function(a){return a.isComplete()})},statistics:function(){return this._statistics},setStatistics:function(a){this._statistics=[];for(var b=a.length-1;0<=
b;b--)this._statistics.push(new Statistic(a[b]))},onStatisticUpdated:function(a){this._accomplishments_ever_set?this.updateProgress(a.data.id,a.data.value):this._buffered_events.push(a)},completeAccomplishments:function(){return this.accomplishments().select(function(a){return!a.isHidden()&&a.isComplete()}).sortBy(function(a){return a.rank()})},incompleteAccomplishments:function(){return this.accomplishments().select(function(a){return!a.isComplete()}).sortBy(function(a){return a.rank()})},hiddenAccomplishments:function(){return this.accomplishments().select(function(a){return a.isHidden()})},
nextAccomplishment:function(){if(0===this._earned_as_guest.size())return this.incompleteAccomplishments()[0];var a=this;return this.incompleteAccomplishments().find(function(b){return!a._earned_as_guest.include(b.id())})},getStatisticById:function(a){return this._statistics.detect(function(b){return a===b.id()})||new Statistic({id:a})},updateProgress:function(a,b){this._watch_stats&&this.statWatch(a,b);this.accomplishments().forEach(function(c){c.updateProgress(a,b)})},accomplishmentForId:function(a){return this.accomplishments().find(function(b){return b.id()==
a})},getTime:function(){return new Date},startWatchingStats:function(){console.log("Started watching stats");this._watch_stats=!0},statWatch:function(a,b){var c=this.getStatisticById(a);c?(0<c.compare(this._stat_values[a],b)&&console.log("Statistic %o id %o updated to value %o",c.name(),a,b),this._stat_values[a]=b):console.log("no such stat")},threeAMTomorrow:function(){var a=new Date;a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);3<=a.getHours()?a.setTime(a.getTime()+36E5*(24-(a.getHours()-
3))):a.setTime(a.getTime()+36E5*(3-a.getHours()));return a},recordGuestAccomplishment:function(a){this._earned_as_guest.include(a.id())||(this._earned_as_guest.push(a.id()),this._guest_points+=a._reward_points,Cookie.setWithDate("guest_points",this._guest_points,this.threeAMTomorrow()),Cookie.setWithDate("guest_accomplishments",this._earned_as_guest,this.threeAMTomorrow()))}};$j.extend(AccomplishmentTracker.prototype,Evented);AdService=function(a){this.initialize(a)};
AdService.prototype={initialize:function(a){var b=this;this._eventDispatcher=a.event_dispatcher;this._adManagers=[];[window.supersonicAdManager,window.hyprMXAdManager,window.trueXAdManager,a.ad_manager].each(function(a){a&&(a.setReceiver(b),b._adManagers.push(a))});this._adManager=this._adManagers.pop();this._adsReady=this._adShowing=this._campaignCompleted=this._initialized=!1;this._eventDispatcher.register(KonduitEvent.ADS_INITIALIZE,this.onInitializeAds.bind(this));this._eventDispatcher.register(KonduitEvent.ADS_SHOW_INCENTIVIZED,
this.onShowAd.bind(this))},onInitializeAds:function(){this._initialized?this._adsReady?(Kongregate.Log.warn("Ad service already initialized, sending ads available"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)):(Kongregate.Log.warn("Ad service already initialized, sending ads unavailable"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)):(this._initialized=!0,this._adManager?this._adManager.readyForAds():(Kongregate.Log.info("No ad managers available"),this.onCampaignsDone()),
Kongregate.Log.info("AdService initialized!"))},onNoAdAvailable:function(){if(this._adManager=this._adManagers.pop())this._initialized=!1,this.onInitializeAds()},onShowAd:function(){this._adsReady?this._adShowing?Kongregate.Log.warn("Ad already showing, ignoring call"):(this._adManager.showAd(),this._adShowing=!0,this._campaignCompleted=!1,this._eventDispatcher.sendMessage(KonduitEvent.AD_OPENED)):(Kongregate.Log.warn("No ads ready, not attempting to display ad"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE),
this._eventDispatcher.sendMessage(KonduitEvent.AD_ABANDONED))},onCampaignsReady:function(){Kongregate.Log.info("Ad campaigns ready!");this._adsReady=!0;this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)},onCampaignsDone:function(){Kongregate.Log.info("Ad campaigns done!");this._adsReady=!1;this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)},onCampaignCompleted:function(){Kongregate.Log.info("Ad campaign completed!");this._campaignCompleted=!0},onCampaignClose:function(){Kongregate.Log.info("Ad campaign closed, completed="+
this._campaignCompleted);this._eventDispatcher.sendMessage(this._campaignCompleted?KonduitEvent.AD_COMPLETED:KonduitEvent.AD_ABANDONED);this._campaignCompleted=this._adShowing=!1}};AnalyticsService=function(a){this.initialize(a)};
AnalyticsService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.ANALYTICS_PAYLOAD,this.onAnalyticsPayloadRequest.bind(this))},sendAnalyticsPayload:function(a){if(!this._activeUser.analyticsInfo()||this._lastUserId===this._activeUser.id())return!1;this._lastUserId=this._activeUser.id();var b=this;a=a||0;$j.ajax({url:this._activeUser.gameResourcePath()+"/analytics_payload.json",
success:this.onAnalyticsPayloadResult.bind(this),error:function(c,d,e){Kongregate.Log.error("Analytics payload request failed, errorCount=",a,c,d,e);a<b.maxRetries()&&b.retryAnalyticsPayload(a+1)}})},retryAnalyticsPayload:function(a){a*=1E4;Kongregate.Log.debug("Retrying analytics payload request after "+a);setTimeout(this.sendAnalyticsPayload.bind(this),a)},onAnalyticsPayloadRequest:function(){this.sendAnalyticsPayload()},onAnalyticsPayloadResult:function(a){Kongregate.Log.debug("Analytics payload received");
a.time_skew=(this.getTime()-moment(a.server_time).toDate().getTime())/1E3;this._eventDispatcher.sendMessage("analytics.payload",{data:{info:this._activeUser.analyticsInfo(),payload:a}})},getTime:function(a){var b;a&&(b=moment(a).toDate().getTime());return b||(new Date).getTime()},maxRetries:function(){return 5}};
ApiLogger={log:function(a,b){Kongregate.Utils.isKlient()&&top.postMessage({type:"kongregate:api-message:log",message:{level:a,message:b}},"*")},echoToConsole:function(a,b){Kongregate.Log[a](b);ApiLogger[a](b)},error:function(a){ApiLogger.log(1,a)},warn:function(a){ApiLogger.log(2,a)},info:function(a){ApiLogger.log(3,a)},debug:function(a){ApiLogger.log(4,a)},spam:function(a){ApiLogger.log(5,a)}};
(function(a){function b(a,b){return function(c){return f(a.call(this,c),b)}}function c(a){return function(b){return this.lang().ordinal(a.call(this,b))}}function d(){}function e(a){h(this,a)}function g(a){var b=this._data={},c=a.years||a.year||a.y||0,d=a.months||a.month||a.M||0,e=a.weeks||a.week||a.w||0,f=a.days||a.day||a.d||0,g=a.hours||a.hour||a.h||0,h=a.minutes||a.minute||a.m||0,A=a.seconds||a.second||a.s||0;a=a.milliseconds||a.millisecond||a.ms||0;this._milliseconds=a+1E3*A+6E4*h+36E5*g;this._days=
f+7*e;this._months=d+12*c;b.milliseconds=a%1E3;A+=l(a/1E3);b.seconds=A%60;h+=l(A/60);b.minutes=h%60;g+=l(h/60);b.hours=g%24;f+=l(g/24);f+=7*e;b.days=f%30;d+=l(f/30);b.months=d%12;c+=l(d/12);b.years=c}function h(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function l(a){return 0>a?Math.ceil(a):Math.floor(a)}function f(a,b){for(a+="";a.length<b;)a="0"+a;return a}function m(a,b,c){var d=b._milliseconds,e=b._days;b=b._months;d&&a._d.setTime(+a+d*c);e&&a.date(a.date()+e*c);b&&(d=a.date(),
a.date(1).month(a.month()+b*c).date(Math.min(d,a.daysInMonth())))}function r(a,b){var c=Math.min(a.length,b.length),d=Math.abs(a.length-b.length),e=0,f;for(f=0;f<c;f++)~~a[f]!==~~b[f]&&e++;return e+d}function q(a){if(!a)return p.fn._lang;!D[a]&&t&&require("./lang/"+a);return D[a]}function x(a){return a.match(/\[.*\]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function v(a){var b=a.match(O),c;var d=0;for(c=b.length;d<c;d++)b[d]=K[b[d]]?K[b[d]]:x(b[d]);return function(e){var f="";for(d=0;d<c;d++)f+=
"function"===typeof b[d].call?b[d].call(e,a):b[d];return f}}function I(a,b){function c(b){return a.lang().longDateFormat(b)||b}for(var d=5;d--&&Z.test(b);)b=b.replace(Z,c);ha[b]||(ha[b]=v(b));return ha[b](a)}function w(a){switch(a){case "DDDD":return S;case "YYYY":return qa;case "YYYYY":return pa;case "S":case "SS":case "SSS":case "DDD":return da;case "MMM":case "MMMM":case "dd":case "ddd":case "dddd":case "a":case "A":return R;case "X":return ma;case "Z":case "ZZ":return X;case "T":return P;case "MM":case "DD":case "YY":case "HH":case "hh":case "mm":case "ss":case "M":case "D":case "d":case "H":case "h":case "m":case "s":return ea;
default:return new RegExp(a.replace("\\",""))}}function B(a){var b,c=[];if(!a._d){for(b=0;7>b;b++)a._a[b]=c[b]=null==a._a[b]?2===b?1:0:a._a[b];c[3]+=a._tzh||0;c[4]+=a._tzm||0;b=new Date(0);a._useUTC?(b.setUTCFullYear(c[0],c[1],c[2]),b.setUTCHours(c[3],c[4],c[5],c[6])):(b.setFullYear(c[0],c[1],c[2]),b.setHours(c[3],c[4],c[5],c[6]));a._d=b}}function G(a){var b=a._f.match(O),c=a._i,d,e;a._a=[];for(d=0;d<b.length;d++)if((e=(w(b[d]).exec(c)||[])[0])&&(c=c.slice(c.indexOf(e)+e.length)),K[b[d]]){var f=e,
g=a,h=g._a;switch(b[d]){case "M":case "MM":h[1]=null==f?0:~~f-1;break;case "MMM":case "MMMM":e=q(g._l).monthsParse(f);null!=e?h[1]=e:g._isValid=!1;break;case "D":case "DD":case "DDD":case "DDDD":null!=f&&(h[2]=~~f);break;case "YY":h[0]=~~f+(68<~~f?1900:2E3);break;case "YYYY":case "YYYYY":h[0]=~~f;break;case "a":case "A":g._isPm="pm"===(f+"").toLowerCase();break;case "H":case "HH":case "h":case "hh":h[3]=~~f;break;case "m":case "mm":h[4]=~~f;break;case "s":case "ss":h[5]=~~f;break;case "S":case "SS":case "SSS":h[6]=
~~(1E3*("0."+f));break;case "X":g._d=new Date(1E3*parseFloat(f));break;case "Z":case "ZZ":g._useUTC=!0,(e=(f+"").match(oa))&&e[1]&&(g._tzh=~~e[1]),e&&e[2]&&(g._tzm=~~e[2]),e&&"+"===e[0]&&(g._tzh=-g._tzh,g._tzm=-g._tzm)}null==f&&(g._isValid=!1)}a._isPm&&12>a._a[3]&&(a._a[3]+=12);!1===a._isPm&&12===a._a[3]&&(a._a[3]=0);B(a)}function n(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function N(a,b,c){b=c-b;c-=a.day();c>b&&(c-=7);c<b-7&&(c+=7);return Math.ceil(p(a).add("d",c).dayOfYear()/7)}function U(b){var c=
b._i,d=b._f;if(null===c||""===c)return null;"string"===typeof c&&(b._i=c=q().preparse(c));if(p.isMoment(c))b=h({},c),b._d=new Date(+c._d);else if(d)if("[object Array]"===Object.prototype.toString.call(d)){c=b;for(var f,g,l=99;c._f.length;){f=h({},c);f._f=c._f.pop();G(f);d=new e(f);if(d.isValid()){g=d;break}f=r(f._a,d.toArray());f<l&&(l=f,g=d)}h(c,g)}else G(b);else if(g=b,c=g._i,d=E.exec(c),c===a)g._d=new Date;else if(d)g._d=new Date(+d[1]);else if("string"===typeof c)if(d=g._i,C.exec(d)){g._f="YYYY-MM-DDT";
for(c=0;4>c;c++)if(aa[c][1].exec(d)){g._f+=aa[c][0];break}X.exec(d)&&(g._f+=" Z");G(g)}else g._d=new Date(d);else"[object Array]"===Object.prototype.toString.call(c)?(g._a=c.slice(0),B(g)):g._d=c instanceof Date?new Date(+c):new Date(c);return new e(b)}function J(a,b){p.fn[a]=p.fn[a+"s"]=function(a){var c=this._isUTC?"UTC":"";return null!=a?(this._d["set"+c+b](a),this):this._d["get"+c+b]()}}function ca(a){p.duration.fn[a]=function(){return this._data[a]}}function ba(a,b){p.duration.fn["as"+a]=function(){return+this/
b}}for(var p,T=Math.round,F,D={},t="undefined"!==typeof module&&module.exports,E=/^\/?Date\((\-?\d+)/i,O=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,Z=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,ea=/\d\d?/,da=/\d{1,3}/,S=/\d{3}/,qa=/\d{1,4}/,pa=/[+\-]?\d{1,6}/,R=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,X=/Z|[\+\-]\d\d:?\d\d/i,P=/T/i,ma=/[\+\-]?\d+(\.\d{1,3})?/,
C=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,aa=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],oa=/([\+\-]|\d\d)/gi,fa="Month Date Hours Minutes Seconds Milliseconds".split(" "),ja={Milliseconds:1,Seconds:1E3,Minutes:6E4,Hours:36E5,Days:864E5,Months:2592E6,Years:31536E6},ha={},ia="DDD w W M D d".split(" "),la="MDHhmswW".split(""),K={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,
a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return f(this.year()%100,2)},YYYY:function(){return f(this.year(),4)},YYYYY:function(){return f(this.year(),
5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return f(~~(this.milliseconds()/10),2)},SSS:function(){return f(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";0>a&&(a=-a,b="-");
return b+f(~~(a/60),2)+":"+f(~~a%60,2)},ZZ:function(){var a=-this.zone(),b="+";0>a&&(a=-a,b="-");return b+f(~~(10*a/6),4)},X:function(){return this.unix()}};ia.length;)F=ia.pop(),K[F+"o"]=c(K[F]);for(;la.length;)F=la.pop(),K[F+F]=b(K[F],2);K.DDDD=b(K.DDD,3);d.prototype={set:function(a){var b;for(b in a){var c=a[b];"function"===typeof c?this[b]=c:this["_"+b]=c}},_months:"January February March April May June July August September October November December".split(" "),months:function(a){return this._months[a.month()]},
_monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b;this._monthsParse||(this._monthsParse=[]);for(b=0;12>b;b++){if(!this._monthsParse[b]){var c=p([2E3,b]);c="^"+this.months(c,"")+"|^"+this.monthsShort(c,"");this._monthsParse[b]=new RegExp(c.replace(".",""),"i")}if(this._monthsParse[b].test(a))return b}},_weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),weekdays:function(a){return this._weekdays[a.day()]},
_weekdaysShort:"Sun Mon Tue Wed Thu Fri Sat".split(" "),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su Mo Tu We Th Fr Sa".split(" "),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,
function(a){return a.slice(1)}),this._longDateFormat[a]=b);return b},meridiem:function(a,b,c){return 11<a?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){a=this._calendar[a];return"function"===typeof a?a.apply(b):a},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",
dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"===typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){a=this._relativeTime[0<a?"future":"past"];return"function"===typeof a?a(b):a.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return N(a,this._week.dow,this._week.doy)},_week:{dow:0,
doy:6}};p=function(a,b,c){return U({_i:a,_f:b,_l:c,_isUTC:!1})};p.utc=function(a,b,c){return U({_useUTC:!0,_isUTC:!0,_l:c,_i:a,_f:b})};p.unix=function(a){return p(1E3*a)};p.duration=function(a,b){var c=p.isDuration(a),d="number"===typeof a,e=c?a._data:d?{}:a;d&&(b?e[b]=a:e.milliseconds=a);b=new g(e);c&&a.hasOwnProperty("_lang")&&(b._lang=a._lang);return b};p.version="2.0.0";p.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";p.lang=function(a,b){if(!a)return p.fn._lang._abbr;b?(b.abbr=a,D[a]||(D[a]=new d),D[a].set(b)):
D[a]||q(a);p.duration.fn._lang=p.fn._lang=q(a)};p.langData=function(a){a&&a._lang&&a._lang._abbr&&(a=a._lang._abbr);return q(a)};p.isMoment=function(a){return a instanceof e};p.isDuration=function(a){return a instanceof g};p.fn=e.prototype={clone:function(){return p(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1E3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return p.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},
toArray:function(){return[this.year(),this.month(),this.date(),this.hours(),this.minutes(),this.seconds(),this.milliseconds()]},isValid:function(){null==this._isValid&&(this._isValid=this._a?!r(this._a,(this._isUTC?p.utc(this._a):p(this._a)).toArray()):!isNaN(this._d.getTime()));return!!this._isValid},utc:function(){this._isUTC=!0;return this},local:function(){this._isUTC=!1;return this},format:function(a){a=I(this,a||p.defaultFormat);return this.lang().postformat(a)},add:function(a,b){a="string"===
typeof a?p.duration(+b,a):p.duration(a,b);m(this,a,1);return this},subtract:function(a,b){a="string"===typeof a?p.duration(+b,a):p.duration(a,b);m(this,a,-1);return this},diff:function(a,b,c){a=this._isUTC?p(a).utc():p(a).local();var d=6E4*(this.zone()-a.zone());b&&(b=b.replace(/s$/,""));if("year"===b||"month"===b){d=432E5*(this.daysInMonth()+a.daysInMonth());var e=12*(this.year()-a.year())+(this.month()-a.month());e+=(this-p(this).startOf("month")-(a-p(a).startOf("month")))/d;"year"===b&&(e/=12)}else d=
this-a-d,e="second"===b?d/1E3:"minute"===b?d/6E4:"hour"===b?d/36E5:"day"===b?d/864E5:"week"===b?d/6048E5:d;return c?e:l(e)},from:function(a,b){return p.duration(this.diff(a)).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(p(),a)},calendar:function(){var a=this.diff(p().startOf("day"),"days",!0);a=-6>a?"sameElse":-1>a?"lastWeek":0>a?"lastDay":1>a?"sameDay":2>a?"nextDay":7>a?"nextWeek":"sameElse";return this.format(this.lang().calendar(a,this))},isLeapYear:function(){var a=
this.year();return 0===a%4&&0!==a%100||0===a%400},isDST:function(){return this.zone()<p([this.year()]).zone()||this.zone()<p([this.year(),5]).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null==a?b:this.add({d:a-b})},startOf:function(a){a=a.replace(/s$/,"");switch(a){case "year":this.month(0);case "month":this.date(1);case "week":case "day":this.hours(0);case "hour":this.minutes(0);case "minute":this.seconds(0);case "second":this.milliseconds(0)}"week"===a&&
this.day(0);return this},endOf:function(a){return this.startOf(a).add(a.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)>+p(a).startOf(b)},isBefore:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)<+p(a).startOf(b)},isSame:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)===+p(a).startOf(b)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},
daysInMonth:function(){return p.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(a){var b=T((p(this).startOf("day")-p(this).startOf("year"))/864E5)+1;return null==a?b:this.add("d",a-b)},isoWeek:function(a){var b=N(this,1,4);return null==a?b:this.add("d",7*(a-b))},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},lang:function(b){if(b===a)return this._lang;this._lang=q(b);return this}};for(F=0;F<fa.length;F++)J(fa[F].toLowerCase().replace(/s$/,""),
fa[F]);J("year","FullYear");p.fn.days=p.fn.day;p.fn.weeks=p.fn.week;p.fn.isoWeeks=p.fn.isoWeek;p.duration.fn=g.prototype={weeks:function(){return l(this.days()/7)},valueOf:function(){return this._milliseconds+864E5*this._days+2592E6*this._months},humanize:function(a){var b=+this;var c=!a;var d=this.lang(),e=T(Math.abs(b)/1E3),f=T(e/60),g=T(f/60),h=T(g/24),l=T(h/365);e=45>e&&["s",e]||1===f&&["m"]||45>f&&["mm",f]||1===g&&["h"]||22>g&&["hh",g]||1===h&&["d"]||25>=h&&["dd",h]||45>=h&&["M"]||345>h&&["MM",
T(h/30)]||1===l&&["y"]||["yy",l];e[2]=c;e[3]=0<b;e[4]=d;c=n.apply({},e);a&&(c=this.lang().pastFuture(b,c));return this.lang().postformat(c)},lang:p.fn.lang};for(F in ja)ja.hasOwnProperty(F)&&(ba(F,ja[F]),ca(F.toLowerCase()));ba("Weeks",6048E5);p.lang("en",{ordinal:function(a){var b=a%10;return a+(1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}});t&&(module.exports=p);"undefined"===typeof ender&&(this.moment=p);"function"===typeof define&&define.amd&&define("moment",[],function(){return p})}).call(this);
var Kongregate=Kongregate||{};Kongregate.Utils=Kongregate.Utils||{};Kongregate.Utils.isKlient=function(){return/klient|kartridge\//.test(navigator.userAgent.toLowerCase())};Kongregate.Utils.findKongregateWindow=function(){if(!Kongregate.Utils.isKlient())return top;for(var a=window,b=window.parent;b!==top;)a=b,b=a.parent;return a};
Kongregate.Utils.catchErrors=function(a,b,c){return function(){try{return a.apply(b,arguments)}catch(d){return Kongregate.Log.error("catchErrors caught unhandled exception",d),c}}};
(function(){function a(a,c,d){Kongregate.Log[a]=function(){try{if("undefined"!==typeof active_user&&void 0===Kongregate.Log.debugLevel&&(Kongregate.Log.debugLevel=active_user.debugLevel()),0===c||Kongregate.Log.debugLevel>=c)console[d]?Function.prototype.apply.call(console[d],console,arguments):console.log(arguments)}catch(e){}}}Kongregate.Log={};a("spam",5,"log");a("debug",4,"log");a("info",3,"info");a("warn",2,"warn");a("error",1,"error");a("always",0,"log")})();
KonduitEvent={INIT:"init",CONNECT:"connect",CONNECTED:"connected",DISCONNECT:"disconnect",LOGIN:"login",SWITCH_USER:"switch_user",JOIN_ROOM:"join_room",LEAVE_ROOM:"leave_room",USER_JOIN:"user_join",USER_DEPARTURE:"user_departure",USER_CHANGED:"user_changed",ROOM_MESSAGE:"room_message",SYSTEM_MESSAGE:"system_message",PRIVATE_MESSAGE:"private_message",ADMIN_MESSAGE:"admin_message",MESSAGE_ERROR:"message_error",SET_PRESENCE:"set_presence",GUEST_COUNT:"guest_count",ROOM_NOT_FOUND:"room_not_found",ROOM_FULL:"room_full",
REQUEST_CHAT_ROOM:"request_chat_room",CREATE_PRIVATE_ROOM:"create_private_room",DESTROY_PRIVATE_ROOM:"destroy_private_room",PRIVATE_ROOM_INVITATION:"private_room_invitation",PRIVATE_ROOM_KICK:"private_room_kick",PRIVATE_ROOM_INVITATION_SENT:"private_room_invitation_sent",JOIN_GUILD_ROOM:"join_guild_room",SILENCED:"silenced",PARTICIPATE:"participate",AMNESTY:"amnesty",API_INITIALIZED:"api_initialized",ADD_STATISTICS:"add_statistics",STATISTIC_UPDATED:"statistic_updated",STATISTIC_SUBMISSION:"statistic_submission",
STATISTICS_FLUSH:"statistics_flush",STATISTICS_FORCE_FLUSH:"statistics_force_flush",SET_ACCOMPLISHMENT_PROGRESS:"set_accomplishment_progress",NEW_HIGH_SCORE:"new_high_score",DISPLAY_SHOUT_BOX:"display_shout_box",DISPLAY_INVITATION_BOX:"display_invitation_box",SEND_PRIVATE_MESSAGE:"send_private_message",DISPLAY_FEED_POST_BOX:"display_feed_post_box",DISPLAY_SIGN_IN_LIGHTBOX:"display_sign_in_lightbox",DISPLAY_REGISTRATION_LIGHTBOX:"display_registration_lightbox",LIGHTBOX_OPENED:"lightbox_opened",LIGHTBOX_CLOSED:"lightbox_closed",
ACCOMPLISHMENT_TASK_PROGRESS:"accomplishment_task_progress",ACCOMPLISHMENT_COMPLETE:"accomplishment_complete",RESIZE_GAME:"resize_game",HANDLE_ITEM_CHECKOUT_REQUEST:"handle_item_checkout_request",KONDUIT_MESSAGE:"konduit_message",ANALYTICS_PAYLOAD:"analytics_payload",OP_EXTERNAL_MESSAGE:"ext.msg",OP_CONNECTED:"connected",OP_HELLO:"hello",OP_USER_INFO:"user.info",OP_SIGN_IN:"sign_in",PARAM_USER:"user",PARAM_USER_ID:"user_id",PARAM_GAME_AUTH_TOKEN:"auth_token",PURCHASE_RESULT:"purchase_result",PARAM_LOCALCONNECTION_ONLY:"localconnection_only",
CUSTOM_TAB_MESSAGE:"custom_tab_message",CUSTOM_TAB_SHOW:"custom_tab_show",CUSTOM_TAB_CLOSE:"custom_tab_close",CUSTOM_TAB_SHOWN:"custom_tab_shown",CUSTOM_TAB_CLEAR_MESSAGES:"custom_tab_clear_messages",OP_CHAT_TAB:"chat.tab",OP_CHAT_CLEAR_DIALOG:"chat.dlg.clear",OP_CHAT_DISPLAY:"chat.disp",OP_CHAT_MSG:"chat.msg",OP_CHAT_CANVAS_ELEMENT:"chat.elm",OP_CHAT_PRIVATE_MESSAGE:"chat.privateMessage",OP_CHAT_RESIZE_GAME:"chat.resizeGame",OP_CHAT_DISPLAY_INVITATION_BOX:"chat.invite",OP_CHAT_DISPLAY_FEED_POST_BOX:"chat.feedpost",
OP_CHAT_DISPLAY_REGISTRATION:"chat.registration",OP_CHAT_DISPLAY_SHOUT_BOX:"chat.shoutbox",PARAM_SHOUT_MESSAGE:"shout_message",PARAM_CANVAS_SIZE:"chat.canvas.size",PARAM_RESIZE_GAME_WIDTH:"chat.resizeGame.width",PARAM_RESIZE_GAME_HEIGHT:"chat.resizeGame.height",PARAM_INVITATION_MESSAGE:"invitation_message",PARAM_FRIEND_FILTER:"filter",PARAM_IMAGE_URI:"image_uri",PARAM_KV_PARAMS:"kv_params",PARAM_NAME:"name",PARAM_DESCRIPTION:"desc",PARAM_DATA:"data",OP_SHOUT_CALLBACK:"ext.shout_callback",PARAM_MESSAGE_TYPE:"ext.message_type",
PARAM_MESSAGE_RECIPIENTS:"ext.message_recipients",PARAM_ERROR:"error",PARAM_SUCCESS:"success",PARAM_REQUEST_ID:"req.id",OP_STATS_SUBMIT:"stat.submit",PARAM_STATS:"stats",ITEM_LIST:"mtx.item_list",ITEM_CHECKOUT:"mtx.checkout",PURCHASE_KREDS:"mtx.kred_purchase",ITEM_INSTANCES:"mtx.item_instances",USE_ITEM_INSTANCE:"mtx.use_item_instance",PARAM_PURCHASE_METHOD:"purchase_method",PARAM_ITEM_TAGS:"item_tags",PARAM_ITEMS:"items",PARAM_ORDER_INFO:"order_info",PARAM_ID:"id",ADS_INITIALIZE:"ads.initialize",
ADS_AVAILABLE:"ads.available",ADS_UNAVAILABLE:"ads.unavailable",ADS_SHOW_INCENTIVIZED:"ads.show_incentivized",AD_OPENED:"ads.ad_opened",AD_COMPLETED:"ads.ad_completed",AD_ABANDONED:"ads.ad_abandoned",PROCESSING_SAVE_SHARED_CONTENT:"processing_save_shared_content",SAVE_SHARED_CONTENT:"save_shared_content",SAVE_SHARED_CONTENT_COMPLETE:"shared_content_save_complete",LOAD_SHARED_CONTENT:"load_shared_content",BROWSE_SHARED_CONTENT:"browse_shared_content",OP_SAVE_SHARED_CONTENT:"save_shared_content",OP_BROWSE_SHARED_CONTENT:"browse_shared_content",
OP_LOAD_SHARED_CONTENT:"load_shared_content",OP_SHARED_CONTENT_SAVE_COMPLETE:"shared_content_save_complete",PARAM_CONTENT_TYPE:"content_type",PARAM_LABEL:"label",PARAM_IMAGE:"image",PARAM_PERMALINK:"permalink",OP_IMAGE_AVATAR_SUBMIT:"avatar.submit",OP_IMAGE_AVATAR_FINISHED:"avatar.finished",IMAGE_AVATAR_SUBMIT:"image_avatar_submit",IMAGE_AVATAR_COMPLETE:"image_avatar_complete",OP_ANALYTICS_PAYLOAD:"analytics.payload",HOLODECK_DATA:"holodeck_data",PARAM_HOLODECK_TYPE:"holodeck_type",FETCH_HISTORY:"fetch_history",
HISTORY_RECEIVED:"history_received",FAYE_DISCONNECT:"faye_disconnect"};KonduitChatErrorMessage={MESSAGE_TOO_LONG:"error_msg_too_long",RATE_LIMITED:"error_msg_rate_limit",STICKER:"error_msg_sticker"};KonduitPresenceType={CHAT:"chat",AWAY:"away"};KonduitEventDispatcher=function(){this.initialize()};
KonduitEventDispatcher.prototype={initialize:function(){this._callbacks={}},map:function(a,b){var c=this;this.register(a,function(a){c.fire({type:b,data:a.data})})},register:function(a,b){this._callbacks.hasOwnProperty(a)||(this._callbacks[a]=[]);this._callbacks[a].push(b)},fire:function(a){var b=a.type;if(this._callbacks.hasOwnProperty(b))for(var c=0,d=this._callbacks[b].length;c<d;c++)this._callbacks[b][c](a)},sendMessage:function(a,b){this.fire({type:KonduitEvent.KONDUIT_MESSAGE,opcode:a,params:b||
{}})}};ApiService=function(a){this.initialize(a)};
ApiService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._createServices(a);this._mapEvents();this._eventDispatcher.register(KonduitEvent.OP_HELLO,this._onClientConnected.bind(this));this._eventDispatcher.register(KonduitEvent.SWITCH_USER,this._sendUserInfo.bind(this))},_mapEvent:function(a,b){ApiService._mapEvent(this._eventDispatcher,a,b)},_mapEvents:function(){this._mapEvent("chat.sign",KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX);
this._mapEvent("chat.registration",KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX);this._mapEvent("chat.shoutbox",KonduitEvent.DISPLAY_SHOUT_BOX);this._mapEvent("chat.feedpost",KonduitEvent.DISPLAY_FEED_POST_BOX);this._mapEvent("chat.invite",KonduitEvent.DISPLAY_INVITATION_BOX);this._mapEvent("chat.privateMessage",KonduitEvent.SEND_PRIVATE_MESSAGE);this._mapEvent("chat.resizeGame",KonduitEvent.RESIZE_GAME)},_createServices:function(a){(new StatisticService({event_dispatcher:a.event_dispatcher,active_user:a.active_user,
statistics:a.statistics,is_connected:a.is_connected})).start();new AnalyticsService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new MicrotransactionService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new AdService({event_dispatcher:a.event_dispatcher,active_user:a.active_user,ad_manager:a.ad_manager});new SharedContentService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new ImageService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});
new ChatService({event_dispatcher:a.event_dispatcher,active_user:a.active_user})},_onClientConnected:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_HELLO,{success:!0});this._sendUserInfo();this._eventDispatcher.fire({type:KonduitEvent.API_INITIALIZED})},_sendUserInfo:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_USER_INFO,{user:this._activeUser.username(),user_id:this._activeUser.id(),auth_token:this._activeUser.gameAuthToken()});this._eventDispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD})}};
ApiService._mapEvent=function(a,b,c){a.register(b,function(b){a.fire({type:c,data:b.data})})};ChatService=function(a){this.initialize(a)};
ChatService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._konduitToCanvas=a.canvas_dispatcher||window.konduitToCanvas;this._queuedMessages=[];this._customTabShowing=!1;this._activeUser.chatApiEnabled()&&(this._eventDispatcher.register(KonduitEvent.OP_CHAT_TAB,this.onChatTabRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CLEAR_DIALOG,this.clearChat.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_DISPLAY,
this.onChatDisplayRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_MSG,this.onCustomTabMessage.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CANVAS_ELEMENT,this.onCanvasElementRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.CUSTOM_TAB_SHOWN,this.onCustomTabShown.bind(this)))},closeTab:function(){Kongregate.Log.info("Closing tab!");this._customTabShowing=!1;this.clearChat();this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLOSE,data:{}})},
clearChat:function(){this._queuedMessages=[];this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,data:{}})},onChatTabRequest:function(a){a=a.data;this._queuedMessages=[];var b=a.name;if(ChatService.DEFAULT_TAB===b)this.closeTab();else{var c=a[KonduitEvent.PARAM_CANVAS_SIZE];if(!isFinite(c)||0>c)c=.5;this.clearChat();this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_SHOW,data:{name:b,description:a.desc,size:Math.min(c,1)/2}})}},onCustomTabShown:function(a){Kongregate.Log.info("Custom tab visible!");
this._customTabShowing=!0;this.flushMessageQueue();var b={};b[KonduitEvent.PARAM_CANVAS_SIZE]=a.data;this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_TAB,b)},onChatDisplayRequest:function(a){var b=a.data;a=b.user;b=Kongregate.LanguageFilter.filter(b.data);a&&b&&(0===a.indexOf("@")&&(a=a.substr(1,a.length-1)),this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{user:{username:a},message:b}}))},onCustomTabMessage:function(a){a=a.data;this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_MSG,
{user:a.user.username,data:a.message})},onCanvasElementRequest:function(a){this._queuedMessages.push({type:a.type,data:a.data.data});this._customTabShowing&&this.flushMessageQueue()},flushMessageQueue:function(){var a=this;this._queuedMessages.forEach(function(b){a._konduitToCanvas(b)});this._queuedMessages=[]}};ChatService.DEFAULT_TAB="Default";ChatService.CUSTOM_TAB="custom";ImageService=function(a){this.initialize(a)};
ImageService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.OP_IMAGE_AVATAR_SUBMIT,this.onAvatarSubmit.bind(this));this._eventDispatcher.register(KonduitEvent.IMAGE_AVATAR_COMPLETE,this.onAvatarSubmissionResult.bind(this))},onAvatarSubmit:function(a){if(this._activeUser.isAuthenticated()){var b=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:a.data.image||Kongregate.DEFAULT_ICON_BASE64},
success:function(a){b._eventDispatcher.fire({type:KonduitEvent.IMAGE_AVATAR_SUBMIT,data:{filename:a}})},error:this.onFailure.bind(this)})}else this.onFailure()},onAvatarSubmissionResult:function(a){this._eventDispatcher.sendMessage(KonduitEvent.OP_IMAGE_AVATAR_FINISHED,{success:a.data.success})},onFailure:function(){this.onAvatarSubmissionResult({data:{success:!1}})}};KonduitJavascriptAdapter=function(a){this.initialize(a)};KonduitJavascriptAdapter.IGNORED_EVENTS=[KonduitEvent.ADD_STATISTICS];
KonduitJavascriptAdapter.prototype={initialize:function(a){this._activeUser=a.activeUser;this._eventDispatcher=a.eventDispatcher;this._klient=Kongregate.Utils.isKlient();this.initializeEventMap();this.initializeMessageConnection()},initializeMessageConnection:function(){this.messageConnection=new Kongregate.MessageConnection({channel_id:window.channel_id});this.messageConnection.addMessageListener(this._onClientMessage.bind(this));this.messageConnection.listen()},initializeEventMap:function(){this._eventMap=
{};this._eventMap[KonduitEvent.CUSTOM_TAB_SHOW]=KonduitEvent.CUSTOM_TAB_SHOWN;this._eventMap[KonduitEvent.CUSTOM_TAB_MESSAGE]=KonduitEvent.OP_CHAT_MSG;this._eventMap[KonduitEvent.SWITCH_USER]=KonduitEvent.SWITCH_USER;this._eventMap[KonduitEvent.IMAGE_AVATAR_COMPLETE]=KonduitEvent.IMAGE_AVATAR_COMPLETE;this._eventMap[KonduitEvent.OP_LOAD_SHARED_CONTENT]=KonduitEvent.OP_LOAD_SHARED_CONTENT;this._eventMap[KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE]=KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE},_onClientMessage:function(a,
b){this._eventDispatcher.fire({type:KonduitEvent.KONDUIT_MESSAGE,data:{outgoing:!0,opcode:a,params:b}})},_setLocalConnectionOnly:function(a,b){a[b]=$j.extend({},a[b]);a[b][KonduitEvent.PARAM_LOCALCONNECTION_ONLY]=!0},_forwardToKlient:function(a){this._klient&&top.postMessage({type:"kongregate:api-message:in",message:{opcode:a.opcode,params:a.params}},"*")},dispatchEvent:function(a){var b=this._eventMap[a.type];if(b)return this._eventDispatcher.fire({type:b,data:a.data}),!0;if(0<=KonduitJavascriptAdapter.IGNORED_EVENTS.indexOf(a.type))return!0;
this._forwardToKlient(a);if(!this.messageConnection.connected())return!1;switch(a.type){case KonduitEvent.KONDUIT_MESSAGE:this.messageConnection.sendMessage(a.opcode,a.params||{});break;default:this.messageConnection.sendMessage(KonduitEvent.OP_EXTERNAL_MESSAGE,{opcode:a.type,data:a.data})}this._setLocalConnectionOnly(a,a.data?"data":"params");return!1}};MicrotransactionService=function(a){this.initialize(a)};
MicrotransactionService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._activeUser.mtxApiEnabled()&&(this._eventDispatcher=a.event_dispatcher,this._eventDispatcher.register(KonduitEvent.ITEM_LIST,this.onItemListRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_CHECKOUT,this.onItemCheckoutRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.PURCHASE_KREDS,this.onKredPurchaseRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_INSTANCES,
this.onItemInstanceRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.USE_ITEM_INSTANCE,this.onUseItemInstanceRequest.bind(this)))},onItemListRequest:function(a){var b=this._eventDispatcher,c=(a.data.item_tags||[]).filter(function(a){return"string"===typeof a&&0<a.length}),d=function(c){var d=c.success,e={success:d};e[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];d&&(e.data=c.items);b.sendMessage(KonduitEvent.ITEM_LIST,e)},e={api_key:this._activeUser.gameId()};
c.length&&(e.tags=c.join(","));Kongregate.Log.info("Requesting item list from server");$j.ajax({url:"/api/items.json",cache:!1,data:e,success:d,error:function(){d({success:!1})}})},onItemCheckoutRequest:function(a){var b=a.data.items,c=a.data.order_info;if(b){b=MicrotransactionService.buildCartJSON(b);var d="/checkouts/new?cart="+encodeURIComponent(b)}else c&&(d="/checkouts/new?order_info="+encodeURIComponent(c));d?(Kongregate.Log.info("Path:",d),this._eventDispatcher.fire({type:KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,
data:{url:"https://"+location.host+this._activeUser.gameResourcePath()+d}})):Kongregate.Log.warn("Couldn't build a URL from item message:",a.data)},onItemInstanceRequest:function(a){var b=this._eventDispatcher,c=a.data.user,d=function(d){Kongregate.Log.info("Item instance list received for "+c);var e=d.success,h={success:e};h[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];e&&(h.data=d.items);b.sendMessage(KonduitEvent.ITEM_INSTANCES,h)};Kongregate.Log.info("Requesting item list from server");
$j.ajax({url:"/api/user_items.json",cache:!1,data:{api_key:this._activeUser.gameId(),username:c},success:d,error:function(){d({success:!1})}})},onUseItemInstanceRequest:function(a){var b=a.data.id,c=this._eventDispatcher,d=function(d){d=d.success;var e={success:d,id:b};Kongregate.Log.info("Item instance use result for item instance id:"+b+", success: "+d);e[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];c.sendMessage(KonduitEvent.USE_ITEM_INSTANCE,e)};Kongregate.Log.info("Requesting item instance use for item ID: "+
b);$j.ajax({url:"/api/use_item.json",method:"POST",data:{api_key:this._activeUser.gameId(),user_id:this._activeUser.id(),game_auth_token:this._activeUser.gameAuthToken(),id:b},success:d,error:function(){d({success:!1})}})},onKredPurchaseRequest:function(a){this._activeUser.activateKredPurchase(a.data.purchase_method)}};
MicrotransactionService.buildCartJSON=function(a){if(!a||0===a.length)return"[]";a=a.map(function(a){return a?"string"===typeof a||$j.isNumeric(a)?{identifier:a}:Array.isArray(a)?1<=a.length?{identifier:a[0],data:a[1]}:null:"string"===typeof a.identifier&&0<a.identifier.length?a:null!==a&&void 0!==a&&$j.isNumeric(a.identifier)?a:null:null}).filter(function(a){return null!==a});return JSON.stringify(a)};SharedContentService=function(a){this.initialize(a)};
SharedContentService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.SAVE_SHARED_CONTENT,this.onSaveSharedContentRequest.bind(this));this._eventDispatcher.register(KonduitEvent.OP_LOAD_SHARED_CONTENT,this.onSharedContentLoaded.bind(this));this._eventDispatcher.register(KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE,this.onSharedContentSaved.bind(this))},onSharedContentLoaded:function(a){var b=
a.data,c={};c[KonduitEvent.PARAM_DATA]=b.content;c[KonduitEvent.PARAM_CONTENT_TYPE]=b.contentType;c[KonduitEvent.PARAM_NAME]=b.name;c[KonduitEvent.PARAM_PERMALINK]=b.permalink;c[KonduitEvent.PARAM_ID]=b.id;c[KonduitEvent.PARAM_LABEL]=b.label;this._eventDispatcher.sendMessage(a.type,c)},onSharedContentSaved:function(a){var b=a.data,c={};c[KonduitEvent.PARAM_DATA]=b.content;c[KonduitEvent.PARAM_SUCCESS]=b.success;c[KonduitEvent.PARAM_NAME]=b.name;c[KonduitEvent.PARAM_PERMALINK]=b.permalink;c[KonduitEvent.PARAM_ID]=
b.id;c[KonduitEvent.PARAM_LABEL]=b.label;this._eventDispatcher.sendMessage(a.type,c)},onSaveSharedContentRequest:function(a){var b=a.data;if(!b.filename)if(this._activeUser.sharedContentApiEnabled()){var c=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:b.image||Kongregate.DEFAULT_ICON_BASE64},success:function(a){c._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{contentType:b.content_type,content:b.data,label:b.label,filename:a}})},error:this.saveFailed.bind(this)});
this._eventDispatcher.fire({type:KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT})}else this._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{}}),this.saveFailed()},saveFailed:function(){this._eventDispatcher.sendMessage(KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,{name:null,data:null,label:null,id:null,permalink:null,success:!1})}};StatisticService=function(a){this.initialize(a)};StatisticService.MAX_STATS_FOR_PRIORITY={low:10,medium:10,high:5};
StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL=6E4;StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL=1E4;StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL=1E4;
StatisticService.prototype={initialize:function(a){this._statistics=a.statistics;this._isConnected=a.is_connected||function(){return!1};this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._started=!1;var b=this;this._activeUser.addOnAuthenticatedObserver(this.start.bind(this));this._eventDispatcher.register(KonduitEvent.OP_STATS_SUBMIT,function(a){b.submitStats(a.data.stats)})},start:function(){if(this._activeUser.isAuthenticated()&&!this._started){this._started=
!0;var a=this.lowPriorityStats(),b=this.mediumPriorityStats(),c=this.highPriorityStats();Kongregate.Log.debug("Initializing statistic service!");Kongregate.Log.debug("Stats count. Low:"+a.length+", Med:"+b.length+", High: "+c.length);Kongregate.Log.debug({lowStats:a});Kongregate.Log.debug({mediumStats:b});Kongregate.Log.debug({highStats:c});this.flushStatsWithIncompleteTasks();this.startTimers();this._eventDispatcher.register(KonduitEvent.STATISTICS_FLUSH,this.onStatisticsFlush.bind(this));this._eventDispatcher.register(KonduitEvent.STATISTICS_FORCE_FLUSH,
this.onForceFlush.bind(this));this._eventDispatcher.register(KonduitEvent.DISCONNECT,this.onDisconnect.bind(this))}},startTimers:function(){var a=this;this._lowPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.LOW)},StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL);this._mediumPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.MEDIUM)},StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL);this._highPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.HIGH)},
StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL)},stop:function(){clearInterval(this._lowPriorityFlusher);clearInterval(this._mediumPriorityFlusher);clearInterval(this._highPriorityFlusher)},reset:function(){Kongregate.Log.info("Resetting statistic service");this._statistics.forEach(function(a){a.reset()})},submitStats:function(a){if(a&&a.length)for(var b=0;b<a.length;b++)this.submit(a[b].name,a[b].value)},submit:function(a,b){var c=this._statistics.find(function(b){return b.name()===a});c?(b=Math.floor(b),
c.attemptUpdate(b)&&(this._activeUser.isAuthenticated()||this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:c.id(),value:c.value()})),this._activeUser.isAuthenticated()&&c.sendImmediately()&&(Kongregate.Log.debug("Instantly flushing",c),this.flushStats([c]))):Kongregate.Log.warn("No statistic named "+a+" found, ignoring")},flushStats:function(a){if(this._activeUser.isAuthenticated())if(this._isConnected&&!this._isConnected())Kongregate.Log.warn("Holding off on statistic flush since we're not connected");
else{var b={};a.filter(function(a){return a.id&&void 0!==a.id()&&null!==a.id()}).forEach(function(a){b[a.id()]=a.valueToSend();a.markAsSent()});0!==Object.keys(b).length&&this.dispatchEvent(KonduitEvent.STATISTICS_FLUSH,{user:this._activeUser.username(),stats:JSON.stringify(b)})}},flushPriorityStats:function(a){if(this._activeUser.isAuthenticated()){var b=Statistic.sortOnSentAt(this.statsForPriority(a)).filter(function(a){return a.readyToSend()}).slice(0,this.maxStatsToSendForPriority(a));if(0!==
b.length){var c={};c["flush"+a]=b;Kongregate.Log.debug(c);this.flushStats(b)}}},flushStatsWithIncompleteTasks:function(){var a=this._statistics.filter(function(a){return a.readyToSend()&&a.hasIncompleteTasks()});0<a.length&&(Kongregate.Log.info("Flushing all stats with tasks, length="+a.length),this.flushStats(a))},processServerResponse:function(a){if(this._activeUser.isAuthenticated())if(a.user_id&&a.user_id!==this._activeUser.id())Kongregate.Log.warn("Not processing stats response since it was for a different user");
else{if(!a.success&&a.retry)return this.resetPendingValues();this.parseAddStats(a["stats.add"]);this.parseServerStats(a.stats);this.parseTaskStatsProgressed(a["stats.prgs"]);this.parseCurrentHighScores(a["stats.current_high"])}else this.reset()},parseAddStats:function(a){this.forEachStatId(a,function(a,c){a.setSavedValue(c)})},parseServerStats:function(a){this.forEachStatId(a,function(a,c){Statistic.ADD_TYPE===a.type()?a.setPendingValue(a.pendingValue()-c):(a.betterThanSavedValue(c)&&a.setSavedValue(c),
(a.betterThanPendingValue(c)||c==a.pendingValue())&&a.setPendingValue(null));ApiLogger.echoToConsole("debug","["+a.name()+"-ServerUpdate]: submitted="+c+", saved="+a.savedValue()+", pending="+a.pendingValue()+", value="+a.value())})},parseTaskStatsProgressed:function(a){if(a)for(var b in a)a.hasOwnProperty(b)&&this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:parseInt(b,10),value:a[b]})},parseCurrentHighScores:function(a){if(a&&a.length){var b=this;this.forEachStatId(a,function(a){b.dispatchEvent(KonduitEvent.NEW_HIGH_SCORE,
{id:a.id(),value:a.savedValue()})})}},onForceFlush:function(){Kongregate.Log.info("Forcing flush of all statistics");this.flushStats(this._statistics)},onStatisticsFlush:function(a){a.data.result&&this.processServerResponse(a.data)},onDisconnect:function(a){Kongregate.Log.debug("Disconnect detected, resetting statistic pending values");this.resetPendingValues()},resetPendingValues:function(){this._statistics.forEach(function(a){a.resetPendingValue()})},dispatchEvent:function(a,b){this._eventDispatcher.fire({type:a,
data:b})},lowPriorityStats:function(){return this.statsForPriority(Statistic.LOW)},mediumPriorityStats:function(){return this.statsForPriority(Statistic.MEDIUM)},highPriorityStats:function(){return this.statsForPriority(Statistic.HIGH)},statsForPriority:function(a){return this._statistics.filter(function(b){return a===b.priority()})},forEachStatId:function(a,b){if(a){var c=Object.isArray(a),d;for(d in a)if(a.hasOwnProperty(d)){var e=c?this.statForId(a[d]):this.statForId(d);e?b(e,c?null:a[d]):ApiLogger.echoToConsole("warn",
"Statistic ID "+d+" not found")}}},statForId:function(a){return this._statistics.find(function(b){return b.id()==a})},maxStatsToSendForPriority:function(a){return StatisticService.MAX_STATS_FOR_PRIORITY[a]||5}};ChatApiTab=function(a){this.initialize(a)};
ChatApiTab.prototype={initialize:function(a){this._holodeck=a.holodeck;if(this._node=$("chat_api_pane")){this._canvas_node=this._node.down("#chat_api_canvas");this._title_node=this._node.down(".chat_api_pane_title");var b=this,c=this._holodeck;this._chat_dialogue=new ChatDialogue(this._node,function(a){b.sentMessage(a);c.konduit().dispatchEvent({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{message:a,user:{username:c.username()}}})},this._holodeck,this._holodeck.chatWindow())}},sentMessage:function(a){this._chat_dialogue.displayMessage(this._holodeck.username(),
a,{},{non_user:!0})},receivedMessage:function(a){this._chat_dialogue.displayMessage(a.data.user.username,a.data.message,{},{non_user:!0})},clearMessages:function(a){this._chat_dialogue.clear()},setTabInfo:function(a){var b=this._holodeck.height(),c=parseInt(a.data.size*b,10);b=Math.min(b-94,b-c-80);$("chat_api_canvas").setStyle({height:c+"px"});this._chat_dialogue.setMessageWindowHeight(b);this._title_node.update(a.data.description);a="string"==typeof a.data.name?a.data.name.substr(0,10):"Match";
$("chat_api_title").update(a)}};ChatDialogue=function(a,b,c,d,e){this.initialize(a,b,c,d,e)};ChatDialogue.MAX_CHARS_PER_MESSAGE=250;ChatDialogue.SCROLL_FUDGE=35;ChatDialogue.VERY_LARGE_SCROLL=131072;ChatDialogue.COLLECTION_PERIOD=8;ChatDialogue.MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');
ChatDialogue.STICKER_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}" style="float: left">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="chat-msg-sticker">\n<img src="#{stickerUrl}" alt="Sticker #{stickerId} #{stickerVariant}" class="chat-msg-sticker__img"></img>\n<span class="chat-msg-sticker__tooltip">\n#{stickerPackName} Pack\n<span class="chat-msg-sticker__tooltip-lvl #{stickerVariant}">Lv <strong>#{stickerLevel}</strong> <span class="pack-quality--#{stickerQuality}"></span></span>\n</span>\n</span>\n</p>');
ChatDialogue.GUILD_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>\n</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');ChatDialogue.GUEST_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span></p>');
ChatDialogue.MOTD_MESSAGE_TEMPLATE=new Template('<p class="whisper received_whisper">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');ChatDialogue.GUILD_JOIN_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> joined the guild\n</span>\n</p>');
ChatDialogue.GUILD_LEAVE_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> left the guild\n</span>\n</p>');ChatDialogue.STICKER_TAB_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-pack-#{id}-tab" class="chat-sticker-nav__btn" data-sticker-pack-id="#{id}" tabindex="-1">\n<img alt="#{name}" src="#{iconUrl}" class="chat-sticker-nav__ico">\n</button>');
ChatDialogue.STICKER_BUTTON_TEMPLATE=new Template('<li class="chat-sticker-tab__sticker">\n<button class="chat-sticker-tab__btn" data-sticker-id="#{type}-#{id}">\n<img alt="#{name}" src="#{iconUrl}" class="chat-sticker-tab__img">\n</button>\n</li>');ChatDialogue.RECENT_STICKER_BUTTON_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-recent-tab" class="chat-sticker-nav__btn" data-sticker-pack-id="recent" tabindex="-1">\n<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" class="chat-sticker-nav__recent">\n<g style="fill:none;stroke:#000;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10">\n<circle cx="12" cy="12" r="11"/>\n<path d="m8 13h4v-6"/>\n</g>\n</svg>\n</button>');
ChatDialogue.STICKER_ADD_BUTTON_TEMPLATE=new Template('<button role="tab" aria-selected="false" aria-controls="sticker-add-tab" class="chat-sticker-nav__btn chat-sticker-nav__add" data-sticker-pack-id="add" tabindex="-1">\n+\n</button>');
ChatDialogue.prototype={initialize:function(a,b,c,d,e){this._messages_until_next_collection=0;this._holodeck=c;this._sticker_manager=c._sticker_manager;this._chat_window=d;this._room=e;this._parent_node=a;this._messages_count=0;this._onInputFunction=b;this._message_window_node=a.down(".chat_message_window");this._input_node=a.down(".chat_input");this._chars_remaining_node=$j(a.down(".chat_chars_remaining"));this._chat_text_controls_node=$j(a.down(".chat_text_controls"));this._chat_sticker_controls_node=
$j(a.down(".chat_sticker_controls"));this._sticker_button_node=$j(a.down(".chat-sticker-btn"));this._text_button_node=$j(a.down(".chat-sticker-nav__txt"));this._sticker_tabs_node=$j(a.down(".chat-sticker-nav__btns"));this._sticker_pack_commons=$j(a.down(".chat-sticker-tab__normal"));this._sticker_pack_shinies=$j(a.down(".chat-sticker-tab__shiny"));this._sticker_tab_node=$j(a.down(".chat-sticker-tab"));this._sticker_market_tab_node=$j(a.down(".chat-sticker-market-tab"));this._chat_message_window=$j(a.down(".chat_message_window"));
this._sticker_next_button=$j(a.down(".chat-sticker-nav__next"));this._sticker_prev_button=$j(a.down(".chat-sticker-nav__prev"));this._sticker_pop_node=$j("#chat_container_cell .c-sticker-preview").first();this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200;var g=this;this._input_node.observe("keypress",function(a){g.onKeyPress(a)});this._input_node.observe("focus",function(a){g.clearPrompt()});$j(this._input_node).on("textchange",function(){g.updateCharsRemaining(g._input_node)});
this._message_window_node.observe("click",function(a){if(a.target){var b=a.target.getAttribute("username");b&&(a.stop(),d.showProfile(b))}});this.setupStickers()},focus:function(){this._input_node.focus()},onKeyPress:function(a){a.keyCode==Event.KEY_RETURN&&(this.sendInput(),this.updateCharsRemaining(a.target),a.stop())},updateCharsRemaining:function(a){a=a.value.length;if(a>ChatDialogue.MAX_CHARS_PER_MESSAGE)return this._chars_remaining_node.addClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-
a),!1;this._chars_remaining_node.removeClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-a)},clearPrompt:function(){this._input_node.hasClassName("prompt_text")&&(this._input_node.removeClassName("prompt_text"),this._input_node.value="",this._input_node.stopObserving("focus"))},sendInput:function(){var a=this._input_node.value;this._holodeck.processChatCommand(a)&&this._holodeck.filterOutgoingMessage(a,this._onInputFunction);this._input_node.value=""},disable:function(){this._parent_node.down(".chat_controls").hide()},
enable:function(){this._parent_node.down(".chat_controls").show()},displayUnsanitizedMessage:function(a,b,c,d){c||(c={});d||(d={});allow_mutes=(active_room=this._holodeck.chatWindow().activeRoom())&&!active_room.canUserModerate(active_room.self())||d.whisper;if(!allow_mutes||!this._chat_window.isMuted(a)){var e=d.non_user?"chat_message_window_undecorated_username":"chat_message_window_username",g=a==this._chat_window.username(),h=[];e=[e];var l=d["private"]?"To ":"";this._messages_count%2&&h.push("even");
c["class"]&&h.push(c["class"]);g&&e.push("is_self");d.timestamp=d.timestamp?new Date(d.timestamp):new Date;d.formatted_timestamp=d.timestamp.format("mmm d - h:MMTT");if(c="string"===typeof b?null:b.stickerId)d.template=ChatDialogue.STICKER_MESSAGE_TEMPLATE,d.stickerId=c,d.stickerVariant=b.stickerVariant,d.stickerPackName=b.stickerPackName,d.stickerLevel=b.level,d.stickerQuality=100<=b.level?b.quality+" is-ranked":b.quality,d.stickerUrl=this._sticker_manager.url(c,d.stickerVariant,72);a=this.messageContent({prefix:l,
username:a,message:b,classNames:h.join(" "),userClassNames:e.join(" "),characterName:d.characterName,timestamp:d.formatted_timestamp,template:d.template,stickerId:d.stickerId,stickerVariant:d.stickerVariant,stickerUrl:d.stickerUrl,stickerLevel:d.stickerLevel,stickerQuality:d.stickerQuality,stickerPackName:d.stickerPackName});this.insert(a,null,{timestamp:d.timestamp});this._messages_count++}},messageContent:function(a){var b=!a.username.match(/^_/);return(a.template?a.template:a.characterName&&b?
ChatDialogue.GUILD_MESSAGE_TEMPLATE:b?ChatDialogue.MESSAGE_TEMPLATE:ChatDialogue.GUEST_MESSAGE_TEMPLATE).evaluate(a)},displayMessage:function(a,b,c,d){var e=this,g=function(b){e.displayUnsanitizedMessage(a,b,c,d)};"string"===typeof b?this._holodeck.filterIncomingMessage(b,g):g(b)},kongBotMessage:function(a){this.displayMessage("Kong Bot",a,{"class":"whisper received_whisper"},{non_user:!0})},displaySystemMessage:function(a,b){switch(a.type){case "guild_join":this.displayUnsanitizedMessage("Kong Bot",
null,{},{non_user:!0,timestamp:b,characterName:a.character_name,template:ChatDialogue.GUILD_JOIN_TEMPLATE});break;case "guild_leave":this.displayUnsanitizedMessage("Kong Bot",null,{},{non_user:!0,timestamp:b,characterName:a.character_name,template:ChatDialogue.GUILD_LEAVE_TEMPLATE})}},insert:function(a,b,c){var d=this,e=this._message_window_node,g=this._holodeck;g.scheduleRender(function(){var h=e.getHeight(),l=h+e.scrollTop+ChatDialogue.SCROLL_FUDGE>=e.scrollHeight,f=0!==h&&l;g.scheduleRender(function(){if("string"==
typeof a||a instanceof String)a=$j("<div/>",{html:a,"class":"chat-message"});c=c||{};var g=$j(a).data(c),h=!1,l;$j(e).children(".chat-message").each(function(){var a=$j(this).data("timestamp");if(a>c.timestamp)return l=this,d.sameTimestamps(c.timestamp,a)&&$j(this).find(".timestamp").hide(),!1;!h&&c.timestamp&&d.sameTimestamps(c.timestamp,a)&&(h=!0)});h&&g.find(".timestamp").hide();l?(g.insertBefore(l),f=!1):g.appendTo(e);f&&d.scrollToBottom();b&&b()})})},scrollToBottom:function(){this._message_window_node.scrollTop=
ChatDialogue.VERY_LARGE_SCROLL},setInput:function(a){this.clearPrompt();var b=this._input_node;setTimeout(function(){b.setValue(a);b.positionCaretAtEnd()},0)},sendPrivateMessage:function(a,b){this._chat_window.sendPrivateMessage(a,b);this.displayMessage(a,b,{"class":"whisper sent_whisper"},{"private":!0})},receivedPrivateMessage:function(a){if(a.data.success){var b=this;this._holodeck.filterIncomingMessage(a.data.message,function(c){b.displayUnsanitizedMessage(a.data.from,c+'&nbsp; (<a class="reply_link" onclick="holodeck.insertPrivateMessagePrefixFor(\''+
a.data.from+'\');return false;" href="#">reply</a>)',{"class":"whisper received_whisper"},{whisper:!0})})}else this.kongBotMessage(a.data.to+" cannot be reached. Please try again later.")},setMessageWindowHeight:function(a){this._message_window_node.setStyle({height:a+"px"})},clear:function(){this._message_window_node.update("")},earliestTimestamp:function(){var a=$j(this._message_window_node).children(".chat-message").first();return a&&a.data("timestamp")?a.data("timestamp")/1E3:0},sameTimestamps:function(a,
b){return"undefined"!==typeof a&&"undefined"!==typeof b&&a.getYear()===b.getYear()&&a.getMonth()===b.getMonth()&&a.getDay()===b.getDay()&&a.getHours()===b.getHours()&&a.getMinutes()===b.getMinutes()},stickersEnabled:function(){return this._room&&this._room.supportsStickers()},setupStickers:function(){if(!this.stickersEnabled())return this._sticker_button_node.remove();this._sticker_manager.on("update",this.onStickersUpdated.bind(this));this._sticker_manager.on("update-recent",this.updateRecentStickers.bind(this));
this._sticker_button_node.on("click",this.showStickerControls.bind(this));this._text_button_node.on("click",this.hideStickerControls.bind(this));this._sticker_next_button.on("click",this.scrollStickers.bind(this,64));this._sticker_prev_button.on("click",this.scrollStickers.bind(this,-64));this.insertStickerCollections();this.insertAddStickerButton()},showStickerControls:function(){this._chat_text_controls_node.hide();this._chat_sticker_controls_node.show();this.insertRecentStickerButton();this._sticker_tabs_node.scrollLeft(0);
this.scrollToBottom();this._recent_stickers_node?this.showRecentStickers():this.showUserStickers(this._sticker_manager.userStickerCollections[0]);var a=this,b=!1,c=0,d=0;$j(document).on("mousedown.stickers",function(e){e.target.closest(".chat-sticker-nav__btns")&&(b=!0,c=e.clientX,d=a._sticker_tabs_node.scrollLeft())});$j(document).on("mouseup.stickers",function(){b&&(b=!b,a._sticker_tabs_node[0].classList.remove("is-dragging"))});$j(document).on("mousemove.stickers",function(e){b&&3<Math.abs(c-e.clientX)&&
(a._sticker_tabs_node[0].classList.add("is-dragging"),a._sticker_tabs_node.scrollLeft(d+c-e.clientX))})},hideStickerControls:function(){this._chat_sticker_controls_node.hide();this._chat_text_controls_node.show();this.hideStickerPopup();$j(document).off(".stickers")},onStickerClicked:function(a,b){this._room.sendSticker(a.id,b);this.hideStickerControls()},onStickersUpdated:function(){this.insertStickerCollections()},insertStickerNodeIntoTab:function(a,b,c){var d={id:a.id,name:a.alt_text,iconUrl:this._sticker_manager.url(a.id,
b,72),type:b};d=$j($j.parseHTML(ChatDialogue.STICKER_BUTTON_TEMPLATE.evaluate(d)));d.on("click",this.onStickerClicked.bind(this,a,b));d.hover(this.showStickerPopup.bind(this,a,b),this.hideStickerPopup.bind(this));"shiny"===b||c?this._sticker_pack_shinies.append(d):this._sticker_pack_commons.append(d)},showUserStickers:function(a){if(a){var b=this;this._sticker_pack_commons.empty();this._sticker_pack_shinies.empty();["shiny","normal"].forEach(function(c){a[c].forEach(function(a){b.insertStickerNodeIntoTab(a,
c)})});this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected","false");this._sticker_tabs_node.find('[data-sticker-pack-id="'+a.id+'"]').attr("aria-selected","true");this._sticker_market_tab_node.hide();this._sticker_tab_node.show()}},isStickerTabActive:function(a){return"true"===this._sticker_tabs_node.find('[data-sticker-pack-id="'+a+'"]').attr("aria-selected")},updateRecentStickers:function(){if(this.isStickerTabActive("recent")){var a=this,b=this._sticker_manager.recentStickers||[];
this._sticker_pack_commons.empty();this._sticker_pack_shinies.empty();b.forEach(function(b){var c=a._sticker_manager.stickers[b.id];c&&a.insertStickerNodeIntoTab(c,b.variant,!0)})}},showRecentStickers:function(){this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected","false");this._sticker_tabs_node.find('[data-sticker-pack-id="recent"]').attr("aria-selected","true");this.updateRecentStickers();this._sticker_market_tab_node.hide();this._sticker_tab_node.show()},showStickerUpsell:function(){this._sticker_tabs_node.find('[role="tab"]').attr("aria-selected",
"false");this._sticker_tabs_node.find('[data-sticker-pack-id="add"]').attr("aria-selected","true");this._sticker_tab_node.hide();this._sticker_market_tab_node.show()},insertStickerCollections:function(){if(this.stickersEnabled()){var a=this;this._sticker_tabs_node.empty();this._sticker_manager.userStickerCollections.forEach(function(b){var c=$j($j.parseHTML(ChatDialogue.STICKER_TAB_TEMPLATE.evaluate(b)));a._sticker_tabs_node.append(c);c.on("click",a.showUserStickers.bind(a,b,c))});this.insertRecentStickerButton();
this._recent_stickers_node?this.showRecentStickers():this.showUserStickers(this._sticker_manager.userStickerCollections[0])}},insertRecentStickerButton:function(){var a=this._sticker_manager.recentStickers;a&&a.length&&!this._recent_stickers_node&&(a=$j($j.parseHTML(ChatDialogue.RECENT_STICKER_BUTTON_TEMPLATE.evaluate({}))),a.on("click",this.showRecentStickers.bind(this)),this._sticker_tabs_node.prepend(a),this._recent_stickers_node=a)},insertAddStickerButton:function(){var a=$j($j.parseHTML(ChatDialogue.STICKER_ADD_BUTTON_TEMPLATE.evaluate({})));
a.on("click",this.showStickerUpsell.bind(this));this._sticker_tabs_node.append(a);this._add_stickers_node=a},scrollStickers:function(a){a=this._sticker_tabs_node.scrollLeft()+a;this._sticker_tabs_node.animate({scrollLeft:a},{duration:125,easing:"linear",queue:!1})},showStickerPopup:function(a,b){var c=this._sticker_pop_node.find("img");this._sticker_pop_node.attr("data-target",b+"-"+a.id);c.attr("src",this._sticker_manager.url(a.id,b,72));c.attr("alt",a.alt_text);this.updateStickerPopup();this._sticker_pop_node.show();
$j(document).on("scroll.stickerPopUp",this.updateStickerPopup.bind(this));$j(this._sticker_tab_node[0]).on("scroll.stickerPopUp",this.updateStickerPopup.bind(this))},updateStickerPopup:function(){var a=this._sticker_pop_node[0].getAttribute("data-target");a=this._parent_node.down("[data-sticker-id="+a+"]").getBoundingClientRect();this._sticker_pop_node[0].style.top=a.top-10+"px";this._sticker_pop_node[0].style.left=a.left+24+"px"},hideStickerPopup:function(){this._sticker_pop_node.hide();$j(document).off("scroll.stickerPopUp");
$j(this._sticker_tab_node[0]).off("scroll.stickerPopUp")}};ChatNag=function(a,b){this.initialize(a,b)};
ChatNag.prototype={initialize:function(a,b){this._chat_window=a;this._chat_nags=b;this._current_increment=0;b.each(function(a){active_user.isPremium()&&a.advertising&&b.splice(b.indexOf(a),1)});if(b&&0<b.length){var c=this;this._executer=new PeriodicalExecuter(function(){c.showNag()},60)}},showNag:function(){var a;this._current_increment+=1;if(this._chat_nags&&0<this._chat_nags.length&&this._current_increment===this._chat_nags.first().spawn_delay){var b=this._chat_nags.shift();if(!this.targetedToDifferentRoom(b)){if(a=
null!==b.cnid){var c="kong_cns_"+b.cnid;if(b.suppressible&&Cookie.get(c))return;if(b.per_user_limit){var d="kong_cnul_"+b.cnid;var e=parseInt(Cookie.get(d)||0,10);if(e>=b.per_user_limit)return;Cookie.set(d,e+1,b.days_to_expire,"/")}d=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||1,10);e="kong_cn_"+b.cnid;var g=parseInt(Cookie.get(e)||0,10);g+=b.frequency}if(!a||g<=d)this._chat_window.showChatNag(this.prepareNagContent(b),function(){var a=$("nag_supress_control_"+b.cnid);a&&a.observe("click",
function(a){$("nag_wrapper_"+b.cnid).hide();Cookie.set(c,"true",b.days_to_expire,"/");Event.stop(a);return!1})}),this._chat_window.recordAnalyticsEvent("ChatNag",b.name),a&&(Cookie.set(e,d,b.days_to_expire,"/"),b.has_campaign_cap&&new Ajax.Request("/chat_nags/"+b.cnid+"/increment",{method:"post"}))}}},prepareNagContent:function(a){var b=(new Date).getTime();b=a.nag_content.gsub("TIMESTAMP",b);var c=new Template('<div id="nag_wrapper_#{cnid}" class="chat_nag"><a title="Do not show this again" id="nag_supress_control_#{cnid}" class="nag_supress_control">X</a>#{content}</div>');
a.suppressible&&(b=c.evaluate({cnid:a.cnid,content:b}));return b},updateDefaultNag:function(a){this._chat_nags&&0!==this._chat_nags.length&&null===this._chat_nags[0].cnid&&(this._chat_nags[0]=a)},targetedToDifferentRoom:function(a){return a.targeted_room_id.blank()?!1:a.targeted_room_id!==this._chat_window.activeRoom().id()?!0:!1}};ChatRoom=function(a,b){this.initialize(a,b)};ChatRoom._generateTemplate=function(){this._template||(this._template=$$(".chat_room_template")[0])};
ChatRoom.template=function(){this._generateTemplate();return this._template.cloneNode(!0)};ChatRoom.updateTemplateSilenceScheduledEnd=function(a){this._generateTemplate();this._template.down(".silence_duration").update(tr("You have been silenced for "+a))};ChatRoom.initializeTemplates=function(){ChatRoom.USER_ROW_TEMPLATE||(ChatRoom.USER_ROW_TEMPLATE=new Template($("user_row_template").innerHTML),ChatRoom.ADMIN_MESSAGE_TEMPLATE=new Template($("admin_message_template").innerHTML))};
ChatRoom.prototype={initialize:function(a,b){this._chat_window=a;this._room=b;this._users={};this._users_list=[];this._guests_in_room_count=this._users_in_room_count=0;this._favorite_room=a.isFavoriteRoom(b.id);this._node=ChatRoom.template();ChatRoom.initializeTemplates();this._users_in_room_node=this._node.down(".users_in_room");this._guests_in_room_node=this._node.down(".guest_count_in_room");this._number_in_room_node=a._chat_window_node.down(".number_in_room");this._guest_count_holder=this._node.down(".guest_count_holder");
this._silence_duration_node=this._node.down(".silence_duration");this._chat_actions_node=(new Element("div")).setStyle({display:"none"}).update($("chat_actions_dropdown_template").innerHTML);this._chat_actions_options=this._chat_actions_node.down("ul.chat_actions_list");this._chat_actions_control=this._chat_actions_node.down("span.btn");var c=this;this._chat_actions_control.observe("click",function(){$j(c._chat_actions_options).toggle()});document.observe("click",function(a){a.target.hasClassName("btn_target")||
$j(c._chat_actions_options).hide()});$("chat_actions_container").insert(this._chat_actions_node);this._chat_actions_options.select(".exclude_"+this.type()).invoke("remove");this._favorite_room_option_node=this._chat_actions_options.down(".favorite_room");this._tab_for_room=this._chat_window.tabForRoom(this);this._unread_message_node=this._tab_for_room.down(".unread_chat_messages");this._favorite_room_option_node&&this._favorite_room&&this._favorite_room_option_node.writeAttribute("data-chat-action",
"unfavorite_room").update(tr8nProxy.trl("Unfavorite room"));var d=function(a){c.addToFavorites();a.stop()},e=function(b){a.showOnlineFriends();b.stop()};this._chat_actions_options.observe("click",function(b){var g=$j(b.target);g.is("li")||(g=g.parent("li"));switch(g.attr("data-chat-action")){case "room_chooser":a.activateRoomChooser();break;case "leave_private":c.isMyPrivateRoom()?holodeck.destroyPrivateRoom():holodeck.leavePrivateRoom();break;case "leave_guild":holodeck.leaveGuildRoom();break;case "friends_online":g=
CapturesToInlineRegistration.decorate(e);g(b);break;case "room_details":a.activateRoomInfo(c);b.stop();break;case "favorite_room":b.stop();g=CapturesToInlineRegistration.decorate(d);g(b);break;case "unfavorite_room":c.removeFromFavorites();b.stop();break;case "set_status":KonduitPresenceType.AWAY==c._presence?a.holodeck().setPresenceChat():a.holodeck().setPresenceAway()}c._chat_actions_options.hide()});this._users_in_room_node.on("mouseover",".js-user-chat-hover",function(b){var d=b.target.getAttribute("username");
d&&d.toLowerCase()!=c.username().toLowerCase()&&(d=c.user(d),a.showUserRollover(d,b.target),Event.stop(b))});this._users_in_room_node.observe("mouseout",function(b){a.hideUserRollover();Event.stop(b)});this._users_in_room_node.on("click",".username",function(b){var c=b.target.getAttribute("username");c&&(a.showProfile(c),Event.stop(b))});this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200;this._chat_dialogue=new ChatDialogue(this._node,function(a){c.sendRoomMessage(a)},
this.holodeck(),this._chat_window,this);a._chat_rooms_container_node.insert({bottom:this._node});this._history_button=$j(this._node).find(".chat_message_window .history-button");this._history_spinner=$j(this._node).find(".chat_message_window .history-spinner");this.isGuildRoom()&&(this.showHistoryButton(),this._history_button.on("click",function(){c._history_button.hide();c._history_spinner.show();c.fetchHistory()}))},showHistoryButton:function(){this._history_button.show();this._history_spinner.hide()},
hideHistoryButton:function(){this._history_button.hide();this._history_spinner.hide()},destroy:function(){this._node.remove();this._chat_actions_node.remove()},chatEnabled:function(){return this._chat_enabled},disable:function(){this._chat_dialogue.disable();this._chat_enabled=!1},disableDueToGuest:function(){this._node.down(".guest_chat_controls").show();this.disable()},disableDueToSilence:function(){this.isPrivate()||(this._node.down(".silenced_chat_controls").show(),this.disable())},disableDueToFayeDisconnect:function(){this.disconnectedFromFaye=
!0;this._node.down(".faye_disconnect_controls").show();this.disable()},enableDueToFayeConnect:function(){this.disconnectedFromFaye=!1;this.enable()},enable:function(){this._node.down(".guest_chat_controls").hide();this._node.down(".silenced_chat_controls").hide();this._node.down(".faye_disconnect_controls").hide();this._chat_dialogue.enable();this._chat_enabled=!0},username:function(){return this._chat_window.username()},id:function(){return this._room.id},name:function(){return this._room.name},
xmppName:function(){return this._room.xmpp_name},shortName:function(){this._short_room_name||(this._short_room_name="room_"+this._room.xmpp_name);return this._short_room_name},type:function(){return this._room.type},isGuildRoom:function(){return"guild"===this._room.type},supportsStickers:function(){return!this.isGuildRoom()},guildId:function(){if("guild"!=this.type())console.error("Attempted to check guildId for non guild room");else return Holodeck.guildIdFromXmppName(this.xmppName())},konduit:function(){return this._chat_window.konduit()},
isPrivate:function(){return"private"==this.type()},isMyPrivateRoom:function(){return this.isPrivateRoomOwner(this.username())},isPrivateRoomOwner:function(a){if(this.isPrivate()&&a)try{var b=this.xmppName(),c=b.substr(b.indexOf("-")+1);return c&&c.toLowerCase()==a.toLowerCase()}catch(d){}return!1},privateRoomOwnerUsername:function(){if(this.isPrivate())try{return this.name().split("'")[0]}catch(a){}return null},dispatchEvent:function(a){this.konduit().dispatchEvent(a)},insert:function(a,b){this._chat_dialogue.insert(a,
b)},receivedAdminMessage:function(a){this._chat_dialogue.insert(ChatRoom.ADMIN_MESSAGE_TEMPLATE.evaluate({content:a.data.admin_message}))},fetchHistory:function(){holodeck.konduit().dispatchEvent({type:KonduitEvent.FETCH_HISTORY,data:{room:this._room,maxTime:this._chat_dialogue.earliestTimestamp()}})},sendRoomMessage:function(a){a&&this.dispatchRoomMessage(this._chat_window.escapeOutgoingMessage(a))},sendSticker:function(a,b){if(this.supportsStickers()){this.holodeck()._sticker_manager.trackRecentSticker(a,
b);var c=this.holodeck()._sticker_manager.stickers[a];c=this.holodeck()._sticker_manager.userStickerPacks[c.sticker_pack_id][b];this.dispatchRoomMessage({stickerId:a,stickerVariant:b,level:c.shiny_level,quality:c.quality,stickerPackName:c.stickerPack.name})}},dispatchRoomMessage:function(a){this.holodeck()._sticker_manager.performDailyActivity("chat_message");this.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:{message:a,room:this._room}})},receivedMessage:function(a){this.isActive()||this._unread_message_node.show();
this.checkUserForModeration(a.data.user.username);this._chat_dialogue.displayMessage(a.data.user.username,a.data.message,{},{characterName:a.data.user.variables.game_character_name,timestamp:a.data.timestamp})},receivedSystemMessage:function(a){this.isActive()||this._unread_message_node.show();this._chat_dialogue.displaySystemMessage(a.data.data,a.data.timestamp)},checkUserForModeration:function(a){this.self()?this.canUserModerate(this.self())&&this._chat_window.noticedModeratableUser(a):this.checkUserForModeration.bind(this).delay(500,
a)},messageError:function(a){this.insert(this._chat_window.errorMessageTemplate(a.data.errorType))},_avatarSrc:function(a){return a.chatAvatarUrl()},_avatarStyle:function(a){return""},_generateUserNode:function(a){var b=this._chat_window,c=a.username;c={rowClasses:[],avatarSrc:this._avatarSrc(a),avatarStyle:this._avatarStyle(a),userNodeId:this.userNodeId(c),usernameNodeId:this.usernameNodeId(c),username:c,level:a.level()};a.gameCharacterName()&&(c.game_character_name="("+a.gameCharacterName()+")");
a.isSilenced()&&c.rowClasses.push("silenced");KonduitPresenceType.AWAY==a.presence()&&c.rowClasses.push("away");b.isMuted(a)&&c.rowClasses.push("muted");var d={};a.isAdmin()?d={extraIconClass:"spritesite admin_icon",extraIconType:"Administrator",extraIconTitle:"Administrator"}:this.owner()==a.username?d={extraIconClass:"spritesite room_owner_icon",extraIconType:"Room Owner",extraIconTitle:"Room Owner"}:this.canUserModerate(a)?d={extraIconClass:"spritesite moderator_icon",extraIconType:"Moderator",
extraIconTitle:"Moderator"}:a.isDeveloper()&&(d={extraIconClass:"spritesite developer_icon",extraIconType:"Developer",extraIconTitle:"Developer"});c=Object.extend(c,d);d=ChatRoom.USER_ROW_TEMPLATE;var e=a.specialChatVars();if(e){var g=(active_user.username()==a.username?"You've":a.username)+" completed",h=[];e.chat_icons&&(e.chat_icons.each(function(a){a.message=g;var b='<img src="#{image_url}" alt="#{message} #{subject_name}" title="#{message} #{subject_name}" class="#{slug} rank_icon" />'.interpolate(a);
"kartridge-charter"==a.slug&&(b='<a href="https://www.kartridge.com" target="_blank">'+b+"</a>");h.push(b)}),c.extraIconTags=h.join(""))}d=(new Element("div",{id:c.userNodeId,"class":"user_row "+c.rowClasses.join(" ")})).update(d.evaluate(c));b.isFriend(a)||d.down(".friend_icon").remove();c.extraIconType||d.down(".rank_icon").remove();a.isPremium()?active_user.premiumizeUpsellNode(d.down(".premium_icon"),"username_icon","icon_tab"):d.down(".premium_icon").remove();a.isMobile()||d.down(".mobile_icon").remove();
a.isGuest()&&d.down(".username").remove();return d},self:function(){return this._users[this.username().toLowerCase()]},removeUser:function(a){if(a=a.userRowNode?a:this.user(a.username))this.removeUserNode(a),delete this._users[a.username.toLowerCase()],this._users_list.orderedDelete(a,this.userSorter())},removeUserNode:function(a){(a=this.user(a.username))&&a.userRowNode()&&a.userRowNode().remove()},isGuest:function(a){return this._chat_window.isGuest(a)},userSorter:function(){var a=this._chat_window,
b=this,c=function(b){return a.username()==b.username},d=function(a){return!a.isSilenced()},e=function(a){return a.isAdmin()},g=function(a){return!a.isAdmin()&&b.canUserModerate(a)},h=function(b){return a.isFriend(b)},l=function(b){return!a.isMuted(b)},f=function(a){return a.isAway()},m=function(a,b,c){b=a(b);a=a(c);return b&&!a?-1:!b&&a?1:0};return function(a,b){return m(c,a,b)||m(d,a,b)||m(e,a,b)||m(g,a,b)||m(h,a,b)||m(l,a,b)||a.username.toLowerCase().localeCompare(b.username.toLowerCase())||m(f,
a,b)}},updateUser:function(a,b){if(!this.isGuest(a)){var c=this.userSorter(),d=this._users[a.username.toLowerCase()];a=a.variables?new ChatUser(a.variables):a;if(b||!d||0!==c(d,a)){d&&(this.removeUserNode(a),this._users_list.orderedDelete(d,c));this._users[a.username.toLowerCase()]=a;a.setUserRowNode(this._generateUserNode(a));var e,g;try{var h=this._users_list.orderedInsert(a,c);0<h&&(g=(e=this._users_list[h-1])?e.userRowNode():null)&&$j(g).after(a.userRowNode());g||$j(a.userRowNode()).prependTo(this._users_in_room_node)}catch(l){Kongregate.Log.error("Error adding user to list",
l,h,e,g)}if(a.username==this._chat_window.username()){if(this._presence!=a.presence())switch(a.presence()){case KonduitPresenceType.CHAT:this._chat_dialogue.kongBotMessage("Set status to active");$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Away"));break;case KonduitPresenceType.AWAY:this._chat_dialogue.kongBotMessage("Set status to away"),$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Active"))}this._presence=a.presence()}}}},
updateRoomHeader:function(){this._chat_window._chat_window_node.down(".room_name").innerHTML=this.name();this.updateUsersCount()},updateUsersCount:function(){this.isActive()&&this._number_in_room_node.update(this._users_list.length+this._guests_in_room_count)},updateGuestCount:function(a){a&&this.setGuestCount(this._guests_in_room_count+a)},guestCountUpdated:function(a){this.setGuestCount(a.data.guests)},setGuestCount:function(a){0<=a&&(this._guests_in_room_count=a);a=" guests in room";1==this._guests_in_room_count&&
(a=" guest in room");0<this._guests_in_room_count?(this._guest_count_holder.show(),this._guests_in_room_node.update(this._guests_in_room_count+a)):this._guest_count_holder.hide()},updateSilenceScheduledEnd:function(a){this._silence_duration_node.update(tr("You have been silenced for "+a))},isSilenced:function(){return this._chat_window.isSilenced()},userJoined:function(a){a=a.data.user;this.user(a.username)||this.updateUser(a);this.isGuest(a)&&this.updateGuestCount(1);this.updateUsersCount()},userChanged:function(a){this.updateUser(a.data.user,
a.data.force||a.data.user.variables.force)},userLeft:function(a){a=a.data.user;this.isGuest(a)||(this.removeUser(a),this.isMyPrivateRoom()&&delete holodeck._users_invited[a.username]);this.isGuest(a)&&this.updateGuestCount(-1);this.updateUsersCount()},updateChatControlsForUser:function(a){a.username==this.username()&&(a.isSilenced()||this.enable(),this.isGuest(a)&&this.disableDueToGuest())},userListScrollTop:function(){return this._users_in_room_node.scrollTop},user:function(a){return this._users[a.toLowerCase()]},
users:function(){return this._users_list},addFriends:function(a){this.refreshUsers(a)},removeFriends:function(a){this.refreshUsers(a)},addMutings:function(a){this.refreshUsers(a)},refreshUsers:function(a){for(var b,c=[],d=0,e=a.length;d<e;d++)if(b=this.user(a[d]))this.removeUser(b),c.push(b);d=0;for(e=c.length;d<e;d++)this.userChanged({data:{user:c[d],force:!0}})},hide:function(){this._node.hide();this._chat_actions_node.hide();this._tab_for_room.removeClassName("active")},show:function(){this._node.show();
this.updateRoomHeader();this._chat_actions_node.show();this._tab_for_room.addClassName("active");this._unread_message_node.hide();this.scrollToBottom()},showChatNag:function(a,b){this.insert(a,b)},owner:function(){return this._chat_window.roomOwner(this._room.id)},holodeck:function(){return this._chat_window.holodeck()},insertInChatInput:function(a){this._chat_dialogue.setInput(a)},addToFavorites:function(){this._chat_window.recordAnalyticsEvent("ChatAction","FavoriteRoom");new Ajax.Request("/rooms/"+
this._room.id+"/favorite_rooms",{asynchronous:!0,evalScripts:!0,method:"post"});this._favorite_room_option_node.writeAttribute("data-chat-action","unfavorite_room").update(tr8nProxy.trl("Unfavorite room"));this._chat_window.addFavoriteRooms([this._room.id])},removeFromFavorites:function(){new Ajax.Request("/rooms/"+this._room.id+"/unfavorite_rooms",{asynchronous:!0,method:"post"});this._favorite_room_option_node.writeAttribute("data-chat-action","favorite_room").update(tr8nProxy.trl("Favorite this room"));
this._chat_window.removeFavoriteRoom(this._room.id)},userNodeId:function(a){return"user_"+a+"_"+this.shortName()},usernameNodeId:function(a){return"username_"+this.userNodeId(a)},getId:function(){return this._room.id},scrollToBottom:function(){this._chat_dialogue.scrollToBottom()},isActive:function(){return this==this._chat_window.activeRoom()},roomId:function(){return parseInt(this._room.id)},isGameRoom:function(){return"game"==this._room.type},gameId:function(){return this.isGameRoom()?this._room.game_id||
parseInt(this._room.id.match(/^\d+/)[0],10):null},canUserModerate:function(a){if(!a)return!1;var b=a.moderatorRoomIds();a=a.moderatorGameIds();return"all"==b||"all"==a?!0:this.isGameRoom()?a.include(this.gameId()):b.include(this.roomId())}};ChatRoomChooser=function(a){this.initialize(a)};ChatRoomChooser.DESCRIPTION_TOP_FUDGE=9;
ChatRoomChooser.prototype={initialize:function(a){this._chat_window=a.chat_window;this._node=$("chat_room_chooser");this._holodeck=a.holodeck;if(this._node){this._rooms_list_node=this._node.down(".rooms_list");if(this._room_description_rollover_node=this._rooms_list_node.down(".room_description_rollover_container"))this._room_description_rollover_content=this._room_description_rollover_node.down(".room_description_rollover_content");var b=this,c=this._holodeck;this._node.down(".return_to_room").observe("click",
function(a){b.deactivate();a.stop()});this._rooms_list_node.observe("click",function(a){var d=a.target;d.hasClassName("room")||(d=d.up(".room"));!d||d.hasClassName("full")&&!c.isChatModerator()||(b._chat_window.recordAnalyticsEvent("ChatAction","ChangeRoom"),b.joinRoom(d));a.stop()});this._room_groups=$H()}},isActive:function(){return this._node.visible()},activate:function(a){a&&this._node.down(".room_name").update(a.name());this._chat_window.hideChatWindow();this.requestJoinableRooms();this.clearGroups();
this._chat_window.setActiveTempPane(this);this.show()},deactivate:function(){this.hide();this._chat_window.clearActiveTempPane();this._chat_window.showChatWindow()},show:function(){this._node.ieHappyShow()},hide:function(){this._node&&this._node.ieHappyHide()},clearGroups:function(){$H(this._room_groups).each(function(a){a=a[1];a.clearRooms();a._node.hide()})},roomGroups:function(a){this.clearGroups();for(var b=0,c=a.length;b<c;b++)this.addRoomGroup(a[b])},redoRoomList:function(){this.clearGroups();
this.isActive()&&this.requestJoinableRooms()},addRoomGroup:function(a){var b=this._rooms_list_node,c=this,d=this._room_groups.getWithDefault(a.name,function(){return new ChatRoomGroup(c,b,a)});d.setRooms(a.rooms);d.show();a.expand&&d.open()},requestJoinableRooms:function(){this._chat_window.showSpinner();var a=this._chat_window;new Ajax.Request("/rooms.js?game_id="+this.holodeck().gameId(),{method:"get",onComplete:a.hideSpinner})},roomGroup:function(a){return this._room_groups.get(a)},joinRoom:function(a){var b=
a.room;(a=$j(a).data("guild-room"))?this.holodeck().joinRoom(a):b.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom","chat_features_tab"):this.holodeck().joinRoom(b)},holodeck:function(){return this._holodeck},showDescriptionRollover:function(a,b){this._room_description_rollover_content.update(a);this.setDescriptionRolloverPosition(b);this._room_description_rollover_node.show()},hideDescriptionRollover:function(){this._room_description_rollover_content.update("");
this._room_description_rollover_node.hide()},beginDescriptionRolloverHide:function(){var a=this;this._room_rollover_hide_timer&&clearTimeout(this._room_rollover_hide_timer);this._room_rollover_hide_timer=setTimeout(function(){a.hideDescriptionRollover()},5E3)},stopDescriptionRolloverHide:function(){clearTimeout(this._room_rollover_hide_timer)},setDescriptionRolloverPosition:function(a){var b=this._rooms_list_node.scrollTop;a=a.positionedOffset()[1];var c=a-=ChatRoomChooser.DESCRIPTION_TOP_FUDGE;b<
a&&(c=a-b);this._room_description_rollover_node.setStyle({top:c+"px"})}};ChatRoomGroup=function(a,b,c){this.initialize(a,b,c)};ChatRoomGroup.template=function(){this._template||(this._template=$$(".joinable_rooms_group")[0]);return this._template.cloneNode(!0)};
ChatRoomGroup.prototype={initialize:function(a,b,c){this._name=c.name;this._chooser=a;a=ChatRoomGroup.template();b.insert(a);c.move_to_top?b.insert({top:a}):b.insert({bottom:a});this._node=a;this._list_node=a.down(".rooms");this._panel=new CollapsiblePanel(a);a.down(".group_name").update(this._name)},setRooms:function(a){var b=this._list_node,c=this._chooser;c.holodeck();var d=this;a.each(function(a,g){var e=d.buildRoomNode(a);b.insert(e);a.description&&(e.observe("mouseover",function(b){c.showDescriptionRollover(a.description,
e);Event.stop(b)}),e.observe("mouseout",function(a){c.beginDescriptionRolloverHide();Event.stop(a)}))})},buildRoomNode:function(a){return"guild"===a.type?this.buildGuildRoomNode(a):this.buildRegularRoomNode(a)},buildGuildRoomNode:function(a){var b=$j("#js-guild-room-template li").clone();b.find(".js-name").html(a.game_title+": "+a.guild_name);b.data("guild-room",a);return b[0]},buildRegularRoomNode:function(a){var b=new Element("li",{"class":0===i%2?"even room":"odd room"});b.room=a;var c=(new Element("p",
{"class":"name"})).update(a.name);a.premium_only&&(active_user.isPremium()||c.addClassName("upsell"),c.addClassName("premium_room_icon spritesite"));"game"===a.type&&"en"!==a.language&&"any"!=a.language&&(c.insert("&nbsp;"),c.insert((new Element("em")).update("<strong>("+a.language+")</strong>")));b.insert(c);a.joinable?b.insert((new Element("p",{"class":"user_count"})).update(a.total_user_count)):(b.insert((new Element("p",{"class":"user_count"})).update("full")),holodeck.isChatModerator()?b.addClassName("mod_full"):
b.addClassName("full"));b.insert(new Element("div",{style:"clear:both;"}));return b},node:function(){return this._node},clearRooms:function(){this._list_node.select(".room").each(function(a){a.remove()})},show:function(){this._node.show()},hide:function(){this._node.hide()},open:function(){this._panel.open()}};ChatUser=function(a){this.initialize(a)};
ChatUser.prototype={initialize:function(a){this.username=a.username;this._game_url=a.game_url;this._game_title=a.game_title;this._chat_avatar_url=a.chat_avatar_url;this._admin=a.admin;this._developer=a.developer;this._premium=a.premium;this._role=a.role;this._presence=a.presence;this._level=a.level;this._game_character_name=a.game_character_name;this._mobile=a.mobile;this._special_chat_vars=null;try{this._special_chat_vars="object"==typeof a.special_chat_vars?a.special_chat_chars:a.special_chat_vars.evalJSON()}catch(b){if("undefined"!=
typeof console)try{console.log("Could not parse variables object %o",a.special_chat_vars)}catch(c){}}this._moderator_room_ids=a.moderator_room_ids||[];this._moderator_game_ids=a.moderator_game_ids||[]},gameCharacterName:function(){return this._game_character_name},gameUrl:function(){return this._game_url},gameTitle:function(){return this._game_title},chatAvatarUrl:function(){return this._chat_avatar_url},isAdmin:function(){return this._admin},isDeveloper:function(){return this._developer},isPremium:function(){return this._premium},
isMobile:function(){return this._mobile},isGuest:function(){return this.username.match(/^_/)},role:function(){return this._role},level:function(){return this._level},presence:function(){return this._presence},specialChatVars:function(){return this._special_chat_vars},moderatorRoomIds:function(){return this._moderator_room_ids},moderatorGameIds:function(){return this._moderator_game_ids},isSilenced:function(){return"participant"!=this.role()&&"moderator"!=this.role()},isAway:function(){return KonduitPresenceType.AWAY==
this.presence()},changeRole:function(a){this._role=a},setUserRowNode:function(a){this._user_row_node=a},userRowNode:function(){return this._user_row_node}};ChatWindow=function(a){this.initialize(a)};ChatWindow.MODERATABLE_TIME_LIMIT=18E5;
ChatWindow.prototype={initialize:function(a){a.chat_window=this;this._holodeck=a.holodeck;this._friends={};this._mutings={};this._rooms=new Hash;this._room_owners={};this._node=$("chat_tab_pane");this._chat_window_node=$("chat_window");this._chat_rooms_container_node=$("chat_rooms_container");this._rooms_to_join=[];this._favorite_rooms=[];this._rooms_by_type={};this._chat_tab_clicked=this._logged_in_to_chat=!1;this._room_chooser=new ChatRoomChooser(a);this._user_rollover_manager=new UserRollover(this);
this._mini_profile=new MiniProfile(a);this._online_friends=new OnlineFriends(this);this._room_info=new RoomInfo(a);this._moderatableUsers={};this._moderatableUsersSweeper=null;this._chat_bootstrap_url=a.chat_bootstrap_url;this._seen=!1;this._deferred_room_params={};this._deferred_room_callbacks={};this.LAST_VIEWED_TAB_COOKIE="kong_chat_tab";this.GENERAL_CHAT_ROOM="chat";this.GAME_CHAT_ROOM="game";this.GUILD_CHAT_ROOM="guild";this.PRIVATE_CHAT_ROOM="private";this.SINGLE_PLAYER_GAME="spg";this.MULTIPLAYER_GAME=
"mpg";this.GUILD_GAME="guilds";this._activeTabMatrix={};this._activeTabMatrix[this.SINGLE_PLAYER_GAME]={};this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GENERAL_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GAME_CHAT_ROOM]=this.GENERAL_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME]=
{};this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GAME_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GAME_CHAT_ROOM]=this.GAME_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME]={};this._activeTabMatrix[this.GUILD_GAME][this.GENERAL_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.GAME_CHAT_ROOM]=
this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;var b=this;this._chat_bootstrap_url&&this.bootstrapChat.bind(this).runWhenDomLoaded(!0);$$("#chat_room_tabs .chat_room_tab").each(function(a){a.down("a").observe("click",function(c){var d=a.id.split("_")[0],g=b.roomByType(d),h=["guild","chat","game"],l=function(a){return a===d};0<=h.indexOf(d)&&active_user.isChatModerator()&&
(h.reject(l).each(function(a){(g=b.roomByType(a))&&holodeck.setPresenceAway(g.xmppName())}),h.filter(l).each(function(a){(g=b.roomByType(a))&&holodeck.setPresenceChat(g.xmppName())}));g?(b.setActiveRoom(g),b.activeChatDialogue().focus()):(b.joinDeferredRoom(d),function(){b.activeChatDialogue().focus()}.delay(.2));Event.stop(c);return!1})})},roomByType:function(a){return this._rooms_by_type[a]},hasJoinedAnyRooms:function(){return 0<this._rooms.size()},requestRoomToJoin:function(){new Ajax.Request(this._chat_bootstrap_url,
{method:"post",parameters:{choose_room:!0}})},bootstrapChat:function(a){var b=this._chat_bootstrap_url,c=Cookie.get("kong_room_id"),d={};c&&(d.room_id=c);a&&(d.gameplay_id=this._holodeck.gameplay(),d.reload=!0,this._mini_profile.deactivate(),this._room_info.deactivate(),this._room_chooser.deactivate());new Ajax.Request(b,{method:"post",parameters:d})},findOrCreateRoom:function(a){if(!a.id)return null;a.owner=this.roomOwner(a.id);var b=this._rooms.get(a.id);b||(b=new ChatRoom(this,a),this._rooms.set(a.id,
b),$("chat_window_header").show());return b},joinedRoom:function(a){var b=this.roomByType(a.type),c=this.findOrCreateRoom(a);if(c&&c!=b)if(this._rooms_by_type[a.type]=c,this.setActiveRoom(c),this.authenticated()&&("private"!=c.type()&&b&&this.updateLastActionTaken(),this.startBeacon()),this.GAME_CHAT_ROOM==a.type&&this._hide_first_game_room_join)this._hide_first_game_room_join=!1;else return this.tabForRoom(c).show(),c},holodeck:function(){return this._holodeck},authenticated:function(){return this._holodeck.authenticated()},
isAdmin:function(a){return this._active_room.user(a).isAdmin()},setLastViewedTabCookie:function(a){Cookie.set(this.LAST_VIEWED_TAB_COOKIE,a,void 0,"/games")},getLastViewedTabCookie:function(){return Cookie.get(this.LAST_VIEWED_TAB_COOKIE)},setActiveRoom:function(a){var b=a.type();this._active_room=a;this.setLastViewedTabCookie(b);this._holodeck._active_dialogue=a._chat_dialogue;this.showActiveRoom()},showActiveRoom:function(){var a=this,b=this._active_room;this.activeTempPane();var c=this._holodeck;
this._rooms.values().each(function(d){d==b?d.show():d.hide();d.disconnectedFromFaye?d.disableDueToFayeDisconnect():a.isSilenced()&&!d.isPrivate()?d.disableDueToSilence():c.authenticated()?d.enable():d.disableDueToGuest()})},fayeDisconnect:function(a){(a=this.roomByType("guild"))&&a.disableDueToFayeDisconnect()},fayeConnect:function(a){(a=this.roomByType("guild"))&&a.enableDueToFayeConnect()},activatePrivateRoom:function(){this.canActivatePrivateRoom()&&this.roomByType("private")&&this.setActiveRoom(this.roomByType("private"))},
canActivatePrivateRoom:function(){return this.roomByType("private")&&this._active_room!=this.roomByType("private")},leftRoom:function(a){var b=a.room,c=this._rooms.get(b.id),d=c?c.type():void 0;if("private"==d||"guild"==d){var e=this.roomByType(d);e&&e.xmppName()==b.xmpp_name&&(this.tabForRoom(e).hide(),this.setFirstAvailableRoomAsActive(["game","chat"]),delete this._rooms_by_type[d])}if(a.kicked)(function(a){a.activeChatDialogue().displayMessage("Kong Bot","You have been removed from "+b.name+".",
{"class":"whisper received_whisper"},{non_user:!0})}).defer(this);else if(c&&c.isPrivate()&&!c.isMyPrivateRoom()&&(a.owner_destroyed||a.owner_left)){var g=c;(function(a){var b=g.privateRoomOwnerUsername()||"The room owner";g=void 0;a.activeChatDialogue().displayMessage("Kong Bot",b+" has left the room and the private session has ended.",{"class":"whisper received_whisper"},{non_user:!0})}).defer(this)}this._rooms.unset(b.id);c&&(c.destroy(),c=void 0);0===this._rooms.keys().length&&$("chat_window_header").hide()},
setFirstAvailableRoomAsActive:function(a){var b=this,c,d;a.find(function(a){c=b.roomByType(a);return!!c})?this.setActiveRoom(c):a.find(function(a){(c=b.hasDeferredRoom(a))&&(d=a);return!!c})&&this.joinDeferredRoom(d)},errorMessageTemplate:function(a){this._error_message_templates_node||(this._error_message_templates_node=this._node.down(".chat_error_message_templates"));if(a=this._error_message_templates_node.down("."+a))return a.cloneNode(!0)},konduit:function(){return this._holodeck.konduit()},
userJoinedRoom:function(a){this.withRoom(a,"userJoined")},userLeftRoom:function(a){this.withRoom(a,"userLeft")},userChangedInRoom:function(a){this.withRoom(a,"userChanged")},updateGuestCount:function(a){this.withRoom(a,"guestCountUpdated")},receivedRoomMessage:function(a){this.withRoom(a,"receivedMessage")},receivedSystemMessage:function(a){this.withRoom(a,"receivedSystemMessage")},receivedAdminMessage:function(a){this._active_room&&this._active_room.receivedAdminMessage(a)},receivedPrivateRoomInvitation:function(a){var b=
this.roomByType("private");if(!b||!b.isPrivateRoomOwner(a.username)){var c=(new Element("div")).update((new Template($("chat_notification_received_private_message").innerHTML)).evaluate({username:a.username})),d=c.down(".yes"),e=c.down(".no"),g=function(a){c.hide();d.stopObserving("click");e.stopObserving("click");Event.stop(a);return!1};b&&d.update("Leave "+b.name()+" and join");d.observe("click",function(b){holodeck.joinRoom(a);return g(b)});e.observe("click",function(b){holodeck.invitationIgnoredBy(a.username);
return g(b)});this.activeChatDialogue().insert(c)}},roomNotFound:function(a){(function(b){var c="guild"===a.type?"Could not connect to guild chat. If this problem persists, refresh the page and try again.":a.name+" is no longer available.";var d=b.activeChatDialogue();d&&d.displayMessage("Kong Bot",c,{"class":"whisper received_whisper"},{non_user:!0});b.roomJoinFail(a.type)}).defer(this)},roomJoinFail:function(a){if(this.GUILD_CHAT_ROOM==a||this.PRIVATE_CHAT_ROOM==a)this.tabForType(a).hide(),this.activeChatDialogue()||
this.joinDeferredRoom(this.GENERAL_CHAT_ROOM)},roomFull:function(a){(function(b){var c=a.name+" is full. Please try again later.";b.activeChatDialogue().displayMessage("Kong Bot",c,{"class":"whisper received_whisper"},{non_user:!0})}).defer(this)},onPrivateRoomInvitationSent:function(a){var b=a.error;a=a.success?a.username+" was invited to join your private chat room.":"user_in_room"==b?a.username+" is already in your private chat room.":a.username+" cannot be reached. Please try again later";this.activeChatDialogue().displayMessage("Kong Bot",
a,{"class":"whisper received_whisper"},{non_user:!0})},activeChatDialogue:function(){if(this._active_room)return this._active_room._chat_dialogue},room:function(a){return this._rooms.get(a)},withRoom:function(a,b){var c=this.room(a.data.room.id);c||(c=this.findOrCreateRoom(a.data.room));if(c)c[b](a)},addFriends:function(a){var b=this._friends;a.each(function(a){b[a.toLowerCase()]=!0});this._rooms.values().each(function(b){b.addFriends(a)})},removeFriends:function(a){var b=this._friends;a.each(function(a){b[a.toLowerCase()]=
!1});this._rooms.values().each(function(b){b.removeFriends(a)})},addMutings:function(a){var b=this._mutings;a.each(function(a){b[a.toLowerCase()]=!0});this._rooms.values().each(function(b){b.addMutings(a)})},addFavoriteRooms:function(a){this._favorite_rooms=this._favorite_rooms.concat(a);var b=this._rooms;a.each(function(a){if(a=b.get(a))a._favorite_room=!0})},removeFavoriteRoom:function(a){this._rooms.get(a)._favorite_room=!1;this._favorite_rooms=this._favorite_rooms.reject(function(b){return b==
a})},removeMutings:function(a){var b=this._mutings;a.each(function(a){delete b[a.toLowerCase()]});this._rooms.values().each(function(b){b.addMutings(a)})},isFavoriteRoom:function(a){return void 0!==this._favorite_rooms.find(function(b){return b==a})},isFriend:function(a){return!0===this._friends[(a.username?a.username:a).toLowerCase()]},isMuted:function(a){return a?!0===this._mutings[(a.username?a.username:a).toLowerCase()]:!1},isGuest:function(a){return this._holodeck.isGuestUsername(a.username)},
onSilenced:function(a){this._silenced=!0;this.updateSilenceScheduledEnd(a.data.scheduled_end);this._rooms.values().each(function(a){a.isPrivate()||a.disableDueToSilence()})},onParticipate:function(a){this._silenced=!1;this._rooms.values().each(function(a){a.enable()})},isSilenced:function(){return this._silenced},updateSilenceScheduledEnd:function(a){var b=TimeInWordsHelper.distanceInWordsFromNow(new Date(a));this._rooms.values().each(function(a){a.updateSilenceScheduledEnd(b)});ChatRoom.updateTemplateSilenceScheduledEnd(b)},
username:function(){if(this._holodeck)return this._holodeck.username()},processRoomEvent:function(a){this._room_chooser.deactivate();this._seen&&this._logged_in_to_chat?this.konduit().dispatchEvent(a):this._rooms_to_join.push(a)},setRooms:function(a){var b=a.defaultRooms;this.clearRoomsToJoin();this.roomByType(this.GENERAL_CHAT_ROOM)||this.setDeferredRoomParams(this.GENERAL_CHAT_ROOM,b.generalChatRoom);a.currentGameType=this.SINGLE_PLAYER_GAME;a.gameRoomEnabled&&(this.roomByType(this.GAME_CHAT_ROOM)||
this.determineGameChatRoom(a),a.currentGameType=this.MULTIPLAYER_GAME);this.roomByType(this.GUILD_CHAT_ROOM)||this.determineGuildChatRoom(a);b.guildChatRoom&&(a.currentGameType=this.GUILD_GAME);!this.roomByType(this.PRIVATE_CHAT_ROOM)&&a.previousPrivateRoom&&this.setDeferredRoomParams(this.PRIVATE_CHAT_ROOM,a.previousPrivateRoom,a.previousPrivateRoomCallback);a.mostRecentChatTab=this.getLastViewedTabCookie()||this.GENERAL_CHAT_ROOM;this.hasJoinedAnyRooms()||this.joinActiveRoomType(a)},joinActiveRoomType:function(a){var b=
this._activeTabMatrix[a.currentGameType][a.mostRecentChatTab];a=this.hasDeferredRoom(b)?b:this._activeTabMatrix[a.currentGameType][this.GENERAL_CHAT_ROOM];this.GUILD_CHAT_ROOM==a&&this._deferred_room_params[this.GAME_CHAT_ROOM]&&(this._hide_first_game_room_join=!0,this.joinDeferredRoom(this.GAME_CHAT_ROOM));this.joinDeferredRoom(a)},determineGameChatRoom:function(a){this.setDeferredRoomParams(this.GAME_CHAT_ROOM,a.previousGameRoom?a.previousGameRoom:a.defaultRooms.gameChatRoom?a.defaultRooms.gameChatRoom:
a.gameRoomJoin)},determineGuildChatRoom:function(a){if(a.previousGuildChatRoomForCurrentGame){var b=a.previousGuildChatRoomForCurrentGame;var c=a.previousGuildChatRoomForCurrentGameCallback}else a.defaultRooms.guildChatRoom?b=a.defaultRooms.guildChatRoom:a.previousSitewideGuildChatRoom&&(b=a.previousSitewideGuildChatRoom,c=a.previousSitewideGuildChatRoomCallback);b&&this.setDeferredRoomParams(this.GUILD_CHAT_ROOM,b,c)},hasDeferredRoom:function(a){return!!this._deferred_room_params[a]},joinDeferredRoom:function(a){var b=
this._deferred_room_params[a];this._deferred_room_params[a]=void 0;var c=this._deferred_room_callbacks[a];c&&c();this._deferred_room_callbacks[a]=void 0;this.joinRoom(b)},joinRoom:function(a){"guild"===a.type?this.processRoomEvent({type:KonduitEvent.JOIN_GUILD_ROOM,data:{guildId:a.guild_id}}):(this.addRoomOwner(a),this.room(a.id)||this.processRoomEvent({type:KonduitEvent.JOIN_ROOM,data:{room:a}}))},setDeferredRoomParams:function(a,b,c){a!=this.PRIVATE_CHAT_ROOM&&this.tabForType(a).show();this._deferred_room_params[a]=
b;this._deferred_room_callbacks[a]=c},sendPrivateMessage:function(a,b){a&&b&&this.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_MESSAGE,data:{message:this.escapeOutgoingMessage(b),username:a}})},escapeOutgoingMessage:function(a){return a.replace(/\\(?!u[0-9a-fA-f]{4}|x[0-9a-fA-f]{2})/g,"\\\\")},onLogin:function(){this._logged_in_to_chat=!0;this.joinRequestedRooms()},onLogout:function(){this._logged_in_to_chat=!1},joinRequestedRooms:function(){if(this._seen&&this._logged_in_to_chat){for(var a=
this._rooms_to_join.length-1;0<=a;a--)this.processRoomEvent(this._rooms_to_join[a]);this.clearRoomsToJoin()}},clearRoomsToJoin:function(){this._rooms_to_join=[]},activateRoomChooser:function(){this.recordAnalyticsEvent("ChatAction","RoomList");this._room_chooser.activate(this._active_room)},hideChatWindow:function(){this._chat_window_node.hide()},showChatWindow:function(){this._chat_window_node.show();this.scrollToBottom()},tabForRoom:function(a){return this.tabForType(a.type())},tabForType:function(a){return $(a+
"_room_tab")},messageError:function(a){this._active_room&&this._active_room.messageError(a)},roomGroups:function(a){this._room_chooser.roomGroups(a)},redoRoomList:function(){this._room_chooser.redoRoomList()},showChatNag:function(a,b){this._active_room&&this._active_room.showChatNag(a,b)},showUserRollover:function(a,b){this._user_rollover_manager.show(a,b)},hideUserRollover:function(){this._user_rollover_manager.beginHide()},addRoomOwner:function(a){this._room_owners[a.id]=a.owner},roomOwner:function(a){return this._room_owners[a]},
insertPrivateMessagePrefixFor:function(a){this.insertInActiveChatInput("/w "+a+" ")},insertInActiveChatInput:function(a){this._active_room&&this._active_room.insertInChatInput(a)},insert:function(a){this._active_room&&this._active_room.insert(a)},updateRolloverMutingLink:function(a){this._user_rollover_manager.updateMutingLink(a)},activeRoomUserListScrollTop:function(){return this._active_room.userListScrollTop()},showProfile:function(a){this.recordAnalyticsEvent("ChatAction","Profile");this._mini_profile.activate(a,
this._active_room)},showSpinner:function(){$("chat_window_spinner").show()},hideSpinner:function(){$("chat_window_spinner").hide()},showOnlineFriends:function(){this.recordAnalyticsEvent("ChatAction","FriendsList");this._online_friends.activate(this._active_room.name())},loadFriendsPage:function(a){this._online_friends.getOnlineFriends(a)},updateLastActionTaken:function(){var a={method:"post",parameters:{game_id:this.gameId()}},b=this.activeRoom();update=!1;b&&("chat"==b.type()&&(a.parameters.room=
b._room.id,update=!0),"game"==b.type()&&(a.parameters.game_room=b._room.id,update=!0),update&&new Ajax.Request("/last_action_taken/update",a))},activeRoomUsernameNode:function(a){return $(this._active_room.usernameNodeId(a))},activeRoom:function(){return this._active_room},startBeacon:function(){this._last_action_beacon&&this._last_action_beacon.stop();var a=this;this._last_action_beacon=new PeriodicalExecuter(function(){a.updateLastActionTaken()},600)},setupBanAndSilencingControls:function(){this._mini_profile.setupBanAndSilencingControls()},
gameId:function(){return this._holodeck.gameId()},deactivateMiniProfile:function(){this._mini_profile.deactivate()},activateRoomInfo:function(a){this.recordAnalyticsEvent("ChatAction","RoomDetails");this._room_info.activate(a)},scrollToBottom:function(){this._rooms.each(function(a){a.value.scrollToBottom()})},deactivateRoomChooser:function(){this._room_chooser.deactivate()},recordAnalyticsEvent:function(a,b){this._holodeck.recordAnalyticsEvent(a,b)},restoreDefaultView:function(){this.clearActiveTempPane();
this.hideSpinner();this._chat_tab_clicked=!0;this._mini_profile._container.hide();this._room_chooser.hide();this._room_info._container.hide();this._online_friends._container.hide();this.showChatWindow()},setActiveTempPane:function(a){this._active_temp_pane=a},clearActiveTempPane:function(){this._active_temp_pane=null},activeTempPane:function(){return this._active_temp_pane},noticedModeratableUser:function(a){active_user.isSuperChatModerator()||(this._moderatableUsers[a]=new Date,this.conditionallyStartModeratableSweeper())},
isModeratableUser:function(a){return active_user.isSuperChatModerator()?!0:!!this._moderatableUsers[a]},conditionallyStartModeratableSweeper:function(){this._moderatableUsersSweeper||(this._moderatableUsersSweeper=new PeriodicalExecuter(function(a){a=new Date;for(var b in this._moderatableUsers)a-this._moderatableUsers[b]>ChatWindow.MODERATABLE_TIME_LIMIT&&delete this._moderatableUsers[b]}.bind(this),60))}};this.Kongregate=this.Kongregate||{};
this.Kongregate.CloudSavesController={modeDetermined:function(a,b,c){active_user.areCloudSavesEnabled()&&(holodeck&&holodeck.ready?("localOnly"==a?(c?holodeck.showCloudSavesTab("promptForLogin",{lastUsername:c}):holodeck.showCloudSavesTab(b?"loadConflict":a),holodeck.showCloudSavesIndicator("localOnly")):"debug"!=a&&holodeck.showCloudSavesIndicator(a),"remoteOnly"!=a&&"sync"!=a&&"debug"!=a||KONGREGATE.cloudSavesHandler.beginPolling()):document.observe("holodeck:ready",this.modeDetermined.bind(this,
a,b,c)))},setMode:function(a){gameLoader.setSyncMode(a);"remoteOnly"==a?holodeck.showCloudSavesTab(a):holodeck.closeCloudSavesTab();holodeck.showCloudSavesIndicator(a)},syncStarted:function(){holodeck.showCloudSavesIndicator("syncing")},syncEnded:function(a){holodeck.showCloudSavesIndicator(a?gameLoader.getSyncMode():"error")},handleConflict:function(){isDebug||(holodeck.showCloudSavesIndicator("error"),holodeck.showCloudSavesTab("saveConflict"))},forceUpdates:function(){KONGREGATE.cloudSavesHandler.forceUpdates();
"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},reloadCloudSaves:function(){gameLoader.reloadCloudSaves();"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},upgradeToSync:function(a){gameLoader.upgradeToSync(a)},remoteWatermark:function(){return cloudSaves.syncWatermark?moment(cloudSaves.syncWatermark).format("MMMM Do, YYYY"):"unknown"},localWatermark:function(){var a=
KONGREGATE.cloudSavesHandler.localWatermark();return a&&!isNaN(a)?moment(a).format("MMMM Do, YYYY"):"unknown"},userAuthenticated:function(){active_user.areCloudSavesEnabled()&&gameLoader.refreshCloudData(function(){0===cloudSaves.syncWatermark?holodeck.showCloudSavesTab("noCloudSave"):(holodeck.showCloudSavesTab("authenticated",{username:active_user.username()}),jQuery(".js-last-cloud-save-date").html(Kongregate.CloudSavesController.remoteWatermark()),jQuery(".js-last-local-save-date").html(Kongregate.CloudSavesController.localWatermark()))})},
reloadGame:function(){gameLoader.reloadGame()}};CollapsiblePanel=function(a,b){this.initialize(a,b)};
CollapsiblePanel.prototype={initialize:function(a,b){this.element=$(a);this.toggle_callback=b;this.element.panel=this;this.handle=this.element.down(".panel_handle");this.body=this.element.down(".panel_body");var c=this;this.handle.observe("click",function(a){c.toggle();a.stop()});this.collapsed()?this.collapse():this.open()},collapsed:function(){return this.handle.hasClassName("closed_link")},collapse:function(){this.body.hide();this.handle.removeClassName("opened_link");this.handle.addClassName("closed_link")},
open:function(){this.body.show();this.handle.removeClassName("closed_link");this.handle.addClassName("opened_link")},toggle:function(){this.toggle_callback&&this.toggle_callback();this.collapsed()?this.open():this.collapse()},scrollTab:function(a){a.scrollTop=this.handle.positionedOffset()[1]-parseInt(this.handle.getStyle("margin-top"),10)}};Kongregate.DEFAULT_ICON_BASE64="iVBORw0KGgoAAAANSUhEUgAAAE4AAABOCAMAAAC5dNAvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAwBQTFRF7u7udGNjVScnv7+/49zclQAA3d3daQAAysrKjQAAVgAAdTs7SQAAilZW07e30ri4aSQk1cvL29XVWAAAhzw8YQAAtJqayqOjnAAAaQUF49PTVxcXko2NYxcXqYeHioODrKysqwMDzLy8yMjIubm5cgUFeAUF6dnZv5KSoqKisgYGmQAAt4iIXAAAekVFhAAAi0VFl2trUAAAqQQEdQQEdAAAsbGxpQICmAAAuaGhq3l5ggAAxbCweAAAzba2rQUFwq6ueiUlfAAA6ubmiAAAbQQEciUlfwAAoAEBhgAAWgAAfwQEZAIC39nZxJ6epgUFdhkZbAAAcQAAbwAAdgAAngAAbgAA7OrqvqamXgAAkQAAkwAA2s7OgAAA/Pr6ZgAAegAAZQMDigAA8OjoYwAA+fb29vLytAcHVAsLgQYGnQYG5uTkogYGfAYGf3NzlQYGjQYGiQYGhQYGZwMD08DAgXZ2dy0tkQYGZA8PsQgIwZKSXAwMoAMDngMDnAMDowMDmgMDYwUFlwMDkwMDjwICigMDhAMDgQMDfAICdgICcgIC7+fncAMDmQYGgQgI28fHbA0NiAMDdAMDhgMDfgICegMDeAMDbgICggICWjMzawICfAUFogEBfwYGXwICUwYGXgQEhn5+w8PDzMzM/v7+zs7O1tbW+/v7/Pz8/f39z8/P0cfH+vr60NDQ+fn55OTk4eHh5eXl+Pj44uLi8PDw3t7e9fX19PT06Ojo6enp29vb0dHR5ubm0tLS2tra9/f339/f2NjY9vb21NTU2dnZ09PT1dXV7e3t8vLy8fHx7Ozs6urq5+fnxsbG6+vr4ODg8/Pz4+PjxMTEwsLClpKSwMDAfwgIqgcHvb29iH9/19fXXQEBtwcH+/r6eWpqb1xct6Ghp6enWgYGr5OTcA8P59fXVQUF59/f+/n5s5GR5+bmxKSk2dLSkk5O5uPjypycuXx88/DwwIuLn3Bw6ejoy66u6unp7ezs8u/vpWtru6envKOjnF9f6uHh8/Lyy7KyaPf3UwAACWlJREFUeNqsmHlc0+cdxzOuX/IDBIw/NSKCclSYMV0gaI0hJUsIiVjNIWtAGo50oGu0FbUwFRWCCqW0KmBBm3q0eBS5bzlF5QqnIKK2Xbt1bl1337ObfX5nQhK7vcLef/H7fl7PO9/neD0vXg/tEgE9cGRy8qIDTE6OBNJJCw130acjQ5f7X3AI/+WhkdN0ullHvxuwrzwrYpODRGSV7wu4Syd19PtT5frsR+npYQ6Rnv4oW18+dZ+O6+j3/X1nHoUJhSsdRCgMezTj64/6aGCmU77Z6cKV4escJnylMD3bdwrMF+gCymfSheHrzp2LdZBz59aFC9NnygNQ3fQ+PbAdjo3d5jCxsYeBT79v+hKNHlmeHRa+Lnbb0nmwLXZdeFh2eSSdFhialS6cpw3zCdOzQgNpI8sjwsBUl84TMN2wiOUjtMnZs2Hh87YBX3jY2dlJ2sULZ4VbYpd+H2e9Pb4rI8OlsVuEZy9ctNStd3VNTLBDoisYZj/CMmvd4UPYT7smMMQyjg3iVEaiayIjVcx5RoY1eegwoSudwXXAxhEJeDYIpGJGAkMmtRPxBCIZ7gO6mVJSlwPm6erKkCV/+Zwd/iBNZYilf7IXPfd7kTgBHbs+x6w7iOkSGXzeKx/a4afJslSOYIm96MMFAg4D1x0kdVsOHkErCalSpV3dagFHzFE/Q8fjgNkCjhzcgutCUF1iYiLQqV65aofVao6Yz1tiL7q6gMdnJIDBqC6E0B3KdQV7DtZH9ckVW66u5vFlqM5eBnSp6IFxzT1koUskdL+6ctmGK4TOTnT5ygJlUioDPX8WupxcIGMwxEm8V8GYKktIHUfw0lXrrArV8YCOAYS5OaTutZw81MYA27d1w5dgTDVJVfVbaWlpa9CtEJ1atGbZJ+YIhJd/nJa2RM0Xo2MT8nJeI3VH8gyYTpYkUEoW/bWqnqR6r0YLqXgijljMT1ZqjfvfqjZnl1e/C8WDDO2OYcg7QugigA6zpYplfBEPiq6q7yao9tKCAVJgA+0ptVlR1WRSX/3qPxVKdbKUL07FfEAXQehyDcCFgo2Kruq+SVDvBYGfR20yviB+6zvVZNJdn/a8Qi3ioxk2kmHItdSJCWRSXnT1zWaCbi+FgI+WOUkCVfSyejK4Wb8sWiWQcmTkMLGFbmeuIZUsc1BdcwvBTVQnA9eMVKDY/7ibrDfXP/3FXJs41ZC7k9TlGajm0MnWtwzgjDd7QQIwIbCiikVpzeNktXsNSwlsljqxIc9SR91zqG5gkKDFC1JL+Ulgf377jxaiOtDyx28gzGaBzKwL3pmXT12NfJEqunuwkWAc3QqpQAl9Mz5OlAZb/r0ItfGt7tH8vJ3BuO7tvHyqnCSIj77ZSCMY8NIqBWqVdkPzIFFpbHlnK2az0nHy894mdYZ8Dp9ACnTNtH6CwSidQqWIW9PSiJeA7TfvKsD9nMS3gpNvMOtOcpIIwBYC3RBBY5RGqz360jhR6Kf9Z0McsImkSdZwTlK63YbTfCmBSK2IbukfxhmlRTHZWU8H+kfxz/4femrATEVSW/inDbtxXdHu/GNJUhEBD4oZH20joEVx/fY2Up9DG2FEwUsW2SJNOpa/u4jSUbZkVDfcSjD01G87jfpqHW78swYCc7Xns9S9V0KWwaGIGWjrwDG1+SwcajV1kJiGaYt0YO3s9FfynqVOlCwgUGpjBk11BB2m1o46CzpGXfzAHSOwIVlE6SRvnjwuIutqoGvsqJlLXR3111DUebs+0fGTb0oI3ekSqsyL18U01jVYUmMyuZgmiI+6/hVsrYqntvGVnCZ1rx87IVCT/yYodDG0mloLJlq/Wuv5d6pU1/+8BlzQVqgFJ469bqEj60oFEkOb6KEYa2h1cYfhJ20NY3ihtuOxNwKplNb/rMzRqefoGppIempbt3vL2XI/l7oeojRm2nsAgeKtfGoL3fFSnpJABSHe/WNuJGOtq/zYOi3C9hytpWptv2aivjnwSo+bdWWULh7SeA/1tOO4NXW8fICtgxQQAj/paHIjqmOjnnKdlY9XRupYb2wqKFQRKLRs79GmLpz2sVUfgEYUClD1c6ltJ8u1v9uP/ki8ykxhwaY3WISupEAZryBAdW63CGo3wmwtWoUQpmcbVW5v8MGaNhOvLCihdCcKVGQd0rG9h916CcY2whpcp2XDL090kfX2mhfguT5VwQmzrpBoDoK0CNO7rasS50EP2h2E6RCmn0tTLxm0m34AfFqIMsYXUro9pYVAhKIFewh7t926g1PZ9CJXjmixBJFzPU1dlWTi9hN3mI3otFp8IKQoLN1j1lUQMg0b5nqbevtw7ri96AHLNYgWgDC5Hv/qqSSSvsqmr325TLYG0eHCCkqXuaesCHVhrXE9PLwbKm8T9Pqs/YCLdQEiDw/fXiq5Xdmzyh1kco0OHQlBRWV7MjFdyo6yM6RtscvmhQu7+joJ+romNv987S+ZGkTDdH+8+Wtz0tl5x61m82LPAzDePHSmbEcKoSvAdDqwPE8aboEOblB03ultGl4Ms8EiuLe1V/bduDEnc+v4EVhcHaYroHSnKrQ6gIbJfaH9xvW53LjdtBgsEtDV9F23pvPWX7igPTBWW3Fqjg5BEA0MdNevWXG9HdXJue4Tt6/ZUPmVB1haBLHUvX+qIg6U0I34Wde1j6y4BnQwmwl0nR/ZcKcO1yFxFafeJ3WFFVhzYPPs6boWg9PyHTpwkkB7FYWkTl+UiWgAQPek9kGlFQ9qQXdMmOveeqvSBre/oToAklmkx3VHCR1Ybu4Kn49t8FkBdKC77R/byXw8YHCYcd1RUpeCsFFgLjjFtnDBaWXCdiMQwnJ0KJJi1p2JM2I6JgyEtsAwUy63H2EZOtQYd4bSSeIeoiU56MEuwCZnPivDdQ/jJJY6OQbzGfy3TC4ndZOzuI45L3Dd7CRtZPl5fdH/Q1ekP798hBYYmrEjOMX4rGX732DKjSnBOzJCA2n0SKfiEJaRPT8d28gKKXaKpNMuOX/K0s+zPaw5PetT50u0S4GfO90LkaQYHV8++UNjiiTkntPngejrorN/RnGIJDPOaHzoEEZjXKYkpDjD35mOPaUG7cq4pw+WsFgpDsFiSYL19zJ2BdGJh96gWV9JsT4k2EFC9MUS39kgOvUM7Rz6mdMXLIf5wumzUGe6xSP5SFDA1K7vOciuqYCgEYtHcuzVfeTutLNDTN8doZNv+N8KMAAJHpuKk0HEGAAAAABJRU5ErkJggg==";
window.lightboxController={closeLightboxWithResult:function(a,b){parent.parent.lightbox.prototype.shutdown()}};(function(){"undefined"===typeof window.DOMParser&&window.ActiveXObject&&(DOMParser=function(){},DOMParser.prototype.parseFromString=function(a,b){b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);return b})})();FayeConnection=function(a){this.initialize(a)};FayeConnection.DISCONNECT_TIMEOUT=2E4;
FayeConnection.prototype={initialize:function(a){this._authenticator=a.authenticator;this._resetReauthenticateBackOffPeriod();this._pendingMessages={}},subscribe:function(a){var b=this;return this._authenticator.authenticate(a.guildId).then(function(c){return b._subscribe(new GuildRoom(a.guildId,c.guild_name))})},disconnect:function(){this._client&&(this._connectionMonitor.destroy(),this._connectionMonitor=null,this._client._state=this._client.DISCONNECTED,this._client._dispatcher.close(),this._pendingMessages=
{},this._activeRoom=this._client=null)},sendMessage:function(a,b){return this._client.publish(b.id,{text:a},{deadline:FayeConnection.DISCONNECT_TIMEOUT/1E3}).then(null,function(a){throw{rateLimited:429===a.code};})},setPresence:function(a,b){b?this.activeRoom=a:a===this.activeRoom&&(this.activeRoom=null)},_connect:function(a){var b=this;this._room=a;this._client=new Faye.Client(window.FAYE_CONFIG.KWAK_SERVICE_URL+"/faye",{scheduler:FayeBackoffScheduler});this._connectionMonitor=new FayeConnectionMonitor({client:this._client,
timeout:FayeConnection.DISCONNECT_TIMEOUT});this._client.addExtension({incoming:this._errorDetectionExtension.bind(this),outgoing:this._outgoingExtension.bind(this)});this._client.addExtension({incoming:this._roomHistoryExtension.bind(this)});this._connectionMonitor.on("disconnect",function(){b.trigger("disconnect")});this._connectionMonitor.on("connect",function(){b.trigger("connect")})},_subscribe:function(a){var b=$j.Deferred(),c=this,d=!1,e=setTimeout(function(){b.reject()},3E4);this._connect(a);
this._pendingMessages[a.id]=[];this._client.subscribe(a.id,function(b){b=FayeMessageTransformer.transform(b);d?c.trigger("message",a,b):c._pendingMessages[a.id].push(b)}).then(function(){var g=c._pendingMessages[a.id];b.resolve(a);for(var h=0;h<g.length;h++)c.trigger("message",a,g[h]);d=!0;clearTimeout(e);delete c._pendingMessages[a.id]});return b.then(null,function(){c.disconnect()})},_reconnect:function(a){var b=this;this.disconnect();this._reauthenticationTimeout||(this._reauthenticationTimeout=
setTimeout(function(){b._authenticator.reauthenticate().then(function(){b._subscribe(a)});b._reauthenticationTimeout=null},Math.min(this._reauthenticateBackOffPeriod,3E5)),this._reauthenticateBackOffPeriod*=2)},_resetReauthenticateBackOffPeriod:function(){this._reauthenticateBackOffPeriod=500},_errorDetectionExtension:function(a,b){void 0!==a.error&&null!==a.error&&(error=Faye.Error.parse(a.error),403===error.code?(a.advice={reconnect:"none"},this._reconnect(this._room)):this._resetReauthenticateBackOffPeriod());
b(a)},_roomHistoryExtension:function(a,b){if("/meta/subscribe"===a.channel&&a.successful){var c=a.ext,d=a.subscription;c&&c.history&&(c=$j.map(c.history,function(a,b){a=FayeMessageTransformer.transform(a);a.history=!0;return a}),this._pendingMessages[d]=c.concat(this._pendingMessages[d]))}b(a)},_outgoingExtension:function(a,b){void 0===a.ext&&(a.ext={});a.ext.auth_token=this._authenticator.token();"/meta/connect"===a.channel&&this.activeRoom&&(a.ext.active_room=this.activeRoom);b(a)}};
$j.extend(FayeConnection.prototype,Evented);FayeEventDispatcher=function(a){this.initialize(a)};FayeEventDispatcher.MAX_UUIDS=50;
FayeEventDispatcher.prototype={initialize:function(a){this._holodeckEventDispatcher=a.holodeckEventDispatcher;this._uuids=[]},message:function(a,b){this.checkDuplicateMessage(b)||("0"===b.kuid?this._holodeckEventDispatcher.fire({type:KonduitEvent.SYSTEM_MESSAGE,data:{data:b.data,timestamp:1E3*b.timestamp,room:a}}):this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_MESSAGE,data:{history:!1,message:b.text,timestamp:1E3*b.timestamp,room:a,user:FayeUserTransformer.transformUser(b)}}))},history:function(a,
b){this._holodeckEventDispatcher.fire({type:KonduitEvent.HISTORY_RECEIVED,data:{room:a,count:b}})},checkDuplicateMessage:function(a){for(var b=0;b<this._uuids.length;b++)if(this._uuids[b]==a.uuid)return!0;this._uuids.push(a.uuid);this._uuids.length>FayeEventDispatcher.MAX_UUIDS&&this._uuids.shift();return!1},disconnect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_DISCONNECT,data:{}})},connect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_CONNECT,data:{}})},
userJoin:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_JOIN,data:{room:a,user:FayeUserTransformer.transformUser(b)}})},userDeparture:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_DEPARTURE,data:{room:a,user:FayeUserTransformer.transformUser(b)}})},userChanged:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_CHANGED,data:{room:a,force:!0,user:FayeUserTransformer.transformUser(b)}})},messageTooLong:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,
data:{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG}})},messageRateLimited:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,data:{errorType:KonduitChatErrorMessage.RATE_LIMITED}})},joinRoom:function(a){this._holodeckEventDispatcher.fire({type:KonduitEvent.JOIN_ROOM,data:{room:a}})},roomNotFound:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_NOT_FOUND,data:{room:{name:"That guild chat room",type:"guild"}}})},leaveRoom:function(a,b){data={owner_left:!1,
kicked:!!b,owner_destroyed:!1,room:a};this._holodeckEventDispatcher.fire({type:KonduitEvent.LEAVE_ROOM,data:data})}};FayeHistoryService=function(a){this.initialize(a)};FayeHistoryService.MAX_MESSAGES=20;
FayeHistoryService.prototype={initialize:function(a){this._authenticator=a.authenticator},_makeAjaxRequest:function(a,b,c){return $j.ajax(this._url(a),{method:"GET",dataType:"jsonp",data:{max_time:b,min_time:c}})},fetchHistory:function(a,b,c){var d=this;this._makeAjaxRequest(a,b,c).then(function(b){$j.each(b.history,function(b,c){d.trigger("message",a,FayeMessageTransformer.transform(c))});d.trigger("history",a,b.history.length)})},_url:function(a){return window.FAYE_CONFIG.KWAK_RAILS_URL+"/rooms"+
a.id+"/history.jsonp?t="+this._authenticator.token()}};$j.extend(FayeHistoryService.prototype,Evented);FayeRoomList=function(a){this.initialize(a)};FayeRoomList.CHANGED="changed";FayeRoomList.ADDED="added";FayeRoomList.EXISTS="exists";FayeRoomList.REMOVED="removed";FayeRoomList.USERNAME_CHANGED="username_changed";
FayeRoomList.prototype={initialize:function(a){this._users={}},addUser:function(a){if(this._users[a.kuid]){if(this._users[a.kuid].username!=a.username){var b={status:FayeRoomList.USERNAME_CHANGED,existingUser:this._users[a.kuid]};this._users[a.kuid]=a;return b}return this._diffUser(a)?(this._users[a.kuid]=a,{status:FayeRoomList.CHANGED}):{status:FayeRoomList.EXISTS}}this._users[a.kuid]=a;return{status:FayeRoomList.ADDED}},addUsers:function(a){var b=this,c={},d=[],e=[],g=[],h=$j.extend({},this._users);
$j.each(a,function(a,c){delete h[c.kuid];a=b.addUser(c);switch(a.status){case FayeRoomList.ADDED:d.push(c);break;case FayeRoomList.CHANGED:e.push(c);break;case FayeRoomList.USERNAME_CHANGED:d.push(c),g.push(a.existingUser)}});$j.each(Object.keys(h),function(a,c){g.push(h[c]);delete b._users[c]});c[FayeRoomList.ADDED]=d;c[FayeRoomList.CHANGED]=e;c[FayeRoomList.REMOVED]=g;return c},_diffUser:function(a){var b=!1,c=this._users[a.kuid];$j.each(Object.keys(a),function(d,e){if(a[e]!==c[e])return b=!0,!1});
return b}};FayeRoomListService=function(a){this.initialize(a)};FayeRoomListService.MESSAGE_FIELDS="kuid level username character_name user_id admin developer premium mobile".split(" ");
FayeRoomListService.prototype={initialize:function(a){this._authenticator=a.authenticator;this._intervalManager=new IntervalManager(this._fetchUserList.bind(this),3E5)},connect:function(a){this._currentRoom&&this._fetchUserList()},subscribe:function(a){this._currentRoom=a;this._roomList=new FayeRoomList;this._intervalManager.start(!1);this._fetchUserList()},unsubscribe:function(a){this._currentRoom&&this._currentRoom.id===a.id&&(this._intervalManager.stop(),this._currentRoom=this._roomList=null)},
message:function(a,b){if(!b.history&&"0"!==b.kuid){var c={active:!0};$j.each(FayeRoomListService.MESSAGE_FIELDS,function(a,e){c[e]=b[e]});a=this._roomList.addUser(c);switch(a.status){case FayeRoomList.ADDED:this.trigger("userJoin",this._currentRoom,c);break;case FayeRoomList.CHANGED:this.trigger("userChanged",this._currentRoom,c);break;case FayeRoomList.USERNAME_CHANGED:this.trigger("userDeparture",this._currentRoom,a.existingUser),this.trigger("userJoin",this._currentRoom,c)}}},_makeAjaxRequest:function(){return $j.ajax(this._url(this._currentRoom),
{method:"GET",dataType:"jsonp"})},_fetchUserList:function(){var a=this,b=this._currentRoom.id;this._makeAjaxRequest().then(function(c){a._currentRoom&&a._currentRoom.id==b&&(c=a._roomList.addUsers(c.characters),a._triggerEvents(c[FayeRoomList.ADDED],"userJoin"),a._triggerEvents(c[FayeRoomList.CHANGED],"userChanged"),a._triggerEvents(c[FayeRoomList.REMOVED],"userDeparture"))})},_triggerEvents:function(a,b){var c=this;$j.each(a,function(a,e){c.trigger(b,c._currentRoom,e)})},_url:function(a){return window.FAYE_CONFIG.KWAK_RAILS_URL+
"/rooms"+a.id+"/characters.jsonp?t="+this._authenticator.token()}};$j.extend(FayeRoomListService.prototype,Evented);FayeService=function(a){this.initialize(a)};
FayeService.prototype={initialize:function(a){this._authenticator=a.authenticator;this._fayeConnection=a.fayeConnection||new FayeConnection({authenticator:this._authenticator});this._fayeConnection.on("message",this,"trigger","message");this._fayeConnection.on("disconnect",this,"trigger","disconnect");this._fayeConnection.on("connect",this,"trigger","connect")},setPresence:function(a,b){this._fayeConnection.setPresence(a,b)},subscribe:function(a){var b=this;this._currentGuildRoom&&this.leaveCurrentGuildRoom(!1);
this._fayeConnection.subscribe(a).then(function(a){b._currentGuildRoom=a;b._fayeConnection.setPresence(a.id,!0);b.trigger("joinRoom",a)},function(){b.trigger("roomNotFound")})},leaveCurrentGuildRoom:function(a){this._fayeConnection.disconnect();this._currentGuildRoom&&(this._fayeConnection.setPresence(this._currentGuildRoom.id,!1),this.trigger("leaveRoom",this._currentGuildRoom,a),this._currentGuildRoom=null)},sendMessage:function(a,b){var c=this,d=!1;250<a.length&&(d=!0,a=a.substr(0,249)+"\u2026");
return this._fayeConnection.sendMessage(a,b).then(function(){d&&c.trigger("messageTooLong")},function(a){a.rateLimited&&c.trigger("messageRateLimited")})},isCurrentRoomId:function(a){return this._currentGuildRoom&&a===this._currentGuildRoom.id},isCurrentRoomName:function(a){return this._currentGuildRoom&&a===this._currentGuildRoom.xmpp_name}};$j.extend(FayeService.prototype,Evented);
FayeUserTransformer=function(){var a=[];$j.each(["blue","green","purple","red"],function(b,c){for(b=1;6>=b;b++)a.push("guestavatar-"+c+b+".png")});return{transformUser:function(b){var c=b.username||"_"+b.kuid,d=null;active_user.username()!==b.username&&(d=b.active?"chat":"away");var e=b.level,g=b.character_name,h=b.admin,l=b.developer,f=b.premium,m=b.mobile,r=window.location.host.split(".")[1];if(b.username)b="assets/dynamic/accounts/"+b.username+"/avatar";else{b=b.kuid;for(var q=0,x=b.length,v=0;v<
x;v++)q=(q<<5)-q+b.charCodeAt(v),q&=q;b="assets/mobile_guest_avatars/"+a[Math.abs(q)%a.length]}return{username:c,variables:{level:e,username:c,game_character_name:g,presence:d,admin:h,curator:!1,developer:l,moderator:!1,premium:f,mobile:m,chat_avatar_url:"https://assets."+r+".com/"+b+"?i10c=img.resize(width:16,height:16)",game_title:null,game_url:null,role:"participant",special_chat_vars:"{}",type:""}}}}}();function evalJS(a){eval(a)}
function updateTaskProgress(a,b){try{$(a+"-progress-amount").update(b)}catch(c){console.warn("error during updateTaskProgress on %s to %s",a,b)}}function markTaskComplete(a){try{Element.addClassName(a,"complete"),Element.removeClassName(a,"incomplete"),$(a+"-progress")&&Element.hide(a+"-progress"),new Effect.Highlight(a,{})}catch(b){console.warn("error during markTaskComplete on %s",a)}}
function markAccomplishmentComplete(a){try{Element.addClassName(a,"complete"),Element.removeClassName(a,"incomplete"),new Effect.Highlight(a,{})}catch(b){console.warn("error during markAccomplishmentComplete on %s",a)}}function GuildChatAuthenticator(){this.initialize()}
GuildChatAuthenticator.prototype={initialize:function(){},authenticate:function(a){this._guildId=a;return this._fetchToken()},reauthenticate:function(){var a=this;return this._fetchToken().then(null,function(){a.trigger("kick")})},_fetchToken:function(){var a=this;return $j.getJSON("/api/internal/v1/guilds/"+this._guildId+"/token.json").then(function(b){a._token=b.token;a._expires=Date.now()+1E3*b.ttl;return b})},token:function(){var a=this;!this._pendingTokenRequest&&Date.now()>=this._expires-3E5&&
(this._pendingTokenRequest=this.reauthenticate().always(function(){a._pendingTokenRequest=null}));return this._token}};$j.extend(GuildChatAuthenticator.prototype,Evented);function GuildRoom(a,b){this.type="guild";this.id="/guilds/"+a+"/rooms/1";this.name=b;this.xmpp_name=this.id}HighScores=function(a){this.initialize(a)};
HighScores.prototype={initialize:function(a){this._active=!1;this._holodeck=a;this._container=$("high_scores_container");this._high_scores_node=$("high_scores");this._high_scores_spinner=$("high_scores_spinner")},activate:function(a){this._holodeck.recordAnalyticsEvent("Achievements","Scores");this.hideAccomplishmentsSection();this.getHighScores(a)},getHighScores:function(a,b,c){var d=this._container,e=this._holodeck,g=this._high_scores_node;e.chatWindow();var h=this,l="/high_scores.chat?game_id="+
e.gameId();this._active=!0;g.hide();this._high_scores_spinner.show();a&&(l+="&statistic_id="+a);c&&(l+="&"+c+"="+b,e.recordAnalyticsEvent("Achievements","ScoresChangePage"));this._tabs&&(this._last_tab=this._tabs.activeLink.key);new Ajax.Updater({success:"high_scores"},l,{method:"get",onComplete:function(){h._active&&(h.hideAccomplishmentsSection(),h._high_scores_spinner.hide(),h.hookUpTabsAndSelect(),g.show(),d.ieHappyShow())}})},deactivate:function(){this._active=!1;this._high_scores_spinner&&this._high_scores_spinner.hide();
this._container&&this._container.ieHappyHide();this.showAccomplishmentsSection()},hideAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyHide()},showAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyShow()},hookUpTabsAndSelect:function(a){var b=this,c=$("statistic_id");a="weekly_high_score_tab_pane";this._last_tab&&(a=this._last_tab);this._tabs=new HolodeckTabs("high_score_tab_set",{defaultTab:a});$$(".high_score_panel_tab").each(function(a){a.observe("click",
function(a){holodeck.recordMappedEventAnalytic(a.target.up("li").id)})});c&&c.observe("change",function(){b._holodeck.recordAnalyticsEvent("Achievements","ScoresChangeStat");var a=c.getValue();b.getHighScores(a)})},accomplishmentsTabNode:function(){this._accomplishments_tab_content_node||(this._accomplishments_tab_content_node=$("accomplishments_tab_content"));return this._accomplishments_tab_content_node}};Holodeck=function(a){this.initialize(a)};Holodeck.KONG_GAMEPLAYS_COOKIE_NAME="kong_gameplays";
Holodeck.KONG_HS_ALERT_COOKIE_NAME="kong_hs_alert";Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME="kong_hs_alert_time";Holodeck.HOLODECK_TAB_COOKIE_NAME="holodeck_tab";Holodeck.SIGNUP_TAB_NAME="signup_tab_pane";Holodeck.SIGNIN_TAB_NAME="signin_tab_pane";Holodeck.CHAT_TAB_NAME="chat_tab_pane";Holodeck.LAST_PRIVATE_ROOM_KEY="last_private_room";Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX="last_game_room_";Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX="last_kgr_";
Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE="last_kgr";Holodeck.GAME_ROOM_JOIN={type:"game"};Holodeck.GOOGLE_A_DAY_START_DATE=new Date("Aug 16 2012");Holodeck.GOOGLE_A_DAY_END_DATE=new Date("Sep 30 2012");Holodeck.HS_ALERT_WAIT_MILLISECONDS=36E5;Holodeck.guildIdFromXmppName=function(a){if(a=/guilds\/(\d+)/.exec(a))return a[1]};
Holodeck.prototype={initialize:function(a){var b=window.location.search.parseQuery().guest_access_key,c={};b&&(c.guest_access_key=b);this.ready=!1;this._konduit=new Konduit;this._game_discussions=new GameDiscussions({gameUrl:active_user.gameResourcePath(),inGuilds:page_data.in_guilds,hasGameSpecificForum:a.has_game_specific_forum});new Ajax.Updater({success:"chat_container"},a.holodeck_url,{method:"get",parameters:c,evalScripts:!0,onComplete:function(){holodeck.uiLoaded(a)},onException:function(a,
b){console.error(b.message)}})},uiLoaded:function(a){window.onunload||(window.onunload=Prototype.emptyFunction);if(a){a.holodeck=this;var b=document.location.href.parseQuery();this._interval_between_renders=parseInt(b.interval_between_renders,10)||20;this._has_shown_cannot_connect_alert=!1;this._event_dispatcher=new KonduitEventDispatcher;this.initializeAccomplishmentTracker(a);this._html_dimensions=a.html_dimensions;this._chat_window=new ChatWindow(a);this._sticker_manager=new StickerManager(a);
this._sticker_manager.trackActiveSession();this._users_invited={};this._ignored_invitations={};this._holodeck_event_analytics=new HolodeckEventAnalytics;this._incoming_message_filters=[];this._outgoing_message_filters=[];this._game_id=a.game_id;(this._active_user=a.active_user)&&this._active_user.setHolodeck(this);this._chat_disconnected_indicator_node=$("chat_disconnected_indicator");this._chat_connected_indicator_node=$("chat_connected_indicator");this._chat_limited_connection_indicator_node=$("chat_limited_connection_indicator");
this._accomplishment_group_award_tab_node=$("accomplishment_group_awarded_tab_pane_content");this._just_earned_badge=this._suppress_disconnect=this._has_logged_in=!1;this._accomplishments_bootstrap_url=a.accomplishments_bootstrap_url;this._sticker_drop_url=a.sticker_drop_url;this._on_loaded_accomplishments_callbacks=[];this._game_path=a.game_path;this._shared_content_type_permalinks=a.shared_content_type_permalinks;this._shared_content_type_names=a.shared_content_type_names;this._permissions=a.permissions;
this._authenticated_only_shared_content_sorts=a.authenticated_only_shared_content_sorts;this._has_game_specific_forum=a.has_game_specific_forum;this._multiplayer_game=a.multiplayer_game;this._suppress_setting_preference_cookie=!1;this._in_beta=a.in_beta;this._in_preview=a.in_preview;this._active_dialogue=void 0;this._chat_commands={};this._chat_api_tab=new ChatApiTab(a);this._chat_host=a.chat_host;this._chat_proxy_websocket=a.chat_proxy_websocket;this._chat_proxy_bosh=a.chat_proxy_bosh;this._saved_shared_content_event=
null;this._login_url=a.login_url;this._custom_game_avatar=null;this._avatar_crop_boundaries={};this._avatar_cropper=null;this._extra_interpolation=a.extra_interpolation;this._gameplay_id=null;this._coupon_templates={};this.addChatCommand("w",this.sendWhisper);this.addChatCommand("msg",this.sendWhisper);this.addChatCommand("bug",function(a,b){b=(b.match(/^\/\S+\s+(.+)$/)||[])[1];var c=a.activeDialogue();b?a.submitGameBug(b,{onSuccess:function(a){c.insert('<p class="bug">Your bug report has been successfully submitted. Thank you!</p>')},
onFailure:function(a){c.insert('<p class="bug">Uh oh! Your bug report could not be completed at this time. Please visit the <a href="/feedbacks/new">feedback form</a> and try again.</p>')}}):c.insert('<p>Use the <code>/bug</code> command to submit a bug report for the game you are playing. Just type <code>/bug</code> followed by a brief report, or visit the <a href="/feedbacks/new">feedback form</a> to submit a more detailed bug report.</p>');return!1});this.addChatCommand("afk",this.setPresenceAway.bind(this));
this.addChatCommand("back",this.setPresenceChat.bind(this));this.addChatCommand("invite",function(a,b){(b=(b.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2])&&0<b.length&&a.sendPrivateRoomInvitation(b);return!1});this.addChatCommand("kick",function(a,b){(b=(b.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2])&&0<b.length&&a.privateRoomKick(b);return!1});this.addChatCommand("history",function(){holodeck.chatWindow().activeRoom()&&holodeck.chatWindow().activeRoom().fetchHistory();return!1});this.addMessageFilters();
var c=this._event_dispatcher,d=this._chat_window,e=this._accomplishment_tracker,g=a.achievements&&0<a.achievements.length;c.register(KonduitEvent.INIT,function(a){holodeck.updateDefaultChatTabMessage("Connecting to chat")});c.register(KonduitEvent.DISCONNECT,function(a){holodeck.showDisconnectedIndicator();CinematicMode.addCinematicMessage("You have been disconnected from Kongregate and scores will not be submitted.");a.data.banned?window.location.href="/":a.data.conflict?holodeck.showSessionAlert():
a.data.login_failed?holodeck.showSessionExpiredAlert():holodeck._suppress_disconnect?holodeck._suppress_disconnect=!1:holodeck.showDisconnectedAlert()});c.register(KonduitEvent.FAYE_DISCONNECT,function(a){d.fayeDisconnect()});c.register(KonduitEvent.FAYE_CONNECT,function(a){d.fayeConnect()});c.register(KonduitEvent.API_INITIALIZED,function(a){(function(){holodeck.loadSharedContentFromUrl();holodeck.saveSharedContentFromUrl();holodeck.konduit().dispatchEvent({type:KonduitEvent.ADD_STATISTICS,data:holodeck._statistics})}).defer()});
c.register(KonduitEvent.STATISTIC_UPDATED,function(a){holodeck._has_submitted_stats=!0;e.onStatisticUpdated(a)});c.register(KonduitEvent.STATISTICS_FLUSH,function(a){holodeck.konduit().dispatchEvent(a)});c.register(KonduitEvent.KONDUIT_MESSAGE,function(a){a.data&&a.data.outgoing?c.fire({type:a.data.opcode,data:a.data.params}):holodeck.konduit().dispatchEvent(a)});c.register(KonduitEvent.LOGIN,function(a){!0===a.data.success?(holodeck.updateDefaultChatTabMessage("Joining room"),holodeck.setUsername(a.data.username),
holodeck._has_logged_in=!0,!0===a.data.bosh?holodeck.showLimitedConnectionIndicator():holodeck.showConnectedIndicator(),d.onLogin(),holodeck.closeAlertTab()):holodeck.updateDefaultChatTabMessage("Chat signin failed!")});c.register(KonduitEvent.CONNECT,function(a){!1===a.data.success?!1===holodeck._has_logged_in&&(holodeck.updateDefaultChatTabMessage("Chat connection failed!"),holodeck.showCannotConnectAlert()):holodeck.updateDefaultChatTabMessage("Signing in")});c.register(KonduitEvent.SILENCED,function(a){d.onSilenced(a)});
c.register(KonduitEvent.PARTICIPATE,function(a){d.onParticipate(a)});c.register(KonduitEvent.JOIN_ROOM,function(a){switch(a.data.room.type){case "game":holodeck.setGameRoomCookie(a.data.room);break;case "guild":var b=Holodeck.guildIdFromXmppName(a.data.room.xmpp_name);a.data.room.guildId=b;b={type:a.data.room.type,guild_id:b};holodeck.setGuildRoomForCurrentGameCookie(b);holodeck.setSitewideGuildRoomCookie(b);break;case "private":$.jStorage.set(Holodeck.LAST_PRIVATE_ROOM_KEY,a.data.room)}holodeck.displayRoom(a.data.room)});
c.register(KonduitEvent.ROOM_NOT_FOUND,function(a){"game"==a.data.room.type&&holodeck.getGameRoomCookie()?(holodeck.setGameRoomCookie(),holodeck.joinRoom({type:"game"})):(d.roomNotFound(a.data.room),a.data.room.lockedRetries&&holodeck.updateDefaultChatTabMessage("No Chat Rooms found!"))});c.register(KonduitEvent.JOIN_GUILD_ROOM,function(a){d.roomNotFound({type:"guild",name:"Guild Room"})});c.register(KonduitEvent.ROOM_FULL,function(a){d.roomFull(a.data.room)});c.register(KonduitEvent.REQUEST_CHAT_ROOM,
function(a){d.requestRoomToJoin()});c.register(KonduitEvent.LEAVE_ROOM,function(a){d.leftRoom(a.data);"guild"===a.data.room.type&&(holodeck.setGuildRoomForCurrentGameCookie(),holodeck.setSitewideGuildRoomCookie())});c.register(KonduitEvent.ROOM_MESSAGE,function(a){d.receivedRoomMessage(a)});c.register(KonduitEvent.SYSTEM_MESSAGE,function(a){d.receivedSystemMessage(a)});c.register(KonduitEvent.MESSAGE_ERROR,function(a){d.messageError(a);if(KonduitChatErrorMessage.RATE_LIMITED===a.data.errorType){var b=
d.activeRoom();b=b?b.getId():null;var c=(Cookie.get("rate_limit_log")||"[]").evalJSON();c.push([(new Date).getTime(),b,a.data.ruleViolated]);Cookie.set("rate_limit_log",Object.toJSON(c),void 0,"/")}});c.register(KonduitEvent.PRIVATE_MESSAGE,function(a){holodeck.receivedPrivateMessage(a)});c.register(KonduitEvent.ADMIN_MESSAGE,function(a){d.receivedAdminMessage(a)});c.register(KonduitEvent.USER_JOIN,function(a){holodeck.displayRoomOnFirstJoin(a.data.room);d.userJoinedRoom(a)});c.register(KonduitEvent.USER_CHANGED,
function(a){d.userChangedInRoom(a)});c.register(KonduitEvent.USER_DEPARTURE,function(a){d.userLeftRoom(a)});c.register(KonduitEvent.GUEST_COUNT,function(a){d.updateGuestCount(a)});c.register(KonduitEvent.DISPLAY_SHOUT_BOX,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayShoutBox(a)})});c.register(KonduitEvent.DISPLAY_INVITATION_BOX,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayInvitationBox(a)})});c.register(KonduitEvent.SEND_PRIVATE_MESSAGE,function(a){h.capturedSelectorWrapper(a,
function(a){holodeck.sendPrivateMessage(a)})});c.register(KonduitEvent.DISPLAY_FEED_POST_BOX,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayFeedPostBox(a)})});c.register(KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,function(a){holodeck.recordAnalyticsEvent("Lightbox","Kred");var b=a.data.url;setTimeout(function(){h.isAuthenticated()?top.lightbox.prototype.initializeKredItemPurchaseFrame(b):(h.activateInlineLogin({},!0),lightbox.prototype.addOnCloseCallback(function(){if(h.isAuthenticated())top.lightbox.prototype.initializeKredItemPurchaseFrame(b);
else try{holodeck.konduit().dispatchEvent({type:"purchase_result",data:{success:!1}})}catch(r){}}))},0)});c.register(KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX,function(a){setTimeout(function(){lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+h.gameId(),{afterStaticContentLoad:lightbox.prototype.toggleRegistration})},0)});c.register(KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX,function(a){setTimeout(function(){h.activateInlineLogin()},0)});c.register(KonduitEvent.RESIZE_GAME,
function(a){var b=a.data["chat.resizeGame.width"],c=a.data["chat.resizeGame.height"];setTimeout(function(){holodeck.resizeGame(b,c)},0)});c.register(KonduitEvent.NEW_HIGH_SCORE,function(a){holodeck.showHighScoreAlert(a)});c.register(KonduitEvent.CUSTOM_TAB_SHOW,function(a){holodeck._chat_api_tab.setTabInfo(a);holodeck.showChatApiTab()});c.register(KonduitEvent.CUSTOM_TAB_CLOSE,function(a){holodeck.closeChatApiTab()});c.register(KonduitEvent.CUSTOM_TAB_MESSAGE,function(a){holodeck._chat_api_tab.receivedMessage(a)});
c.register(KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,function(a){holodeck._chat_api_tab.clearMessages(a)});c.register(KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT,function(a){holodeck.promptProcessingSaveSharedContent(a)});c.register(KonduitEvent.SAVE_SHARED_CONTENT,function(a){a.data.filename&&holodeck.promptSaveSharedContent(a.data)});c.register(KonduitEvent.IMAGE_AVATAR_SUBMIT,function(a){holodeck.showAvatarTab(a.data.filename)});c.register(KonduitEvent.BROWSE_SHARED_CONTENT,function(a){holodeck.showSharedContentsIndex(a.data.content_type,
a.data.sort_order,a.data.label)});c.register(KonduitEvent.PRIVATE_ROOM_INVITATION,function(a){holodeck.receivedPrivateRoomInvitation(a.data)});c.register(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,function(a){d.onPrivateRoomInvitationSent(a.data)});c.register(KonduitEvent.HOLODECK_DATA,function(a){holodeck.handleHolodeckPacket(a.data)});c.register(KonduitEvent.HISTORY_RECEIVED,function(a){var b=holodeck.chatWindow().roomByType("guild");b&&(a.data.count<FayeHistoryService.MAX_MESSAGES?b.hideHistoryButton():
b.showHistoryButton())});this._accomplishments=(a.achievements||[]).concat(a.challenges||[]);this._has_submitted_stats=this._authenticated_and_loaded_accomplishments=!1;this._statistics=a.statistics||[];this.setStatisticsAndAccomplishments(this._statistics,this._accomplishments);this.initializeJavascriptApi()}var h=holodeck._active_user;h.occasionallyShowRegistrationLightbox.bind(h).runWhenReady();holodeck._tabs=new HolodeckTabs("main_tab_set",{afterChange:function(){if(holodeck._tabs){var a=holodeck._tabs.activeContainer;
holodeck.checkChatScroll();holodeck.updateTabCookie(a);"chat_tab_pane"===a.id?holodeck.chatWindow().restoreDefaultView():"accomplishments_tab_pane"===a.id&&g&&holodeck.hideHighScores()}},beforeChange:function(a,b){if(!holodeck._tabs)return!1;a=b.id;if(0===b.children.length){var c=new Template($(a+"_template").innerHTML);b.insert(c.evaluate());document.fire(a+":loaded")}},defaultTab:void 0,holodeck:holodeck});var l=holodeck._chat_window;holodeck.addOnTabSelectCallback("chat_tab_pane",function(){l._seen||
(l._seen=!0,l.joinRequestedRooms())});holodeck.addOnTabSelectCallback("more_games_tab_pane",function(){holodeck._seen_more_games_tab||holodeck.loadMoreGamesTab();holodeck._seen_more_games_tab=!0});holodeck._tabs.addOnCloseCallback("avatar_tab_pane",function(){holodeck.cancelAvatar()});holodeck.authenticated()?$j("#shared_links_tab").show():h.addRunWhenAuthenticatedObserver(function(){$j("#shared_links_tab").show()});holodeck.authenticated()?(b=holodeck.getTabFromCookie(),holodeck._tab_from_cookie=
b.gsub("_pane",""),holodeck._tabs.show(b)):page_data.autofill_username?($$("#new_session_form input[name='username']").first().value=page_data.autofill_username,holodeck._tabs.show(Holodeck.SIGNIN_TAB_NAME)):holodeck._tabs.show(Holodeck.SIGNUP_TAB_NAME);holodeck.addOnTabLoadCallback("accomplishments_tab_pane",function(){$("accomplishment_vtab_set")?(holodeck.buildAccomplishmentVtabSet(),holodeck.authenticated()||$$(".accomplishment_signin").each(Element.show)):holodeck.loadHighScores();var a=$("accomplishment_awarded_tab");
a&&a.down(".close_tab_link").observe("click",function(a){holodeck.recordAnalyticsEvent("Award","Close")})});this._active_user.addRunWhenAuthenticatedObserver(function(){h.hideRateThisGameTab()||(new UserActionCounter({username:h.username(),counterName:"rate_this_game_closure_user_action_counter"})).count(function(a){setTimeout(holodeck._in_beta||holodeck._in_preview?function(){holodeck.showMoreGamesTab()}:function(){holodeck.loadRateThisGameTab(a.count)},12E5)})});holodeck._shared_content_welcome_tab=
new SharedContentWelcomeTab(a);holodeck._lightbox=lightbox.prototype;document.fire("chat_tabs:ready");a=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||0,10);Cookie.set(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME,a+1,1E4,"/");this._konduit.setup({eventDispatcher:this._event_dispatcher,chatHost:this._chat_host,chatProxyWebsocket:this._chat_proxy_websocket,chatProxyBosh:this._chat_proxy_bosh});this.ready=!0;document.fire("holodeck:ready");holodeck.setUsername(h.username())},initializeAccomplishmentTracker:function(a){this._accomplishment_tracker=
new AccomplishmentTracker(Object.clone(a));this._accomplishment_notifications_node=$$(".accomplishment_notifications")[0];this._accomplishment_tracker.on("task-progress",function(a){var b=a.percentValue(),d=a.displayValue();a.isComplete();$$(".accomplishmenttasks-"+a.id()).each(function(c){if(a.isComplete()){c.addClassName("complete");var e=c.down(".accomplishment_task_progress");e&&e.remove()}else(e=c.down(".progress_amount"))&&e.update(d);50<b&&(e=c.down(".marker"))&&e.addClassName("right");(e=
c.down(".current"))&&e.update(d);(c=c.down(".bar"))&&c.setStyle({width:b+"%"})})});this._accomplishment_tracker.on("task-complete",function(a){(a=holodeck.accomplishmentTaskCompletionTemplate(a.id()))&&holodeck.showAccomplishmentCompletedTab(a.cloneNode(!0))});this._accomplishment_tracker.on("accomplishment-complete",function(a){holodeck.recordGuestCompletion(a);var b=holodeck._tabs.activeContainer;holodeck.showAccomplishmentsTab();holodeck.setTab(b.id);a.hasCompletionTabBeenShown()||(holodeck.showAccomplishmentCompletionTab(a.id()),
b=holodeck.accomplishmentCompletionTemplate(a.id()),b=a.isBadgeOfTheDay()?$("botd_award_title"):b.down(".reward_tasks h4"),CinematicMode.addCinematicMessage(b.innerHTML));holodeck.authenticated()&&a.hasCompleteAccomplishmentGroup()&&(holodeck.showAccomplishmentGroupCompletionTab(a.accomplishmentGroup().id()),b="Congratulations! You completed the '"+a.accomplishmentGroup().name()+"' quest.",CinematicMode.addCinematicMessage(b));holodeck.updateAccomplishmentTab(a.id())})},initializeJavascriptApi:function(){this._api_service=
new ApiService({event_dispatcher:this._event_dispatcher,statistics:this._accomplishment_tracker.statistics(),is_connected:function(){return holodeck.konduit().jabberConnected()}})},requestAnalyticsInfo:function(){this._event_dispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD,data:{}})},displayRoomOnFirstJoin:function(a){this._chat_window.roomByType(a.type)||this.displayRoom(a)},handleHolodeckPacket:function(a){switch(a.holodeck_type){case "levelup":holodeck.showLevelUpTab(a);break;case "coupon_awarded":holodeck.showCouponAwardsTab(a);
break;default:console.log("I do not understand this packet type captain.")}},showLevelUpTab:function(a){var b=new Template($("levelup_content_template").innerHTML);holodeck.showProgressTab(b.evaluate($H(a).merge({username:active_user.username()})));75==a.level&&($("hololevel_next_level_message").hide(),$("hololevel_max_level_message").show())},addCouponTemplate:function(a,b){this._coupon_templates[a]=new Template(b)},showCouponAwardsTab:function(a){var b=a.coupon_promotion_id;if(void 0!==this._coupon_templates[b]){var c=
$j("#coupon_promotion_"+b+"_award_content");$j(".js-coupon-promotion-award-content").hide();c.html(this._coupon_templates[b].evaluate(a));c.show();this._tabs.showOnTop("coupon_awards_tab_pane")}},displayRoom:function(a){this._chat_window._active_room||this._chat_window.showChatWindow();this.hideDefaultChatTabContent();this.hideSessionAlertContentInChatTab();this.updateDefaultChatTabMessage("Connecting to chat");this._chat_window.joinedRoom(a)},rebootstrapChat:function(){this._chat_window.bootstrapChat(!0)},
showAccomplishmentCompletionTab:function(a){var b=this._accomplishment_tracker.getAccomplishmentById(a);b&&!b.isHidden()&&(this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(a).cloneNode(!0)),this._currently_shown_award_tab="award",this._holodeck_event_analytics.recordEvent("TabView","Award"),b.setHasCompletionTabBeenShown(),this.authenticated()&&!b.isBadgeOfTheDay()&&b.accomplishmentGroupProgressContent()?this.insertProgressContentInSuggestionNodes(b.accomplishmentGroupProgressContent()):
(!b.isBadgeOfTheDay()||b.isBadgeOfTheDay()&&!this.authenticated())&&this.insertTemplateForNextActionSuggestion({".prize_name":b.prizeName()},this.suggestNextAction.bind(this)),this.getsGoogleADayUpsell(b)&&(a=$("google_a_day_award_tab_upsell_"+b.id()))&&a.show())},insertProgressContentInSuggestionNodes:function(a){this.suggestionLocationNodes().each(function(b){$j(b).html(a)})},showStickerAwardTab:function(){$("more_games_tab_pane").hide();this._tabs.showOnTop("sticker_award_tab_pane")},getsGoogleADayUpsell:function(a){var b=
new Date;return Holodeck.GOOGLE_A_DAY_START_DATE<b&&Holodeck.GOOGLE_A_DAY_END_DATE>b&&!active_user.hasGoogleADayForToday()&&a.isAchievement()},showBadgeOfTheDayAwardTab:function(a){this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(a).cloneNode(!0));$("won_both_badge_and_botd_content").hide();$("won_just_botd_content").show()},showBountyAwardInfo:function(){$("bounty_banner_wrapper").show()},updateAccomplishmentTab:function(a){var b=this._accomplishment_tracker.accomplishmentForId(a);
b&&b.isComplete()&&($$(".achieved_image_"+a+"_for_award").each(function(a){a&&!a.visible()&&(a.previous().hide(),a.show())}),this.updateAccomplishmentPaneTitle())},updateAccomplishmentPaneTitle:function(){var a=$("accomplishments_pane_title"),b=a.down(".no_accomplishments_completed"),c=a.down(".some_accomplishments_completed");a=a.down(".all_accomplishments_completed");var d=this._accomplishment_tracker,e=d.completeAccomplishments().length;d=d.accomplishments().length-d.hiddenAccomplishments().length;
0===e?(a.hide(),c.hide(),b.show()):d==e?(c.hide(),b.hide(),a.show()):(a.hide(),b.hide(),c.down(".earned_accomplishments_count").update(e),c.show())},insertTaskCompletedIntoChat:function(a){this.chatWindow().insert(holodeck.accomplishmentTaskCompletionTemplate(a).cloneNode(!0))},currentAwardTab:function(){var a=this._currently_shown_award_tab;this._currently_shown_award_tab=null;return a},showHighScoreAlert:function(a){if(this.shouldShowHighScoreAlert(a.data.value)){this._currently_shown_award_tab=
"high score";this._holodeck_event_analytics.recordEvent("TabView","HighScoreAlert");$("high_score_alert_username").update(active_user.username());var b=a.data.id,c=this._accomplishment_tracker.getStatisticById(b);a='<p class="high_score_number holodeck_kongbot_happy"><strong>'+a.data.value.toLocaleString()+"</strong> "+c.displayName()+"</p>";c=(new Element("a",{href:"#"})).update("view leaderboard &raquo;");c.observe("click",function(a){holodeck.showHighScores(b)});this._tabs.show("high_score_alert_tab_pane");
this._tabs.container("high_score_alert_tab_pane").down(".high_score_summary").update(a).insert(c);this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this))}},shouldShowHighScoreAlert:function(a){if(!a||this.isShowingAccomplishmentCompletedTab())return!1;a=Cookie.get(Holodeck.KONG_HS_ALERT_COOKIE_NAME);return this.hasNotSeenHighScoreRecently()&&!a?(Cookie.set(Holodeck.KONG_HS_ALERT_COOKIE_NAME,"hs_alert",void 0,this._game_path),!0):!1},hasNotSeenHighScoreRecently:function(){var a=
Cookie.get(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME);if(a){if(a=new Date(a),(new Date).getTime()-a.getTime()>Holodeck.HS_ALERT_WAIT_MILLISECONDS)return Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0}else return Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0;return!1},chatWindow:function(){return this._chat_window},setTab:function(a){this._suppress_setting_preference_cookie=!0;this._tabs.setActiveTab(a)},closeAlertTab:function(){this._tabs.close("alert_tab_pane")},
showCloudSavesTab:function(a,b){this.ready?(this._tabs.show("cloud_saves_tab_pane",HolodeckTabs.Priority.CLOUD_SAVES),$$("#cloud_saves_tab_pane .js-cloud-save-mode").invoke("hide"),a=$$("#cloud_saves_tab_pane .js-cloud-saves-"+a).first(),b&&a.select(".js-cloud-saves-replace").each(function(a){var c=a.readAttribute("data-option-name");a.update(b[c])}),a.show()):document.observe("holodeck:ready",this.showCloudSavesTab.bind(this,a,b))},closeCloudSavesTab:function(){this._tabs.close("cloud_saves_tab_pane")},
showAlertTab:function(){this._tabs.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},showAccomplishmentsTab:function(){this.setTab("accomplishments_tab_pane")},showAvatarTab:function(a){if(a){this._custom_game_avatar=a;a=this.avatarUrlForFile(this._custom_game_avatar);var b=$("game_supplied_avatar_image_tag");this.setAvatarCropBoundaries({});this._custom_game_avatar&&b&&(startCropper=function(){var a=b.width,d=b.height;if(a==d){var e=0;var g=a;var h=0;var l=d}else a>d?(h=0,l=d,e=a/2-d/2,g=e+d):
(e=0,g=a,h=d/2-a/2,l=h+a);e={x1:e,x2:g,y1:h,y2:l};40<a&&40<d&&(this.setAvatarCropBoundaries(e),this._avatar_cropper=new Cropper.Img("game_supplied_avatar_image_tag",{displayOnInit:a==d?!1:!0,ratioDim:{x:1,y:1},minWidth:40,minHeight:40,onloadCoords:e,onEndCrop:function(a,b){holodeck.setAvatarCropBoundaries({x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2})}}))}.bind(this),b.onload=startCropper,b.src=a,this.prepareAvatarTab(),this._tabs.show("avatar_tab_pane"))}},prepareAvatarTab:function(){this.authenticated()&&($("avatar_controls_guest").hide(),
$("avatar_controls").show());$("avatar_save_results").hide();$("avatar_update_spinner").hide();$("game_avatar_accept_button").show();$("avatar_prompt_content").show()},avatarUrlForFile:function(a){return"https://"+active_user.singleCDNDomain()+"/assets/imported_images/"+a},saveAvatar:function(){var a="/accounts/"+this.username()+"/update_avatar.chat";$("game_avatar_accept_button").hide();$("avatar_update_spinner").show();new Ajax.Updater({success:"avatar_save_results"},a,{method:"post",parameters:$H(this.scaledAvatarCropBoundaries()).merge({filename:this._custom_game_avatar,
game_id:this.gameId()}).toObject(),onSuccess:function(){holodeck.avatarSuccess()},onFailure:function(){holodeck.notifyKonduitOfAvatarResults(!1)},onComplete:function(){$("avatar_prompt_content").hide();$("avatar_save_results").show()}})},setAvatarCropBoundaries:function(a){this._avatar_crop_boundaries=a},scaledAvatarCropBoundaries:function(){var a=this._avatar_crop_boundaries,b=a.x1,c=a.y1,d=a.x2;a=a.y2;var e=this.avatarScaleRatios();if(void 0===b||void 0===d||void 0===c||void 0===a)return{};b=parseInt(b/
e.wRatio,10);d=parseInt(d/e.wRatio,10);c=parseInt(c/e.hRatio,10);a=parseInt(a/e.hRatio,10);return{x1:b,y1:c,x2:d,y2:a}},avatarScaleRatios:function(){var a=$("game_supplied_avatar_image_tag");var b=a.getStyle("max-height");var c=a.getStyle("max-width");a.setStyle({maxHeight:""});a.setStyle({maxWidth:""});var d=a.height;var e=a.width;a.setStyle({maxHeight:b});a.setStyle({maxWidth:c});return{hRatio:a.height/d,wRatio:a.width/e}},avatarSuccess:function(){this.notifyKonduitOfAvatarResults(!0);active_user.pullUserData()},
cancelAvatar:function(){this.notifyKonduitOfAvatarResults(!1);this.closeAvatarTab()},closeAvatarTab:function(){this._tabs.close("avatar_tab_pane")},notifyKonduitOfAvatarResults:function(a){holodeck._avatar_cropper&&holodeck._avatar_cropper.remove();holodeck.konduit().dispatchEvent({type:KonduitEvent.IMAGE_AVATAR_COMPLETE,data:{success:a}})},showShareTab:function(){this._holodeck_event_analytics.recordEvent("TabView","Share");this._tabs.showOnTop("share_tab_pane")},showAccomplishmentsOrMoreGamesTab:function(){$("accomplishments_tab_pane")?
this.showAccomplishmentsTab():this.showMoreGamesTab()},showAccomplishmentCompletedTab:function(a){$("more_games_tab_pane").hide();this._just_earned_badge=!0;this._tabs.showOnTop("accomplishment_awarded_tab_pane");this._tabs.container("accomplishment_awarded_tab_pane").down("#accomplishment_awarded_tab_pane_content").update(a)},showProgressTab:function(a){$("more_games_tab_pane").hide();this._just_earned_badge=!0;this._tabs.showOnTop("progress_tab_pane");this._tabs.container("progress_tab_pane").down("#progress_tab_pane_content").update(a)},
showDiscountTab:function(a){this._tabs.showOnTop("cart_discount_tab_pane");this._tabs.container("cart_discount_tab_pane").down("#accomplishment_awarded_tab_pane_content");this.setTab("cart_discount_tab_pane");$j("#discount_purchase").on("click",function(){lightbox.prototype.initializeKredPurchase()});var b=setInterval(function(){var c=moment(a);if(c.isAfter(moment())){var d=c.diff(moment(),"hours"),e=c.subtract(d,"hours").diff(moment(),"minutes");c=c.subtract(e,"minutes").diff(moment(),"seconds");
$j("#discount_hours_remaining").text(d);$j("#discount_minutes_remaining").text(e);$j("#discount_seconds_remaining").text(c)}else $j("#discount_countdown").hide(),$j("#discount_expiration").show(),clearInterval(b)},1E3)},closeDiscountTab:function(){this._tabs.close("cart_discount_tab_pane")},showMoreGamesTab:function(){this.setTab("more_games_tab_pane")},loadMoreGamesTab:function(){holodeck._more_game_tab_page=1;new Ajax.Updater({success:"more_games_tab_pane"},"/recommended_games/show_more_tab",{parameters:{game_id:this.gameId()},
method:"get"})},moreGamesNextPage:function(){new Ajax.Request("/recommended_games/show_more_tab",{parameters:{game_id:this.gameId(),page:this._more_game_tab_page+1},method:"get",onSuccess:function(a){holodeck._more_game_tab_page+=1;$$(".more_games_load_btn")[0].insert({before:a.responseText});48>4*holodeck._more_game_tab_page?$("load_more_games_button").restore():($("load_more_games_button").hide(),$$(".more_games_load_btn").each(Element.hide))}})},showChatApiTab:function(){this._tabs.show("chat_api_pane")},
closeChatApiTab:function(){this._tabs.close("chat_api_pane")},showSharedContentWelcomeTab:function(){this._tabs.show("shared_content_welcome_tab_pane")},isShowingAccomplishmentCompletedTab:function(){return $("accomplishment_awarded_tab_pane").visible()},highlightContent:function(a){var b=$(a);b&&(b.addClassName("highlighted"),setTimeout(function(){b.removeClassName("highlighted")},3E3))},revealContent:function(a,b,c){var d=$(a);b=$(b);var e;d&&b&&(e=b.panel)&&(this.setTab(a),e.open(),e.scrollTab(d),
this.highlightContent(c));return!1},revealFullInstructions:function(){this._tabs.show("game_tab_pane");this.recordAnalyticsEvent("Quick","Instructions");this.revealContent("game_tab_pane","game_instructions_panel","game_instructions");var a=$("game_instructions");if(a){var b=a.down(".truncated_text");a=a.down(".full_text");b&&a&&b.visible()&&(b.hide(),a.show())}},hideDefaultChatTabContent:function(){$("chat_default_content").hide()},showDefaultChatTabContent:function(){$("chat_default_content").show()},
showDisconnectedAlert:function(){this._holodeck_event_analytics.recordEvent("TabView","Disconnect");this.showDefaultChatTabContent();this._tabs.showAlert("disconnected_alert")},showSessionAlert:function(){this.showSessionAlertContentInChatTab();this._holodeck_event_analytics.recordEvent("TabView","SessionAlert");this._tabs.showAlert("session_conflict_alert")},showSessionExpiredAlert:function(){this.showSessionAlertContentInChatTab();this._tabs.showAlert("session_expired_alert")},showCannotConnectAlert:function(){this._has_shown_cannot_connect_alert||
this._holodeck_event_analytics.recordEvent("TabView","CannotConnect");this._tabs.showAlert("cannot_connect_alert");this._has_shown_cannot_connect_alert=!0},updateTabCookie:function(a){this.authenticated()&&!a.closeable&&(this._suppress_setting_preference_cookie?this._suppress_setting_preference_cookie=!1:Cookie.get("holodeck_tab_override")!=a.id&&Cookie.set(Holodeck.HOLODECK_TAB_COOKIE_NAME,this.makeCookieValue(a.id),12,"/"))},getTabsFromCookie:function(){var a=Cookie.get("kong_opened_panel"),b=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME),
c=Cookie.get("holodeck_tab_override"),d=this;return c?[c]:a?(Cookie.erase("kong_opened_panel"),["game_tab_pane"]):b&&(a=b.split("|").select(function(a){return(a=d._tabs.tab(d._tabs.linkForKey(a)))&&a.visible()}),0<a.length)?a:["chat_tab_pane"]},getTabFromCookie:function(){return this.getTabsFromCookie()[0]},makeCookieValue:function(a){var b=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME);return b?(b=b.split("|").select(function(b){return b!=a}),b.unshift(a),b.join("|")):a},registerKonduitCallback:function(a,
b){this._event_dispatcher.register(a,b)},konduit:function(){return this._konduit},konduitEvent:function(a){a=Base64.decode(a).evalJSON(!0);this._event_dispatcher.fire(a)},getGameRoomCookie:function(){var a=Cookie.get(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId());if(a)return a.evalJSON()},setGameRoomCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId(),a,7,this._game_path)},getGuildRoomForCurrentGameCookie:function(){if(this.authenticated()){var a=
Cookie.get(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId());if(a)return a.evalJSON()}else this.setGuildRoomForCurrentGameCookie()},setGuildRoomForCurrentGameCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId(),a,7,this._game_path)},getSitewideGuildRoomCookie:function(){if(this.authenticated()){var a=Cookie.get(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE);if(a)return a.evalJSON()}else this.setSitewideGuildRoomCookie()},
setSitewideGuildRoomCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE,a,void 0,"/")},deletePrivateRoomCookie:function(){$.jStorage.deleteKey(Holodeck.LAST_PRIVATE_ROOM_KEY)},initializeChatWindow:function(a){this._sticker_manager.update(a);a.gameRoomEnabled&&(a.previousGameRoom=this.getGameRoomCookie(),a.gameRoomJoin=Holodeck.GAME_ROOM_JOIN);if(!page_data.opted_out_of_guilds){var b=this.getGuildRoomForCurrentGameCookie();b&&(a.previousGuildChatRoomForCurrentGameCallback=
this.setGuildRoomForCurrentGameCookie.bind(this),a.previousGuildChatRoomForCurrentGame=b);if(b=this.getSitewideGuildRoomCookie())a.previousSitewideGuildChatRoomCallback=this.setSitewideGuildRoomCookie.bind(this),a.previousSitewideGuildChatRoom=b}if(b=$.jStorage.get(Holodeck.LAST_PRIVATE_ROOM_KEY))a.previousPrivateRoomCallback=this.deletePrivateRoomCookie.bind(this),a.previousPrivateRoom=b;this._chat_window.setRooms(a)},joinRoom:function(a){this._chat_window.joinRoom(a)},addChatCommand:function(a,
b){this._chat_commands[a]||(this._chat_commands[a]=[]);this._chat_commands[a].push(b)},processChatCommand:function(a){var b=((a.match(/^\/([^\s]+)/)||[])[1]||"").toLowerCase();if(this._chat_commands[b]){var c=this;return void 0===this._chat_commands[b].detect(function(b){return!1===b(c,a)})}return!0},sendWhisper:function(a,b){var c=b.match(/^\/([^\s]+)\s+([^\s]+)\s+([\s\S]+)/)||[];b=c[2];c=c[3];var d=a.chatWindow();a=a.activeDialogue();b&&c&&(a?a.sendPrivateMessage(b,c):d.sendPrivateMessage(b,c));
return!1},setPresenceAway:function(a){a==holodeck&&(a=null);this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.AWAY,room_name:a}});return!1},setPresenceChat:function(a){a==holodeck&&(a=null);this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.CHAT,room_name:a}});return!1},setStatisticsAndAccomplishments:function(a,b){this._accomplishment_tracker.setStatistics(a);this._accomplishment_tracker.setAccomplishments(b)},
setAccomplishmentsProgress:function(a){a&&(this._accomplishment_tracker.setAccomplishmentsProgress(a),this.updateAccomplishmentPaneTitle(),this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this)),this.konduit().dispatchEvent({type:KonduitEvent.SET_ACCOMPLISHMENT_PROGRESS,data:a}))},addFriends:function(a){this._chat_window.addFriends(a)},addMutings:function(a){this._chat_window.addMutings(a)},addFavoriteRooms:function(a){this._chat_window.addFavoriteRooms(a)},roomGroups:function(a){this._chat_window.roomGroups(a)},
redoRoomList:function(){this._chat_window.redoRoomList()},addChatNags:function(a){this._chat_nag=new ChatNag(this._chat_window,a)},switchUser:function(a,b,c,d,e,g){this._active_user.updateAttributes({chat_username:a,chat_password:b,special_chat_vars:c.extra_vars});this._active_user.updateGameAttributes({game_auth_token:d,user_vars:c.user_vars,user_vars_sig:c.user_vars_sig});this._suppress_disconnect=g;this.chatWindow().onLogout();this.konduit().dispatchEvent({type:KonduitEvent.SWITCH_USER,data:{username:a,
user_id:e,slk:b,variables:c,game_auth_token:d}});this.requestAnalyticsInfo()},isGuestUsername:function(a){return/^Guest/i.match(a)},setUsername:function(a){var b=this.isGuestUsername(this._username);if(a!=this._username&&(this._username=a,!this.isGuestUsername(a)))this.onAuthenticated(b)},username:function(){return this._active_user?this._active_user.username():"Guest"},onAuthenticated:function(a){a=a&&this._has_submitted_stats;this.updateUsernameIndicator();this.loadAccomplishments(a);this.hideNextActionSuggestion();
this.addOnLoadedAccomplishmentsCallback(this.checkForStickerDrop.bind(this))},hasAccomplishments:function(){return 0<this._accomplishments.length},updateUsernameIndicator:function(){var a=$$(".user_connection .logged_in_user")[0];a.down(".logged_in_user_username").update(this.username());a.show()},authenticated:function(){return this._active_user&&this._active_user.isAuthenticated()},gameId:function(){return this._game_id},addFriend:function(a){this._chat_window.addFriends([a])},removeFriend:function(a){this._chat_window.removeFriends([a])},
addMuting:function(a){this._chat_window.addMutings([a]);this._chat_window.updateRolloverMutingLink(a)},removeMuting:function(a){this._chat_window.removeMutings([a]);this._chat_window.updateRolloverMutingLink(a)},alertLog:function(){return this.konduit().alertLog()},insertPrivateMessagePrefixFor:function(a){this._chat_window.insertPrivateMessagePrefixFor(a)},selectRoom:function(a){a.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom",
"chat_features_tab"):(holodeck._chat_window._online_friends.deactivate(),this.joinRoom(a))},loadFriendsPage:function(a){this._chat_window.loadFriendsPage(a)},loadAccomplishments:function(a){var b=this._on_loaded_accomplishments_callbacks,c=function(){for(;b;)b.pop()()};!this._authenticated_and_loaded_accomplishments&&this.hasAccomplishments()&&this.authenticated()&&(a||(this._authenticated_and_loaded_accomplishments=!0),new Ajax.Request(this._accomplishments_bootstrap_url,{method:"get",onComplete:c}))},
checkForStickerDrop:function(){new Ajax.Request(this._sticker_drop_url,{method:"post"})},addKongpanionInfoToBotdTab:function(){$j(".kongpanion_botd_award_name").text(active_user.kongpanionInfo().name);$j(".kongpanion_botd_award_link").attr("href","/accounts/"+active_user.username()+"/kongpanions");var a=$j("<img />");0===active_user.botdsThisWeek()?(a.attr("src",active_user.kongpanionInfo().normal_url),$j("#kongpanion_botd_award_icon_normal_target").append(a),$j("#kongpanion_botd_award_content_normal").show()):
active_user.botdsThisWeek()==active_user.shinyThreshold()-1&&(a.attr("src",active_user.kongpanionInfo().shiny_url),$j("#kongpanion_botd_award_icon_shiny_target").append(a),$j("#kongpanion_botd_award_content_shiny").show());$j("#award_tab_botd_info").show()},prepareBadgeOfTheDayAwardTab:function(a){!active_user.kongpanionInfo()||0!==active_user.botdsThisWeek()&&active_user.botdsThisWeek()!=active_user.shinyThreshold()-1?this.authenticated()&&$("award_tab_botd_check_tomorrow_content")&&($("award_tab_botd_check_tomorrow_content").show(),
$("award_tab_botd_info").show()):this.addKongpanionInfoToBotdTab()},prioritizeBadgeOfTheDay:function(a){if(a=this._accomplishment_tracker.accomplishmentForId(a))a._level="badge_of_the_day"},addOnLoadedAccomplishmentsCallback:function(a){if(!this.hasAccomplishments())return a();this._on_loaded_accomplishments_callbacks.push(a)},tabbifyAccomplishments:function(){var a=this;(function(){a.showAccomplishmentTab(a.nextAccomplishment())}).defer();this.buildAccomplishmentVtabSet()},buildAccomplishmentVtabSet:function(){this._accomplishment_vtab_set=
new HolodeckTabs("accomplishment_vtab_set",{tabSelector:".vtab"})},loadScoresPage:function(a,b,c){this._high_scores.getHighScores(a,b,c)},loadHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this));this._high_scores.getHighScores()},showHighScores:function(a){this._tabs.show("accomplishments_tab_pane");this._high_scores||(this._high_scores=new HighScores(this));this._high_scores.activate(a)},hideHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this));
this._high_scores.deactivate()},registerAccomplishmentCompletionCallback:function(a,b){this._accomplishment_tracker.registerAccomplishmentCompletionCallback(a,b)},registerAccomplishmentProgressCallback:function(a,b,c,d){this._accomplishment_tracker.registerAccomplishmentProgressCallback(a,b,c,d)},accomplishmentTemplates:function(){return this._accomplishment_notifications_node},accomplishmentCompletionTemplate:function(a){return this.accomplishmentTemplates().down(".accomplishment_"+a).down(".accomplishment_completed")},
accomplishmentTaskCompletionTemplate:function(a){if(a=$("completed_accomplishment_task_"+a))return a.down(".task_completed")},accomplishmentSuggestionTemplate:function(a){return this.accomplishmentTemplates().down(".accomplishment_"+a).down(".accomplishment_suggested")},accomplishmentFromOtherGameSuggestionTemplate:function(){var a=this.accomplishmentTemplates().down("#suggestibles").select(".suggestible");return a[parseInt(Math.random()*a.length,10)]},claimAwardTemplate:function(){return this.accomplishmentTemplates().down(".claim_award_box")},
showDisconnectedIndicator:function(){this._chat_connected_indicator_node.hide();this._chat_limited_connection_indicator_node.hide();this._chat_disconnected_indicator_node.show()},showConnectedIndicator:function(){this._chat_disconnected_indicator_node.hide();this._chat_limited_connection_indicator_node.hide();this._chat_connected_indicator_node.show()},showLimitedConnectionIndicator:function(){this._chat_disconnected_indicator_node.hide();this._chat_connected_indicator_node.hide();this._chat_limited_connection_indicator_node.show()},
showCloudSavesIndicator:function(a){var b=this,c=function(){b._chat_connected_indicator_node.addClassName("cloud-mode");if("sync"===a){var c=$j("#cloud_sync_indicator");c.tooltip({content:function(){return $j("#cloud_save_info_template").html()},position:{my:"right+21 top+10",at:"bottom"}});var e=JSON.parse(Cookie.get("cloud_saves_game_ids_"+active_user.id()))||[];0>e.indexOf(active_user.gameId())&&(c.tooltip("open"),setTimeout(function(){c.tooltip("close")},1E4),e.push(active_user.gameId()),Cookie.set("cloud_saves_game_ids_"+
active_user.id(),JSON.stringify(e)))}};$$(".js-cloud-indicator").invoke("hide");$("cloud_"+a+"_indicator").show();this.ready?c():document.observe("holodeck:ready",function(){c()}.bind(this))},reconnect:function(){this.konduit().dispatchEvent({type:KonduitEvent.CONNECT})},setupBanAndSilencingControls:function(){this._chat_window.setupBanAndSilencingControls()},hideNextActionSuggestion:function(){var a=$("accomplishment_awarded_tab_pane").down(".suggestion_placeholder");a&&a.update("")},suggestionLocationNodes:function(){return[$("accomplishment_awarded_tab_pane"),
$("high_score_alert_tab_pane")].compact().map(function(a){return a.down(".suggestion_placeholder")}).compact()},suggestNextAction:function(a){this.suggestionLocationNodes().each(function(b){a.insertAt(b)})},setAccomplishmentGroupSuggestions:function(a){var b=this;a.each(function(a){var c=a[1];b._accomplishment_tracker.getAccomplishmentById(a[0]).setAccomplishmentGroupProgressContent(c)})},showAccomplishmentGroupCompletionTab:function(a){if(a=$("accomplishment_group_completion_tab_content_"+a))this._accomplishment_group_award_tab_node.update(a.innerHTML),
this._active_user.populateUserSpecificLinks(this._accomplishment_group_award_tab_node),this._tabs.showOnTop("accomplishment_group_awarded_tab_pane")},notifyOnGameTab:function(a){this._tabs.showOnTop("game_tab_pane");$("game_tab_pane").scrollTop=0;$("rating_message").update(a);$("rating_message").addClassName("highlighted")},insertTemplateForNextActionSuggestion:function(a,b){var c=this.authenticated()?(c=this.nextAccomplishment())?this.accomplishmentSuggestionTemplate(c.id()):this.accomplishmentFromOtherGameSuggestionTemplate():
this.claimAwardTemplate();b(new SuggestionTemplate(c,a))},nextAccomplishment:function(){return this._accomplishment_tracker.nextAccomplishment()},showMiniProfile:function(a){this.showChatTab();this._chat_window.showProfile(a)},updateDefaultChatNag:function(a){this._chat_nag&&this._chat_nag.updateDefaultNag(a)},showChatTab:function(){this._tabs.show("chat_tab_pane")},showAccomplishmentTab:function(a){a&&this._accomplishment_vtab_set.show(a.domId())},setSilenceScheduledEnd:function(a){this._chat_window.updateSilenceScheduledEnd(a)},
isChatModerator:function(){return active_user.isChatModerator()},activeDialogue:function(){return this._active_dialogue},receivedPrivateMessage:function(a){var b=this._active_dialogue;b&&b.receivedPrivateMessage(a)},sendPrivateRoomInvitation:function(a){this.premiumUserOnly(function(){holodeck._users_invited[a]=!0;holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_INVITATION,data:{username:a}})},"chat_features_tab")},receivedPrivateRoomInvitation:function(a){this._ignored_invitations[a.username]||
this._chat_window.receivedPrivateRoomInvitation(a)},hasActiveShoutCall:function(){return!!this._currentRequestId},sendPrivateMessage:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");new Ajax.Request("/api/shout.json",{method:"post",parameters:{game_id:active_user.gameId(),game_message:b,from_game:!0,"shout[private]":!0,game_auth_token:active_user.gameAuthToken(),username:active_user.username()},onSuccess:function(a){holodeck.invokeShoutCallback({message_type:"private",
success:a.responseJSON.success,error:a.responseJSON.error})}})},displayShoutBox:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");setTimeout(function(){lightbox.prototype.initializeShoutFrame(holodeck.gameId(),b)},0)},displayInvitationBox:function(a){var b=a.data.invitation_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");var c=a.data.filter;void 0===c&&(c="");lightbox.prototype.initializeInvitationFrame(holodeck.gameId(),
b,c,a.data.kv_params)},displayFeedPostBox:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");var c=a.data.image_uri;void 0===c&&(c="");var d=a.data.kv_params;void 0===d&&(d={});setTimeout(function(){var a=function(){active_user.shoutForGame(active_user.gameId(),function(a){if(a){a={game_id:holodeck.gameId(),image_uri:c,game_auth_token:active_user.gameAuthToken(),game_message:b,from_game:!0,username:active_user.username()};var e={};
$H(d).each(function(a){e["shout_api_params["+a[0]+"]"]=a[1]});new Ajax.Request("/api/shout.json",{method:"post",parameters:$H(a).merge(e),onSuccess:function(a){holodeck.invokeShoutCallback({message_type:"feed",success:a.responseJSON.success,error:a.responseJSON.error})}})}else lightbox.prototype.initializeFeedPostFrame(holodeck.gameId(),b,c,d)})};active_user.isAuthenticated()?a():(lightbox.prototype.addOnCloseCallback(function(){active_user.isAuthenticated()&&a()}),lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+
holodeck.gameId(),{done_class_name:"lightbox_login"}))},0)},invokeShoutCallback:function(a){var b={};b[KonduitEvent.PARAM_REQUEST_ID]=this._currentRequestId;b[KonduitEvent.PARAM_MESSAGE_TYPE]=a.message_type;b[KonduitEvent.PARAM_MESSAGE_RECIPIENTS]=a.recipients;b[KonduitEvent.PARAM_SUCCESS]=a.success;b[KonduitEvent.PARAM_ERROR]=a.error;this._currentRequestId=null;holodeck.konduit().dispatchEvent({type:KonduitEvent.OP_SHOUT_CALLBACK,data:b})},invokeShoutDialogClosedCallback:function(a){holodeck.hasActiveShoutCall()&&
holodeck.invokeShoutCallback({message_type:a,success:!1,error:"User closed dialog"})},destroyPrivateRoom:function(){holodeck._users_invited={};holodeck.konduit().dispatchEvent({type:KonduitEvent.DESTROY_PRIVATE_ROOM,data:{}})},leaveRoom:function(a){holodeck.konduit().dispatchEvent({type:KonduitEvent.LEAVE_ROOM,data:{room_type:a}})},leavePrivateRoom:function(){this.leaveRoom("private")},leaveGuildRoom:function(){this.leaveRoom("guild")},invitationIgnoredBy:function(a){this._ignored_invitations[a]=
!0},privateRoomKick:function(a){holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_KICK,data:{username:a}})},hasInvited:function(a){return this._users_invited[a]},premiumUserOnly:function(a,b){active_user.isPremium()?a():lightbox.prototype.initializePremiumMembershipPurchase("private_chat",b)},height:function(){return this._html_dimensions.game_frame_height},checkChatScroll:function(){this._tabs&&"chat_tab_pane"==this._tabs.activeContainer.id&&this._chat_window.scrollToBottom()},recordAnalyticsEvent:function(a,
b,c){this._holodeck_event_analytics.recordEvent(a,b,c)},recordMappedEventAnalytic:function(a){this._holodeck_event_analytics.recordMappedEventAnalytic(a)},setMetricTracker:function(a){this._holodeck_event_analytics.setMetricTracker(a)},startWatchingStats:function(){this._accomplishment_tracker.startWatchingStats()},scheduleRender:function(a){this._queued_renders||(this._queued_renders=[]);this._queued_renders.push(a);if(!this._queued_render_worker){var b=this;this._queued_render_worker=setTimeout(function(){b.processRenderQueue()},
this._interval_between_renders)}},processRenderQueue:function(){var a=this._queued_renders.shift();if(this._queued_renders.length){var b=this;this._queued_render_worker=setTimeout(function(){b.processRenderQueue()},this._interval_between_renders)}else this._queued_render_worker=null;a&&a()},showSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").show();$j("#chat_window").css({opacity:0})},hideSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").hide();
$j("#chat_window").css({opacity:"inherit"})},updateDefaultChatTabMessage:function(a){$("chat_default_content").down("p").update(a)},submitGameBug:function(a,b){a=$H(b).merge({method:"post",parameters:{type:"GameBugReport","feedback[game_bug_content]":a,"feedback[game_id]":this.gameId(),"alert[log]":JSON.stringify(this.alertLog())}}).toObject();new Ajax.Request("/feedbacks",a);this.recordAnalyticsEvent("Game","Bug")},showSignupTab:function(){this.authenticated()||(this._tabs.showOnTop("signup_tab_pane"),
new Effect.Highlight("signup_tab_pane",{startcolor:"#ffff99",endcolor:"#dddddd",restorecolor:"#dddddd"}))},closeSignupTab:function(a){this._tabs.closeSignupTab(a)},closeSigninTab:function(a){this._tabs.closeSigninTab(a)},addSignupTabOnCloseCallback:function(a){this._tabs.addOnCloseCallback("signup_tab_pane",a)},isShowingSignupTab:function(){return $("signup_tab_pane").visible()},_purgeTabCookies:function(){Cookie.erase("kong_opened_panel");Cookie.erase(Holodeck.HOLODECK_TAB_COOKIE_NAME);Cookie.erase("holodeck_tab_override")},
loadCollaborators:function(){new Ajax.Request(this._game_path+"/collaborations.js",{method:"get",onSuccess:function(a){var b=$("collaborators_placeholder");b&&b.update(a.responseText)}})},sharedContentData:function(){if(this._shared_content_data)return this._shared_content_data.content},promptSaveSharedContent:function(a){this._permissions.save_shared_content?this.authenticated()?(this._shared_content_data=a,a=Object.extend({},a),delete a.content,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+
"/shared_contents/new?"+Object.toQueryString(a),"kred_purchase")):(this._shared_content_data=a,this._lightbox.wait_for_shutdown=!0,this._lightbox.reloadInfoFromUrl(this._login_url,"kred_purchase lightbox_login")):this.alertSharedContentSavingNotPermitted(a.contentType)},redoPromptSavedSharedContent:function(){this._shared_content_data&&(this._lightbox.wait_for_shutdown=!1,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+"/shared_contents/new?"+Object.toQueryString(this._shared_content_data),
"kred_purchase"))},promptProcessingSaveSharedContent:function(a){var b=this;this._lightbox.addOnCloseCallback(function(){b.saveSharedContentFailed()});this._lightbox.initializeKongregateLightboxFromContent('<p class="shared_content_loading_message">Processing Thumbnail (<a href="#" onclick="holodeck.closeLightbox();return false;">cancel</a>)</p>',{afterStaticContentLoad:function(){$("kongregate_lightbox_spinner").show()}})},saveSharedContentFailed:function(){this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,
data:{success:!1}});this._lightbox.deactivate()},saveSharedContentSuccessful:function(a){this._lightbox.clearOnCloseCallbacks();this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,data:{success:!0,content:a.content,name:a.name,permalink:a.permalink,id:a.id,label:a.label}});a.externally_submitted?this.loadSharedContentWithoutClosingLightbox(a):this.showSharedContent(a.tab_link,a.tab_contents_url)},loadSharedContentWithoutClosingLightbox:function(a){var b=this;this._last_loaded_shared_content_id&&
this._last_loaded_shared_content_id==a.id||(this._shared_content_timer&&clearTimeout(this._shared_content_timer),this._last_loaded_shared_content_id=a.id,this._shared_content_timer=setTimeout(function(){b._last_loaded_shared_content_id=null},5E3),this.konduit().dispatchEvent({type:KonduitEvent.LOAD_SHARED_CONTENT,data:{contentType:a.contentType,content:a.content,name:a.name,permalink:a.permalink,id:a.id,label:a.label}}),this.showSharedContent(a.tab_link,a.tab_contents_url))},loadSharedContent:function(a){this.closeLightbox();
this.loadSharedContentWithoutClosingLightbox(a)},loadSharedContentFromUrl:function(){var a=this,b=document.location.search.parseQuery(),c=this._shared_content_type_permalinks.find(function(a){return b[a]});c&&new Ajax.Request(this._active_user.gameResourcePath()+"/shared_contents/"+b[c]+".json",{method:"get",onSuccess:function(b){b=b.responseText.evalJSON();a.loadSharedContent(b)}})},alertSharedContentSavingNotPermitted:function(a){alert(a+" saving is not permitted for this game.")},saveSharedContentFromUrl:function(){if(!this._shared_content_saved_from_url){this._shared_content_saved_from_url=
!0;var a=document.location.search.parseQuery();a.type&&(this._permissions.save_shared_content?this._permissions.save_external_shared_content?this._shared_content_type_names.include(a.type.toLowerCase())&&a.content&&/&z$/.match(document.location.href)?this.promptSaveSharedContent({contentType:a.type,label:a.label,content:a.content,fromUrl:!0}):alert("This "+a.type+" could not be saved."):alert(a.type+" saving is only enabled on Kongregate.com."):this.alertSharedContentSavingNotPermitted(a.type))}},
showSharedContent:function(a,b){a+="_pane";var c=a+"_spinner",d=$("shared_content_tab_content"),e=$(c);e&&e.show();d&&d.remove();this._tabs.ajaxUpdateTab(a,b,function(){e&&e.hide();(d=$("shared_content_tab_content"))&&d.select(".collapsible_panel").each(function(a){new CollapsiblePanel(a)})});this._tabs.show(a);Element.scrollTo("maingame")},showSharedContentsIndex:function(a,b,c){this._permissions.save_shared_content&&(a=this._active_user.gameResourcePath()+"/shared/"+encodeURIComponent(a)+(b?"?"+
Object.toQueryString({sort:b,label:c}):""),!this.authenticated()&&b&&this._authenticated_only_shared_content_sorts.include(b.toLowerCase())?(this._show_shared_contents_index_url=a,this._lightbox.wait_for_shutdown=!0,this.showLightbox(this._login_url)):this.showLightbox(a))},redoShowSharedContentsIndex:function(){this._show_shared_contents_index_url&&this._lightbox.reloadInfoFromUrlFromUrl(this._show_shared_contents_index_url)},updateSharedContentsIndex:function(a){new Ajax.Updater({success:"lightbox_form"},
a,{asynchronous:!0,evalScripts:!0,method:"get",onLoading:function(a){Element.show("shared_content_sorting_indicator")}})},showLightbox:function(a){this._lightbox.initializeKongregateLightboxFromAjax(a)},closeLightbox:function(){this._lightbox&&this._lightbox.deactivate()},recordGuestCompletion:function(a){this.authenticated()||this._accomplishment_tracker.recordGuestAccomplishment(a)},loadAdminControls:function(){this._active_user.isAdmin()&&new Ajax.Updater({success:"admin_control_container"},this._active_user.gameResourcePath()+
"/admin_controls",{method:"get"})},loadDeveloperControls:function(){active_user.animationThrowdownSteam()||this._active_user.isDeveloperOfGame()&&!this._active_user.isAdmin()&&new Ajax.Updater({success:"developer_control_container"},this._active_user.gameResourcePath()+"/developer_controls",{method:"get"})},loadDiscussions:function(){this._game_discussions.loadDiscussions()},loadRateThisGameTab:function(a){var b=new UserActionCounter({username:this._active_user.username(),counterName:"rate_this_game_closure_user_action_counter"});
this.userRating()||$j(document.activeElement).hasClass("chat_input")||($("rate_this_game_tab").show(),0>=this.userRating()&&$$(".rate_this_game_tab_unrated").invoke("show"),this._tabs.showOnTop("rate_this_game_tab_pane"),3<=a&&($j("#rate_this_game_tab_pane_content div#opt_out").show(),$j("#rate_this_game_tab_pane_content div#opt_out input#rate_game_opt_out").change(function(){var a="/accounts/"+holodeck._active_user.username()+"/user_preferences";$j(this).is(":checked")?$j.csrfPost({url:a,data:{preference:"hide_rate_this_game_tab"}}):
$j.csrfDelete({url:a+"/1",data:{preference:"hide_rate_this_game_tab"}})})),$j(".rate_later_link").click(function(a){a.preventDefault();holodeck.closeRateThisGameTab();holodeck.trackRateThisGameTabClosure(b)}),$j("li.tab#rate_this_game_tab span.close_tab_link").click(function(){holodeck.trackRateThisGameTabClosure(b)}))},trackRateThisGameTabClosure:function(a){a.increment(function(){})},closeRateThisGameTab:function(){this._tabs.close("rate_this_game_tab_pane")},hasSharedContent:function(){return this._shared_content_type_names&&
this._shared_content_type_names.length},showPlayLaterLinks:function(){$("quicklinks_play_later_block").show();$("below_game_play_later_block").show()},showStickerPackLink:function(){$("quicklinks_sticker_pack").show()},addUserStickerPack:function(a){this._sticker_manager.pushNewUserStickerPack(a)},addIncomingMessageFilter:function(a){this._incoming_message_filters.unshift(a)},filterIncomingMessage:function(a,b){this.filterMessage(a,this._incoming_message_filters,b)},addOutgoingMessageFilter:function(a){this._outgoing_message_filters.unshift(a)},
filterOutgoingMessage:function(a,b){this.filterMessage(a,this._outgoing_message_filters,b)},filterMessage:function(a,b,c){b.inject(c,function(a,b){return function(c){b(c,a)}})(a)},addMessageFilters:function(){if(this._active_user){var a=this._active_user.domain().gsub(".","\\."),b=new RegExp("\\b((?:https?://)?www\\."+a+'(?:/[^\\s"]*)*\\b/?)',"i"),c=new Element("p");this.addIncomingMessageFilter(function(a,b){c.setText(a);b(c.innerHTML.gsub("\\\\","\\").gsub("<br>",""),b)});this.addIncomingMessageFilter(function(a,
c){c(a.gsub(b,function(a){return'<a href="'+(0===a[0].indexOf("http")?"":"http://")+a[0]+'" target="_blank">'+a[0]+"</a>"}),c)})}},resizeGame:function(a,b){function c(a,b,c,d){var e={};$A(["width","minWidth","maxWidth"]).each(function(b){c.hasOwnProperty(b)&&(e[b]=a+c[b]+"px")});$A(["height","minHeight","maxHeight"]).each(function(a){c.hasOwnProperty(a)&&(e[a]=b+c[a]+"px")});d.setStyle(e)}var d=this._html_dimensions;a=parseInt(a,10)||0;b=parseInt(b,10)||0;a<d.game_width&&(a=d.game_width);b<d.game_height&&
(b=d.game_height);d=[["#maingame",{width:d.divider_width+d.chat_width,height:d.quicklinks_height}],["#maingamecontent",{width:d.divider_width+d.chat_width,height:d.quicklinks_height}],["#flashframecontent",{width:d.divider_width+d.chat_width,height:d.quicklinks_height}],["#gameholder",{width:0}],["#game",{width:0,height:0}],["#gameiframe",{width:0,height:0}],["#chat_container",{height:0}],[".game_avatar_image>img",{maxHeight:-d.avatar_image_gutter_height}],["#kong_game_ui>.tabpane",{height:-d.chat_pane_tab_height}]];
for(var e=d.length-1;0<=e;e--)$$(d[e][0]).each(c.curry(a,b,d[e][1]));CinematicMode.refreshCinematicLayout()},updateGameplay:function(a){this._gameplay_id=a},gameplay:function(){return this._gameplay_id},userRating:function(){return this._user_rating},addOnTabSelectCallback:function(a,b){this._tabs.addOnSelectCallback(a,b)},addOnTabLoadCallback:function(a,b){document.observe(a+":loaded",b);this._tabs.activeContainer.id===a&&b()},setupBelowFoldTabs:function(){$$(".game_tab_index").each(function(a){$(a).firstDescendant().addClassName("active")});
$$(".game_tab_group").each(function(a){$(a).firstDescendant().addClassName("active")});this._game_discussions.setupTabs();$(document).on("click",".game_tab_link",function(a){var b=$(a.target||a.srcElement),c=b.readAttribute("href").sub("#","");b.up().siblings().each(function(a){$(a).removeClassName("active")});b.up().addClassName("active");$(c).siblings().each(function(a){$(a).removeClassName("active")});$(c).addClassName("active");a.stop()})}};function CapturesToInlineRegistration(){}
CapturesToInlineRegistration.decorate=function(a){return active_user.capturedSelectorWrapper.bindAsEventListener(active_user,a)};HolodeckEventAnalytics=function(){this.initialize()};
HolodeckEventAnalytics.tab_mappings={chat_tab:["TabView","Chat"],game_tab:["TabView","Game"],accomplishments_tab:["TabView","Achievements"],more_games_tab:["TabView","MoreGames"],signup_tab:["TabView","Signup"],game_info_panel:["Game","InfoToggle"],game_description_panel:["Game","DescriptionToggle"],game_instructions_panel:["Game","InstructionsToggle"],game_shared_contents_panel:["Game","SharedContentToggle"],today_high_score_tab:["Achievements","ScoresToday"],weekly_high_score_tab:["Achievements",
"ScoresLast7"],all_time_high_score_tab:["Achievements","ScoresAllTime"],friends_high_score_tab:["Achievements","ScoresFriends"]};
HolodeckEventAnalytics.prototype={initialize:function(){var a=this;["chat_tab","game_tab","accomplishments_tab","more_games_tab","signup_tab"].each(function(b){var c=$(b);c&&c.observe("click",function(c){a.recordMappedEventAnalytic(b)})})},setMetricTracker:function(a){this._metric_tracker=a},recordEvent:function(a,b,c){if(this._metric_tracker){var d=this._metric_tracker;setTimeout(function(){d.trackEvent(a,b,c)},0)}},recordMappedEventAnalytic:function(a){(a=HolodeckEventAnalytics.tab_mappings[a])&&
this.recordEvent(a[0],a[1])}};
HolodeckTabs=Class.create(Control.Tabs,{initialize:function($super,b,c){c||(c={});this._closeableTabs={};this._preservableTabs={};this._closeableTabsStack=[];this._onCloseCallbacks={};this._onSelectCallbacks={};this._onChangeCallback=c.afterChange;this._tabSelector=c.tabSelector||".tab";c.hideFunction=this.hideContainer;c.showFunction=this.showContainer;c.afterChange=function(b){(b=this._onSelectCallbacks[b.id])&&b.each(function(b){b()});this._onChangeCallback&&this._onChangeCallback()};this._current_top_priority=
HolodeckTabs.Priority.ON_TOP;$super(b,c);this._holodeck=c.holodeck},addTab:function($super,b){var c=this,d=b.up(this._tabSelector),e=d.hasClassName("closeable"),g=d.hasClassName("preserve");$super(b);var h=this.containers.get(b.key);h.closeable=e;h.preservable=g;e&&(this._closeableTabs[b.key]=!0,(d=d.down(".close_tab_link"))&&d.observe("click",function(d){c.close(b);d.stop()}));g&&(this._preservableTabs[b.key]=!0)},keyForLink:function(a){var b;if(a||"undefined"!==typeof a)return b="string"==typeof a?
this.links.find(function(b){return b.key==a}).key:"number"==typeof a?this.links[a].key:a.key},linkForKey:function(a){return a.key?a:void 0===a.length?this.links[a]:"first"==a?this.links[0]:this.links.find(function(b){return b.key==a})},tab:function(a){var b=this.keyForLink(a);return(a=this.links.find(function(a){return a.key==b}))?a.up("li"):null},container:function(a){return this.containers.get(this.keyForLink(a))},addOnCloseCallback:function(a,b){var c=this._onCloseCallbacks[a]||[];c.push(b);this._onCloseCallbacks[a]=
c},addOnSelectCallback:function(a,b){var c=this._onSelectCallbacks[a]||[];c.push(b);this._onSelectCallbacks[a]=c;this.activeContainer.id==a&&b()},close:function(a,b){var c=this.linkForKey(a);a=this._onCloseCallbacks[c.key];if(this.isCloseable(c))return a&&(delete this._onCloseCallbacks[c.key],a.each(function(a){a(b)})),this._closeableTabsStack=this._closeableTabsStack.reject(function(a){return a==c}),this._closeableTabsStack.length&&(a=this._closeableTabsStack[this._closeableTabsStack.length-1],this.show(a,
a._priority)),this.hide(c),this.updateStackedTab(),!0},closeTab:function(a,b){$(a)&&this.close(a,b)},closeSignupTab:function(a){this.closeTab("signup_tab_pane",a)},closeSigninTab:function(a){this.closeTab("signin_tab_pane",a)},updateStackedTab:function(){(function(){this._closeableTabsStack.each(function(a){a.up("li").removeClassName("stacked")});1<this._closeableTabsStack.length&&this._closeableTabsStack[0].up("ul").down(".active").up("li").addClassName("stacked")}).bind(this).defer()},hide:function(a,
b){var c=this.tab(a),d=this.container(a);c.hide();d.hide();this.activeLink!=a||b||(b=this._holodeck.getTabFromCookie(),a.id.startsWith("signup")||b.startsWith("signup")?holodeck.showAccomplishmentsOrMoreGamesTab():this.show(b))},showOnTop:function(a){this.show(a,++this._current_top_priority)},show:function(a,b){var c=this.linkForKey(a);a=c;if(this.isCloseable(c)){a=this._closeableTabsStack.reject(function(a){return a==c});for(var d=a.length-1;0<=d;d--)c!=a[d]&&this.hide(a[d],!0);c._priority=b||0;
a.push(c);this._closeableTabsStack=a.sortBy(function(a){return a._priority});a=this._closeableTabsStack[this._closeableTabsStack.length-1]}this.updateStackedTab();b=this.tab(a);d=this.container(a);b&&d&&(b.show(),d.show(),this.setActiveTab(a))},isCloseable:function(a){return this._closeableTabs[this.keyForLink(a)]},ajaxUpdateTab:function(a,b,c,d){var e=this;new Ajax.Request(b,{method:"get",onSuccess:function(b){var g=e.container(a);d&&(g=g.down(d));g.update(b.responseText);c&&c()},onFailure:function(b){e.close(a)}})},
showAlert:function(a){this._alert_tab_pane_content||(this._alert_tab_pane_content=$("alert_tab_pane_content"));alert_div=$(a);this._alert_tab_pane_content.innerHTML=alert_div.innerHTML;a.startsWith("session_")&&($("session_conflict_content_for_chat_tab").innerHTML=alert_div.innerHTML);this.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},hideContainer:function(a){a.preservable?(a.setStyle({visibility:"hidden"}),a.select(".hideable").each(function(a){a.setStyle({visibility:"hidden"})})):a.hide()},
showContainer:function(a){a.preservable?(a.setStyle({visibility:"visible"}),a.select(".hideable").each(function(a){a.setStyle({visibility:"visible"})})):a.show()}});HolodeckTabs.Priority={ERROR:1,ON_TOP:2,CLOUD_SAVES:100};IntervalManager=function(a,b,c){this.initialize(a,b,c)};
IntervalManager.prototype={initialize:function(a,b,c){this._func=a;this._interval=b;this._deadline=c},start:function(a){this._timeout||(a&&this._func(),this._createTimeout())},stop:function(){clearTimeout(this._timeout);this._timeout=null},_createTimeout:function(){var a=this,b;this._deadline&&(b=Date.now()+a._deadline);this._timeout=setTimeout(function(){(!b||Date.now()<b)&&a._func();a._createTimeout()},this._interval)}};function JabberChatRoom(a){this.initialize(a)}JabberChatRoom.TIME_FORMAT="YYYYMMDDTHH:mm:ss";
JabberChatRoom.USER_VAR_KEYS="username type level chat_avatar_url game_title game_url moderator_room_ids moderator_game_ids".split(" ");
JabberChatRoom.prototype={initialize:function(a){this._messageFilter=a.messageFilter||new MessageFilter;this._connection=a.connection;this._activeUser=a.activeUser;this._muc=this._connection._client.muc;this._type=a.type;this._name=a.name;this._xmppName=a.xmppName;this._gameId=a.gameId||null;this.reset();this._rateLimiters={};this._retryAttempts=0},join:function(){if(this._connection.connected()){var a=Kongregate.Utils.catchErrors,b=$build("status",JSON.stringify(this._userStatus())).node;this.muc().join(this.jid(),
this.userNickname(),a(this._onRoomMessage,this,!0),a(this._onRoomPresence,this,!0),a(this._onRoomRoster,this,!0),null,{seconds:60},b)}},leave:function(a){!a&&this._joined&&this._connection.connected()&&this.muc().leave(this.jid(),this.userNickname(),null,"");this._onRoomLeave()},sendGroupMessage:function(a){if(this._connection.connected())if("string"===typeof a)this.muc().groupchat(this.jid(),a);else if(a.stickerId){var b=":sticker-"+a.stickerId+"-"+a.stickerVariant+":";this.muc().groupchat(this.jid(),
b,JSON.stringify(a))}},xmppName:function(){return this._xmppName},reset:function(){this._occupants={};this._joined=!1},jid:function(){return this.xmppName()+"@conference."+this._connection.serverName()},userNickname:function(){return this._activeUser.chatUsername()},isMyPrivateRoom:function(){var a=JabberConnection.PRIVATE_ROOM_PREFIX+this.userNickname().toLowerCase();return"private"===this._type&&this._xmppName==a},userJid:function(){return this.jid()+"/"+this.userNickname()},muc:function(){return this._connection._client.muc},
toObject:function(){return{xmpp_name:this._xmppName,id:this._xmppName,name:this._name,type:this._type,game_id:this._gameId}},_dispatchEvent:function(a,b){this._connection.trigger(a,b)},_userStatus:function(){return[this._activeUser.userVarsSig(),this._activeUser.userVars(),{special_chat_vars:JSON.stringify(this._activeUser.specialChatVars())}]},_parsePresence:function(a){return XmppRoom._parsePresence(a)},_parseMessage:function(a){var b={history:!1,timestamp:null};b.nick=Strophe.getResourceFromJid(a.getAttribute("from"));
$j.map(a.childNodes,function(a){switch(a.nodeName){case "body":b.body=a.textContent||a.text;break;case "html":if(!a.childNodes.length)break;a=a.childNodes[0];b.payload=JSON.parse(a.textContent||a.text);break;case "subject":b.subject=a.textContent||a.text;break;case "x":"jabber:x:delay"===a.getAttribute("xmlns")&&(b.history=!0,a=a.getAttribute("stamp"),b.timestamp=moment.utc(a,JabberChatRoom.TIME_FORMAT).valueOf())}});return b},_onRoomMessage:function(a,b){b=this._parseMessage(a);var c=b.nick,d=this._occupants[c];
Kongregate.Log.debug("RoomMessage",b,a);if(!b.history&&this._checkRateLimitViolation(b.nick))return!0;b.subject?(a=JSON.parse(b.subject).g,void 0!==a&&this._dispatchEvent(KonduitEvent.GUEST_COUNT,{room:this.toObject(),guests:a})):d&&this._dispatchEvent(KonduitEvent.ROOM_MESSAGE,{user:{username:c,variables:d},room:this.toObject(),message:b.payload||this._filterMessage(b.body),history:b.history,timestamp:b.timestamp||null});return!0},_checkRateLimitViolation:function(a){"undefined"===typeof this._rateLimiters[a]&&
(this._rateLimiters[a]=new JabberRateLimiter);return this._rateLimiters[a].ruleViolated()},_filterMessage:function(a){return this._messageFilter.filterMessage(a)},_deleteMucRoom:function(){var a=this.muc();if(a&&a.rooms&&a.roomNames){delete a.rooms[this.jid()];var b=a.roomNames.indexOf(this.jid());0<=b&&a.roomNames.splice(b,1)}},_onRoomPresence:function(a,b){var c=this._parsePresence(a);if("error"===c.type)return this._onRoomError(c),!0;b=c.nick||"";var d=this._createUserPayload(c),e={user:d,room:this.toObject()};
Kongregate.Log.debug("RoomPresence",c,d);"unavailable"===c.type?(delete this._occupants[b],this._dispatchEvent(KonduitEvent.USER_DEPARTURE,e),b.toLowerCase()===this.userNickname().toLowerCase()&&this._onUserKicked(c)):d.variables.valid?(a=!!this._occupants[b],this._occupants[b]=d.variables,this._dispatchEvent(a?KonduitEvent.USER_CHANGED:KonduitEvent.USER_JOIN,e)):0!==b.toLowerCase().indexOf("guest")&&Kongregate.Log.error("Invalid user ignored: "+b,a,c);return!0},_onRoomRoster:function(a,b){this.reset();
this._joined=!0;this._dispatchEvent(KonduitEvent.JOIN_ROOM,{room:this.toObject()})},_onRoomLeave:function(a){this._joined&&(a=a||{kicked:!1,owner_destroyed:!1,owner_left:!1},a=$j.extend({room:this.toObject()},a),this.reset(),this._dispatchEvent(KonduitEvent.LEAVE_ROOM,a),this._deleteMucRoom())},_onUserKicked:function(a){var b=!1,c=this;$j.each(a.states,function(a,e){if("321"===e)b=!0;else if("307"===e)return Kongregate.Log.info("Kicked from room due to premium-only"),c._onRoomLeave(),c._onRoomError({errorcode:"404"})});
"private"===this._type&&(this.isMyPrivateRoom()?this._onRoomLeave():(a={kicked:b,owner_left:!b,owner_destroyed:!1},Kongregate.Log.info("Kicked from room",a),this._onRoomLeave(a)))},_onRoomError:function(a){Kongregate.Log.error("Room error",a);switch(a.errorcode){case "407":case "405":this._onRoomNotFound();break;case "503":this._onRoomFull();break;case "404":this._onRoomLocked();break;default:Kongregate.Log.warn("Unknown room error, treating as not found"),this._onRoomNotFound()}},_onRoomNotFound:function(){this._dispatchEvent(KonduitEvent.ROOM_NOT_FOUND,
{room:this.toObject()})},_onRoomFull:function(){this._dispatchEvent(KonduitEvent.ROOM_FULL,{room:this.toObject()})},_onRoomLocked:function(){Kongregate.Log.warn("Room is locked",this.toObject());if("game"===this._type)Kongregate.Log.warn("Requested game room is locked, requesting another"),this._connection.joinRoom({type:"game"});else if("chat"===this._type)if(Kongregate.Log.warn("Requested chat room is locked, requesting another"),0>this._retryAttempts++)this._dispatchEvent(KonduitEvent.REQUEST_CHAT_ROOM,
{room:this.toObject()});else{Kongregate.Log.warn("Too many retries");var a=this.toObject();a.lockedRetries=!0;this._dispatchEvent(KonduitEvent.ROOM_NOT_FOUND,{room:a})}else Kongregate.Log.error("Unknown locked room type: "+this._type)},_createUserPayload:function(a){var b=a.nick;var c=a.status||!this._occupants[b]?this._parseUserVariables(b,a.status):this._occupants[b];c={username:b,variables:c};c.variables.username=a.nick;c.variables.role=a.role;c.variables.presence=a.show;return c},_parseUserVariables:function(a,
b){try{b=(JSON.parse(b)||[]).slice()}catch(e){Kongregate.Log.error("Error while parsing user variables for "+a+" - "+e.message,b),b=[]}var c=b[1]||[];if("string"===typeof c)try{c=JSON.parse(c)}catch(e){Kongregate.Log.error("Error while parsing variables array for"+a+" - "+e.message,c),c=[]}var d={special_chat_vars:(b[2]||{}).special_chat_vars};$j.map(JabberChatRoom.USER_VAR_KEYS,function(a,b){d[a]=c[b]});b=d.type||"";d.developer=0<=b.indexOf("d");d.admin=0<=b.indexOf("a");d.moderator=0<=b.indexOf("m");
d.curator=0<=b.indexOf("c");d.premium=0<=b.indexOf("p");d.chat_avatar_url=this._parseAvatarUrl(d.chat_avatar_url);d.valid=this._validateUserVariables(a,c,d);return d},_validateUserVariables:function(a,b,c){if(a!==c.username)return Kongregate.Log.error("Username mismatch for "+a+" != "+c.username),!1;if(b.length!==JabberChatRoom.USER_VAR_KEYS.length)return Kongregate.Log.error("Invalid user variables array length: "+b.length),!1;if("number"!==typeof c.level||1>c.level||75<c.level)return Kongregate.Log.error("Invalid level: "+
c.level),!1;a=/<.+?>/;if(a.test(c.chat_avatar_url)||a.test(c.game_url)||a.test(c.game_title))return Kongregate.Log.error("Invalid tag found in user data"),!1;a=/['" ]+/;return a.test(c.chat_avatar_url)||a.test(c.game_url)?(Kongregate.Log.error("Invalid avatar or game url"),!1):!0},_parseAvatarUrl:function(a){return a&&0!==a.indexOf("http")&&0<a.indexOf(":")?(a=a.split(":"),"https://"+a.shift()+"."+this._activeUser.bareCDNhost()+a.join(":")):a}};$j.extend(JabberChatRoom.prototype,Evented);
function JabberConnection(a){this.initialize(a)}
(function(){JabberConnection.CONNECTION_MONITOR_INTERVAL=1E4;JabberConnection.WEBSOCKET_PING_INTERVAL=3E4;JabberConnection.PING_INTERVAL=6E4;JabberConnection.IDLE_INCOMING_TIMEOUT=2.1*JabberConnection.PING_INTERVAL;JabberConnection.RECONNECT_INTERVAL=1E4;JabberConnection.MAX_RECONNECT_INTERVAL=3E4;JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS=1;JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=10;JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=4;JabberConnection.WEBSOCKET_CONNECTION_DURATION=
3E4;JabberConnection.SET_PRESENCE_INTERVAL=3E3;JabberConnection.KONGREGATE_IQ_NAMESPACE="kongregate:iq:msg";JabberConnection.KONGREGATE_MESSAGE_EVENT="kongregate_message";JabberConnection.PRIVATE_ROOM_PREFIX="kpr-";JabberConnection.OP_REQUEST_GAME_ROOM="room.rq";JabberConnection.OP_PRIVATE_MESSAGE="chat.pm";JabberConnection.OP_STATS_SUBMIT="stat.submit";JabberConnection.OP_SET_PRESENCE="set_presence";JabberConnection.OP_CREATE_PRIVATE_ROOM="room.create";JabberConnection.OP_DESTROY_PRIVATE_ROOM="room.destroy";
JabberConnection.OP_PRIVATE_ROOM_INVITE="room.invite.private";JabberConnection.OP_PRIVATE_ROOM_KICK="room.kick.private";JabberConnection.OP_SILENCED="silenced";JabberConnection.OP_PARTICIPATE="participate";var a=Kongregate.Utils.catchErrors;Strophe.log=function(a,c){try{Kongregate.Log.debug("Strophe["+a+"]: "+c)}catch(d){}};JabberConnection.prototype={initialize:function(a){var b=this;this._setupWsPolyfill(a);this._messageFilter=a.messageFilter||new MessageFilter;this._wsEndpoint=a.wsEndpoint?a.wsEndpoint.replace(/\/?$/,
"/"):null;this._boshEndpoint=a.boshEndpoint?a.boshEndpoint.replace(/\/?$/,"/"):null;this._host=a.host;this._activeUser=a.activeUser;this._rooms={};this._traceXmpp=a.traceXmpp;this._presence={};this._webSocketsSuccessful=this._webSocketsReliable=!1;this._forceBosh=this._boshEndpoint&&!this.webSocketsEnabled();this._connectionAttempts=0;this._numConnections={websocket:0,bosh:0};this._stanzasSent=this._stanzasReceived=this._numTimeouts=0;this._sessionId=uuid.v4();this._patchStrophe();this._createClient();
this._messageFilter.on(KonduitEvent.MESSAGE_ERROR,function(a){b._onFilterError(a)});this._rateLimiter=new JabberRateLimiter},shutdown:function(){this._stopConnectionMonitor();clearTimeout(this._reconnectTimeout)},connect:function(){if(!this.connected()){this._shouldSwitchConnectionType()?this._switchConnectionType():this._invalidSession?(Kongregate.Log.debug("Creating new client due to invalid session"),this._createClient()):this._resetClient();var b=this.myNode()+"@"+this._host+"/xiff",c=JSON.stringify({k:this._activeUser.chatPassword()});
this._client.connect(b,c,a(this._onConnectionStatus,this,!0));this._connectionAttempts+=1;Kongregate.Log.info("Chat connection attempt #"+this._connectionAttempts+" type="+this.connectionType())}},disconnect:function(){this.connected()&&this._client.disconnect()},switchUser:function(){Kongregate.Log.debug("Switching user to: "+this._activeUser.chatUsername());this.disconnect();this.connect()},sendGroupMessage:function(a,c){this._validate()&&(c=this._filterMessage(c),(a=this.room(a))&&a.sendGroupMessage(c))},
sendPrivateMessage:function(a,c){this._validate()&&(c=this._filterMessage(c),Kongregate.Log.debug("Sending private message to "+a+", msg: "+c),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_MESSAGE,{from:this._activeUser.chatUsername(),to:a,data:c}))},inviteUserToPrivateRoom:function(a){this._validate()&&(Kongregate.Log.info("Inviting user "+a+" to my private room"),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_INVITE,{from:this._activeUser.chatUsername(),to:a}))},destroyPrivateRoom:function(){this.sendKongregateMessage(JabberConnection.OP_DESTROY_PRIVATE_ROOM,
{})},kickUserFromPrivateRoom:function(a){Kongregate.Log.info("Kicking user "+a+" from my private room");this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_KICK,{user:a})},flushStatistics:function(a){this.connected()&&(a.game_id=this._activeUser.gameId(),this.sendKongregateMessage(JabberConnection.OP_STATS_SUBMIT,a))},room:function(a){return this._rooms[a]},joinRoom:function(a){if("game"!==a.type||this._validateGameRoom(a)){if("private"===a.type){if(!this._validatePrivateRoom(a))return;var b=
this._rooms.private,d=JabberConnection.PRIVATE_ROOM_PREFIX+this.myNode();b&&b.xmpp_name===d&&this.destroyPrivateRoom()}this.leaveRoom(a.type);b=this._createRoom(a);this._rooms[a.type]=b;b.join()}},leaveRoom:function(a){var b=this.room(a);b&&(b.leave(),delete this._rooms[a])},connected:function(){return this._client.connected},host:function(){return this._host},supportsWebSockets:function(){return"undefined"!==typeof window.WebSocket},webSocketsEnabled:function(){return!this._boshEndpoint||this.supportsWebSockets()&&
this._activeUser.webSocketsEnabled()},webSocketEndpoint:function(){return this._wsEndpoint},boshEndpoint:function(){return this._boshEndpoint},connectionEndpoint:function(){return(this._forceBosh?this.boshEndpoint():this.webSocketsEnabled()?this.webSocketEndpoint():this.boshEndpoint())+"?"+this._connectionQueryString()},connectionType:function(){return 0===this.connectionEndpoint().indexOf("ws")?"websocket":"bosh"},jid:function(){return this._client.jid},myNode:function(){return this._activeUser.chatUsername().toLowerCase()},
serverName:function(){return this.jid().split("@")[1].split("/")[0]},sendKongregateMessage:function(a,c){a=this._buildKongregateIQ(a,c).tree();this._client.send(a)},_patchStrophe:function(){if("undefined"!==typeof Strophe){Kongregate.Log.debug("Patching BOSH error handler");var a=Strophe.Bosh.prototype._hitError;Strophe.Bosh.prototype._hitError=function(b){a.bind(this)(b);3<=this.errors&&this._conn._onDisconnectTimeout()}}},_connectionQueryString:function(){var a={sid:this._sessionId,svid:this._activeUser.siteVisitorUID(),
wsr:this._webSocketsReliable,wss:this._webSocketsSuccessful,ca:this._connectionAttempts,wc:this._numConnections.websocket,bc:this._numConnections.bosh,tc:this._numTimeouts,sr:this._stanzasReceived,ss:this._stanzasSent,pb:!0};return Object.toQueryString(a)},_setupWsPolyfill:function(a){if(WebSocket&&"function"===typeof WebSocket.loadFlashPolicyFile){-1!==a.wsEndpoint.indexOf("chat-proxy")&&(a.wsEndpoint=a.wsEndpoint.replace("chat-proxy","chat-proxy-flash"),Kongregate.Log.debug("Using WebSocket endpoint: "+
a.wsEndpoint));var b=a.wsEndpoint.match(/:\/\/([^:]+):?(\d*)$/),d=b[1];(b=b[2])&&"80"!==b&&"443"!==b&&(b=parseInt(b,10)+1,Kongregate.Log.debug("Loading Flash policy file from non-standard port: "+b),WebSocket.loadFlashPolicyFile("xmlsocket://"+d+":"+b));a.boshEndpoint=null}},_requestJoinGameRoom:function(){this.sendKongregateMessage(JabberConnection.OP_REQUEST_GAME_ROOM,{game_id:this._activeUser.gameId(),permalink:this._activeUser.gamePermalink(),game_name:this._activeUser.gameName()})},_validateGameRoom:function(a){if(!a.xmpp_name||
0===a.xmpp_name.length)return Kongregate.Log.info("Game room join request received with no roomID, requesting one from server"),this._requestJoinGameRoom(),!1;if(0!==a.xmpp_name.indexOf(this._activeUser.gameId()+"-"+this._activeUser.gamePermalink()+"-")){if("en"===a.language)return Kongregate.Log.warn("Invalid English game room: "+a.xmpp_name),!1;if(isNaN(parseInt(a.xmpp_name,10)))return Kongregate.Log.warn("Invalid non-English game room: "+a.xmpp_name),!1}return!0},_validatePrivateRoom:function(a){a=
a.xmpp_name;return 0!==a.indexOf(JabberConnection.PRIVATE_ROOM_PREFIX)?(Kongregate.Log.warn("Invalid private room name: "+a),!1):!0},_buildKongregateIQ:function(a,c){c=Base64.encode(JSON.stringify(c||{}));return $iq({type:"get",id:this._client.getUniqueId()}).c("query",{xmlns:JabberConnection.KONGREGATE_IQ_NAMESPACE}).c("msg",{opcode:a}).t(c).up().up()},_parseKongregateIQ:function(a){var b=Strophe.getNodeFromJid(a.getAttribute("from")),d=a.childNodes[0].childNodes[0];a=d.getAttribute("opcode");d=
JSON.parse(Base64.decode(d.textContent||d.text));Kongregate.Log.debug("Kongregate Packet["+b+"] "+a+": "+JSON.stringify(d));if("admin"===b||0===b.indexOf("kong_"))return{opcode:a,params:d};throw Error("Ignoring Kongregate IQ packet from incorrect sender");},_createClient:function(){this._resetClient();this.connectionEndpoint();this._client=new Strophe.Connection(this.connectionEndpoint(),{contentType:"text/plain; charset=utf-8",withCredentials:!0});this._resetClient()},_shouldSwitchConnectionType:function(){if(!this.webSocketsEnabled())return!1;
var a="bosh"===this.connectionType();return 0===this._connectionAttempts?a:a?this._connectionAttempts>JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS:this._connectionAttempts>=(this._webSocketsReliable?JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS:JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS)},_switchConnectionType:function(){this._wasOffline?(Kongregate.Log.info("Was offline, will attempt to reconnect with websocket"),this._forceBosh=!1):(Kongregate.Log.info("Switching connection type due to failures, attempts="+
this._connectionAttempts),this._forceBosh=!this._forceBosh);this._wasOffline=!1;this._createClient();this._connectionAttempts=0;this._webSocketsReliable=!1},_resetClient:function(){this._client&&(this._client.reset(),this._resetRooms(),this._client.rawOutput=a(this._onOutgoingData,this,!0),this._client.rawInput=a(this._onIncomingData,this,!0),this._client.addHandler(a(this._onKongregateIQ,this,!0),JabberConnection.KONGREGATE_IQ_NAMESPACE,"iq"),this._client.addHandler(a(this._onErrorStanza,this,!0),
"jabber:client",null,"error"),this._client.service=this.connectionEndpoint(),this._invalidSession=this._loginFailed=this._banned=this._sessionConflict=!1)},_startConnectionMonitor:function(){this._stopConnectionMonitor();this._connectionMonitorInterval=setInterval(this._connectionMonitor.bind(this),JabberConnection.CONNECTION_MONITOR_INTERVAL)},_stopConnectionMonitor:function(){this._connectionMonitorInterval&&(clearInterval(this._connectionMonitorInterval),this._connectionMonitorInterval=void 0)},
_sendEmptyWebsocketPacket:function(){try{"websocket"===this.connectionType()&&this._client._proto.socket&&(this._client._proto.socket.send(""),this._lastWebsocketPing=(new Date).getTime())}catch(b){Kongregate.Log.error("Error while sending empty websocket packet",b)}},_connectionMonitor:function(){if(this.connected()){var a=(new Date).getTime(),c=a-this._lastOutgoingPacket,d=a-this._lastIncomingPacket,e=a-this._connectionTime;a-=this._lastWebsocketPing;0>c||c>=JabberConnection.PING_INTERVAL?this._client.ping.ping():
a>=JabberConnection.WEBSOCKET_PING_INTERVAL&&this._sendEmptyWebsocketPacket();d>=JabberConnection.IDLE_INCOMING_TIMEOUT?(this._numTimeouts+=1,this.disconnect("timeout")):!this._webSocketsReliable&&"websocket"===this.connectionType()&&e>=JabberConnection.IDLE_INCOMING_TIMEOUT&&(Kongregate.Log.debug("Marking WebSocket connections as reliable"),this._webSocketsReliable=!0)}},_scheduleReconnect:function(){this._reconnectTimeout=setTimeout(this.connect.bind(this),this._reconnectTime)},_createRoom:function(a){return new JabberChatRoom({connection:this,
activeUser:this._activeUser,xmppName:a.xmpp_name,gameId:a.game_id,name:a.name,type:a.type})},_resetRooms:function(){var a=this._client.muc;a.rooms={};a.roomNames=[];a._muc_handler=null;$j.each(this._rooms,function(a,b){b.leave(!0)})},_joinRooms:function(){$j.each(this._rooms,function(a,c){c.join()})},setPresence:function(a,c){if(this._presence[c]!=a){if(null===c){var b=(new Date).getTime();if(this._lastSetPresence&&b-this._lastSetPresence<JabberConnection.SET_PRESENCE_INTERVAL)return;this._lastSetPresence=
b;$j.each(this._rooms,function(b,c){this._presence[c]=a}.bind(this))}this._presence[c]=a;Kongregate.Log.info("Changing user presence to "+a);this.sendKongregateMessage(JabberConnection.OP_SET_PRESENCE,{from:this._activeUser.chatUsername(),presence:a,room_name:c})}},_isBlankBoshStanza:function(a){return/^<body/.test(a)&&!/<\/body>$/.test(a)},_onIncomingData:function(a){Kongregate.Log.spam(" IN: "+a);this._isBlankBoshStanza(a)||(this._stanzasReceived+=1,this._lastIncomingPacket=(new Date).getTime())},
_onOutgoingData:function(a){Kongregate.Log.spam("OUT: "+a);this._isBlankBoshStanza(a)||(a=(new Date).getTime(),this._stanzasSent+=1,this._lastWebsocketPing=this._lastOutgoingPacket=a)},_onKongregateIQ:function(a){try{var b=this._parseKongregateIQ(a);this._onServerMessage(b);this.trigger(JabberConnection.KONGREGATE_MESSAGE_EVENT,b)}catch(d){Kongregate.Log.error("Error handling kongregate packet",d)}return!0},_onErrorStanza:function(a){Kongregate.Log.error("XMPP error received",a);(a=a.textContent||
a.text)&&"sticker"===a.split(":")[0]&&this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.STICKER});return!0},_onServerMessage:function(a){var b=a.params;switch(a.opcode){case JabberConnection.OP_REQUEST_GAME_ROOM:this._onGameRoomResult(b);break;case JabberConnection.OP_PRIVATE_MESSAGE:this._onPrivateMessage(b);break;case JabberConnection.OP_STATS_SUBMIT:this._onStatSubmissionResult(b);break;case JabberConnection.OP_CREATE_PRIVATE_ROOM:this._onPrivateRoomCreated(b);break;case JabberConnection.OP_PRIVATE_ROOM_INVITE:this._onPrivateRoomInvite(b);
break;case JabberConnection.OP_SILENCED:this._onSilenced(b);break;case JabberConnection.OP_PARTICIPATE:this._onParticipate(b)}},_onPrivateRoomCreated:function(a){if(a.success){var b=a["room.name"];a=a["room.natural"];Kongregate.Log.info("Private room created: "+b+", name="+a);this.joinRoom({type:"private",id:b,xmpp_name:b,name:a})}else Kongregate.Log.info("Private room creation failed")},_onPrivateRoomInvite:function(a){var b=a["room.name"],d=a["room.natural"],e=a.from;e.toLowerCase()===this.myNode()?
(b=a.success,d=a.error,Kongregate.Log.info("Private room invitation sent, sucess="+b+", error="+d),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,{username:a.to,success:b,error:d})):(Kongregate.Log.info("Private room invitation (from "+e+"): "+b+", name="+d),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION,{username:e,xmpp_name:b,name:d,type:"private"}))},_onGameRoomResult:function(a){Kongregate.Log.debug("Game room result",a);this.joinRoom({type:"game",id:a["room.name"],xmpp_name:a["room.name"],
name:a["room.natural"],game_id:this._activeUser.gameId()})},_onSilenced:function(a){this.trigger(KonduitEvent.SILENCED,a)},_onParticipate:function(a){this.trigger(KonduitEvent.PARTICIPATE,a)},_onConnectionStatus:function(a,c){Kongregate.Log.debug("Connection status changed, status="+a+", err="+c);switch(a){case Strophe.Status.ERROR:this._onError(c);break;case Strophe.Status.CONNECTING:this.trigger(KonduitEvent.CONNECT);break;case Strophe.Status.CONNECTED:this._onConnected();break;case Strophe.Status.DISCONNECTED:this._onDisconnected(c);
break;case Strophe.Status.AUTHFAIL:this._onAuthFailure();break;default:Kongregate.Log.debug("Unknown status: "+a)}},_onConnected:function(){clearTimeout(this._reconnectTimeout);var a=this.connectionType();"websocket"===a&&(Kongregate.Log.info("Marking websocket connection successful"),this._webSocketsSuccessful=!0);var c=(new Date).getTime();this._numConnections[a]+=1;this._reconnectTime=void 0;this._connectionTime=this._lastWebsocketPing=this._lastIncomingPacket=this._lastOutgoingPacket=c;this._shutdown=
!1;this._connectionAttempts=0;this._startConnectionMonitor();this._setRosterPresence("chat");this.trigger(KonduitEvent.LOGIN);this._joinRooms()},_onDisconnected:function(){this._stopConnectionMonitor();this._resetRooms();navigator.onLine||(this._wasOffline=!0,Kongregate.Log.info("Network unavailable, setting offline flag"));this.trigger(KonduitEvent.DISCONNECT,{conflict:this._sessionConflict,login_failed:this._loginFailed,banned:this._banned});if(!(this._sessionConflict||this._banned||this._loginFailed)){var a=
Math.random()*JabberConnection.RECONNECT_INTERVAL/2+JabberConnection.RECONNECT_INTERVAL/2,c=JabberConnection.MAX_RECONNECT_INTERVAL;this._reconnectTime=this._reconnectTime?Math.min(c,1.5*this._reconnectTime):a;Kongregate.Log.warn("Disconnected, reconnecting in: "+this._reconnectTime);this._scheduleReconnect()}},_onError:function(a){Kongregate.Log.warn("Connection error",a);"conflict"===a?(Kongregate.Log.debug("Session conflict detected"),this._sessionConflict=!0):"policy-violation"===a?(Kongregate.Log.debug("Ban detected"),
this._banned=!0):"system-shutdown"===a||"remote-stream-error"===a?(Kongregate.Log.debug("System shutdown detected"),this._shutdown=!0):"item-not-found"===error&&(this._invalidSession=!0,Kongregate.Log.debug("Invalid session detected"))},_onAuthFailure:function(){Kongregate.Log.debug("Login failure detected");this._loginFailed=!0;this._onDisconnected()},_onPrivateMessage:function(a){var b=a.from,d=a.to,e=a.success;a=a.data;!0===e&&0===b.toLowerCase().indexOf("guest")||this.trigger(KonduitEvent.PRIVATE_MESSAGE,
{success:e,from:b,to:d,message:a})},_onStatSubmissionResult:function(a){a.result=!0;this.trigger(KonduitEvent.STATISTICS_FLUSH,a)},_setRosterPresence:function(a){this._client.send($pres().c("show").t(a))},_validate:function(){return!this._activeUser.isAuthenticated()||this._checkRateLimitViolation()?!1:!0},_filterMessage:function(a){return a=this._messageFilter.filterMessage(a)},_checkRateLimitViolation:function(){var a=this._rateLimiter.ruleViolated();return a?(this.trigger(KonduitEvent.MESSAGE_ERROR,
{errorType:KonduitChatErrorMessage.RATE_LIMITED,ruleViolated:a}),!0):!1},_onFilterError:function(a){this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:a.errorType})}};$j.extend(JabberConnection.prototype,Evented)})();function JabberRateLimiter(){this._timestamps=[];this._rules=[{duration:1E3,capacity:2},{duration:6E4,capacity:8}]}
JabberRateLimiter.prototype={ruleViolated:function(){var a=(new Date).getTime(),b=!1,c=this;this._timestamps=this._timestamps.filter(function(b){return b>=a-6E4});$j.each(this._rules,function(d,e){c._timestamps.filter(function(b){return b>=a-e.duration}).length>=e.capacity&&(b=!0)});b||this._timestamps.push(a);return b}};Konduit=function(a){this.initialize(a)};
Konduit.prototype={initialize:function(){this.queuedEvents=[];this.setupComplete=!1},setup:function(a){this.setupComplete||(this.flashAdapter=new KonduitFlashAdapter(a),this.fayeAdapter=new KonduitFayeAdapter(a),this.jabberAdapter=new KonduitJabberAdapter($j.extend(a,{connect:!0,traceXmpp:5<=active_user.debugLevel(),activeUser:active_user,host:a.chatHost,wsEndpoint:a.chatProxyWebsocket,boshEndpoint:a.chatProxyBosh,flashEventDispatcher:this.flashAdapter})),this.jsAdapter=new KonduitJavascriptAdapter($j.extend(a,
{activeUser:active_user})),this.setupComplete=!0,this.flushEventQueue())},dispatchEvent:function(a){this.setupComplete?this.fayeAdapter.dispatchEvent(a)||this.jabberAdapter&&this.jabberAdapter.dispatchEvent(a)||this.jsAdapter&&this.jsAdapter.dispatchEvent(a)||this.flashAdapter.dispatchEvent(a):(Kongregate.Log.debug("Queueing konduit event",a),this.queuedEvents.push(a))},flushEventQueue:function(){var a=this;this.queuedEvents.forEach(function(b){a.dispatchEvent(b)});this.queuedEvents=[]},alertLog:function(){return this.flashAdapter&&
this.flashAdapter.alertLog()},jabberConnected:function(){return this.jabberAdapter&&this.jabberAdapter.connected()}};KonduitFayeAdapter=function(a){this.initialize(a)};
KonduitFayeAdapter.prototype={initialize:function(a){this._fayeEventDispatcher=new FayeEventDispatcher({holodeckEventDispatcher:a.eventDispatcher});this._authenticator=a.authenticator||new GuildChatAuthenticator;this._fayeService=new FayeService({authenticator:this._authenticator,fayeConnection:a.fayeConnection});this._fayeRoomListService=a.fayeRoomListService||new FayeRoomListService({authenticator:this._authenticator});this._fayeHistoryService=a.fayeHistoryService||new FayeHistoryService({authenticator:this._authenticator});
this._registerEvents()},_registerEvents:function(){this._fayeService.on("joinRoom",this._fayeEventDispatcher,"joinRoom");this._fayeService.on("joinRoom",this._fayeRoomListService,"subscribe");this._fayeService.on("roomNotFound",this._fayeEventDispatcher,"roomNotFound");this._fayeService.on("messageRateLimited",this._fayeEventDispatcher,"messageRateLimited");this._fayeService.on("messageTooLong",this._fayeEventDispatcher,"messageTooLong");this._fayeService.on("message",this._fayeEventDispatcher,"message");
this._fayeService.on("message",this._fayeRoomListService,"message");this._fayeService.on("disconnect",this._fayeEventDispatcher,"disconnect");this._fayeService.on("connect",this._fayeEventDispatcher,"connect");this._fayeService.on("connect",this._fayeRoomListService,"connect");this._fayeService.on("leaveRoom",this._fayeEventDispatcher,"leaveRoom");this._fayeService.on("leaveRoom",this._fayeRoomListService,"unsubscribe");this._fayeRoomListService.on("userJoin",this._fayeEventDispatcher,"userJoin");
this._fayeRoomListService.on("userChanged",this._fayeEventDispatcher,"userChanged");this._fayeRoomListService.on("userDeparture",this._fayeEventDispatcher,"userDeparture");this._fayeHistoryService.on("message",this._fayeEventDispatcher,"message");this._fayeHistoryService.on("history",this._fayeEventDispatcher,"history");this._authenticator.on("kick",this._fayeService,"leaveCurrentGuildRoom",!0)},dispatchEvent:function(a){switch(a.type){case KonduitEvent.SET_PRESENCE:return this._handleSetPresence(a.data);
case KonduitEvent.JOIN_GUILD_ROOM:return this._handleJoinGuildRoom(a.data);case KonduitEvent.ROOM_MESSAGE:return this._handleRoomMessage(a.data);case KonduitEvent.LEAVE_ROOM:return this._handleLeaveRoom(a.data);case KonduitEvent.FETCH_HISTORY:return this._fetchHistory(a.data)}return!1},_handleSetPresence:function(a){return this._fayeService.isCurrentRoomName(a.room_name)?(this._fayeService.setPresence(a.room_name,"chat"===a.presence),!0):!1},_handleLeaveRoom:function(a){return"guild"===a.room_type?
(this._fayeService.leaveCurrentGuildRoom(!1),!0):!1},_handleRoomMessage:function(a){return this._fayeService.isCurrentRoomId(a.room.id)?(this._fayeService.sendMessage(a.message,a.room),!0):!1},_handleJoinGuildRoom:function(a){this._fayeService.subscribe(a);return!0},_fetchHistory:function(a){this._fayeHistoryService.fetchHistory(a.room,a.maxTime)}};KonduitFlashAdapter=function(){this.initialize()};
KonduitFlashAdapter.prototype={initialize:function(){this.swf=$j("#konduit")[0]},dispatchEvent:function(a){this.enabled()&&this.swf.dispatchJSONEvent(Object.toJSON(a))},alertLog:function(){return this.enabled()?this.swf.alertLog():[]},enabled:function(){return this.swf&&"function"===typeof this.swf.dispatchJSONEvent}};KonduitJabberAdapter=function(a){this.initialize(a)};
KonduitJabberAdapter.PASS_THROUGH_EVENTS=[KonduitEvent.JOIN_ROOM,KonduitEvent.USER_JOIN,KonduitEvent.USER_CHANGED,KonduitEvent.USER_DEPARTURE,KonduitEvent.ROOM_MESSAGE,KonduitEvent.GUEST_COUNT,KonduitEvent.LEAVE_ROOM,KonduitEvent.DISCONNECT,KonduitEvent.PRIVATE_MESSAGE,KonduitEvent.MESSAGE_ERROR,KonduitEvent.STATISTICS_FLUSH,KonduitEvent.PRIVATE_ROOM_INVITATION,KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,KonduitEvent.REQUEST_CHAT_ROOM,KonduitEvent.ROOM_FULL,KonduitEvent.ROOM_NOT_FOUND,KonduitEvent.SILENCED,
KonduitEvent.PARTICIPATE];
KonduitJabberAdapter.prototype={initialize:function(a){this._activeUser=a.activeUser;this._connection=new JabberConnection(a);this._eventDispatcher=a.eventDispatcher;this._flashEventDispatcher=a.flashEventDispatcher;this._registerEvents();a.connect&&this._connection.connect()},connected:function(a){return this._connection.connected()},dispatchEvent:function(a){switch(a.type){case KonduitEvent.CONNECT:return this._connection.connect(),!0;case KonduitEvent.JOIN_ROOM:return this._connection.joinRoom(a.data.room),!0;
case KonduitEvent.LEAVE_ROOM:return this._connection.leaveRoom(a.data.room_type),!0;case KonduitEvent.ROOM_MESSAGE:return this._connection.sendGroupMessage(a.data.room.type,a.data.message),!0;case KonduitEvent.SWITCH_USER:return this._connection.switchUser(),!1;case KonduitEvent.PRIVATE_MESSAGE:return this._connection.sendPrivateMessage(a.data.username,a.data.message),!0;case KonduitEvent.STATISTICS_FLUSH:if(a.data.result)return!1;this._connection.flushStatistics(a.data);return!0;case KonduitEvent.SET_PRESENCE:return this._connection.setPresence(a.data.presence,
a.data.room_name),!0;case KonduitEvent.PRIVATE_ROOM_INVITATION:return this._connection.inviteUserToPrivateRoom(a.data.username),!0;case KonduitEvent.PRIVATE_ROOM_KICK:return this._connection.kickUserFromPrivateRoom(a.data.username),!0;case KonduitEvent.DESTROY_PRIVATE_ROOM:return this._connection.destroyPrivateRoom(),!0;default:return!1}},_registerEvents:function(){this._connection.on(KonduitEvent.CONNECT,this._onConnect.bind(this));this._connection.on(KonduitEvent.LOGIN,this._onAuthenticated.bind(this));
this._connection.on(KonduitEvent.ROOM_MESSAGE,this._onRoomMessage.bind(this));var a=this;$j.map(KonduitJabberAdapter.PASS_THROUGH_EVENTS,function(b){a._connection.on(b,function(c){a._eventDispatcher.fire({type:b,data:c})})})},_onConnect:function(){this._eventDispatcher.fire({type:KonduitEvent.CONNECT,data:{success:!0}})},_onAuthenticated:function(){this._eventDispatcher.fire({type:KonduitEvent.LOGIN,data:{success:!0,username:this._activeUser.username(),bosh:"bosh"===this._connection.connectionType()}})},
_onRoomMessage:function(a){this._flashEventDispatcher.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:a})}};
(function(){var a="fuck;cocksuck;nigger;faggot;nigga;kike;fags;pornhub;youporn;brazzers;redtube;xhamster;xvideos;xnxx;youjizz;tube8;spankbang;chaturbate;blue waffle;lemon party;meatspin".split(";"),b=["fag"],c=/(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(c|c( )*;|C( )*;)(u|u( )*;|U( )*;)(n|n( )*;|N( )*;)(t|t( )*;|T( )*;)|(c|c( )*;|C( )*;)(o|o( )*;|O( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)(s|s( )*;|S( )*;)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(n|n( )*;|N( )*;)(i|i( )*;|I( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(e|e( )*;|E( )*;)(r|r( )*;|R( )*;)|(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(o|o( )*;|O( )*;)(t|t( )*;|T( )*;)|\b(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)\b/gi,d=
function(){for(var c=[],d=0;d<a.length;d++)c.push("("+a[d].replace(/\w(?=\w)/g,"$&[\\s;]*")+")");for(d=0;d<b.length;d++)c.push("\\b("+b[d].replace(/\w(?=\w)/g,"$&[\\s;]*")+")\\b");return new RegExp(c.join("|"),"gi")}();Kongregate.LanguageFilter={filter:function(a){if("string"!==typeof a)return a;for(var b="",e=0;e<a.length;e++){var l=a.charCodeAt(e);32>l&&9!=l&&10!=l&&13!=l||(b+=a.charAt(e))}return b.replace(c,"****").replace(d,"****")}}})();
LocalMuteService=function(){function a(){var a=$.jStorage.get("KWAK-MUTINGS");return a?JSON.parse(a):{}}return{mute:function(b){var c=a();c[b]=!0;$.jStorage.set("KWAK-MUTINGS",JSON.stringify(c))},unmute:function(b){var c=a();delete c[b];$.jStorage.set("KWAK-MUTINGS",JSON.stringify(c))},isMuted:function(b){return!!a()[b]},mutings:function(){return Object.keys(a())}}}();function MessageFilter(a){this.initialize(a)}
MessageFilter.prototype={initialize:function(a){this.maxLength=250},filterMessage:function(a){return a=this._truncateMessage(a)},_truncateMessage:function(a){a.length>this.maxLength&&(a=a.substring(0,this.maxLength-1)+"\u2026",this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG}));return a}};$j.extend(MessageFilter.prototype,Evented);MiniProfile=function(a){this.initialize(a)};
MiniProfile.prototype={initialize:function(a){this._chat_window=a.chat_window;this._holodeck=a.holodeck;var b=this;(this._container=$("user_mini_profile_container"))&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a,b){this._chat_window.setActiveTempPane(this);this._current_username=a;this._current_room=b;var c=this._container,d=this._chat_window,e=this;$("user_mini_profile").update("");c.down(".room_name").update(b.name());d.hideChatWindow();
d._chat_tab_clicked=!1;c.ieHappyShow();d.showSpinner();new Ajax.Updater({success:"user_mini_profile"},"/accounts/"+a+".chat",{method:"get",onComplete:function(){!1===d._chat_tab_clicked&&(d.hideSpinner(),e.setupBanAndSilencingControls(a),active_user.addCapturedSelector("#add_friend"),active_user.addCapturedSelector("#mute_user"))}})},deactivate:function(){this._chat_window.clearActiveTempPane();this._container.ieHappyHide();this._chat_window.hideSpinner();this._chat_window.showChatWindow()},updateManualBanReasonField:function(a){$("ban_ban_reason_id").value?
$("ban_reason_block").hide():$("ban_reason_block").show()},updateManualSilencingReasonField:function(a){$("silencing_silencing_reason_id").value?$("silencing_reason_block").hide():$("silencing_reason_block").show()},setupBanAndSilencingControls:function(a){this._chat_window.isModeratableUser(a)&&(["silencings","bans"].each(Element.show),$("ban_ban_reason_id")&&($("ban_ban_reason_id").observe("click",this.updateManualBanReasonField),$("ban_ban_reason_id").observe("change",this.updateManualBanReasonField),
$("ban_ban_reason_id").observe("keypress",this.updateManualBanReasonField),this.updateManualBanReasonField(null)),$("silencing_silencing_reason_id")&&($("silencing_silencing_reason_id").observe("click",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("change",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("keypress",this.updateManualSilencingReasonField),this.updateManualSilencingReasonField(null)))}};OnlineFriends=function(a){this.initialize(a)};
OnlineFriends.prototype={initialize:function(a){this._chat_window=a;var b=this;this._container=$("friends_online_container");this._friend_list_node=$("friends_online");this._container&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a){var b=this._chat_window;this._container.down(".room_name").update(a);b.hideChatWindow();this.getOnlineFriends()},getOnlineFriends:function(a){var b=this._container,c=this._chat_window,d=this._friend_list_node;
d.hide();c.showSpinner();a=a?"?page="+a:"";c._chat_tab_clicked=!1;new Ajax.Updater({success:"friends_online"},"/accounts/"+c.username()+"/online_friends.chat"+a,{method:"get",onSuccess:function(a){!1===c._chat_tab_clicked&&(c.hideChatWindow(),c.hideSpinner(),d.show(),b.show())}})},deactivate:function(){this._container.hide();this._chat_window.showChatWindow()}};
Array.prototype.binarySearch=function(a,b,c){b||(b=function(a,b){return a==b?0:a<b?-1:1});for(var d=0,e=this.length-1,g,h;d<=e;)if(g=Math.floor((d+e)/2),h=b(this[g],a),0>h)d=g+1;else if(0<h)e=g-1;else return g;return c?d:-1};Array.prototype.orderedInsert=function(a,b){b=this.binarySearch(a,b,!0);this.splice(b,0,a);return b};Array.prototype.orderedDelete=function(a,b){b=this.binarySearch(a,b);if(0<=b)return this.splice(b,1),b;for(b=0;b<this.length;b++)if(this[b]===a)return this.splice(b,1),b;return-1};
RoomInfo=function(a){this.initialize(a)};
RoomInfo.prototype={initialize:function(a){this._chat_window=a.chat_window;this._holodeck=a.holodeck;var b=this;(this._container=$("room_info_container"))&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a){this._chat_window._chat_tab_clicked=!1;this._chat_window.setActiveTempPane(this);this._current_room=a;var b=this._container,c=this._chat_window;b.down(".room_name").update(a.name());c.hideChatWindow();c.showSpinner();new Ajax.Updater({success:"room_info"},
"/rooms/"+a.getId()+".chat",{method:"get",onSuccess:function(a){!1===c._chat_tab_clicked&&(c.hideChatWindow(),c.hideSpinner(),b.ieHappyShow())}})},deactivate:function(){this._chat_window.clearActiveTempPane();this._container.ieHappyHide();this._chat_window.showChatWindow()}};SharedContentWelcomeTab=function(a){this.initialize(a)};
SharedContentWelcomeTab.prototype={initialize:function(a){this._active_user=a.active_user;this._holodeck=a.holodeck;this._active_user&&this._active_user.isAuthenticated()&&this._holodeck.hasSharedContent()&&!this._active_user.seenSharedContentWelcome()&&this.update()},update:function(){var a=this._holodeck,b=this._active_user.gameResourcePath()+"/featured_shared_contents.chat";this._active_user.setSeenSharedContentWelcome(!0);new Ajax.Updater({success:"shared_content_welcome_tab_pane_content"},b,
{method:"get",on200:a.showSharedContentWelcomeTab.bind(a)})}};StickerManager=function(a){this.initialize(a)};StickerManager.RECENT_STICKERS_PREFIX="kong_stickers:recent:";StickerManager.MAX_RECENT_STICKERS=15;
StickerManager.prototype={initialize:function(a){this.activeUser=a.active_user||window.active_user;this.recentStickersPrefix=a.recent_stickers_prefix||StickerManager.RECENT_STICKERS_PREFIX;this.dailyActivityTrackers={};this.queuedDailyActivities=[];this.update(a)},update:function(a){this.stickers={};this.stickerPacks={};this.userStickerPacks={};this.userOwnedStickers={};this.userStickerCollections=[];this.recentStickers=[];this.parseStickers(a.stickers);this.parseStickerPacks(a.sticker_packs);this.parseUserStickerPacks(a.user_sticker_packs);
this.buildStickerCollections();this.loadRecentStickers();this.flushDailyActivityQueue();this.trigger("update")},trackActiveSession:function(){var a=this;setTimeout(function(){a.performDailyActivity("active_session")},3E5)},performDailyActivity:function(a){if(a)if(this.activeUser.isAuthenticated()){var b=this.dailyActivityTrackers[a]||0;if(!(this.getTimestamp()<b)){var c=this;new Ajax.Request(this.activityUrl(),{method:"POST",parameters:{activity:a},onSuccess:function(b){c.dailyActivityTrackers[a]=
c.getTimestamp()+1E3*b.responseJSON.delay}})}}else-1===this.queuedDailyActivities.indexOf(a)&&this.queuedDailyActivities.push(a)},url:function(a,b,c){a="https://"+this.activeUser.singleCDNDomain()+"/assets/dynamic/stickers/"+a+"/"+("shiny"===b?"shiny":"normal")+".png";c&&(a+="?width="+c);return a},activityUrl:function(){return"/user_sticker_activities.json"},addSticker:function(a){var b=$j.extend({},a);this.stickers[a.id]=b},addStickerPack:function(a){var b=this,c=$j.extend({},a);delete c.sticker_ids;
delete c.hero_sticker_id;delete c.hero_sticker_normal_url;delete c.hero_sticker_shiny_url;c.stickers=[];c.heroSticker=this.stickers[a.hero_sticker_id];c.heroStickerNormalUrl=a.hero_sticker_normal_url;c.heroStickerShinyUrl=a.hero_sticker_shiny_url;a.sticker_ids.forEach(function(a){(a=b.stickers[a])&&c.stickers.push(a)});this.stickerPacks[a.id]=c},addUserStickerPack:function(a){this.userStickerPacks[a.sticker_pack_id]=this.userStickerPacks[a.sticker_pack_id]||{};var b=$j.extend({},a);delete b.sticker_pack_id;
b.stickerPack=this.stickerPacks[a.sticker_pack_id];b.variant=a.shiny?"shiny":"normal";b.heroStickerUrl=a.shiny?b.stickerPack.heroStickerShinyUrl:b.stickerPack.heroStickerNormalUrl;var c=this.userStickerPacks[a.sticker_pack_id][b.variant];c&&c.shiny_level>=a.shiny_level?(b.shiny_level=c.shiny_level,b.quality=c.quality):(b.shiny_level=a.shiny_level,b.quality=a.quality);this.userStickerPacks[a.sticker_pack_id][b.variant]=b;var d=this;b.stickerPack.stickers.forEach(function(a){d.userOwnedStickers[a.id]=
d.userOwnedStickers[a.id]||{};d.userOwnedStickers[a.id][b.variant]=!0})},pushNewUserStickerPack:function(a){this.parseStickers(a.stickers);this.parseStickerPacks(a.sticker_packs);this.addUserStickerPack(a.user_sticker_pack);this.userStickerCollections=[];this.buildStickerCollections();this.trigger("update")},parseStickers:function(a){var b=this;(a||[]).forEach(function(a){b.addSticker(a)})},parseStickerPacks:function(a){var b=this;(a||[]).forEach(function(a){b.addStickerPack(a)})},parseUserStickerPacks:function(a){var b=
this;(a||[]).forEach(function(a){b.addUserStickerPack(a)})},buildStickerCollections:function(){for(var a in this.userStickerPacks)this.addToStickerCollections(a)},addToStickerCollections:function(a){if(Object.prototype.hasOwnProperty.call(this.userStickerPacks,a)){var b=this.userStickerPacks[a].shiny;a=this.userStickerPacks[a].normal;var c=b||a;this.userStickerCollections.push({id:c.stickerPack.id,shiny:b?b.stickerPack.stickers:[],normal:a?a.stickerPack.stickers:[],name:c.stickerPack.name,iconUrl:c.heroStickerUrl})}},
isStickerOwned:function(a,b){return!!(this.userOwnedStickers[a]||{})[b]},recentStickersKey:function(){return this.recentStickersPrefix+this.activeUser.id()},loadRecentStickers:function(){this.recentStickers=$.jStorage.get(this.recentStickersKey())||[];this.pruneRecentStickers()},storeRecentStickers:function(){$.jStorage.set(this.recentStickersKey(),this.recentStickers)},clearRecentStickers:function(){this.recentStickers=[];this.storeRecentStickers();this.loadRecentStickers()},pruneRecentStickers:function(){var a=
this;for(this.recentStickers=this.recentStickers.filter(function(b){return a.isStickerOwned(b.id,b.variant)});this.recentStickers.length>StickerManager.MAX_RECENT_STICKERS;)this.recentStickers.pop()},trackRecentSticker:function(a,b){this.recentStickers=this.recentStickers.filter(function(c){return c.id!==a||c.variant!==b});this.recentStickers.unshift({id:a,variant:b});this.pruneRecentStickers();this.storeRecentStickers();this.trigger("update-recent")},flushDailyActivityQueue:function(){if(this.activeUser.isAuthenticated()){var a=
this;this.queuedDailyActivities.forEach(function(b){a.performDailyActivity(b)});this.queuedDailyActivities=[]}},getTimestamp:function(){return+new Date}};$j.extend(StickerManager.prototype,Evented);SuggestionTemplate=function(a,b){this.initialize(a,b)};
SuggestionTemplate.prototype={initialize:function(a,b){this._source=(a=$(a))?a.cloneNode(!0):void 0;this._substitutions=$H(b||{})},source:function(){return this._source?this._source.cloneNode(!0):void 0},substitutions:function(){return this._substitutions},insertAt:function(a){if(this.source()){var b=$(a);b&&(b.update(this.source()),this.substitutions().each(function(a){var c=a.value;(a=b.down(a.key))&&a.update(c)}))}}};UserRollover=function(a){this.initialize(a)};UserRollover.USER_TOP_FUDGE=9;
UserRollover.BASE_LEFT_VALUE=54;
UserRollover.prototype={initialize:function(a){this._chat_window=a;this._rollover_template_node=$("user_rollover_template");this._gamelink_node=$("rollover_game_link");this._profile_node=$("rollover_profile_link");this._add_friend_node=$("rollover_add_friend_link");this._private_message_node=$("rollover_private_message_link");this._private_room_invite_node=$("rollover_private_room_invite_link");this._private_room_kick_node=$("rollover_private_room_kick_link");this._mute_node=$("rollover_mute_link");
this._add_friend_observer=function(){};this._profile_observer=function(){};this._private_message_observer=function(){};this._mute_observer=function(){};if(this._rollover_template_node){var b=this;this._rollover_template_node.observe("mouseover",function(a){b.stopHide();Event.stop(a)});this._rollover_template_node.observe("mouseout",function(a){b.beginHide();Event.stop(a)})}},show:function(a,b){this._hideTimer&&clearTimeout(this._hideTimer);this.updateCurrentGame(a);this.updateProfileLink(a);this.updateAddFriendLink(a.username);
this.updatePrivateMessageLink(a.username);this.updatePrivateRoomInviteLink(a.username);this.updatePrivateRoomKickLink(a.username);this.updateMutingLink(a.username);this.toggleApplicableLinks(a);this.setRolloverPosition(b);this._rollover_template_node.show()},setRolloverPosition:function(a){var b=this._chat_window.activeRoomUserListScrollTop(),c=a.positionedOffset(),d=c[0],e=c[1];c=e-=UserRollover.USER_TOP_FUDGE;b<e&&(c=e-b);a=a.getWidth();this._rollover_template_node.setStyle({left:d+a+"px",top:c+
"px"})},updateCurrentGame:function(a){a.gameTitle()?(this._gamelink_node.up().show(),this._gamelink_node.writeAttribute("href",a.gameUrl()),this._gamelink_node.update(a.gameTitle())):this._gamelink_node.up().hide()},updateAddFriendLink:function(a){this._chat_window.username();this._chat_window.isFriend(a)?this._add_friend_node.hide():(this._add_friend_node.update("Add Friend"),this._add_friend_node.stopObserving("click",this._add_friend_observer),this._add_friend_observer=CapturesToInlineRegistration.decorate(function(b){Element.show("add_as_friend_indicator");
var c="/accounts/"+this._chat_window.username()+"/friends/"+a+"?friend_from=chat";new Ajax.Request(c,{asynchronous:!0,evalScripts:!0,method:"put"});Event.stop(b);return!1}.bind(this)),this._add_friend_node.observe("click",this._add_friend_observer),this._add_friend_node.show())},updatePrivateMessageLink:function(a){var b=this._chat_window;this._private_message_node.stopObserving("click",this._private_message_observer);this._private_message_observer=CapturesToInlineRegistration.decorate(function(c){b.insertPrivateMessagePrefixFor(a);
Event.stop(c);return!1}.bind(this));this._private_message_node.observe("click",this._private_message_observer)},updatePrivateRoomInviteLink:function(a){var b=this._private_room_invite_node,c=this._chat_window.roomByType("private");c&&c.isMyPrivateRoom()&&c.user(a)?b.hide():(b.show(),holodeck.hasInvited(a)?(b.down(".invite").hide(),b.down(".retry").show()):(b.down(".invite").show(),b.down(".retry").hide()));b.stopObserving("click");b.observe("click",function(c){b.down(".invite").hide();b.down(".retry").show();
holodeck.sendPrivateRoomInvitation(a);Event.stop(c);return!1})},updatePrivateRoomKickLink:function(a){var b=this._chat_window._active_room,c=this._private_room_kick_node,d=this;b.isPrivate()&&b.isMyPrivateRoom()?(c.show(),c.stopObserving("click"),c.observe("click",function(b){holodeck.privateRoomKick(a);d.hide();Event.stop(b);return!1})):c.hide()},updateMutingLink:function(a){var b;if(this._chat_window.isAdmin(a))this._mute_node.hide();else{this._mute_node.show();var c=a.match(/^_/),d=this._chat_window.username();
this._chat_window.isMuted(a)?(this._mute_node.update("Unmute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=function(e){c?(holodeck.removeMuting(a),LocalMuteService.unmute(a)):(Element.show("muting_indicator"),b="/accounts/"+d+"/muted_users/"+a+"?from_chat=true",new Ajax.Request(b,{asynchronous:!0,evalScripts:!0,method:"delete"}));Event.stop(e);return!1}):(this._mute_node.update("Mute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=
CapturesToInlineRegistration.decorate(function(e){c?(holodeck.addMuting(a),LocalMuteService.mute(a)):(b="/accounts/"+d+"/muted_users?username="+a+"&from_chat=true",Element.show("muting_indicator"),new Ajax.Request(b,{asynchronous:!0,evalScripts:!0,method:"post"}));Event.stop(e);return!1}.bind(this)));this._mute_node.observe("click",this._mute_observer)}},updateProfileLink:function(a){var b=this._chat_window,c=this;this._profile_node.stopObserving("click",this._profile_observer);this._profile_observer=
function(d){c.hide();b.showProfile(a.username);Event.stop(d);return!1};this._profile_node.observe("click",this._profile_observer)},beginHide:function(){var a=this;this._hideTimer&&clearTimeout(this._hideTimer);this._hideTimer=setTimeout(function(){a.hide()},500)},stopHide:function(){clearTimeout(this._hideTimer)},hide:function(){this._rollover_template_node.hide()},toggleApplicableLinks:function(a){a.isGuest()?(this._private_room_invite_node.hide(),this._private_message_node.hide(),this._profile_node.hide(),
this._add_friend_node.hide()):(a.isMobile()?(this._private_room_invite_node.hide(),this._private_message_node.hide()):(this._private_room_invite_node.show(),this._private_message_node.show()),this._profile_node.show())}};window.WEB_SOCKET_DEBUG=!1;window.WEB_SOCKET_SWF_LOCATION="https://assets.kongregate.com/flash/WebSocketMain.swf";window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0;
(function(){if(!window.WEB_SOCKET_FORCE_FLASH){if(window.WebSocket)return;if(window.MozWebSocket){window.WebSocket=MozWebSocket;return}}var a=window.WEB_SOCKET_LOGGER?WEB_SOCKET_LOGGER:window.console&&window.console.log&&window.console.error?window.console:{log:function(){},error:function(){}};10>swfobject.getFlashPlayerVersion().major?a.error("Flash Player >= 10.0.0 is required."):("file:"==location.protocol&&a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),
window.WebSocket=function(a,c,d,e,g){var b=this;b.__id=WebSocket.__nextId++;WebSocket.__instances[b.__id]=b;b.readyState=WebSocket.CONNECTING;b.bufferedAmount=0;b.__events={};c?"string"==typeof c&&(c=[c]):c=[];b.__createTask=setTimeout(function(){WebSocket.__addTask(function(){b.__createTask=null;WebSocket.__flash.create(b.__id,a,c,d||null,e||0,g||null)})},0)},WebSocket.prototype.send=function(a){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";
a=WebSocket.__flash.send(this.__id,encodeURIComponent(a));if(0>a)return!0;this.bufferedAmount+=a;return!1},WebSocket.prototype.close=function(){this.__createTask?(clearTimeout(this.__createTask),this.__createTask=null,this.readyState=WebSocket.CLOSED):this.readyState!=WebSocket.CLOSED&&this.readyState!=WebSocket.CLOSING&&(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(a,c,d){a in this.__events||(this.__events[a]=[]);this.__events[a].push(c)},
WebSocket.prototype.removeEventListener=function(a,c,d){if(a in this.__events)for(a=this.__events[a],d=a.length-1;0<=d;--d)if(a[d]===c){a.splice(d,1);break}},WebSocket.prototype.dispatchEvent=function(a){for(var b=this.__events[a.type]||[],d=0;d<b.length;++d)b[d](a);(b=this["on"+a.type])&&b.apply(this,[a])},WebSocket.prototype.__handleEvent=function(a){"readyState"in a&&(this.readyState=a.readyState);"protocol"in a&&(this.protocol=a.protocol);if("open"==a.type||"error"==a.type)var b=this.__createSimpleEvent(a.type);
else if("close"==a.type)b=this.__createSimpleEvent("close"),b.wasClean=a.wasClean?!0:!1,b.code=a.code,b.reason=a.reason;else if("message"==a.type)a=decodeURIComponent(a.message),b=this.__createMessageEvent("message",a);else throw"unknown event type: "+a.type;this.dispatchEvent(b)},WebSocket.prototype.__createSimpleEvent=function(a){if(document.createEvent&&window.Event){var b=document.createEvent("Event");b.initEvent(a,!1,!1);return b}return{type:a,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=
function(a,c){return window.MessageEvent&&"function"==typeof MessageEvent&&!window.opera?new MessageEvent("message",{view:window,bubbles:!1,cancelable:!1,data:c}):document.createEvent&&window.MessageEvent&&!window.opera?(a=document.createEvent("MessageEvent"),a.initMessageEvent("message",!1,!1,c,null,null,window,null),a):{type:a,data:c,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__isFlashImplementation=!0,WebSocket.__initialized=
!1,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(a){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(a)})},WebSocket.__initialize=function(){if(!WebSocket.__initialized)if(WebSocket.__initialized=!0,WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),window.WEB_SOCKET_SWF_LOCATION){if(!window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&!WEB_SOCKET_SWF_LOCATION.match(/(^|\/)WebSocketMainInsecure\.swf(\?.*)?$/)&&
WEB_SOCKET_SWF_LOCATION.match(/^\w+:\/\/([^\/]+)/)){var b=RegExp.$1;location.host!=b&&a.error("[WebSocket] You must host HTML and WebSocketMain.swf in the same host ('"+location.host+"' != '"+b+"'). See also 'How to host HTML file and SWF file in different domains' section in README.md. If you use WebSocketMainInsecure.swf, you can suppress this message by WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR = true;")}b=document.createElement("div");b.id="webSocketContainer";b.style.position="absolute";WebSocket.__isFlashLite()?
(b.style.left="0px",b.style.top="0px"):(b.style.left="-100px",b.style.top="-100px");var c=document.createElement("div");c.id="webSocketFlash";b.appendChild(c);document.body.appendChild(b);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(b){b.success||a.error("[WebSocket] swfobject.embedSWF failed")})}else a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf")},
WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash");WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var a=0;a<WebSocket.__tasks.length;++a)WebSocket.__tasks[a]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){setTimeout(function(){try{for(var b=WebSocket.__flash.receiveEvents(),c=0;c<b.length;++c)WebSocket.__instances[b[c].webSocketId].__handleEvent(b[c])}catch(d){a.error(d)}},
0);return!0},WebSocket.__log=function(b){a.log(decodeURIComponent(b))},WebSocket.__error=function(b){a.error(decodeURIComponent(b))},WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];return a&&a.enabledPlugin&&a.enabledPlugin.filename?a.enabledPlugin.filename.match(/flashlite/i)?!0:!1:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||
swfobject.addDomLoadEvent(function(){WebSocket.__initialize()}))})();
var GameBelowFoldHighScores={isSetup:!1,setup:function(){this.isSetup||($j("#highscoresholder").on("change","#stat_selector",function(a){a.preventDefault();a=$j(this).val();GameBelowFoldHighScores.updateScores(a,1,"today_page")}),$j("#highscoresholder").on("click",".js-high-scores-paginate",function(a){a.preventDefault();var b=$j(this);a=b.data("statistic-id");var c=b.data("page");b=b.data("page-param");GameBelowFoldHighScores.updateScores(a,c,b)}),$j("#highscoresholder").on("click",".tab_title.dormant",
function(a){a.preventDefault();$j("#highscoresholder dd.tab_box").html('<span class="spinner spinner_big">Loading...</span>');GameBelowFoldHighScores.updateScores($j("#stat_selector").val(),1,$j(a.currentTarget).data("tab")+"_page")}),this.isSetup=!0)},updateScores:function(a,b,c){a={game_id:active_user.gameId(),statistic_id:a,page_param:c};a[c]=b;$j.get("/high_scores/game_below_fold",a,function(a){$j("#highscoresholder").html(a)})}},GameBelowFoldStickerPack={updateStickerPack:function(){var a={game_id:active_user.gameId()};
(holderElement=$j("#sticker_pack_holder"))&&$j.get("/stickers/game_below_fold",a,function(a){a&&($j("#sticker_pack_holder").html(a),document.querySelector(".game_sticker_packs").classList.add("is-visible"),holodeck.showStickerPackLink())})}},CinematicMode={initialize:function(a){this._disallow_cinematic_scaling=a;this._cinematic_mode_active=this._hooked_up_cinematic_mode_link=!1;this._suppress_room_not_found=null;this._showingCinematicMessage=!1;this._cinematic_messages=[];this._game_standard_layout=
null},hookUpCinematicQuicklink:function(){this._hooked_up_cinematic_mode_link||($("cinematic_mode_link").removeClassName("disabled"),$("cinematic_mode_link").observe("click",function(a){a.stop();CinematicMode.activateCinematicMode()}),this._hooked_up_cinematic_mode_link=!0)},isInCinematicMode:function(){return $("play").hasClassName("cinematic_mode")},addCinematicMessage:function(a){this.isInCinematicMode()&&($("cinematic_close_link").addClassName("alt"),this._cinematic_messages.push(a),this.showNextCinematicMessage())},
gameElement:function(){return $("gamediv")||$("gameiframe")},gameWrapper:function(){return $("game_wrapper")||$("gameiframe")},showNextCinematicMessage:function(){if(!this._showingCinematicMessage&&0<this._cinematic_messages.length){this._showingCinematicMessage=!0;var a=CinematicMode._cinematic_messages.shift();$("game").insert('<p id="overlay_message" class="cinematic_alert" style="opacity:0;"><span class="spritegame cinematic_alert_ico mrm"></span><span class="cinematic_alert_text">'+a+"</span></p>");
$("overlay_message").fade({duration:2,from:0,to:1,afterFinish:function(){setTimeout(function(){$("overlay_message").fade({duration:2,from:1,to:0,afterFinish:function(){$("overlay_message")&&($("overlay_message").remove(),$("cinematic_close_link").removeClassName("alt"));CinematicMode._showingCinematicMessage=!1;CinematicMode.showNextCinematicMessage()}})},3E4)}});this.refreshCinematicLayout()}},activateCinematicMode:function(){if(!this._cinematic_mode_active)if(active_user.isAuthenticated()){holodeck.recordAnalyticsEvent("CinematicMode",
"Enter");var a=$("play");a.addClassName("cinematic_mode");a.insert({top:(new Element("div")).addClassName("cinematic_overlay")});$("cinematic_close_link").show();document.viewport.getDimensions();$("game").getLayout();110<$("game").cumulativeOffset()[1]&&($("play").hasClassName("premium_user")?$("game").setStyle({top:"50px"}):$("game").setStyle({top:"130px"}));this._game_standard_layout=this.gameWrapper().getLayout();$("cinematic_close_container").setStyle({width:this._game_standard_layout.get("width")+
"px"});Event.observe(document,"click",this.handleClickInCinematicMode);window.scrollTo(0,0);Event.observe(window,"resize",this.refreshCinematicLayout);$$(".square_ad").each(function(a){a.hide()});this._cinematic_mode_active=!0;this.refreshCinematicLayout()}else active_user.activateInlineLogin({from_upsell:"cinematic_mode"},!0)},deactivateCinematicMode:function(){if(this._cinematic_mode_active){holodeck.recordAnalyticsEvent("CinematicMode","Exit");this._cinematic_mode_active=!1;Event.stopObserving(window,
"resize",this.refreshCinematicLayout);Event.stopObserving(document,"click",this.deactivateCinematicMode);if(!CinematicMode._disallow_cinematic_scaling){var a=this._game_standard_layout;this.gameWrapper().setStyle({width:a.get("width")+"px",height:a.get("height")+"px"});$("cinematic_close_container").setStyle({width:a.get("width")+"px"})}$("play").removeClassName("cinematic_mode");$("cinematic_close_link").hide();$$(".cinematic_overlay").each(Element.remove);$("play").removeClassName("cinematic_small");
$$(".square_ad").each(function(a){a.show()});$("game").setStyle({left:"",top:"",width:this._game_standard_layout.get("width")+"px"})}this._cinematic_messages=[];$("cinematic_close_link").removeClassName("alt");$("overlay_message")&&$("overlay_message").remove();$("play").removeClassName("cinematic_mode");$("cinematic_close_link").hide();$$(".cinematic_overlay").each(Element.remove);$$(".square_ad").each(function(a){a.show()})},handleClickInCinematicMode:function(a){if(!a.findElement("#gamediv")&&
!a.findElement("#gameiframe")){var b=CinematicMode,c=b.gameWrapper(),d=c.getDimensions();c=c.cumulativeOffset();var e=a.pointerX();a=a.pointerY();e>c.left-30&&e<c.left+d.width+30&&a>c.top-30&&a<c.top+d.height+30||b.deactivateCinematicMode()}},refreshCinematicLayout:function(){var a=CinematicMode;if(a._cinematic_mode_active){if(!a._disallow_cinematic_scaling){var b=50;$("play").hasClassName("premium_user")&&(b=80);var c=a._game_standard_layout,d=c.get("width")/c.get("height"),e=document.viewport.getWidth()-
110,g=e/d,h=a.gameElement().viewportOffset();g+h.top+b>document.viewport.getHeight()&&(g=document.viewport.getHeight()-h.top-b,e=g*d);e<c.get("width")&&(e=c.get("width"),g=c.get("height"));a.gameWrapper().setStyle({width:e.toFixed()+"px",height:g.toFixed()+"px"})}a=$("gamediv")||$("gameiframe");b=a.getWidth()+60;$("cinematic_close_container").setStyle({width:b+"px"});$("game").setStyle({width:b+"px"});a=(document.viewport.getWidth()-a.getWidth()-60)/2;b=document.viewport.getDimensions().height;$("game").setStyle({left:Math.max(0,
a)+"px"});b>$("game").getHeight()+129?$("play").hasClassName("cinematic_small")||$("play").addClassName("cinematic_small"):$("play").hasClassName("premium_user")&&b>$("game").getHeight()+39?$("play").hasClassName("cinematic_small")||$("play").addClassName("cinematic_small"):$("play").hasClassName("cinematic_small")&&$("play").removeClassName("cinematic_small");if(a=$("overlay_message"))b=$("cinematic_close_container").getWidth(),c=($("game").getWidth()-20-b)/2,a.setStyle({width:b+"px",left:c+"px"})}}};
KONGREGATE={};
KONGREGATE.cloudSavesHandler=function(){var a={SYNC:"sync",REMOTE_ONLY:"remoteOnly",LOCAL_ONLY:"localOnly"},b={},c=[],d=[],e,g="gamediv";return{MODES:a,clearConfig:function(a){b={}},configure:function(a){$j.extend(b,a)},swf:function(){return $j("#"+g)[0]},setSwfObjectId:function(a){null!==a&&"undefined"!=typeof a&&""!==a&&(g=a)},enterConflict:function(){b.mode===a.SYNC&&this.swf().enterConflict();this.runConflictCallbacks()},addConflictCallback:function(a){d.push(a)},runConflictCallbacks:function(){$j.each(d,function(a,
b){setTimeout(function(){b()},0)})},readAllSyncedSharedObjectKeys:function(){return b.syncedSharedObjects.keys()},determineSyncMode:function(c,d,f,g){e=d;if(b.mode)return this.runModeDeterminedCallbacks(b.mode,f),b.mode;if(!b.enabled)return b.mode=a.LOCAL_ONLY,!this.getUserId()&&g&&this.runModeDeterminedCallbacks(b.mode,f,g),b.mode;b.mode=c&&!d||f?a.LOCAL_ONLY:a.SYNC;this.runModeDeterminedCallbacks(b.mode,f);return b.mode},addModeDeterminedCallback:function(a){c.push(a)},runModeDeterminedCallbacks:function(a,
b,d){$j.each(c,function(c,e){setTimeout(function(){e(a,b,d)},0)})},getSyncMode:function(){return b.mode},getSyncedSharedObject:function(a){return b.syncedSharedObjects.get(a)},updateSyncedSharedObject:function(a,c){var d={};d[a]=c;b.syncedSharedObjects.processData({data:d,watermark:b.syncWatermark})},clearSyncedSharedObject:function(a){b.syncedSharedObjects.clear(a,b.syncWatermark)},getSyncedSharedObjectWatermark:function(){return b.syncWatermark},setSyncedSharedObjectWatermark:function(a){b.syncWatermark=
a},getUserId:function(){return b.userId},getUsername:function(){return b.username},forceUpdates:function(){this.swf().resolveConflict();b.syncedSharedObjects.forceUpdates()},zeroLocalMetadata:function(){this.swf().resolveConflict();this.swf().zeroLocalMetadata()},touchLocalMetadata:function(){this.swf().touchLocalMetadata()},localWatermark:function(){return e},pollData:function(){return this.swf().pollData()},beginPolling:function(){setInterval(KONGREGATE.cloudSavesHandler.processData,Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME)},
processData:function(){b.syncedSharedObjects.processData(KONGREGATE.cloudSavesHandler.pollData())},flush:function(c){b.mode!==a.LOCAL_ONLY&&"undefined"!==typeof b.syncedSharedObjects&&b.syncedSharedObjects.flush(KONGREGATE.cloudSavesHandler.pollData(),c)}}}();
(function(){function a(){try{lightbox.prototype.deactivate()}catch(b){}}"undefined"!=typeof cloudSaves&&cloudSaves&&active_user.addRunWhenAuthenticatedObserver(function(b){b.isPremium()&&null===b.areCloudSavesEnabled()&&(lightbox.prototype.initializeKongregateLightboxFromAjax("/cloud_saves_preference/new",{done_class_name:"kred_purchase lightbox_login cloud_lb",afterStaticContentLoad:function(){$j(".js-cloud-saves-game-name").text(active_user.gameName())}}),$j(document).on("click",".js-cloud-saves-preference",
function(b){b=$j(b.target);var c=b.data("enabled");b.parent("p").html('<span class="spinner">Loading...</span>');$j.ajax("/cloud_saves_preference",{type:"post",data:{cloud_saves_preference:{enabled:c}}}).done(function(){c?window.location.reload():a()}).fail(function(){a()})}))})}).runWhenReady();
var GameIframe=function(a,b,c){active_user.forceSSLIframe()&&(Kongregate.Log.warn("Forcing SSL iframe"),a.iframe_url&&(a.iframe_url=a.iframe_url.replace(/^http:/,"https:")),a.iframe_host&&(a.iframe_host=a.iframe_host.replace(/^http:/,"https:")));this.config=a;this.urlOptions=b;this.channelId=c};
GameIframe.prototype.createGameIframeElement=function(){var a=new Element("iframe",{id:"gameiframe",name:"gameiframe",scrolling:"auto",border:0,frameborder:0,style:"width: "+this.config.game_width+"px; height: "+this.config.game_height+"px; position: absolute; top: "+this.config.game_top+"px; left: "+this.config.game_left+"px;","class":this.config.iframe_class,allowfullscreen:!this.config.max_game_height});$("gameiframe").replace(a);this.getGameIframeUrl(function(b){a.contentWindow.location.replace(b)});
if(this.config.post_message){var b=function(b){b.origin===this.config.iframe_host&&"kongregate_request_params"===b.data&&(b={type:"params",data:this.iframeOptions()},Kongregate.PostMessage.supportsObjects()||(b=JSON.stringify(b)),a.contentWindow.postMessage(b,this.config.iframe_host))}.bind(this);Kongregate.PostMessage.addMessageListener(window,b)}this.config.max_game_width&&this.config.max_game_height&&(function(){this.setSizeToMaxForWindow()}.bind(this).runWhenGameLoaded(),document.observe("holodeck:ready",
function(a){this.setSizeToMaxForWindow()}.bind(this)),$j(window).resize(function(a){this.setSizeToMaxForWindow()}.bind(this)));this.setupErrorListener()};
GameIframe.prototype.getGameIframeUrl=function(a){var b=this,c=window.location.search.match(/forceWebPlayer/);unityObject.detectUnity(function(d){var e=b.config.iframe_url;d="installed"===d||"running"===d;"unity"===b.config.game_type&&(b.config.alternate_game_file_url&&!c?(e=b.config.alternate_game_file_url,b.config.iframe_host=e.split("/",3).join("/")):d||(e=window.location.protocol+"//"+window.location.host+window.location.pathname+"/browser_upsell",document.observe("holodeck:ready",function(a){b.setSize(800,
800)})));b.config.post_message||(e+=0>e.indexOf("?")?"?":"&",e+=Object.toQueryString(b.iframeOptions()));a(e)})};
GameIframe.prototype.iframeOptions=function(){var a={DO_NOT_SHARE_THIS_LINK:1,kongregate_username:active_user.username(),kongregate_user_id:active_user.id(),kongregate_game_auth_token:active_user.gameAuthToken(),kongregate_game_id:this.config.game_id,kongregate_host:this.config.host,kongregate_game_url:this.config.game_url,kongregate_api_host:this.config.api_host,kongregate_channel_id:this.config.channel_id,kongregate_api_path:this.config.api_path,kongregate_ansible_path:this.config.ansible_path,
kongregate_preview:this.config.preview,kongregate_game_version:this.config.game_version,kongregate_language:active_user.currentLocale().slice(0,2),preview:this.config.preview,kongregate_split_treatments:encodeURIComponent(active_user.gameSplitTreatments(this.config.game_permalink)),kongregate:!0,kongregate_svid:active_user.siteVisitorUID(),kongregate_analytics_mode:this.config.analytics_mode,kongregate_debug_level:active_user.debugLevel(),kongregate_js_api:!0,kongregate_flash_postmessage:active_user.flashPostMessageEnabled(),
KEEP_THIS_DATA_PRIVATE:1},b=$H(location.search.toQueryParams()).merge(this.urlOptions.toQueryParams()).toObject();"true"===String(this.config.auto_resize)&&(a.kongregate_auto_resize=!0);for(var c in b)if(0===c.indexOf("guest_access_key")||0===c.indexOf(this.config.flash_var_prefix))a[c]=b[c];return a};
GameIframe.prototype.setSizeToMaxForWindow=function(){this.setSize(Math.max(this.config.game_width,Math.min($j(window).width()-333,this.config.max_game_width)),Math.max(this.config.game_height,Math.min($j(window).height()-150,this.config.max_game_height)))};
GameIframe.prototype.setSize=function(a,b){var c=["flashframecontent","maingamecontent","maingame"],d=["gameholder","game"],e=$("maingame");if(e){var g=e.getLayout(),h=$("gameiframe").getLayout();e=Math.max(620,a);g.get("width");h.get("width");h=g.get("height")-h.get("height");g=Math.max(e+300,923);var l=b+h;h=null;h=$("gameiframe");h.style.width=a+"px";h.width=a;h.style.height=b+"px";h.height=b;for(a=0;a<d.length;a++)h=$(d[a]),h.style.width=e+"px",h.width=e,h.style.height=b+"px",h.height=b;for(a=
0;a<c.length;a++)h=$(c[a]),h.style.width=g+"px",h.width=g,h.style.height=l+"px",h.height=l;if(b=$("chat_container"))b.style.height=l-26+"px",b.height=l-26;$$(".chat_message_window").each(function(a){a.style.height=l-283+"px";a.style["max-height"]=l-283+"px";a.height=l-283});$$(".tabpane").each(function(a){a.style.height=l-66+"px";a.height=l-66})}};
GameIframe.prototype.setupErrorListener=function(){if("undefined"!==typeof metricTracker){var a=function(a){var b;"object"===typeof a.data&&(b=a.data.kongregateGameError)&&(metricTracker.trackEvent("GamePage","Error",b.type,null,!0),Kongregate.Log.warn("Game error reported",b))}.bind(this);Kongregate.PostMessage.addMessageListener(window,Kongregate.Utils.catchErrors(a,this))}};
Kongregate.SyncedSharedObjects=function(a,b,c,d){function e(){w||v||(w=setTimeout(function(){w=null;g()},Math.max(Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME,B-1E3*new Date)))}function g(){v=null;$j.extend(r,q);q={};B=Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME+1E3*new Date;$j.ajax(a,{type:"POST",data:{updates:JSON.stringify(r),watermark:x,load_watermark:c,debug:d},beforeSend:function(){$j.each(l,function(a,b){setTimeout(b,0)});return!0},complete:function(a,b){var c="success"===b;$j.each(f,
function(a,b){setTimeout(function(){b(c)},0)});return!0},success:function(){$j.extend(h,r);r={};I=0;$j.isEmptyObject(q)||e()},error:function(a){409==a.status?($j.each(m,function(a,b){setTimeout(b,0)}),I=0):401==a.status?I=0:(v=setTimeout(g,1E3*Math.pow(2,I)),I++)}})}var h=b||{},l=[],f=[],m=[],r={},q={},x,v=null,I=0,w,B=0,G=this;this.processData=function(a){x=a.watermark;$j.extend(q,a.data);$j.isEmptyObject(q)||e()};this.get=function(a){return h[a]};this.clear=function(a,b){delete h[a];clearData={};
clearData[a]=null;G.processData({data:clearData,watermark:b})};this.flush=function(b,e){clearTimeout(w);clearTimeout(v);$j.extend(r,q);b&&($j.extend(r,b.data),x=b.watermark);q={};$j.isEmptyObject(r)?e&&e():$j.ajax(a,{type:"POST",async:!!e,data:{updates:JSON.stringify(r),watermark:x,load_watermark:c,debug:d},success:e})};this.keys=function(){var a=[];$j.each(h,function(b,c){a.push(b)});return a};this.retryCount=function(){return I};this.addSyncStartedCallback=function(a){l.push(a)};this.addSyncEndedCallback=
function(a){f.push(a)};this.addConflictCallback=function(a){m.push(a)};this.forceUpdates=function(){x=c=+new Date;g()};this.hasActiveRetry=function(){return null!==v}};Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME=5E3;Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME=6E4;
Kongregate.GameLoader=function(a,b,c){function d(){"undefined"!==typeof active_user&&"function"===typeof active_user.areCloudSavesEnabled&&"undefined"!==typeof cloudSaves&&"undefined"!==typeof cloudSaves.syncedSharedObjects&&active_user.areCloudSavesEnabled()&&!h&&(KONGREGATE.cloudSavesHandler.flush(),h=!0)}var e,g=!1,h=!1,l=this;if(KONGREGATE.cloudSavesHandler)if(void 0!==window.onbeforeunload)$j(window).on("beforeunload.cloud_saves",d);else $j(window).on("unload.cloud_saves",d);this.refreshCloudData=
function(a){$j.ajax({url:b,success:function(b){cloudSaves=b;a()}})};this.loadGame=function(d){b&&"undefined"!==typeof cloudSaves&&("undefined"!==typeof cloudSaves.syncedSharedObjects?cloudSaves.syncedSharedObjects.constructor!==Kongregate.SyncedSharedObjects&&(e=new Kongregate.SyncedSharedObjects(b,cloudSaves.syncedSharedObjects,cloudSaves.loadWatermark,c),cloudSaves.syncedSharedObjects=e,e.addSyncStartedCallback(Kongregate.CloudSavesController.syncStarted.bind(Kongregate.CloudSavesController)),e.addSyncEndedCallback(Kongregate.CloudSavesController.syncEnded.bind(Kongregate.CloudSavesController)),
e.addConflictCallback(KONGREGATE.cloudSavesHandler.enterConflict.bind(KONGREGATE.cloudSavesHandler))):(e=new Kongregate.SyncedSharedObjects(b,{}),cloudSaves.syncedSharedObjects=e,c||active_user.addRunWhenAuthenticatedObserver(Kongregate.CloudSavesController.userAuthenticated.bind(Kongregate.CloudSavesController))),g||(KONGREGATE.cloudSavesHandler.addModeDeterminedCallback(Kongregate.CloudSavesController.modeDetermined.bind(Kongregate.CloudSavesController)),KONGREGATE.cloudSavesHandler.addConflictCallback(Kongregate.CloudSavesController.handleConflict.bind(Kongregate.CloudSavesController)),
g=!0),c&&(cloudSaves.mode="debug"),KONGREGATE.cloudSavesHandler.configure(cloudSaves));a(d)};this.reloadCloudSaves=function(){this.refreshCloudData(function(){l.loadGame()})};this.forceUpdate=function(){e.forceUpdate()};this.setSyncMode=function(a){KONGREGATE.cloudSavesHandler.configure({mode:a});this.loadGame()};this.getSyncMode=function(){return KONGREGATE.cloudSavesHandler.getSyncMode()};this.upgradeToSync=function(a){"localOnly"!==this.getSyncMode()||a?a?l.refreshAndSync():KONGREGATE.cloudSavesHandler.flush(function(){l.refreshAndSync()}):
(KONGREGATE.cloudSavesHandler.touchLocalMetadata(),this.setSyncMode("sync"))};this.reloadGame=function(){KONGREGATE.cloudSavesHandler.clearConfig();this.loadGame()};this.refreshAndSync=function(){l.refreshCloudData(function(){KONGREGATE.cloudSavesHandler.zeroLocalMetadata();l.setSyncMode("sync")})}};
var GameMetricsUpdater=function(){return{update:function(){new Ajax.Request(active_user.gameResourcePath()+"/metrics.json",{method:"get",onSuccess:function(a){a=a.responseJSON;[[".favorites_count",a.favorites_count_with_delimiter],[".gameplays_count",a.gameplays_count_with_delimiter],["#game_statistics",a.game_statistics],[".average_rating",a.average_rating_text],[".average_rating_with_count",a.average_rating_with_count],["#rating_message",a.rating_message],["#below_game_rating_message",a.below_game_rating_message],
["#star_ratings_block",a.user_rating],["#below_game_star_ratings_block",a.below_game_user_rating],["#quicklinks_star_ratings_block",a.quicklinks_user_rating],[".flag_game",a.flagged],["#favorite_game",a.favorite_message],["#below_game_favorite_game",a.below_game_favorite_message],["#quicklinks_favorite_block",a.quicklinks_favorite_message],["#quicklinks_play_later_block",a.quicklinks_play_later_message],["#below_game_play_later_block",a.below_game_play_later_message],["#user_donation_holder",a.last_tip_message],
["#combined_favorites_js",a.combined_favorites_js],["#game_block",a.block_game_js]].each(function(a){var b=a[0],d=a[1];d&&$$(b).each(function(a){a.update(d)})});holodeck._user_rating=a.user_rating_value},onFailure:function(a){console.error("Error loading game metrics: %o",a.responseText)}})}}}();
(function(){HyprMXAdManager=function(a){this.initialize(a)};HyprMXAdManager.AD_AVAILABLE_URL="https://live.hyprmx.com/embedded_offers/videos_available_jsonp?";HyprMXAdManager.EMBED_AD_URL="https://live.hyprmx.com/embedded_offers/player?";HyprMXAdManager.AD_COMPLETE_WAIT_TIME=5E3;HyprMXAdManager.prototype={initialize:function(a){this._distributorId=a.distributorId;this._site=a.site;this._enabled=!(!a.distributorId||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._serviceNotified=this._adCompleted=
!1},setReceiver:function(a){this._receiver=a},readyForAds:function(){this._enabled&&this._distributorId&&this._checkForAds()},handleHyprMXResponse:function(a){a?(Kongregate.Log.info("HyprMX: ad available"),this._receiver.onCampaignsReady()):(Kongregate.Log.info("HyprMX: no ad available for this user"),this._receiver.onNoAdAvailable())},onAdComplete:function(){Kongregate.Log.info("HyprMX ad complete!");this._adCompleted=!0;this._trackMetricsEvent("IncentivizedAdFinish");this._receiver.onCampaignCompleted();
this._loadPostAdContentIntoLightbox()},onAdClose:function(){Kongregate.Log.info("HyprMX ad closed");this._serviceNotified||(this._receiver.onCampaignClose(),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon"));this._checkForAds()},showAd:function(){this._serviceNotified=this._adCompleted=!1;Kongregate.Log.info("HyprMX: show ad");var a={distributorid:this._distributorId,uid:active_user.siteVisitorUID(),partner_code:active_user.gameId(),site:this._site};a=HyprMXAdManager.EMBED_AD_URL+
Object.toQueryString(a);this._trackMetricsEvent("IncentivizedAdStart");var b=this;lightbox.prototype.initializeHyprMXVideoFrame(a,function(){b.onAdClose()},{width:800,height:550})},_checkForAds:function(){var a={distributorid:this._distributorId,uid:active_user.siteVisitorUID()};a=HyprMXAdManager.AD_AVAILABLE_URL+Object.toQueryString(a);this._loadScript(a)},_loadScript:function(a){$j.getScript(a)},_loadPostAdContentIntoLightbox:function(){var a=$j("<div>",{id:"hyprmx_complete"});a.append($j("<p>").text("Thanks for watching!"));
var b=$j("<input>",{type:"button",value:"Close"});b.addClass("btn btn_action");b.click(function(){lightbox.prototype.shutdown()});a.append(b);setTimeout(function(){lightbox&&lightbox.prototype&&lightbox.prototype.updateWithContent(a);$j("#lightbox").removeClass("hyprmx_video").addClass("lightbox_login")},HyprMXAdManager.AD_COMPLETE_WAIT_TIME)},_trackMetricsEvent:function(a){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",a)}}})();
function IMAVideoBumper(a){this.initialize(a)}IMAVideoBumper.AD_BLOCK_TIMEOUT=5E3;IMAVideoBumper.CLOSE_LINK_TIMEOUT=1E4;IMAVideoBumper.ON_COMPLETE_PAUSE=1E3;IMAVideoBumper.CLOSE_LINK_FADE_IN=1E3;IMAVideoBumper.FAILSAFE_TIMEOUT=12E4;
IMAVideoBumper.prototype={initialize:function(a){this._targetingParams=a.targetingParams;this._baseUrl=a.baseUrl;this._metricTracker=a.metricTracker;this._topKredsGame=!1;this._targetingParams&&this._targetingParams.gamegroup&&(this._targetingParams.gamegroup.include("top-kreds")&&(this._topKredsGame=!0),this._targetingParams.gamegroup.include("no-preroll")&&(this._suppressPrerollGroup=!0))},loadGame:function(a){if(a&&this.getsBumper())this.showPreroll();else this.onComplete()},hasBadIEVersion:function(){return Prototype.Browser.IE9||
Prototype.Browser.IE8||Prototype.Browser.IE7},suppressForTopKredsGame:function(){return this._topKredsGame?active_user.inTopKredGracePeriod():!1},getsBumper:function(){return this._suppressPrerollGroup||this.hasBadIEVersion()||active_user.getsRegistrationLightbox()||active_user.isPremium()||this.suppressForTopKredsGame()?!1:!0},showPreroll:function(){this.trackEvent("PrerollInitiated");this.adBlockTimeout=setTimeout(this.abortAd.bind(this),IMAVideoBumper.AD_BLOCK_TIMEOUT);this.failsafeTimeout=setTimeout(this.reachedFailsafe.bind(this),
IMAVideoBumper.FAILSAFE_TIMEOUT);$j("#noflash").is(":visible")&&(this.hidFlashMessage=!0,$j("#noflash").hide());$j("#bumper_premium_header").show();$j("#ad_skip_controls").show();$j("#ima_bumper").show();$j("#game").css("visibility","hidden");$j("#bumper_premium_header").show();this.createAdPlayer();this.player.play()},createAdPlayer:function(){this.player=videojs("ima_bumper");this.player.ima({id:"ima_bumper",debug:null===window.location.hostname.match(/kongregate\.com/),adTagUrl:this.createAdTagUrl()});
this.setupEventListeners();this.player.ima.requestAds();var a=$j("#game").height()-$j("#bumper_premium_header").height()-$j("#ad_skip_controls").height();$j("#ima_bumper").css("height",a)},createAdTagUrl:function(){this._convertTargetingArraysToStrings();return this.adTagUrl=this._baseUrl+"&cust_params="+encodeURIComponent(decodeURIComponent($j.param(this._targetingParams)))},setupEventListeners:function(){this.player.on("adend",this.onAdEnd.bind(this));this.player.on("adserror",this.onComplete.bind(this));
this.player.on("adsready",this.onAdsReady.bind(this))},trackEvent:function(a){this._metricTracker&&this._metricTracker.trackEvent("GamePage",a)},onAdsReady:function(){this.trackEvent("PrerollAdsReady");clearTimeout(this.adBlockTimeout);active_user.isAuthenticated()&&!active_user.inCloseLinkTest()&&setTimeout(this.showCloseLink,IMAVideoBumper.CLOSE_LINK_TIMEOUT)},onAdEnd:function(){this.trackEvent("PrerollEnded");this.clearFailsafeTimeout();this.onComplete()},showCloseLink:function(){var a=$j("#bumper_close_link");
a.click(function(){setTimeout(window.imaVideoBumper.closeAd.bind(window.imaVideoBumper),0)});a.fadeIn(IMAVideoBumper.CLOSE_LINK_FADE_IN)},abortAd:function(){this.trackEvent("PrerollAdLoadAborted");this.clearFailsafeTimeout();this.onComplete()},closeAd:function(){this.trackEvent("PrerollAdSkipped");this.clearFailsafeTimeout();this.onComplete()},reachedFailsafe:function(){this.trackEvent("PrerollFailsafeTimeoutReached");this.onComplete()},clearFailsafeTimeout:function(){clearTimeout(this.failsafeTimeout)},
onComplete:function(){var a=this;setTimeout(function(){$j("#bumper_premium_header").remove();try{$j("#ima_bumper").remove()}catch(b){}$j("#ad_skip_controls").remove();$j("#game").css("visibility","visible");activateGame();a.hidFlashMessage&&$j("#noflash").show()},IMAVideoBumper.ON_COMPLETE_PAUSE)},_convertTargetingArraysToStrings:function(){var a=this;$j.each(this._targetingParams,function(b,c){Array.isArray(c)&&(a._targetingParams[b]=c.join(","))})}};
function GameLoadObserver(a){this.initialize(a)}
GameLoadObserver.prototype=function(){return{initialize:function(a){this._loaded=!1;this._startTime=(new Date).getTime();this._timeout=a.timeout||3E3;this._interval=null;this._debug=a.debug;this._queue=[];this.startObserving.bind(this).runWhenDomLoaded()},percentLoaded:function(){if($("gamediv"))try{return $("gamediv").PercentLoaded()}catch(a){return-1}},observeGameLoad:function(){var a=(new Date).getTime()-this._startTime,b=a>=this._timeout,c=this.percentLoaded();0<c||b?(this._debug&&console.log("Firing onGameLoaded, percentLoaded: "+
c+", timeElapsed: "+a+", timedOut: "+b),this.onGameLoaded()):0>c&&(this._debug&&console.log("Firing onGameLoaded, no flash gamediv found, percentLoaded: "+c+", timeElapsed: "+a),this.onGameLoaded())},onGameLoaded:function(){this._loaded||(this._loaded=!0,clearInterval(this._interval),this._queue.each(function(a){a.defer()}),this._queue=[])},runWhenGameLoaded:function(a){this._loaded?a.defer():this._queue.push(a)},startObserving:function(){this._interval&&clearInterval(this._interval);this._interval=
setInterval(this.observeGameLoad.bind(this),100)}}}();Function.prototype.runWhenGameLoaded=function(){window.gameLoadObserver?window.gameLoadObserver.runWhenGameLoaded(this):this.runWhenDomLoaded()};window.gameLoadObserver=new GameLoadObserver({timeout:2E3,debug:!1});function ShareWithUsersTab(a,b,c){this.initialize(a,b,c)}
ShareWithUsersTab.prototype={initialize:function(a,b,c){this._share_dialog=b;this._tab_id=a;this._current_page=0;this._request_more_func=c;(a=$(a+"_tab"))&&a.observe("click",this.handleShowTab.bindAsEventListener(this))},getMore:function(){this._current_page++;this._request_more_func();$(this._tab_id+"_indicator").show()},handleShowTab:function(a){this.refreshSelected()},handleScroll:function(a){$(this._tab_id).scrollTop+$(this._tab_id).getHeight()>=$(this._tab_id).scrollHeight&&(Event.stopObserving($(this._tab_id),
"scroll"),this.getMore())},onRequestSuccess:function(){$(this._tab_id).observe("scroll",this.handleScroll.bindAsEventListener(this))},onRequestComplete:function(){$(this._tab_id+"_indicator").hide();this.refreshSelected()},refreshSelected:function(){for(var a=$(this._tab_id).select(".user"),b=0;b<a.length;++b){var c=a[b].select("#recipient_ids_").first();c.checked=this._share_dialog.isSelected(c.value);this._share_dialog.isSelected(c.value)?a[b].addClassName("selected"):a[b].removeClassName("selected")}}};
function ShareWithFriendsDialog(a){this.initialize(a)}
ShareWithFriendsDialog.prototype={initialize:function(a){this._selected_users=[];this._user_limit=a;this._error_msg_timer=this._search_box_timer=null;$("max_users_error").hide();$("new_game_invite_feed_item").setAttribute("action","javascript:;")},setRequestFunctions:function(a,b,c){this._friends_tab=new ShareWithUsersTab("share_with_friends",this,a);this._friends_tab.getMore();this._fans_tab=new ShareWithUsersTab("share_with_fans",this,b);this._fans_tab.getMore();this._chat_members_tab=new ShareWithUsersTab("share_with_chat_members",
this,c);this._chat_members_tab.getMore()},toggleSelected:function(a,b){var c=this.findSelected(a),d=!1;-1<c?(this._selected_users.splice(c,1),d=!0,$("error_messages").update("")):this._selected_users.length<this._user_limit?(this._selected_users.push({user_id:a,username:b}),d=!0,$("error_messages").update("")):this._selected_users.length>=this._user_limit&&($("max_users_error").show(),$("max_users_error").removeClassName("hidden"),null!==this._error_msg_timer&&clearTimeout(this._search_box_timer),
this._error_msg_timer=setTimeout(function(){this._error_msg_timer=null;$("max_users_error").hide()},2500));this.friends_tab&&this._friends_tab.refreshSelected();this._fans_tab&&this._fans_tab.refreshSelected();this._chat_members_tab&&this._chat_members_tab.refreshSelected();$("selected_users").update(this.selectedUsersMessage());$("recipients").value=this.getSelectedUserIds();return d},selectedUsersMessage:function(){var a=this._selected_users.length;return 0===a?"no users selected":1==a?this._selected_users[0].username+
" selected":2==a?this._selected_users[0].username+" and "+this._selected_users[1].username+" selected":3==a?this._selected_users[0].username+", "+this._selected_users[1].username+" and "+this._selected_users[2].username+" selected":4==a?this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and 1 other user selected":this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and "+(a-3)+" other users selected"},
refreshSearchDropdown:function(){for(var a=$$(".recipient_chooser").first().select(".user"),b=0;b<a.length;++b){var c=eval("("+a[b].down(".metadata").innerHTML+")");this.isSelected(c.user_id)?a[b].addClassName("chosen"):a[b].removeClassName("chosen")}},searchUserSelected:function(a){var b=shareWithFriendsDialog.toggleSelected(a.user_id,a.username);$("recipient_search").value="";b&&($("recipient_search_container").hide(),this.isSelected(a.user_id)?$("recipient_list_updated_msg").innerHTML=a.username+
" was added to the recipient list":$("recipient_list_updated_msg").innerHTML=a.username+" was removed from the recipient list",$("recipient_list_updated_msg").show(),null!==this._search_box_timer&&clearTimeout(this._search_box_timer),this._search_box_timer=setTimeout(function(){this._search_box_timer=null;$("recipient_list_updated_msg").hide();$("recipient_search_container").show()},2500))},findSelected:function(a){for(var b=0;b<this._selected_users.length;b++)if(this._selected_users[b].user_id==
a)return b;return-1},isSelected:function(a){return-1<this.findSelected(a)},getSelectedUserIds:function(){for(var a="",b=0;b<this._selected_users.length;++b)a+=this._selected_users[b].user_id,b+1<this._selected_users.length&&(a+=",");return a}};
SharedLinksController=function(a){this.container=$(a.id);this.select=this.container.down("select");this.checkbox=this.container.down("input[type=checkbox]");this.reload=this.container.down(".shared_link_reload");this.url=a.url;this.out_of_links=this.fetching=!1;this.shown_items=0;this.addFormHandlers();this.addShowMoreHandler();this.addScrollHandler()};
SharedLinksController.prototype={fetch:function(a){if(!this.fetching){this.fetching=!0;var b=this,c=this.container.down("ul");$("shared_link_list_container");var d=this.select.getValue();a||(a={});"All"!=d&&(a.shared_link_type_id=d);new Ajax.Request(b.url,{method:"get",parameters:a,onCreate:function(){c.insert((new Element("li",{id:"shared_links_loading"})).insert((new Element("span",{"class":"spinner spinner_big"})).update("Loading...")));b.hideShowMoreLink()},onComplete:function(){$("shared_links_loading").remove();
b.fetching=!1},onSuccess:function(a){a=$A(a.responseJSON);var d;a.each(function(a){d=b.renderLink(a);c.insert(d);!b.showHidden()&&d.hasClassName("visited")||b.shown_items++});0<a.length&&(b.maxId=a.last().id);b.showShowMoreLink();25>a.length?(b.out_of_links=!0,b.shown_items=0):(b.out_of_links=!1,17>b.shown_items?(b.fetching=!1,b.fetch({max_id:b.maxId})):b.shown_items=0)}})}},renderLink:function(a){var b=$.jStorage.get(this.storageKey(a)),c=new Element("li",{id:"shared_link_"+a.id,"class":"shared_link"}),
d=(new Element("a",{"class":"shared_title_link"})).update(a.name);b&&(c.addClassName("visited"),this.showHidden()||c.hide());d.observe("click",this.handleClick.bindAsEventListener(this,a,c));c.insert((new Element("div",{"class":"shared_link_title truncate_one_line"})).insert(d));c.observe("click",function(){c.hasClassName("open")?c.removeClassName("open"):c.addClassName("open")});if(a.additional_params){c.addClassName("expandable");var e=new Element("dl",{"class":"link_info mvm"});$H(a.additional_params.evalJSON()).each(function(a){e.insert((new Element("dt",
{"class":"truncate_one_line"})).update(a.key.stripTags()));e.insert((new Element("dd",{"class":"truncate_one_line"})).update(a.value.toString().stripTags()))});c.insert(e)}return c},handleClick:function(a,b,c){$("gameiframe")?activateGame(b.link_params):(a=$H(document.location.search.toQueryParams()).merge(b.link_params.toQueryParams()).toQueryString(),window.open(document.location.pathname+"?"+a,"_blank"));$.jStorage.set(this.storageKey(b),!0,{TTL:b.ttl});c.addClassName("visited");this.showHidden()||
c.hide()},addFormHandlers:function(){var a=this.container.down("ul");this.select.observe("change",function(){a.update();this.maxId=0;this.hideShowMoreLink();this.fetch()}.bind(this));this.reload.observe("click",function(){a.update();this.maxId=0;this.hideShowMoreLink();this.fetch()}.bind(this));this.checkbox.observe("change",function(){a.select("li.visited").invoke("Y"==this.checkbox.getValue()?"show":"hide")}.bind(this))},addShowMoreHandler:function(){$("shared_link_show_more").observe("click",function(){this.fetch({max_id:this.maxId});
this.hideShowMoreLink()}.bind(this))},showShowMoreLink:function(){$("shared_link_show_more").show()},hideShowMoreLink:function(){$("shared_link_show_more").hide()},storageKey:function(a){return active_user.gameId()+"-"+a.id},addScrollHandler:function(){var a=$("shared_link_show_more"),b=0,c=$("shared_link_list_container");c.observe("scroll",function(){var d=0===c.scrollTop?c.parentNode.scrollTop:c.scrollTop;!this.out_of_links&&d+window.innerHeight>a.positionedOffset().top&&d>b&&this.fetch({max_id:this.maxId});
b=d}.bind(this))},showHidden:function(){return"Y"==this.checkbox.getValue()}};
(function(){SupersonicAdManager=function(a){this.initialize(a)};SupersonicAdManager.prototype={initialize:function(a){this._key=a.key;this._element=a.element;this._enabled=!(!a.key||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._adCompleted=!1;if("gamediv"===this._element){var b=this;window.readyForAds=function(){b.readyForAds()}}},setReceiver:function(a){this._receiver=a},readyForAds:function(){if(this._enabled){var a=this;this._receiver||(this._receiver=$j("#"+this._element)[0]);
window.ssa_json={applicationUserId:active_user.siteVisitorUID(),applicationKey:this._key,fitToFrame:!0,verticalAlign:"top",scrollToEngagement:!0,onCampaignsReady:function(){a._receiver.onCampaignsReady.apply(a._receiver,arguments)},onCampaignsDone:function(){a._receiver.onCampaignsDone.apply(a._receiver,arguments)},onCampaignOpen:function(){a._adCompleted=!1;lightbox.prototype.hideHiddenElements();"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdStart")},onCampaignCompleted:function(){a._receiver.onCampaignCompleted.apply(a._receiver,
arguments);a._adCompleted=!0;"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdFinish")},onCampaignClose:function(){lightbox.prototype.showHiddenElements();a._receiver.onCampaignClose.apply(a._receiver,arguments);a._adCompleted||"undefined"==typeof metricTracker||metricTracker.trackEvent("GamePage","IncentivizedAdAbandon")}};this._loadScript()}},showAd:function(){this._enabled&&"undefined"!==typeof SSA_CORE&&SSA_CORE.BrandConnect.engage();lightbox.prototype.dispatchLightboxOpened({width:700,
height:800})},_loadScript:function(){var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="https://a248.e.akamai.net/ssastatic.s3.amazonaws.com/inlineDelivery/delivery.min.gz.js";b.parentNode.insertBefore(a,b)}}})();
(function(){TrueXAdManager=function(a){this.initialize(a)};TrueXAdManager.prototype={initialize:function(a){this._key=a.key;this._enabled=!(!a.key||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._adCompleted=!1;this._truexActivity=this._truexClient=null;this._serviceNotified=!1},setReceiver:function(a){this._receiver=a},readyForAds:function(){this._enabled&&this._loadScript()},showAd:function(){this._serviceNotified=!1;Kongregate.Log.info("TrueX: show ad");var a=this,b=this._truexActivity;
lightbox.prototype.initializeTrueXVideoFrame(function(){a._truexClient.loadActivityIntoContainer(b,"truex_target")},a.onAdClose.bind(a),{width:960,height:600})},onAdClose:function(){this._serviceNotified||(this._receiver.onCampaignClose.apply(this._receiver,arguments),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon"));lightbox.prototype.shutdown()},onCreditEvent:function(a){if(a&&a.signature_argument_string&&a.signature){var b=this;$j.post("/truex_ad_engagements/verify_signature",
{sig_string:a.signature,arg_string:a.signature_argument_string},function(){b._adCompleted=!0;b._receiver.onCampaignCompleted.apply(b._receiver,arguments);b._trackMetricsEvent("IncentivizedAdFinish");Kongregate.Log.info("TrueX: ad credit received and verified");b._setUpClient()})}},_trackMetricsEvent:function(a){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",a)},_setUpClient:function(){var a={network_user_id:active_user.siteVisitorUID(),partner_config_hash:this._key,game_id:active_user.gameId(),
dimension_1:active_user.gameId()},b=this;truex.client(a,function(a){b._truexClient=a;b._truexClient.requestActivity(function(a){a?(b._truexActivity=a,a.onStart(function(a){b._adCompleted=!1;b._trackMetricsEvent("IncentivizedAdStart")}),a.onFinish(function(a){Kongregate.Log.info("TrueX: ad finish")}),a.onCredit(function(a){b.onCreditEvent(a)}),a.onClose(function(){b.onAdClose()}),b._receiver.onCampaignsReady.apply(b._receiver,arguments)):(Kongregate.Log.info("TrueX: No activity available for this user"),
b._receiver.onNoAdAvailable())})})},_loadScript:function(){var a=this;(function(b,c){var d=b.createElement(c),e=b.getElementsByTagName(c)[0];d.async=!0;d.src="https://static.truex.com/js/client.js";d.readyState?d.onreadystatechange=function(){if("loaded"==d.readyState||"complete"==e.readyState)d.onreadystatechange=null,a._setUpClient()}:d.onload=function(){a._setUpClient()};e.parentNode.insertBefore(d,e)})(document,"script")}}})();function GameDiscussions(a){this.initialize(a)}
GameDiscussions.prototype={initialize:function(a){this.gameUrl=a.gameUrl;this.inGuilds=a.inGuilds;this.hasGameSpecificForum=a.hasGameSpecificForum},loadForum:function(){new Ajax.Request(this.gameUrl+"/forum",{method:"get",onSuccess:function(a){$("latest_posts").update(a.responseText)}})},loadGuildForum:function(){new Ajax.Request(this.gameUrl+"/forum/guild",{method:"get",onSuccess:function(a){$("guild_posts_container").update(a.responseText).select(".game_tab_index > :first-child, .game_tab_group > :first-child").invoke("addClassName",
"active")}})},loadDiscussions:function(){this.hasGameSpecificForum&&this.loadForum();this.inGuilds&&this.loadGuildForum()},setupTabs:function(){var a=this;$$(".game_discussions .game_tab_index").each(function(b){!0!==a.inGuilds&&($(b).down(".game_tab_item",0).removeClassName("active"),$(b).down(".game_tab_item",1).addClassName("active"))});$$(".game_discussions .game_tab_group").each(function(b){!0!==a.inGuilds&&($(b).down(".tab",0).removeClassName("active"),$(b).down(".tab",1).addClassName("active"))})}};
(function(a){function b(b){if(b.valueExtensions)return!0;if(("INPUT"!==b.nodeName||"text"!==b.type&&"password"!==b.type)&&"TEXTAREA"!==b.nodeName)return!1;b.valueExtensions={current:null};if(b.constructor&&b.constructor.prototype){var c=Object.getOwnPropertyDescriptor(b.constructor.prototype,"value");Object.defineProperty(b,"value",{get:function(){return c.get.call(this)},set:function(a){b.valueExtensions.current=a;c.set.call(this,a)}})}a(b).on("propertychange",e).on("dragend",function(a){window.setTimeout(function(){e(a)},
0)});return!0}function c(){var b=h;h=[];var c;var d=0;for(c=b.length;d<c;d+=1){var e=b[d];var g=e.value;e.valueExtensions.current!==g&&(e.valueExtensions.current=g,a(e).trigger("textchange"))}}function d(){g&&(a(g).off("keyup keydown",e),g=null)}if(void 0!==document.createElement("input").oninput&&9<(document.documentMode||100))a(document).on("input",function(b){a(b.target).trigger("textchange")});else{var e=null,g=null,h=[];e=function(a){a=a.target;if(b(a)&&a.valueExtensions.current!==a.value){var d;
var e=0;for(d=h.length;e<d&&h[e]!==a;e+=1);e>=d&&(h.push(a),0===d&&window.setTimeout(c,0))}};a(document).on("focusin",function(c){d();b(c.target)&&(g=c.target,a(g).on("keyup keydown",e))}).on("focusout",d).on("input",e).on("selectionchange",function(a){if(document.selection){var b=document.selection.createRange();b&&(b=b.parentElement())&&(a.target=b,e(a))}})}})(jQuery);
